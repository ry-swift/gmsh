# GModel 构造函数图解指南 (小白版)

## 一句话总结

`GModel` 就像一个**空白画布**，用来存放你的 3D 模型（点、线、面、体）和网格数据。

---

## 类比理解

把 `GModel` 想象成一个 **建筑项目文件夹**：

```
📁 GModel (项目文件夹)
│
├── 📐 几何数据 ──────────── 建筑设计图
│   ├── 点 (GVertex)         柱子位置
│   ├── 线 (GEdge)           墙线
│   ├── 面 (GFace)           地板、墙面
│   └── 体 (GRegion)         房间、楼层
│
├── 🔧 CAD 内核 ──────────── 绘图软件
│   ├── GEO (原生)           Gmsh 自带画笔
│   └── OCC (OpenCASCADE)    专业 CAD 软件
│
├── 🔲 网格数据 ──────────── 施工网格
│   ├── 网格点 (MVertex)
│   └── 网格单元 (MElement)
│
└── 📏 尺寸场 ─────────────── 网格大小控制
```

---

## 构造函数做了什么？(6 步图解)

### 全局视角

```
┌─────────────────────────────────────────────────────────────────┐
│                    new GModel() 执行过程                         │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
   ┌─────────┐          ┌─────────┐          ┌─────────┐
   │ 步骤1-2 │          │ 步骤3-4 │          │ 步骤5-6 │
   │ 初始化  │          │ 注册    │          │ 创建    │
   │ 变量    │          │ 自己    │          │ 内核    │
   └─────────┘          └─────────┘          └─────────┘
```

---

### 步骤 1: 初始化成员变量

**目的**：给"文件夹"贴标签，准备好空架子

```
┌─────────────────────────────────────────────────────────────────┐
│                     GModel 初始状态                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   _name = ""          📝 模型名称 (空)                          │
│   _visible = 1        👁️  可见 (是)                             │
│                                                                 │
│   _geo_internals = nullptr     🔧 GEO内核 (空)                  │
│   _occ_internals = nullptr     🔧 OCC内核 (空)                  │
│                                                                 │
│   _fields = nullptr            📏 尺寸场 (空)                   │
│   _elementOctree = nullptr     🌳 八叉树 (空)                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

💡 说明: nullptr 表示"还没有"，后面按需创建
```

---

### 步骤 2: 初始化编号计数器

**目的**：准备好"身份证号发放器"

```
          网格顶点编号                    网格元素编号
    ┌──────────────────┐          ┌──────────────────┐
    │                  │          │                  │
    │  下一个可用编号  │          │  下一个可用编号  │
    │                  │          │                  │
    │    _maxVertexNum │          │   _maxElementNum │
    │        = 0       │          │        = 0       │
    │                  │          │                  │
    │   ┌──┬──┬──┬──┐  │          │   ┌──┬──┬──┬──┐  │
    │   │1 │2 │3 │..│  │          │   │1 │2 │3 │..│  │
    │   └──┴──┴──┴──┘  │          │   └──┴──┴──┴──┘  │
    │   待分配的编号   │          │   待分配的编号   │
    │                  │          │                  │
    └──────────────────┘          └──────────────────┘

💡 说明: 每创建一个顶点/元素，计数器 +1
```

---

### 步骤 3: 隐藏其他模型

**目的**：新来的模型成为"主角"，其他模型退到幕后

```
  隐藏前                               隐藏后
┌─────────┐                         ┌─────────┐
│ Model A │ 👁️ 可见                 │ Model A │ 👁️‍🗨️ 隐藏
├─────────┤         ─────────►      ├─────────┤
│ Model B │ 👁️ 可见                 │ Model B │ 👁️‍🗨️ 隐藏
├─────────┤                         ├─────────┤
│ Model C │ 👁️ 可见                 │ Model C │ 👁️‍🗨️ 隐藏
└─────────┘                         ├─────────┤
                                    │ 新Model │ 👁️ 可见 ⭐
                                    └─────────┘

代码: for(i = 0; i < list.size(); i++)
        list[i]->setVisibility(0);  // 把所有旧模型设为隐藏
```

---

### 步骤 4: 注册到全局列表 (最重要!)

**目的**：让程序能找到这个模型

```
                    GModel::list (全局模型列表)
                    ┌─────────────────────────┐
                    │  std::vector<GModel*>   │
                    └─────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          │                   │                   │
          ▼                   ▼                   ▼
     ┌─────────┐         ┌─────────┐         ┌─────────┐
     │ list[0] │         │ list[1] │         │ list[2] │
     │ Model A │         │ Model B │         │ 新Model │ ← 新加入!
     └─────────┘         └─────────┘         └─────────┘


  代码: list.push_back(this);  // 把自己加入列表


┌─────────────────────────────────────────────────────────────────┐
│  💡 这就是为什么 new GModel() 不需要保存返回值!                  │
│                                                                 │
│     new GModel();           // ✅ 正确! 自动注册到 list         │
│     GModel* m = new GModel(); // 也可以，但没必要               │
│                                                                 │
│  之后通过这些方式访问:                                           │
│     GModel::current()    → 获取当前模型                         │
│     GModel::list[i]      → 获取第 i 个模型                      │
│     GModel::list.back()  → 获取最新的模型                       │
└─────────────────────────────────────────────────────────────────┘
```

---

### 步骤 5: 创建 GEO 内核

**目的**：安装 Gmsh 自带的"绘图工具"

```
┌─────────────────────────────────────────────────────────────────┐
│                        CAD 内核对比                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  GEO 内核 (Gmsh 原生)              OCC 内核 (OpenCASCADE)       │
│  ┌─────────────────────┐          ┌─────────────────────┐      │
│  │                     │          │                     │      │
│  │  🎨 简单画笔        │          │  🏗️ 专业CAD软件     │      │
│  │                     │          │                     │      │
│  │  • 基本几何操作     │          │  • 复杂布尔运算     │      │
│  │  • 点线面体         │          │  • IGES/STEP 支持   │      │
│  │  • 轻量级           │          │  • 工业级精度       │      │
│  │                     │          │                     │      │
│  │  ✅ 总是创建        │          │  ⏳ 按需创建        │      │
│  │                     │          │  (加载CAD文件时)    │      │
│  └─────────────────────┘          └─────────────────────┘      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

  代码: createGEOInternals();  // 创建 GEO 内核
```

---

### 步骤 6: 创建尺寸场管理器

**目的**：准备控制网格大小的工具

```
┌─────────────────────────────────────────────────────────────────┐
│                      FieldManager 作用                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  没有尺寸场控制:                 有尺寸场控制:                  │
│                                                                 │
│  ┌─────────────────┐            ┌─────────────────┐            │
│  │ ▲   ▲   ▲   ▲  │            │ ▲     ▲▲▲     ▲ │            │
│  │▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲│            │▲ ▲   ▲▲▲▲▲   ▲ ▲│            │
│  │ ▲   ▲   ▲   ▲  │            │  ▲  ▲▲▲▲▲▲▲  ▲  │            │
│  │▲ ▲ ▲ ▲ ▲ ▲ ▲ ▲│            │ ▲ ▲  ▲▲▲▲▲  ▲ ▲ │            │
│  └─────────────────┘            └─────────────────┘            │
│    均匀网格 (无聊)                 自适应网格 (精细)            │
│                                   边界处更密集                  │
└─────────────────────────────────────────────────────────────────┘

  代码: _fields = new FieldManager();
```

---

## 完整流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                     GModel::GModel() 构造函数                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 1: 初始化列表 (设置默认值)                                 │
│  ─────────────────────────────                                  │
│  _name = "", _visible = 1                                       │
│  所有指针 = nullptr                                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 2: 初始化编号计数器                                        │
│  ─────────────────────────                                      │
│  _maxVertexNum = 0    (顶点从 1 开始编号)                       │
│  _maxElementNum = 0   (元素从 1 开始编号)                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 3: 隐藏其他模型                                            │
│  ──────────────────                                             │
│  for(所有已存在的模型)                                           │
│      setVisibility(0);  // 设为不可见                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 4: 注册到全局列表 ⭐ 最重要                                │
│  ────────────────────────                                       │
│  list.push_back(this);                                          │
│  // 之后可以用 GModel::current() 访问                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 5: 创建 GEO 内核                                          │
│  ─────────────────────                                          │
│  createGEOInternals();                                          │
│  // Gmsh 原生几何内核，总是需要                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  步骤 6: 创建尺寸场管理器                                        │
│  ────────────────────────                                       │
│  _fields = new FieldManager();                                  │
│  // 用于控制网格大小                                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  构造完成! ✅   │
                    │  空模型已就绪   │
                    └─────────────────┘
```

---

## GModel 数据结构图解

```
┌─────────────────────────────────────────────────────────────────┐
│                          GModel 结构                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────── 基本信息 ────────────────────────┐  │
│  │                                                          │  │
│  │  _name = "model1"        模型名称                        │  │
│  │  _visible = 1            是否可见                        │  │
│  │  _fileName = "hhh.igs"   来源文件                        │  │
│  │                                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────── 几何实体 ────────────────────────┐  │
│  │                                                          │  │
│  │  vertices ─────► [GVertex1, GVertex2, ...]   点集合      │  │
│  │  edges ────────► [GEdge1, GEdge2, ...]       边集合      │  │
│  │  faces ────────► [GFace1, GFace2, ...]       面集合      │  │
│  │  regions ──────► [GRegion1, GRegion2, ...]   体集合      │  │
│  │                                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────── CAD 内核 ────────────────────────┐  │
│  │                                                          │  │
│  │  _geo_internals ──────► GEO_Internals     ✅ 总是有      │  │
│  │  _occ_internals ──────► OCC_Internals     ⏳ 按需创建    │  │
│  │  _acis_internals ─────► nullptr           ❌ 一般没有    │  │
│  │  _parasolid_internals ► nullptr           ❌ 一般没有    │  │
│  │                                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────── 网格相关 ────────────────────────┐  │
│  │                                                          │  │
│  │  _maxVertexNum = 1000    已分配的最大顶点编号            │  │
│  │  _maxElementNum = 5000   已分配的最大元素编号            │  │
│  │  _fields ─────────────► FieldManager   尺寸场管理器     │  │
│  │  _elementOctree ──────► MElementOctree 元素快速查找     │  │
│  │                                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 静态成员图解

```
┌─────────────────────────────────────────────────────────────────┐
│                    GModel 静态成员 (全局共享)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   static std::vector<GModel*> list;    // 所有模型的列表        │
│   static int _current;                 // 当前模型的索引        │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                        list                             │  │
│   │  ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │  │
│   │  │  0  │   │  1  │   │  2  │   │  3  │                 │  │
│   │  │     │   │     │   │     │   │     │                 │  │
│   │  │  *──┼──►│  *──┼──►│  *──┼──►│  *  │                 │  │
│   │  │     │   │     │   │     │   │     │                 │  │
│   │  └──┬──┘   └──┬──┘   └──┬──┘   └──┬──┘                 │  │
│   │     │         │         │         │                     │  │
│   │     ▼         ▼         ▼         ▼                     │  │
│   │  GModel    GModel    GModel    GModel                   │  │
│   │    A         B         C       (新建)                   │  │
│   │                                   ▲                     │  │
│   │                                   │                     │  │
│   │                         _current = 3                    │  │
│   │                         (指向最新的模型)                │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│   访问方式:                                                     │
│   ─────────                                                    │
│   GModel::current()     → 返回 list[_current]，即当前模型      │
│   GModel::list.size()   → 返回 4，模型总数                     │
│   GModel::list[0]       → 返回 Model A                         │
│   GModel::list.back()   → 返回最新创建的模型                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 生命周期图解

```
┌─────────────────────────────────────────────────────────────────┐
│                     GModel 生命周期                              │
└─────────────────────────────────────────────────────────────────┘

  程序启动
      │
      ▼
┌───────────────┐
│ new GModel()  │ ─────► 空模型创建
└───────────────┘        ├─ _geo_internals ✅
      │                  ├─ _occ_internals = nullptr
      │                  └─ vertices/edges/faces/regions = 空
      ▼
┌───────────────┐
│ 加载 IGES     │ ─────► 按需创建 OCC 内核
│ MergeFile()   │        ├─ _occ_internals ✅ 创建!
└───────────────┘        └─ 几何数据填充
      │
      ▼
┌───────────────┐
│ synchronize() │ ─────► OCC 数据同步到 GModel
└───────────────┘        ├─ vertices 填充 GVertex
      │                  ├─ edges 填充 GEdge
      │                  ├─ faces 填充 GFace
      │                  └─ regions 填充 GRegion
      ▼
┌───────────────┐
│ 生成网格      │ ─────► 创建网格数据
│ mesh()        │        ├─ MVertex (网格顶点)
└───────────────┘        └─ MElement (网格元素)
      │
      ▼
┌───────────────┐
│ 保存/导出     │
└───────────────┘
      │
      ▼
┌───────────────┐
│ delete        │ ─────► 清理所有数据
│ ~GModel()     │        从 list 中移除
└───────────────┘
```

---

## 常见问题

### Q1: 为什么 `new GModel()` 不保存返回值？

```cpp
// 这样写:
new GModel();

// 而不是:
GModel* model = new GModel();
```

**答案**: 因为构造函数内部会执行 `list.push_back(this)`，自动注册到全局列表。之后用 `GModel::current()` 就能访问。

---

### Q2: `_occ_internals` 什么时候创建？

```cpp
// 构造时:
_occ_internals = nullptr;  // 还没有

// 加载 IGES/STEP 文件时:
if(!_occ_internals)
    _occ_internals = new OCC_Internals;  // 按需创建!
```

**答案**: 只有在需要 OpenCASCADE 功能时（如加载 IGES/STEP 文件）才创建，节省资源。

---

### Q3: 为什么要隐藏其他模型？

**答案**: Gmsh 支持同时加载多个模型，但 GUI 通常只显示一个。新创建的模型成为"当前模型"并显示，旧模型被隐藏（但数据还在）。

---

## 一图总结

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│                    🎯 GModel 构造函数做了什么？                  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                                                         │   │
│  │   1. 初始化变量 ───────► 准备空架子                     │   │
│  │                                                         │   │
│  │   2. 设置编号器 ───────► 准备发"身份证"                │   │
│  │                                                         │   │
│  │   3. 隐藏旧模型 ───────► 让新模型成为主角               │   │
│  │                                                         │   │
│  │   4. 注册到列表 ───────► 让程序能找到自己 ⭐            │   │
│  │                                                         │   │
│  │   5. 创建GEO内核 ──────► 安装基本绘图工具               │   │
│  │                                                         │   │
│  │   6. 创建尺寸场 ───────► 准备网格大小控制器             │   │
│  │                                                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│                         结果: 一个空的、可用的几何模型容器       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```
