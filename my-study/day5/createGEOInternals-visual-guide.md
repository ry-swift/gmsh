# createGEOInternals() 函数图解指南 (小白版)

## 源码位置

**文件**: `src/geo/GModelIO_GEO.cpp`
**行号**: 1691

```cpp
void GModel::createGEOInternals() { _geo_internals = new GEO_Internals; }
```

---

## 一句话总结

这行代码的作用是：**给 GModel 安装一个 "Gmsh 原生绘图工具箱"**。

---

## 类比理解

想象你买了一台新电脑 (GModel)，现在要安装一个绘图软件：

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   🖥️ 新电脑 (GModel)                                            │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                                                         │  │
│   │   安装前:                                               │  │
│   │   _geo_internals = nullptr  (没有绘图软件)             │  │
│   │                              ❌ 空的                    │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│                   createGEOInternals()                         │
│                      (安装软件)                                 │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                                                         │  │
│   │   安装后:                                               │  │
│   │   _geo_internals = new GEO_Internals                   │  │
│   │                     ✅ 绘图工具箱已就绪!               │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## GEO_Internals 是什么？

`GEO_Internals` 是 **Gmsh 原生几何内核**，就像一个**绘图工具箱**：

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│              🧰 GEO_Internals (绘图工具箱)                       │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                                                         │  │
│   │   📦 存储容器 (Tree_T 树形结构)                         │  │
│   │   ─────────────────────────────                        │  │
│   │                                                         │  │
│   │   🔵 Points ──────────► 存放所有的点                   │  │
│   │                                                         │  │
│   │   📏 Curves ──────────► 存放所有的曲线/边              │  │
│   │                                                         │  │
│   │   🔄 EdgeLoops ───────► 存放边的循环(围成面的边界)     │  │
│   │                                                         │  │
│   │   📄 Surfaces ────────► 存放所有的面                   │  │
│   │                                                         │  │
│   │   📦 SurfaceLoops ────► 存放面的循环(围成体的边界)     │  │
│   │                                                         │  │
│   │   🧊 Volumes ─────────► 存放所有的体                   │  │
│   │                                                         │  │
│   │   🏷️ PhysicalGroups ──► 存放物理组(给实体贴标签)       │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                                                         │  │
│   │   🗑️ 删除缓存 (记录被删除的实体)                        │  │
│   │   ────────────────────────────                         │  │
│   │                                                         │  │
│   │   DelPoints, DelCurves, DelSurfaces, DelVolumes        │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                                                         │  │
│   │   🔢 编号计数器 (给新实体分配ID)                        │  │
│   │   ─────────────────────────────                        │  │
│   │                                                         │  │
│   │   _maxPointNum = 0      下一个点的编号                  │  │
│   │   _maxLineNum = 0       下一条线的编号                  │  │
│   │   _maxSurfaceNum = 0    下一个面的编号                  │  │
│   │   _maxVolumeNum = 0     下一个体的编号                  │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 几何实体层次图解

GEO_Internals 管理的几何实体是**层级结构**的：

```
                    🧊 Volume (体)
                   ┌─────────────┐
                   │   3D 实体   │
                   │  例如:立方体 │
                   └──────┬──────┘
                          │ 由多个面围成
                          ▼
              ┌─────────────────────────┐
              │    📦 SurfaceLoop       │
              │   (面的循环/壳)         │
              └───────────┬─────────────┘
                          │ 包含多个面
                          ▼
                    📄 Surface (面)
                   ┌─────────────┐
                   │   2D 曲面   │
                   │  例如:矩形  │
                   └──────┬──────┘
                          │ 由多条边围成
                          ▼
              ┌─────────────────────────┐
              │      🔄 EdgeLoop        │
              │    (边的循环/线环)      │
              └───────────┬─────────────┘
                          │ 包含多条边
                          ▼
                    📏 Curve (边/曲线)
                   ┌─────────────┐
                   │   1D 曲线   │
                   │  例如:直线  │
                   └──────┬──────┘
                          │ 由点定义
                          ▼
                    🔵 Point (点)
                   ┌─────────────┐
                   │   0D 顶点   │
                   │  例如:(0,0) │
                   └─────────────┘
```

---

## 具体例子：画一个正方形

```
              GEO 脚本                              GEO_Internals 内部存储
     ─────────────────────                    ───────────────────────────

     // 定义4个点                              Points 树:
     Point(1) = {0,0,0};          ──────►    ┌───┬───────────┐
     Point(2) = {1,0,0};                     │ 1 │ (0,0,0)   │
     Point(3) = {1,1,0};                     │ 2 │ (1,0,0)   │
     Point(4) = {0,1,0};                     │ 3 │ (1,1,0)   │
                                             │ 4 │ (0,1,0)   │
                                             └───┴───────────┘

     // 定义4条边                              Curves 树:
     Line(1) = {1, 2};            ──────►    ┌───┬───────────┐
     Line(2) = {2, 3};                       │ 1 │ 点1→点2   │
     Line(3) = {3, 4};                       │ 2 │ 点2→点3   │
     Line(4) = {4, 1};                       │ 3 │ 点3→点4   │
                                             │ 4 │ 点4→点1   │
                                             └───┴───────────┘

     // 定义边循环                             EdgeLoops 树:
     Curve Loop(1) = {1,2,3,4};   ──────►    ┌───┬───────────────┐
                                             │ 1 │ {边1,2,3,4}  │
                                             └───┴───────────────┘

     // 定义平面                               Surfaces 树:
     Plane Surface(1) = {1};      ──────►    ┌───┬───────────────┐
                                             │ 1 │ 边循环1围成   │
                                             └───┴───────────────┘
```

**可视化结果**:

```
     点4 (0,1,0)          点3 (1,1,0)
          ●───────────────────●
          │                   │
     边4  │                   │ 边2
          │     面1 (正方形)   │
          │                   │
          ●───────────────────●
     点1 (0,0,0)    边1    点2 (1,0,0)
```

---

## GEO vs OCC 内核对比

Gmsh 支持两种主要的几何内核：

```
┌─────────────────────────────────────────────────────────────────┐
│                     几何内核对比                                 │
├─────────────────────────────┬───────────────────────────────────┤
│     GEO_Internals           │     OCC_Internals                 │
│     (Gmsh 原生内核)          │     (OpenCASCADE 内核)            │
├─────────────────────────────┼───────────────────────────────────┤
│                             │                                   │
│  🎨 简单画笔                │  🏗️ 专业 CAD 软件                 │
│                             │                                   │
│  ✅ 轻量级，启动快          │  ⚡ 功能强大，较重                 │
│                             │                                   │
│  ✅ 基本几何操作            │  ✅ 复杂布尔运算                   │
│     • 点、线、面、体        │     • 并、交、差                   │
│     • 拉伸、旋转            │     • 倒角、圆角                   │
│                             │                                   │
│  ❌ 不支持 IGES/STEP        │  ✅ 支持 IGES/STEP/BREP           │
│                             │                                   │
│  📝 用于 .geo 脚本          │  📝 用于 CAD 文件导入              │
│                             │                                   │
│  ✅ 总是创建                │  ⏳ 按需创建                       │
│                             │                                   │
├─────────────────────────────┴───────────────────────────────────┤
│                                                                 │
│  创建时机:                                                      │
│                                                                 │
│  GModel() 构造函数                                              │
│       │                                                         │
│       ├──► createGEOInternals()  ✅ 总是调用                   │
│       │                                                         │
│       └──► _occ_internals = nullptr  (等待按需创建)            │
│                   │                                             │
│                   ▼                                             │
│            加载 IGES/STEP 文件时才创建 OCC_Internals            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 调用链路图

```
./gmsh ../tutorials/hhh.igs
              │
              ▼
┌─────────────────────────────┐
│  main() [Main.cpp:42]       │
└─────────────┬───────────────┘
              │
              ▼
┌─────────────────────────────┐
│  GmshMainFLTK()             │
│  [GmshGlobal.cpp:512]       │
└─────────────┬───────────────┘
              │
              ▼
┌─────────────────────────────┐
│  new GModel()               │
│  [GmshGlobal.cpp:515]       │
└─────────────┬───────────────┘
              │
              ▼
┌─────────────────────────────┐
│  GModel::GModel()           │
│  [GModel.cpp:72]            │
│                             │
│  构造函数中调用:             │
│  createGEOInternals();      │
└─────────────┬───────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────┐
│  createGEOInternals()                                           │
│  [GModelIO_GEO.cpp:1691]    ← 当前位置 ⭐                       │
│                                                                 │
│  _geo_internals = new GEO_Internals;                           │
│                                                                 │
└─────────────┬───────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────┐
│  GEO_Internals::GEO_Internals()                                │
│  [GModelIO_GEO.h:42]                                           │
│                                                                 │
│  GEO_Internals() { _allocateAll(); }                           │
│                                                                 │
│  _allocateAll() 做了什么:                                       │
│  • 创建 Points 树                                               │
│  • 创建 Curves 树                                               │
│  • 创建 EdgeLoops 树                                            │
│  • 创建 Surfaces 树                                             │
│  • 创建 SurfaceLoops 树                                         │
│  • 创建 Volumes 树                                              │
│  • 创建 PhysicalGroups 树                                       │
│  • 初始化所有编号计数器为 0                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## GEO_Internals 的主要功能

```
┌─────────────────────────────────────────────────────────────────┐
│                  GEO_Internals 功能一览                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📝 添加几何实体                                                │
│  ────────────────                                              │
│  addVertex()    → 添加点                                       │
│  addLine()      → 添加直线                                     │
│  addCircleArc() → 添加圆弧                                     │
│  addSpline()    → 添加样条曲线                                 │
│  addCurveLoop() → 添加边循环                                   │
│  addSurface()   → 添加面                                       │
│  addVolume()    → 添加体                                       │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🔄 几何变换                                                    │
│  ────────────                                                  │
│  translate()  → 平移                                           │
│  rotate()     → 旋转                                           │
│  dilate()     → 缩放                                           │
│  symmetry()   → 对称                                           │
│  extrude()    → 拉伸                                           │
│  revolve()    → 旋转拉伸                                       │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📏 网格控制                                                    │
│  ──────────                                                    │
│  setMeshSize()          → 设置网格尺寸                         │
│  setTransfiniteLine()   → 设置结构化网格边                     │
│  setTransfiniteSurface()→ 设置结构化网格面                     │
│  setRecombine()         → 设置四边形重组                       │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🔗 同步到 GModel                                               │
│  ────────────────                                              │
│  synchronize(GModel* model)                                    │
│  → 将 GEO_Internals 中的数据转换为 GModel 的几何实体           │
│  → 创建 GVertex, GEdge, GFace, GRegion 对象                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 数据流图

```
                        用户操作
                           │
         ┌─────────────────┼─────────────────┐
         │                 │                 │
         ▼                 ▼                 ▼
    ┌─────────┐      ┌─────────┐      ┌─────────┐
    │ .geo    │      │ GUI     │      │ API     │
    │ 脚本    │      │ 交互    │      │ 调用    │
    └────┬────┘      └────┬────┘      └────┬────┘
         │                │                 │
         └────────────────┼─────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │         GEO_Internals              │
         │  ┌─────────────────────────────┐   │
         │  │  Points   Curves   Surfaces │   │
         │  │  🔵🔵🔵    📏📏📏    📄📄📄   │   │
         │  └─────────────────────────────┘   │
         └────────────────┬───────────────────┘
                          │
                          │ synchronize()
                          ▼
         ┌────────────────────────────────────┐
         │            GModel                  │
         │  ┌─────────────────────────────┐   │
         │  │ vertices  edges  faces      │   │
         │  │ GVertex  GEdge   GFace      │   │
         │  └─────────────────────────────┘   │
         └────────────────┬───────────────────┘
                          │
                          ▼
         ┌────────────────────────────────────┐
         │          网格生成器                 │
         │  ┌─────────────────────────────┐   │
         │  │ MVertex  MElement           │   │
         │  │ 网格点   网格单元            │   │
         │  └─────────────────────────────┘   │
         └────────────────────────────────────┘
```

---

## 一图总结

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│           createGEOInternals() 做了什么？                        │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                                                         │  │
│   │   _geo_internals = new GEO_Internals;                  │  │
│   │                                                         │  │
│   │   翻译成人话:                                           │  │
│   │   ─────────────                                        │  │
│   │   给 GModel 安装一个 "Gmsh 原生绘图工具箱"              │  │
│   │                                                         │  │
│   │   这个工具箱包含:                                       │  │
│   │   • 存放点的容器 (Points)                              │  │
│   │   • 存放线的容器 (Curves)                              │  │
│   │   • 存放面的容器 (Surfaces)                            │  │
│   │   • 存放体的容器 (Volumes)                             │  │
│   │   • 各种几何操作功能                                   │  │
│   │                                                         │  │
│   │   为什么需要?                                           │  │
│   │   ───────────                                          │  │
│   │   • 处理 .geo 脚本文件                                 │  │
│   │   • 提供基本几何操作                                   │  │
│   │   • 即使加载 IGES 文件也需要 (作为基础)                │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 常见问题

### Q1: 为什么总是要创建 GEO_Internals？

**答案**: GEO 是 Gmsh 的**原生格式**，即使你加载的是 IGES 文件，某些基本操作仍然需要 GEO 内核支持。它是 Gmsh 的"标配工具"。

### Q2: GEO_Internals 和 OCC_Internals 有什么区别？

| 特性 | GEO_Internals | OCC_Internals |
|------|---------------|---------------|
| 来源 | Gmsh 原生 | OpenCASCADE |
| 创建时机 | 总是创建 | 按需创建 |
| 功能 | 基本几何 | 复杂 CAD |
| 文件支持 | .geo | IGES/STEP/BREP |
| 布尔运算 | 简单 | 强大 |

### Q3: Tree_T 是什么数据结构？

**答案**: `Tree_T` 是 Gmsh 内部使用的一种**平衡二叉搜索树**，用于高效存储和查找几何实体。每个实体都有一个唯一的 tag（编号），树按 tag 排序。
