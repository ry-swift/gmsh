# NCollection_BaseMap 类图解详析

## 概述

`NCollection_BaseMap` 是 OpenCASCADE (OCCT) 中**所有 Map 容器的基类**，位于 `NCollection_BaseMap.hxx`。

它为以下派生类提供基础设施：
- `NCollection_Map` - 集合（只存Key）
- `NCollection_DataMap` - 键值对映射
- `NCollection_DoubleMap` - 双向映射
- `NCollection_IndexedMap` - 索引Map
- `NCollection_IndexedDataMap` - 索引数据Map

**本质上，这是一个哈希表（Hash Table）的基类实现。**

---

## 哈希表基础回顾

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        什么是哈希表？                                        │
│                                                                             │
│   哈希表是一种通过"桶"(Bucket)来组织数据的数据结构                             │
│                                                                             │
│   工作原理:                                                                  │
│   ┌──────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   Key "apple" ──┐                                                    │  │
│   │                 │ hash("apple") = 12345                              │  │
│   │                 ▼                                                    │  │
│   │   ┌────────────────────────┐                                         │  │
│   │   │  12345 % NbBuckets = 3 │ ← 取模运算决定放入哪个桶                  │  │
│   │   └───────────┬────────────┘                                         │  │
│   │               │                                                      │  │
│   │               ▼                                                      │  │
│   │   Bucket[0] → NULL                                                   │  │
│   │   Bucket[1] → NULL                                                   │  │
│   │   Bucket[2] → NULL                                                   │  │
│   │   Bucket[3] → ["apple" | value] → NULL    ← 存入第3个桶              │  │
│   │   Bucket[4] → NULL                                                   │  │
│   │   ...                                                                │  │
│   └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   优点: 查找时间复杂度接近 O(1)                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## NCollection_BaseMap 类结构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        NCollection_BaseMap                                   │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                           成员变量                                     │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │  protected:                                                      │ │  │
│  │  │                                                                  │ │  │
│  │  │  Handle(NCollection_BaseAllocator) myAllocator;  // 内存分配器   │ │  │
│  │  │  NCollection_ListNode** myData1;   // 第一组桶数组 (主数据)       │ │  │
│  │  │  NCollection_ListNode** myData2;   // 第二组桶数组 (双向Map用)    │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │  private:                                                        │ │  │
│  │  │                                                                  │ │  │
│  │  │  Standard_Integer myNbBuckets;  // 桶的数量                       │ │  │
│  │  │  Standard_Integer mySize;       // 已存储元素的数量               │ │  │
│  │  │  Standard_Boolean isDouble;     // 是否是双向Map                  │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         公共方法                                       │  │
│  │                                                                       │  │
│  │  NbBuckets()  → 返回桶的数量                                          │  │
│  │  Extent()     → 返回已存储元素数量 (即 mySize)                        │  │
│  │  IsEmpty()    → 是否为空 (mySize == 0)                               │  │
│  │  Statistics() → 输出统计信息                                          │  │
│  │  Allocator()  → 返回内存分配器                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                        保护方法                                        │  │
│  │                                                                       │  │
│  │  BeginResize()      → 准备扩容                                        │  │
│  │  EndResize()        → 完成扩容                                        │  │
│  │  Resizable()        → 是否需要扩容                                    │  │
│  │  Increment()        → mySize++                                       │  │
│  │  Decrement()        → mySize--                                       │  │
│  │  Destroy()          → 销毁所有节点                                    │  │
│  │  NextPrimeForMap()  → 获取下一个质数 (用于桶数量)                     │  │
│  │  exchangeMapsData() → 交换两个Map的数据                               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 核心数据结构图解

### myData1 和 myData2 的内存布局

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    桶数组 (Bucket Array) 结构                                │
│                                                                             │
│   myData1 (主桶数组):                                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   myData1 ──► ┌───────┬───────┬───────┬───────┬───────┬─────┐      │   │
│   │               │  [0]  │  [1]  │  [2]  │  [3]  │  [4]  │ ... │      │   │
│   │               └───┬───┴───┬───┴───┬───┴───┬───┴───┬───┴─────┘      │   │
│   │                   │       │       │       │       │                 │   │
│   │                   ▼       ▼       ▼       ▼       ▼                 │   │
│   │                  NULL   Node    NULL   Node    NULL                 │   │
│   │                          │               │                          │   │
│   │                          ▼               ▼                          │   │
│   │                        Node            Node                         │   │
│   │                          │               │                          │   │
│   │                          ▼               ▼                          │   │
│   │                        NULL            NULL                         │   │
│   │                                                                     │   │
│   │   每个桶是一个链表的头指针                                            │   │
│   │   链表用于解决哈希冲突 (多个Key映射到同一个桶)                         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   myData2 (第二桶数组, 仅用于 DoubleMap):                                    │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │   用于反向查找 (Value → Key 的映射)                                  │   │
│   │   普通Map时 myData2 = nullptr                                        │   │
│   │   isDouble = true 时才使用 myData2                                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 链表节点结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    NCollection_ListNode 节点结构                             │
│                                                                             │
│   每个节点的基本结构:                                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   ┌──────────────────────────────────────┐                          │   │
│   │   │         NCollection_ListNode         │                          │   │
│   │   │  ┌────────────────────────────────┐  │                          │   │
│   │   │  │  Next() → 指向下一个节点        │  │                          │   │
│   │   │  └────────────────────────────────┘  │                          │   │
│   │   └──────────────────────────────────────┘                          │   │
│   │                     ▲                                                │   │
│   │                     │ 继承                                           │   │
│   │   ┌──────────────────────────────────────┐                          │   │
│   │   │      派生类 (如 MapNode)              │                          │   │
│   │   │  ┌────────────────────────────────┐  │                          │   │
│   │   │  │  Key   - 键                     │  │                          │   │
│   │   │  │  Value - 值 (DataMap才有)       │  │                          │   │
│   │   │  │  Hash  - 哈希值缓存             │  │                          │   │
│   │   │  └────────────────────────────────┘  │                          │   │
│   │   └──────────────────────────────────────┘                          │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   链式结构示意:                                                              │
│                                                                             │
│   Bucket[i] ──► [Node1|Key1] ──► [Node2|Key2] ──► [Node3|Key3] ──► NULL    │
│                      │                                                      │
│                      └── 这些Key的 hash % NbBuckets 都等于 i                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Iterator 迭代器图解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Iterator 迭代器工作原理                              │
│                                                                             │
│   迭代器成员:                                                                │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  myNbBuckets  - 桶总数                                              │   │
│   │  myBuckets    - 指向桶数组 (myData1)                                 │   │
│   │  myBucket     - 当前桶索引                                           │   │
│   │  myNode       - 当前节点指针                                         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   遍历过程:                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   Buckets:  [0]    [1]    [2]    [3]    [4]                        │   │
│   │              │      │      │      │      │                          │   │
│   │              ▼      ▼      ▼      ▼      ▼                          │   │
│   │            NULL    A─►B  NULL   C─►D─►E  NULL                       │   │
│   │                                                                     │   │
│   │   遍历顺序: A → B → C → D → E                                       │   │
│   │                                                                     │   │
│   │   步骤1: myBucket=0, 为空, 跳过                                     │   │
│   │   步骤2: myBucket=1, myNode=A, 返回A                                │   │
│   │   步骤3: myNode=A.Next()=B, 返回B                                   │   │
│   │   步骤4: myNode=B.Next()=NULL, myBucket++                           │   │
│   │   步骤5: myBucket=2, 为空, 跳过                                     │   │
│   │   步骤6: myBucket=3, myNode=C, 返回C                                │   │
│   │   步骤7: myNode=C.Next()=D, 返回D                                   │   │
│   │   步骤8: myNode=D.Next()=E, 返回E                                   │   │
│   │   步骤9: myNode=E.Next()=NULL, myBucket++                           │   │
│   │   步骤10: myBucket=4, 为空, myBucket > myNbBuckets, 结束            │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   关键方法:                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  PMore() → myNode != nullptr  // 是否还有更多元素                   │   │
│   │  PNext() → 移动到下一个节点:                                         │   │
│   │            1. 如果当前节点有Next, 移到Next                           │   │
│   │            2. 否则, 移到下一个非空桶的第一个节点                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 动态扩容机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           动态扩容 (Resize)                                  │
│                                                                             │
│   何时扩容?                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Resizable() → IsEmpty() || (mySize > myNbBuckets)                  │   │
│   │                                                                     │   │
│   │  即: 当元素数量 > 桶数量时, 需要扩容                                  │   │
│   │  这确保平均每个桶只有约1个元素, 保持 O(1) 查找效率                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   扩容过程:                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   扩容前 (NbBuckets = 5):                                           │   │
│   │   ┌───┬───┬───┬───┬───┐                                            │   │
│   │   │ A │B,C│ D │E,F│ G │  ← 7个元素, 5个桶, 需要扩容                 │   │
│   │   └───┴───┴───┴───┴───┘                                            │   │
│   │                                                                     │   │
│   │   步骤1: BeginResize()                                              │   │
│   │          - 计算新桶数 = NextPrimeForMap(当前桶数)                    │   │
│   │          - 分配新的桶数组                                            │   │
│   │                                                                     │   │
│   │   步骤2: 重新哈希所有元素                                            │   │
│   │          - 每个元素: newBucket = hash % newNbBuckets                │   │
│   │                                                                     │   │
│   │   步骤3: EndResize()                                                │   │
│   │          - 释放旧桶数组                                              │   │
│   │          - 更新 myData1, myNbBuckets                                │   │
│   │                                                                     │   │
│   │   扩容后 (NbBuckets = 11, 质数):                                     │   │
│   │   ┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐                    │   │
│   │   │ A │   │ B │ C │   │ D │   │ E │   │ F │ G │                    │   │
│   │   └───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘                    │   │
│   │   元素分布更均匀, 冲突减少                                           │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   为什么使用质数作为桶数量?                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  质数能让哈希值更均匀地分布到各个桶                                   │   │
│   │  减少哈希冲突的概率                                                  │   │
│   │  NextPrimeForMap() 返回大于N的下一个质数                             │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 单Map vs 双Map

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      single vs isDouble 模式                                │
│                                                                             │
│   构造函数参数: single                                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  single = true  → isDouble = false → 普通Map, 只用 myData1          │   │
│   │  single = false → isDouble = true  → 双向Map, 同时用 myData1/myData2│   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   普通Map (Map, DataMap, IndexedMap):                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   myData1: Key → Value 映射                                         │   │
│   │   myData2: nullptr (不使用)                                         │   │
│   │                                                                     │   │
│   │   支持: 通过 Key 查找 Value                                         │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   双向Map (DoubleMap):                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   myData1: Key1 → Key2 映射                                         │   │
│   │   myData2: Key2 → Key1 映射 (反向索引)                               │   │
│   │                                                                     │   │
│   │   支持: Key1 → Key2 和 Key2 → Key1 双向查找                         │   │
│   │                                                                     │   │
│   │   例如: Shape ↔ Tag 的双向映射                                       │   │
│   │         myData1: Shape → Tag                                        │   │
│   │         myData2: Tag → Shape                                        │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 派生类层次结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     NCollection Map 家族继承关系                             │
│                                                                             │
│                        NCollection_BaseMap                                  │
│                              (基类)                                          │
│                               │                                             │
│        ┌──────────┬──────────┼──────────┬──────────────┐                   │
│        │          │          │          │              │                   │
│        ▼          ▼          ▼          ▼              ▼                   │
│  ┌──────────┐┌──────────┐┌──────────┐┌──────────┐┌──────────────┐          │
│  │   Map    ││ DataMap  ││DoubleMap ││IndexedMap││IndexedDataMap│          │
│  │          ││          ││          ││          ││              │          │
│  │ 集合     ││ 键值对   ││ 双向映射 ││ 索引集合 ││ 索引键值对   │          │
│  │ Key only ││ Key→Val  ││ K1↔K2    ││ Key↔Int  ││ Key↔(Int,Val)│          │
│  └──────────┘└──────────┘└──────────┘└──────────┘└──────────────┘          │
│                                                                             │
│   在 Gmsh 中的应用:                                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  TopTools_IndexedMapOfShape  - 形状的索引Map                        │   │
│   │  TopTools_DataMapOfShapeInteger - Shape → Tag 映射                  │   │
│   │  TopTools_DataMapOfIntegerShape - Tag → Shape 映射                  │   │
│   │                                                                     │   │
│   │  这些都继承自 NCollection_BaseMap                                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 在 Gmsh OCC_Internals 中的应用

```
┌─────────────────────────────────────────────────────────────────────────────┐
│              NCollection_BaseMap 在 Gmsh 中的应用                           │
│                                                                             │
│   OCC_Internals 类使用了多种基于 NCollection_BaseMap 的容器:                 │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  // 形状索引Map (IndexedMap)                                        │   │
│   │  TopTools_IndexedMapOfShape _vmap;   // Vertex 索引                 │   │
│   │  TopTools_IndexedMapOfShape _emap;   // Edge 索引                   │   │
│   │  TopTools_IndexedMapOfShape _fmap;   // Face 索引                   │   │
│   │  TopTools_IndexedMapOfShape _somap;  // Solid 索引                  │   │
│   │                                                                     │   │
│   │  // Shape → Tag 映射 (DataMap)                                      │   │
│   │  TopTools_DataMapOfShapeInteger _vertexTag;                         │   │
│   │  TopTools_DataMapOfShapeInteger _edgeTag;                           │   │
│   │  TopTools_DataMapOfShapeInteger _faceTag;                           │   │
│   │  TopTools_DataMapOfShapeInteger _solidTag;                          │   │
│   │                                                                     │   │
│   │  // Tag → Shape 映射 (DataMap)                                      │   │
│   │  TopTools_DataMapOfIntegerShape _tagVertex;                         │   │
│   │  TopTools_DataMapOfIntegerShape _tagEdge;                           │   │
│   │  TopTools_DataMapOfIntegerShape _tagFace;                           │   │
│   │  TopTools_DataMapOfIntegerShape _tagSolid;                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   典型使用场景:                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   导入STEP文件:                                                     │   │
│   │   TopoDS_Shape face = ...;  // 从STEP读取的面                       │   │
│   │   int tag = 1;                                                      │   │
│   │                                                                     │   │
│   │   _faceTag.Bind(face, tag);   // 记录 Face → Tag                    │   │
│   │   _tagFace.Bind(tag, face);   // 记录 Tag → Face                    │   │
│   │                                                                     │   │
│   │   // 之后可以双向查询:                                               │   │
│   │   int t = _faceTag.Find(face);     // 通过Face找Tag                 │   │
│   │   TopoDS_Shape f = _tagFace.Find(1); // 通过Tag找Face               │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 性能特性

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           性能复杂度分析                                     │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  操作              平均时间复杂度     最坏时间复杂度                  │   │
│   │  ─────────────────────────────────────────────────────────────────  │   │
│   │  查找 (Find)           O(1)              O(n)                       │   │
│   │  插入 (Bind)           O(1)              O(n)                       │   │
│   │  删除 (UnBind)         O(1)              O(n)                       │   │
│   │  遍历 (Iterator)       O(n)              O(n)                       │   │
│   │  扩容 (Resize)         O(n)              O(n)                       │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   最坏情况发生在:                                                            │
│   - 所有元素都哈希到同一个桶 (哈希函数质量差)                                 │
│   - 此时退化为链表, 查找变成 O(n)                                           │
│                                                                             │
│   优化措施:                                                                  │
│   - 使用质数作为桶数量                                                       │
│   - 当 mySize > myNbBuckets 时自动扩容                                      │
│   - 保持负载因子 ≈ 1                                                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 总结

`NCollection_BaseMap` 是 OpenCASCADE 中哈希表实现的基类：

| 特性 | 说明 |
|------|------|
| **数据结构** | 链地址法哈希表 (Separate Chaining) |
| **桶数组** | myData1 (主), myData2 (双向Map用) |
| **扩容策略** | 当 mySize > myNbBuckets 时扩容到下一个质数 |
| **迭代器** | 顺序遍历所有桶中的链表节点 |
| **派生类** | Map, DataMap, DoubleMap, IndexedMap, IndexedDataMap |
| **Gmsh应用** | TopTools_*Map 系列，管理 Shape ↔ Tag 映射 |

这个类是 OpenCASCADE 几何内核中高效数据管理的基石，在 Gmsh 的 OCC_Internals 中被大量使用来管理几何形状与标签之间的映射关系。
