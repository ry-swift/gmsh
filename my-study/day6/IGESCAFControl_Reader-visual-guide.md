# IGESCAFControl_Reader 类图解详析

## 概述

`IGESCAFControl_Reader` 是 OpenCASCADE 中用于**读取 IGES 文件并支持扩展属性（颜色、图层、名称）**的读取器类。

- **位置**: `IGESCAFControl_Reader.hxx`
- **CAF**: 全称 "XCAF" (eXtended CAD Application Framework)
- **核心功能**: 读取 IGES 文件 + 提取颜色/图层/名称等元数据

---

## 类继承层次

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         类继承关系图                                         │
│                                                                             │
│                    ┌─────────────────────────┐                              │
│                    │    XSControl_Reader     │  ← 最基础的数据交换读取器     │
│                    │  (通用交换格式读取器)    │                              │
│                    └───────────┬─────────────┘                              │
│                                │                                            │
│                                │ 继承                                        │
│                                ▼                                            │
│                    ┌─────────────────────────┐                              │
│                    │   IGESControl_Reader    │  ← IGES 格式专用读取器        │
│                    │   (IGES 基础读取器)     │     只读取几何形状            │
│                    └───────────┬─────────────┘                              │
│                                │                                            │
│                                │ 继承                                        │
│                                ▼                                            │
│                    ┌─────────────────────────┐                              │
│                    │  IGESCAFControl_Reader  │  ← IGES + XCAF 读取器        │
│                    │  (IGES + 属性读取器)    │     读取几何 + 颜色/名称/图层 │
│                    └─────────────────────────┘                              │
│                                                                             │
│   类比:                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  XSControl_Reader    = 通用快递员 (只送包裹)                         │   │
│   │  IGESControl_Reader  = IGES专用快递员 (只送IGES包裹)                 │   │
│   │  IGESCAFControl_Reader = 高级IGES快递员 (送包裹+保留标签+颜色标记)   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 普通 Reader vs CAF Reader 对比

```
┌─────────────────────────────────────────────────────────────────────────────┐
│               IGESControl_Reader vs IGESCAFControl_Reader                   │
│                                                                             │
│   ┌─────────────────────────────────┐  ┌─────────────────────────────────┐  │
│   │      IGESControl_Reader         │  │    IGESCAFControl_Reader        │  │
│   │         (普通版本)               │  │        (CAF增强版本)            │  │
│   ├─────────────────────────────────┤  ├─────────────────────────────────┤  │
│   │                                 │  │                                 │  │
│   │  读取内容:                       │  │  读取内容:                       │  │
│   │  ┌─────────────────────────┐   │  │  ┌─────────────────────────┐   │  │
│   │  │  ✓ 几何形状 (Shape)     │   │  │  │  ✓ 几何形状 (Shape)     │   │  │
│   │  │  ✗ 颜色 (Color)        │   │  │  │  ✓ 颜色 (Color)         │   │  │
│   │  │  ✗ 图层 (Layer)        │   │  │  │  ✓ 图层 (Layer)         │   │  │
│   │  │  ✗ 名称 (Name)         │   │  │  │  ✓ 名称 (Name)          │   │  │
│   │  └─────────────────────────┘   │  │  └─────────────────────────┘   │  │
│   │                                 │  │                                 │  │
│   │  输出:                          │  │  输出:                          │  │
│   │  TopoDS_Shape                   │  │  TopoDS_Shape + Attributes     │  │
│   │                                 │  │  (通过 TDocStd_Document)        │  │
│   │                                 │  │                                 │  │
│   └─────────────────────────────────┘  └─────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  IGES 文件内容示例:                                                  │   │
│   │                                                                     │   │
│   │  ┌───────────────────────────────────────────────────────────────┐  │   │
│   │  │  实体1: 圆柱体                                                 │  │   │
│   │  │    - 几何数据: 中心点, 半径, 高度                              │  │   │
│   │  │    - 颜色: 红色 (R=255, G=0, B=0)                             │  │   │
│   │  │    - 名称: "Cylinder_001"                                     │  │   │
│   │  │    - 图层: "Layer_Mechanical"                                 │  │   │
│   │  └───────────────────────────────────────────────────────────────┘  │   │
│   │                                                                     │   │
│   │  IGESControl_Reader:      只读取几何 → 丢失颜色/名称/图层          │   │
│   │  IGESCAFControl_Reader:   读取全部 → 保留所有信息                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 类成员详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    IGESCAFControl_Reader 类结构                              │
│                                                                             │
│  class IGESCAFControl_Reader : public IGESControl_Reader {                  │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  私有成员 (控制开关)                                                   │  │
│  │                                                                       │  │
│  │  private:                                                             │  │
│  │    Standard_Boolean myColorMode;  // 是否读取颜色 (默认: true)        │  │
│  │    Standard_Boolean myNameMode;   // 是否读取名称 (默认: true)        │  │
│  │    Standard_Boolean myLayerMode;  // 是否读取图层 (默认: true)        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  公共方法                                                              │  │
│  │                                                                       │  │
│  │  构造函数:                                                            │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │  IGESCAFControl_Reader();  // 默认构造,所有模式都为 true        │ │  │
│  │  │  IGESCAFControl_Reader(WorkSession, FromScratch);               │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                       │  │
│  │  核心方法:                                                            │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │  ReadFile(filename)  // 继承自基类,读取IGES文件                 │ │  │
│  │  │  Transfer(Document)  // 转换到 XCAF 文档 (带属性)               │ │  │
│  │  │  Perform(filename, Document)  // ReadFile + Transfer 一步完成   │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                       │  │
│  │  模式控制:                                                            │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │  SetColorMode(bool) / GetColorMode()  // 颜色开关                │ │  │
│  │  │  SetNameMode(bool)  / GetNameMode()   // 名称开关                │ │  │
│  │  │  SetLayerMode(bool) / GetLayerMode()  // 图层开关                │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  };                                                                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 使用流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    IGESCAFControl_Reader 使用流程                            │
│                                                                             │
│   方式1: 分步执行                                                            │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   IGESCAFControl_Reader reader;                                     │   │
│   │           │                                                         │   │
│   │           ▼                                                         │   │
│   │   reader.SetColorMode(true);   // 可选: 配置读取模式                │   │
│   │   reader.SetNameMode(true);                                         │   │
│   │   reader.SetLayerMode(true);                                        │   │
│   │           │                                                         │   │
│   │           ▼                                                         │   │
│   │   reader.ReadFile("model.iges");  // 步骤1: 读取文件                │   │
│   │           │                                                         │   │
│   │           ▼                                                         │   │
│   │   reader.NbRootsForTransfer();    // 步骤2: 获取根实体数量          │   │
│   │           │                                                         │   │
│   │           ▼                                                         │   │
│   │   reader.TransferRoots();         // 步骤3: 转换所有根实体          │   │
│   │           │                                                         │   │
│   │           ▼                                                         │   │
│   │   TopoDS_Shape shape = reader.OneShape();  // 步骤4: 获取结果       │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   方式2: 一步执行 (使用 XCAF Document)                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   IGESCAFControl_Reader reader;                                     │   │
│   │   Handle(TDocStd_Document) doc = new TDocStd_Document("XmlXCAF");   │   │
│   │           │                                                         │   │
│   │           ▼                                                         │   │
│   │   reader.Perform("model.iges", doc);  // 一步完成读取+转换          │   │
│   │           │                                                         │   │
│   │           ▼                                                         │   │
│   │   // doc 中包含了形状 + 颜色 + 名称 + 图层                          │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 在 Gmsh 中的使用

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Gmsh 中的 IGESCAFControl_Reader 使用                      │
│                                                                             │
│   位置: src/geo/GModelIO_OCC.cpp : importShapes()                           │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  // 代码片段 (GModelIO_OCC.cpp:4837-4854)                           │   │
│   │                                                                     │   │
│   │  #if defined(HAVE_OCC_CAF)                                          │   │
│   │      IGESCAFControl_Reader reader;  // 使用 CAF 版本                │   │
│   │      if(reader.ReadFile(fileName.c_str()) != IFSelect_RetDone) {    │   │
│   │          Msg::Error("Could not read file '%s'", fileName.c_str());  │   │
│   │          return false;                                              │   │
│   │      }                                                              │   │
│   │      if(CTX::instance()->geom.occImportLabels)                      │   │
│   │          readAttributes(_attributes, reader, "IGES-XCAF");          │   │
│   │          // ↑ 如果启用了标签导入,读取颜色/名称等属性                 │   │
│   │  #else                                                              │   │
│   │      IGESControl_Reader reader;  // 使用普通版本 (无属性)           │   │
│   │      ...                                                            │   │
│   │  #endif                                                             │   │
│   │                                                                     │   │
│   │  reader.NbRootsForTransfer();                                       │   │
│   │  reader.TransferRoots();                                            │   │
│   │  result = reader.OneShape();                                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   条件编译:                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  HAVE_OCC_CAF 宏:                                                   │   │
│   │  - 如果 OpenCASCADE 编译时启用了 XCAF 模块                          │   │
│   │  - Gmsh 就会使用 IGESCAFControl_Reader 来读取属性                   │   │
│   │  - 否则使用 IGESControl_Reader (只读几何)                           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## IGES 文件结构简介

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         IGES 文件格式结构                                    │
│                                                                             │
│   IGES (Initial Graphics Exchange Specification) 是一种 CAD 数据交换格式    │
│                                                                             │
│   文件结构:                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  Start Section (S)  - 人类可读的注释                        │   │   │
│   │   │  "This is a test IGES file..."                              │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                              │                                      │   │
│   │                              ▼                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  Global Section (G)  - 全局参数                             │   │   │
│   │   │  单位、精度、作者、日期等                                    │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                              │                                      │   │
│   │                              ▼                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  Directory Entry (D)  - 实体目录                            │   │   │
│   │   │  每个实体的元数据 (类型、颜色、图层、名称等)                  │   │   │
│   │   │  ┌─────────────────────────────────────────────────────┐    │   │   │
│   │   │  │  Entity 1: Type=110 (Line), Color=1, Layer=0       │    │   │   │
│   │   │  │  Entity 2: Type=100 (Arc), Color=2, Layer=1        │    │   │   │
│   │   │  │  Entity 3: Type=314 (Color), R=255, G=0, B=0       │    │   │   │
│   │   │  └─────────────────────────────────────────────────────┘    │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                              │                                      │   │
│   │                              ▼                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  Parameter Data (P)  - 实体几何数据                         │   │   │
│   │   │  每个实体的具体参数值                                        │   │   │
│   │   │  ┌─────────────────────────────────────────────────────┐    │   │   │
│   │   │  │  Entity 1: 0.0,0.0,0.0, 10.0,10.0,10.0  (线的端点)  │    │   │   │
│   │   │  │  Entity 2: 5.0,5.0,0.0, 3.0, 0.0,90.0   (圆弧参数)  │    │   │   │
│   │   │  └─────────────────────────────────────────────────────┘    │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                              │                                      │   │
│   │                              ▼                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  Terminate Section (T)  - 文件结束标记                      │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   IGESCAFControl_Reader 读取的属性来自 Directory Entry (D) 段               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三种模式详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    三种属性读取模式                                          │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  1. ColorMode (颜色模式)                                            │   │
│   │                                                                     │   │
│   │  IGES 实体类型 314 (Color Definition Entity):                       │   │
│   │  ┌───────────────────────────────────────────────────────────────┐  │   │
│   │  │  参数: R, G, B (0.0 - 100.0 的百分比)                         │  │   │
│   │  │  例如: 100.0, 0.0, 0.0 = 红色                                 │  │   │
│   │  └───────────────────────────────────────────────────────────────┘  │   │
│   │                                                                     │   │
│   │  reader.SetColorMode(true);  → 读取颜色                            │   │
│   │  reader.SetColorMode(false); → 忽略颜色                            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  2. LayerMode (图层模式)                                            │   │
│   │                                                                     │   │
│   │  IGES 图层信息存储在 Directory Entry 的 Level 字段:                 │   │
│   │  ┌───────────────────────────────────────────────────────────────┐  │   │
│   │  │  Level = 0: 默认图层                                          │  │   │
│   │  │  Level = 1: 图层1                                             │  │   │
│   │  │  Level = N: 图层N                                             │  │   │
│   │  └───────────────────────────────────────────────────────────────┘  │   │
│   │                                                                     │   │
│   │  reader.SetLayerMode(true);  → 读取图层                            │   │
│   │  reader.SetLayerMode(false); → 忽略图层                            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  3. NameMode (名称模式)                                             │   │
│   │                                                                     │   │
│   │  IGES 实体类型 406 (Property Entity) 子类型 15 (Name):              │   │
│   │  ┌───────────────────────────────────────────────────────────────┐  │   │
│   │  │  存储实体的名称字符串                                          │  │   │
│   │  │  例如: "Cylinder_Main_Body"                                   │  │   │
│   │  └───────────────────────────────────────────────────────────────┘  │   │
│   │                                                                     │   │
│   │  reader.SetNameMode(true);  → 读取名称                             │   │
│   │  reader.SetNameMode(false); → 忽略名称                             │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 与 STEPCAFControl_Reader 的对比

```
┌─────────────────────────────────────────────────────────────────────────────┐
│               IGESCAFControl_Reader vs STEPCAFControl_Reader                │
│                                                                             │
│   两者都是 XCAF 增强版读取器,但针对不同格式:                                  │
│                                                                             │
│   ┌─────────────────────────────┐  ┌─────────────────────────────┐         │
│   │  IGESCAFControl_Reader      │  │  STEPCAFControl_Reader      │         │
│   ├─────────────────────────────┤  ├─────────────────────────────┤         │
│   │  文件格式: IGES (.igs/.iges)│  │  文件格式: STEP (.stp/.step)│         │
│   │  标准年份: 1980年代          │  │  标准年份: 1990年代          │         │
│   │  装配体: 有限支持            │  │  装配体: 完整支持            │         │
│   │  颜色: 基本支持              │  │  颜色: 完整支持              │         │
│   │  材料: 不支持                │  │  材料: 支持                  │         │
│   │  PMI: 不支持                 │  │  PMI: 部分支持               │         │
│   └─────────────────────────────┘  └─────────────────────────────┘         │
│                                                                             │
│   在 Gmsh 中的使用:                                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  importShapes() 根据文件扩展名自动选择:                              │   │
│   │                                                                     │   │
│   │  .iges/.igs → IGESCAFControl_Reader                                 │   │
│   │  .step/.stp → STEPCAFControl_Reader                                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 完整调用链路

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Gmsh 读取 IGES 文件的完整链路                             │
│                                                                             │
│   用户命令: gmsh model.iges                                                 │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   main()                                                            │   │
│   │     │                                                               │   │
│   │     ▼                                                               │   │
│   │   OpenProject("model.iges")                                         │   │
│   │     │                                                               │   │
│   │     ▼                                                               │   │
│   │   MergeFile("model.iges")                                           │   │
│   │     │                                                               │   │
│   │     ▼                                                               │   │
│   │   GModel::readOCCIGES("model.iges")                                 │   │
│   │     │                                                               │   │
│   │     ▼                                                               │   │
│   │   OCC_Internals::importShapes("model.iges", ...)                    │   │
│   │     │                                                               │   │
│   │     ├─► setTargetUnit(...)  // 设置单位                             │   │
│   │     │                                                               │   │
│   │     ├─► ┌─────────────────────────────────────────────────────────┐│   │
│   │     │   │  IGESCAFControl_Reader reader;  // 创建CAF读取器        ││   │
│   │     │   │  reader.ReadFile("model.iges"); // 读取文件              ││   │
│   │     │   │  readAttributes(_attributes, reader, "IGES-XCAF");      ││   │
│   │     │   │  reader.NbRootsForTransfer();   // 获取根实体数          ││   │
│   │     │   │  reader.TransferRoots();        // 转换实体              ││   │
│   │     │   │  result = reader.OneShape();    // 获取形状              ││   │
│   │     │   └─────────────────────────────────────────────────────────┘│   │
│   │     │                                                               │   │
│   │     ├─► _healShape(result, ...)  // 修复几何                        │   │
│   │     │                                                               │   │
│   │     └─► _multiBind(result, ...)  // 绑定到标签                      │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 总结

| 特性 | 说明 |
|------|------|
| **类名** | `IGESCAFControl_Reader` |
| **继承** | `IGESControl_Reader` → `XSControl_Reader` |
| **功能** | 读取 IGES 文件 + 提取颜色/图层/名称属性 |
| **三种模式** | ColorMode, LayerMode, NameMode (默认全开) |
| **核心方法** | `ReadFile()`, `Transfer()`, `Perform()` |
| **Gmsh 使用** | 需要 `HAVE_OCC_CAF` 宏定义 |
| **对比版本** | `IGESControl_Reader` (无属性读取) |

`IGESCAFControl_Reader` 是 OpenCASCADE 提供的增强版 IGES 读取器，让 Gmsh 能够从 IGES 文件中保留颜色、名称、图层等重要元数据。
