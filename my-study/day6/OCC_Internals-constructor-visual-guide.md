# OCC_Internals 构造函数图解详析

## 概述

`OCC_Internals` 是 Gmsh 与 OpenCASCADE (OCC) 几何内核交互的**核心桥梁类**，位于 `src/geo/GModelIO_OCC.cpp:170`。

它的作用是：
1. 管理 OpenCASCADE 的几何形状（TopoDS_Shape）
2. 维护形状与 Gmsh 实体标签（tag）之间的映射
3. 存储网格属性（尺寸、拉伸参数等）

---

## 构造函数代码

```cpp
// GModelIO_OCC.cpp:170-176
OCC_Internals::OCC_Internals()
{
  for(int i = 0; i < 6; i++)
    _maxTag[i] = CTX::instance()->geom.firstEntityTag - 1;
  _changed = true;
  _attributes = new OCCAttributesRTree(CTX::instance()->geom.tolerance);
}
```

---

## 逐行图解

### 第1部分：初始化 `_maxTag[6]` 数组

```cpp
for(int i = 0; i < 6; i++)
    _maxTag[i] = CTX::instance()->geom.firstEntityTag - 1;
```

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      _maxTag[6] 数组初始化                                   │
│                                                                             │
│   为什么是6个元素？对应6种几何拓扑实体类型：                                    │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  索引    类型        对应OCC类型           Gmsh维度   说明            │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │   0     Shell      TopoDS_Shell            -       壳（面的集合）    │   │
│   │   1     Wire       TopoDS_Wire             -       线框（边的集合）  │   │
│   │   2     Vertex     TopoDS_Vertex          dim=0    顶点（点）       │   │
│   │   3     Edge       TopoDS_Edge            dim=1    边（曲线）       │   │
│   │   4     Face       TopoDS_Face            dim=2    面（曲面）       │   │
│   │   5     Solid      TopoDS_Solid           dim=3    体（实体）       │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   初始值: CTX::instance()->geom.firstEntityTag - 1                          │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  firstEntityTag 默认值 = 1                                          │   │
│   │  所以 _maxTag[i] = 1 - 1 = 0                                        │   │
│   │                                                                     │   │
│   │  含义: 当前每种类型的最大标签号为0                                    │   │
│   │       下一个新建实体的标签将从 1 开始                                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   内存布局:                                                                  │
│   ┌─────┬─────┬─────┬─────┬─────┬─────┐                                    │
│   │  0  │  0  │  0  │  0  │  0  │  0  │                                    │
│   ├─────┼─────┼─────┼─────┼─────┼─────┤                                    │
│   │Shell│Wire │Vertex│Edge │Face │Solid│                                   │
│   │ [0] │ [1] │ [2] │ [3] │ [4] │ [5] │                                    │
│   └─────┴─────┴─────┴─────┴─────┴─────┘                                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 第2部分：设置 `_changed` 标志

```cpp
_changed = true;
```

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         _changed 标志                                        │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    脏标志模式 (Dirty Flag Pattern)                   │   │
│   │                                                                     │   │
│   │   _changed = true  →  表示OCC内部数据已修改,需要与GModel同步          │   │
│   │   _changed = false →  表示OCC数据与GModel已同步,无需再次同步          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   工作流程:                                                                  │
│                                                                             │
│   ┌──────────────────┐                                                      │
│   │ 用户操作          │                                                      │
│   │ (创建/修改几何)   │                                                      │
│   └────────┬─────────┘                                                      │
│            │                                                                │
│            ▼                                                                │
│   ┌──────────────────┐                                                      │
│   │ OCC_Internals    │                                                      │
│   │ _changed = true  │ ← 标记为已修改                                       │
│   └────────┬─────────┘                                                      │
│            │                                                                │
│            ▼                                                                │
│   ┌──────────────────┐                                                      │
│   │ synchronize()    │ ← 同步到GModel                                       │
│   │ _changed = false │ ← 同步完成,重置标志                                   │
│   └──────────────────┘                                                      │
│                                                                             │
│   初始化时设为 true 是因为:                                                   │
│   即使是空的OCC_Internals,也需要在首次同步时被处理                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 第3部分：创建 `_attributes` R树

```cpp
_attributes = new OCCAttributesRTree(CTX::instance()->geom.tolerance);
```

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    OCCAttributesRTree 创建                                   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    什么是 OCCAttributesRTree？                       │   │
│   │                                                                     │   │
│   │   这是一个用于存储和快速查找几何属性的空间索引数据结构                  │   │
│   │                                                                     │   │
│   │   R-Tree (矩形树) 是一种平衡树,专门用于空间数据的索引                 │   │
│   │   可以快速回答"在这个区域内有哪些对象"的查询                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   OCCAttributesRTree 内部结构:                                              │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  class OCCAttributesRTree {                                         │   │
│   │      RTree<OCCAttributes*, double, 3> *_rtree[4]; // 4棵R树         │   │
│   │      //      │              │     │                                 │   │
│   │      //      │              │     └── 3维空间                       │   │
│   │      //      │              └── 坐标类型                            │   │
│   │      //      └── 存储的数据类型(属性指针)                            │   │
│   │                                                                     │   │
│   │      std::vector<OCCAttributes*> _all;  // 所有属性的列表            │   │
│   │      double _tol;  // 容差 (来自geom.tolerance)                      │   │
│   │  };                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   _rtree[4] 对应4个维度的实体:                                               │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │   _rtree[0] → dim=0 → Vertex (点)    的属性索引                     │   │
│   │   _rtree[1] → dim=1 → Edge   (边)    的属性索引                     │   │
│   │   _rtree[2] → dim=2 → Face   (面)    的属性索引                     │   │
│   │   _rtree[3] → dim=3 → Solid  (体)    的属性索引                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   OCCAttributes 存储什么？                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │   • meshSize      - 网格尺寸                                        │   │
│   │   • extrudeParams - 拉伸参数                                        │   │
│   │   • label         - 标签/名称                                       │   │
│   │   • color         - 颜色(用于可视化)                                 │   │
│   │   • boundingBox   - 包围盒(用于R树索引)                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   tolerance 参数的作用:                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │   用于判断两个几何位置是否"足够接近"被视为相同                        │   │
│   │                                                                     │   │
│   │   例如: tolerance = 1e-6                                            │   │
│   │   点 A(0.0, 0.0, 0.0) 和 点 B(1e-7, 0.0, 0.0)                       │   │
│   │   距离 < tolerance,被认为是同一点                                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## R-Tree 可视化理解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         R-Tree 空间索引示意                                  │
│                                                                             │
│   假设我们有一个CAD模型,包含多个几何实体:                                      │
│                                                                             │
│   二维示意 (实际是三维):                                                      │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Y                                                                  │   │
│   │  ↑                                                                  │   │
│   │  │     ┌───────────────────────────────────────┐                   │   │
│   │  │     │  R-Tree 根节点 (整个空间的包围盒)      │                   │   │
│   │  │     │  ┌─────────────┐  ┌─────────────────┐ │                   │   │
│   │  │     │  │ 子节点1     │  │ 子节点2         │ │                   │   │
│   │  │     │  │ ┌───┐ ┌───┐│  │ ┌─────┐ ┌─────┐│ │                   │   │
│   │  │     │  │ │ A │ │ B ││  │ │  C  │ │  D  ││ │                   │   │
│   │  │     │  │ └───┘ └───┘│  │ └─────┘ └─────┘│ │                   │   │
│   │  │     │  └─────────────┘  └─────────────────┘ │                   │   │
│   │  │     └───────────────────────────────────────┘                   │   │
│   │  │                                                                  │   │
│   │  └────────────────────────────────────────────────────────→ X       │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   查询: "找出(2,3)位置附近的几何实体"                                         │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  步骤1: 从根节点开始                                                 │   │
│   │  步骤2: 检查哪个子节点的包围盒包含查询点                              │   │
│   │  步骤3: 递归进入匹配的子节点                                         │   │
│   │  步骤4: 到达叶节点,返回匹配的实体                                    │   │
│   │                                                                     │   │
│   │  时间复杂度: O(log n) 而不是遍历的 O(n)                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## OCC_Internals 完整架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        OCC_Internals 类架构                                  │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         OCC_Internals                                  │  │
│  │                                                                        │  │
│  │   ┌────────────────────────────────────────────────────────────────┐  │  │
│  │   │  状态管理                                                       │  │  │
│  │   │  ┌──────────────┐  ┌─────────────────────────────────────────┐ │  │  │
│  │   │  │ _changed     │  │ _maxTag[6]                              │ │  │  │
│  │   │  │ (同步标志)    │  │ [Shell, Wire, Vertex, Edge, Face, Solid]│ │  │  │
│  │   │  └──────────────┘  └─────────────────────────────────────────┘ │  │  │
│  │   └────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │   ┌────────────────────────────────────────────────────────────────┐  │  │
│  │   │  形状存储 (TopTools_IndexedMapOfShape)                          │  │  │
│  │   │  ┌────────┬────────┬────────┬────────┬────────┬─────────┐     │  │  │
│  │   │  │ _vmap  │ _emap  │ _wmap  │ _fmap  │ _shmap │ _somap  │     │  │  │
│  │   │  │Vertices│ Edges  │ Wires  │ Faces  │ Shells │ Solids  │     │  │  │
│  │   │  └────────┴────────┴────────┴────────┴────────┴─────────┘     │  │  │
│  │   └────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │   ┌────────────────────────────────────────────────────────────────┐  │  │
│  │   │  标签映射 (双向映射)                                             │  │  │
│  │   │                                                                 │  │  │
│  │   │  Shape → Tag:  _vertexTag, _edgeTag, _faceTag, _solidTag       │  │  │
│  │   │  Tag → Shape:  _tagVertex, _tagEdge, _tagFace, _tagSolid       │  │  │
│  │   │                                                                 │  │  │
│  │   │  内部用:       _wireTag/_tagWire, _shellTag/_tagShell          │  │  │
│  │   └────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │   ┌────────────────────────────────────────────────────────────────┐  │  │
│  │   │  属性存储 (R-Tree空间索引)                                       │  │  │
│  │   │  ┌───────────────────────────────────────────────────────────┐ │  │  │
│  │   │  │  _attributes (OCCAttributesRTree*)                        │ │  │  │
│  │   │  │  ┌─────────┬─────────┬─────────┬─────────┐                │ │  │  │
│  │   │  │  │rtree[0] │rtree[1] │rtree[2] │rtree[3] │                │ │  │  │
│  │   │  │  │ (点)    │ (边)    │ (面)    │ (体)    │                │ │  │  │
│  │   │  │  └─────────┴─────────┴─────────┴─────────┘                │ │  │  │
│  │   │  └───────────────────────────────────────────────────────────┘ │  │  │
│  │   └────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │   ┌────────────────────────────────────────────────────────────────┐  │  │
│  │   │  待处理队列                                                      │  │  │
│  │   │  ┌──────────────────────┐  ┌──────────────────────┐            │  │  │
│  │   │  │ _toRemove            │  │ _toPreserve          │            │  │  │
│  │   │  │ (待删除的实体)        │  │ (布尔运算中保留的实体) │            │  │  │
│  │   │  └──────────────────────┘  └──────────────────────┘            │  │  │
│  │   └────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 构造函数在整体流程中的位置

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     OCC_Internals 生命周期                                   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                          创建阶段                                    │   │
│   │                                                                     │   │
│   │   GModel 创建时:                                                    │   │
│   │   GModel::GModel() {                                                │   │
│   │       _occ_internals = new OCC_Internals();  ← 调用构造函数          │   │
│   │   }                                                                 │   │
│   │                                                                     │   │
│   │   构造函数执行:                                                      │   │
│   │   ┌─────────────────────────────────────────────────────────┐       │   │
│   │   │ 1. 初始化 _maxTag[6] = {0,0,0,0,0,0}                    │       │   │
│   │   │ 2. 设置 _changed = true                                 │       │   │
│   │   │ 3. 创建 _attributes R-Tree                              │       │   │
│   │   └─────────────────────────────────────────────────────────┘       │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                          使用阶段                                    │   │
│   │                                                                     │   │
│   │   读取STEP/IGES文件:                                                │   │
│   │   ┌─────────────────────────────────────────────────────────┐       │   │
│   │   │ importShapes() → _bind() → 更新_maxTag → _changed=true  │       │   │
│   │   └─────────────────────────────────────────────────────────┘       │   │
│   │                                                                     │   │
│   │   创建几何:                                                          │   │
│   │   ┌─────────────────────────────────────────────────────────┐       │   │
│   │   │ addBox/addSphere/... → _bind() → 更新_maxTag            │       │   │
│   │   └─────────────────────────────────────────────────────────┘       │   │
│   │                                                                     │   │
│   │   同步到GModel:                                                      │   │
│   │   ┌─────────────────────────────────────────────────────────┐       │   │
│   │   │ synchronize() → 如果_changed为true,创建GEntity          │       │   │
│   │   │              → _changed = false                         │       │   │
│   │   └─────────────────────────────────────────────────────────┘       │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                          销毁阶段                                    │   │
│   │                                                                     │   │
│   │   OCC_Internals::~OCC_Internals() {                                 │   │
│   │       delete _attributes;  ← 释放R-Tree                             │   │
│   │   }                                                                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## OpenCASCADE 拓扑结构回顾

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    OpenCASCADE 拓扑层次结构                                  │
│                                                                             │
│                           TopoDS_Compound                                   │
│                                  │                                          │
│                                  ▼                                          │
│                          ┌─────────────┐                                    │
│                          │TopoDS_Solid │ ← _maxTag[5], _somap              │
│                          │  (实体/体)   │                                    │
│                          └──────┬──────┘                                    │
│                                 │                                           │
│                                 ▼                                           │
│                          ┌─────────────┐                                    │
│                          │TopoDS_Shell │ ← _maxTag[0], _shmap              │
│                          │  (壳)       │                                    │
│                          └──────┬──────┘                                    │
│                                 │                                           │
│                                 ▼                                           │
│                          ┌─────────────┐                                    │
│                          │TopoDS_Face  │ ← _maxTag[4], _fmap               │
│                          │  (面)       │                                    │
│                          └──────┬──────┘                                    │
│                                 │                                           │
│                                 ▼                                           │
│                          ┌─────────────┐                                    │
│                          │TopoDS_Wire  │ ← _maxTag[1], _wmap               │
│                          │  (线框)     │                                    │
│                          └──────┬──────┘                                    │
│                                 │                                           │
│                                 ▼                                           │
│                          ┌─────────────┐                                    │
│                          │TopoDS_Edge  │ ← _maxTag[3], _emap               │
│                          │  (边)       │                                    │
│                          └──────┬──────┘                                    │
│                                 │                                           │
│                                 ▼                                           │
│                          ┌─────────────┐                                    │
│                          │TopoDS_Vertex│ ← _maxTag[2], _vmap               │
│                          │  (顶点)     │                                    │
│                          └─────────────┘                                    │
│                                                                             │
│   注意: _maxTag 索引与拓扑层次的对应关系:                                     │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │  _maxTag[0] = Shell  (内部使用,不映射到GEntity)                    │    │
│   │  _maxTag[1] = Wire   (内部使用,不映射到GEntity)                    │    │
│   │  _maxTag[2] = Vertex → GVertex (dim=0)                            │    │
│   │  _maxTag[3] = Edge   → GEdge   (dim=1)                            │    │
│   │  _maxTag[4] = Face   → GFace   (dim=2)                            │    │
│   │  _maxTag[5] = Solid  → GRegion (dim=3)                            │    │
│   └───────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 关键设计模式

### 1. 懒加载/延迟同步 (Lazy Synchronization)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│   _changed 标志实现了懒加载模式:                                             │
│                                                                             │
│   多次修改:                                                                  │
│   addBox() → _changed = true                                                │
│   addSphere() → _changed = true  (仍然是true,不重复同步)                     │
│   addCylinder() → _changed = true                                           │
│                                                                             │
│   只在需要时同步一次:                                                        │
│   synchronize() → 检查_changed → 批量同步 → _changed = false                │
│                                                                             │
│   优点: 避免每次修改都同步,提高性能                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2. 双向映射 (Bidirectional Mapping)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│   Shape ↔ Tag 双向映射:                                                      │
│                                                                             │
│   Shape → Tag: _vertexTag, _edgeTag, ...                                    │
│   Tag → Shape: _tagVertex, _tagEdge, ...                                    │
│                                                                             │
│   使用场景:                                                                  │
│   • 给定Shape查Tag: 导入CAD后为每个形状分配标签                              │
│   • 给定Tag查Shape: 用户通过标签引用几何时查找实际形状                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 总结

`OCC_Internals` 构造函数完成了三项关键初始化：

| 初始化项 | 代码 | 作用 |
|---------|------|------|
| `_maxTag[6]` | `= firstEntityTag - 1` | 6种拓扑类型的标签计数器，初始为0 |
| `_changed` | `= true` | 同步标志，标记OCC数据已修改待同步 |
| `_attributes` | `new OCCAttributesRTree(tol)` | R-Tree空间索引，用于快速查找几何属性 |

这个构造函数虽然简短，但为整个 OCC 与 Gmsh 的交互奠定了基础数据结构。
