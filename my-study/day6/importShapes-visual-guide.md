# importShapes 方法图解详析

## 概述

`importShapes` 是 Gmsh 中用于**导入 CAD 文件并将其转换为内部几何表示**的核心方法，位于 `src/geo/GModelIO_OCC.cpp:4790`。

它的主要职责是：
1. 读取 CAD 文件（BREP/STEP/IGES 格式）
2. 可选地读取属性（标签、颜色等）
3. 修复几何缺陷（Healing）
4. 将几何形状绑定到标签（Binding）

---

## 方法签名

```cpp
bool OCC_Internals::importShapes(
    const std::string &fileName,      // CAD 文件路径
    bool highestDimOnly,              // 是否只绑定最高维度的实体
    std::vector<std::pair<int, int>> &outDimTags,  // 输出: (维度, 标签) 列表
    const std::string &format         // 可选: 强制指定格式
);
```

---

## 完整执行流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    importShapes(fileName, ...) 完整流程                      │
│                                                                             │
│   输入: fileName = "model.step"                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第1步: 文件存在性检查                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  if(StatFile(fileName)) {                                           │    │
│  │      Msg::Error("File '%s' does not exist", fileName);              │    │
│  │      return false;                                                  │    │
│  │  }                                                                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第2步: 解析文件扩展名                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  std::vector<std::string> split = SplitFileName(fileName);          │    │
│  │                                                                     │    │
│  │  例如: "model.step"                                                 │    │
│  │  split[0] = ""         (路径)                                       │    │
│  │  split[1] = "model"    (文件名)                                     │    │
│  │  split[2] = ".step"    (扩展名)                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第3步: 根据格式选择读取器 ⭐⭐⭐                                              │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      格式路由判断                                    │    │
│  │                                                                     │    │
│  │         ┌─────────────────────────────────────┐                     │    │
│  │         │     检查 format 或 扩展名            │                     │    │
│  │         └─────────────────────────────────────┘                     │    │
│  │                         │                                           │    │
│  │         ┌───────────────┼───────────────┬───────────────┐          │    │
│  │         │               │               │               │          │    │
│  │         ▼               ▼               ▼               ▼          │    │
│  │   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐       │    │
│  │   │  .brep   │   │  .step   │   │  .iges   │   │  其他     │       │    │
│  │   │  .BREP   │   │  .stp    │   │  .igs    │   │ (错误)    │       │    │
│  │   └────┬─────┘   └────┬─────┘   └────┬─────┘   └──────────┘       │    │
│  │        │              │              │                             │    │
│  │        ▼              ▼              ▼                             │    │
│  │   BRepTools    STEPControl    IGESControl                          │    │
│  │   ::Read()     _Reader        _Reader                              │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  各格式详细处理:                                                             │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  BREP 格式 (最简单):                                                   │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │  BRep_Builder aBuilder;                                         │  │  │
│  │  │  BRepTools::Read(result, fileName.c_str(), aBuilder);           │  │  │
│  │  │                                                                 │  │  │
│  │  │  BREP 是 OpenCASCADE 的原生格式,直接读取                         │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  STEP 格式 (工业标准):                                                 │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │  STEPControl_Reader reader;                                     │  │  │
│  │  │  // 或使用 STEPCAFControl_Reader (支持属性)                      │  │  │
│  │  │                                                                 │  │  │
│  │  │  setTargetUnit(...);  // 设置目标单位                           │  │  │
│  │  │  Interface_Static::SetIVal("read.step.ideas", 1);               │  │  │
│  │  │  Interface_Static::SetIVal("read.step.nonmanifold", 1);         │  │  │
│  │  │                                                                 │  │  │
│  │  │  reader.ReadFile(fileName.c_str());                             │  │  │
│  │  │                                                                 │  │  │
│  │  │  #if HAVE_OCC_CAF  // 如果有 XCAF 支持                          │  │  │
│  │  │      readAttributes(_attributes, cafreader, "STEP-XCAF");       │  │  │
│  │  │      // 读取标签、颜色等属性                                     │  │  │
│  │  │  #endif                                                         │  │  │
│  │  │                                                                 │  │  │
│  │  │  reader.NbRootsForTransfer();  // 获取根实体数量                 │  │  │
│  │  │  reader.TransferRoots();       // 转换所有根实体                 │  │  │
│  │  │  result = reader.OneShape();   // 获取合并后的形状               │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  IGES 格式 (早期CAD标准):                                              │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │  IGESControl_Reader reader;                                     │  │  │
│  │  │  // 或使用 IGESCAFControl_Reader (支持属性)                      │  │  │
│  │  │                                                                 │  │  │
│  │  │  setTargetUnit(...);                                            │  │  │
│  │  │  reader.ReadFile(fileName.c_str());                             │  │  │
│  │  │  reader.NbRootsForTransfer();                                   │  │  │
│  │  │  reader.TransferRoots();                                        │  │  │
│  │  │  result = reader.OneShape();                                    │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第4步: 清理三角化缓存                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  BRepTools::Clean(result);                                          │    │
│  │                                                                     │    │
│  │  清除 Shape 上可能存在的旧三角化数据                                  │    │
│  │  (某些 CAD 文件会包含预计算的三角化,Gmsh 会重新生成)                   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第5步: 几何修复 (_healShape) ⭐⭐⭐                                          │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  _healShape(result, tolerance, fixDegenerated, fixSmallEdges,       │    │
│  │             fixSmallFaces, sewFaces, makeSolids, scaling);          │    │
│  │                                                                     │    │
│  │  详见下方 _healShape 详细流程图                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第6步: 绑定形状到标签 (_multiBind) ⭐⭐⭐                                     │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  _multiBind(result, -1, outDimTags, highestDimOnly, true);          │    │
│  │                                                                     │    │
│  │  参数说明:                                                           │    │
│  │  - result: 读取并修复后的 Shape                                      │    │
│  │  - -1: 自动分配标签 (不指定特定标签)                                  │    │
│  │  - outDimTags: 输出 (维度,标签) 列表                                 │    │
│  │  - highestDimOnly: 是否只绑定最高维度                                │    │
│  │  - true: 递归绑定子实体                                              │    │
│  │                                                                     │    │
│  │  详见下方 _multiBind 详细流程图                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
                               ┌──────────────┐
                               │ return true  │
                               └──────────────┘
```

---

## _healShape 几何修复详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     _healShape 几何修复流程                                  │
│                                                                             │
│   为什么需要修复？                                                           │
│   CAD 文件常存在以下问题:                                                    │
│   • 退化边 (长度为0的边)                                                    │
│   • 小边/小面 (低于容差的微小几何)                                          │
│   • 缝隙 (相邻面之间有微小间隙)                                             │
│   • 非流形几何                                                              │
│   这些问题会导致网格生成失败!                                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  修复步骤1: 几何缩放 (可选)                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  if(scaling != 1.0) {                                               │    │
│  │      gp_Trsf t;                                                     │    │
│  │      t.SetScaleFactor(scaling);                                     │    │
│  │      BRepBuilderAPI_Transform trsf(myshape, t);                     │    │
│  │      myshape = trsf.Shape();                                        │    │
│  │  }                                                                  │    │
│  │                                                                     │    │
│  │  用途: 将不同单位的模型统一到毫米/米等标准单位                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  修复步骤2: 修复退化边和面 (fixDegenerated)                                  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │   退化边示例:                                                        │    │
│  │   ┌───────────────────────────────────────────────────────────┐     │    │
│  │   │                                                           │     │    │
│  │   │    圆锥顶点处的边                                          │     │    │
│  │   │         ●  ← 退化边 (起点=终点,长度=0)                     │     │    │
│  │   │        /│\                                                │     │    │
│  │   │       / │ \                                               │     │    │
│  │   │      /  │  \                                              │     │    │
│  │   │     /   │   \                                             │     │    │
│  │   │    ●────●────●                                            │     │    │
│  │   │                                                           │     │    │
│  │   └───────────────────────────────────────────────────────────┘     │    │
│  │                                                                     │    │
│  │   修复操作:                                                          │    │
│  │   1. 遍历所有边,删除退化边                                           │    │
│  │   2. 使用 ShapeFix_Face 修复面:                                      │    │
│  │      - 修复线框                                                      │    │
│  │      - 修复方向                                                      │    │
│  │      - 添加缺失的接缝                                                │    │
│  │      - 移除小面积线框                                                │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  修复步骤3: 修复小边 (fixSmallEdges)                                         │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │   小边问题:                                                          │    │
│  │   ┌───────────────────────────────────────────────────────────┐     │    │
│  │   │                                                           │     │    │
│  │   │     ●────────────────●                                    │     │    │
│  │   │     │                │                                    │     │    │
│  │   │     │  ●─●  ← 小边   │  长度 < tolerance                  │     │    │
│  │   │     │                │                                    │     │    │
│  │   │     ●────────────────●                                    │     │    │
│  │   │                                                           │     │    │
│  │   └───────────────────────────────────────────────────────────┘     │    │
│  │                                                                     │    │
│  │   修复操作:                                                          │    │
│  │   - 使用 ShapeFix_Wireframe 修复                                    │    │
│  │   - 合并短边的端点                                                   │    │
│  │   - 或删除过短的边                                                   │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  修复步骤4: 修复小面 (fixSmallFaces)                                         │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │   面积过小的面会导致网格生成问题                                      │    │
│  │   - 合并到相邻面                                                     │    │
│  │   - 或直接删除                                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  修复步骤5: 缝合面 (sewFaces)                                                │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │   缝隙问题:                                                          │    │
│  │   ┌───────────────────────────────────────────────────────────┐     │    │
│  │   │                                                           │     │    │
│  │   │     ┌────────────┐   ┌────────────┐                       │     │    │
│  │   │     │   Face A   │   │   Face B   │                       │     │    │
│  │   │     │            │   │            │                       │     │    │
│  │   │     │            │   │            │                       │     │    │
│  │   │     └────────────┘   └────────────┘                       │     │    │
│  │   │                   ↑                                        │     │    │
│  │   │             微小缝隙 (gap)                                 │     │    │
│  │   │                                                           │     │    │
│  │   └───────────────────────────────────────────────────────────┘     │    │
│  │                                                                     │    │
│  │   修复操作:                                                          │    │
│  │   BRepOffsetAPI_Sewing sewingAlgo(tolerance);                       │    │
│  │   sewingAlgo.Add(shape);                                            │    │
│  │   sewingAlgo.Perform();                                             │    │
│  │   result = sewingAlgo.SewedShape();                                 │    │
│  │                                                                     │    │
│  │   将间隙小于 tolerance 的相邻边合并                                  │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  修复步骤6: 构建实体 (makeSolids)                                            │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │   如果缝合后形成封闭的壳(Shell),尝试构建实体(Solid)                   │    │
│  │                                                                     │    │
│  │   ┌────────────────┐      ┌────────────────┐                        │    │
│  │   │  封闭的 Shell  │  →   │     Solid      │                        │    │
│  │   │   (只有面)     │      │  (有体积的)    │                        │    │
│  │   └────────────────┘      └────────────────┘                        │    │
│  │                                                                     │    │
│  │   BRepBuilderAPI_MakeSolid mkSolid(shell);                          │    │
│  │   TopoDS_Solid solid = mkSolid.Solid();                             │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## _multiBind 绑定流程详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    _multiBind 形状绑定流程                                   │
│                                                                             │
│   功能: 将 TopoDS_Shape 中的所有子形状绑定到 Gmsh 标签                       │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  void _multiBind(const TopoDS_Shape &shape, int tag,                │   │
│   │                  vector<pair<int,int>> &outDimTags,                 │   │
│   │                  bool highestDimOnly, bool recursive,               │   │
│   │                  bool returnNewOnly);                               │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  遍历顺序: 从高维到低维                                                      │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │   步骤1: 遍历所有 Solid (dim=3)                                     │    │
│  │   ┌─────────────────────────────────────────────────────────────┐   │    │
│  │   │  for(exp0.Init(shape, TopAbs_SOLID); exp0.More(); ...)      │   │    │
│  │   │      TopoDS_Solid solid = TopoDS::Solid(exp0.Current());    │   │    │
│  │   │                                                             │   │    │
│  │   │      // 检查是否已绑定                                       │   │    │
│  │   │      if(_solidTag.IsBound(solid)) {                         │   │    │
│  │   │          t = _solidTag.Find(solid);  // 已有标签            │   │    │
│  │   │      } else {                                               │   │    │
│  │   │          t = getMaxTag(3) + 1;       // 分配新标签          │   │    │
│  │   │      }                                                      │   │    │
│  │   │                                                             │   │    │
│  │   │      _bind(solid, t, recursive);     // 绑定                │   │    │
│  │   │      outDimTags.push_back({3, t});   // 记录输出            │   │    │
│  │   └─────────────────────────────────────────────────────────────┘   │    │
│  │                                                                     │    │
│  │   if(highestDimOnly && count > 0) return;  // 只要最高维度          │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │   步骤2: 遍历所有 Face (dim=2)                                      │    │
│  │   ┌─────────────────────────────────────────────────────────────┐   │    │
│  │   │  for(exp0.Init(shape, TopAbs_FACE); exp0.More(); ...)       │   │    │
│  │   │      TopoDS_Face face = TopoDS::Face(exp0.Current());       │   │    │
│  │   │      // 同样的绑定逻辑...                                    │   │    │
│  │   │      _bind(face, t, recursive);                             │   │    │
│  │   │      outDimTags.push_back({2, t});                          │   │    │
│  │   └─────────────────────────────────────────────────────────────┘   │    │
│  │                                                                     │    │
│  │   if(highestDimOnly && count > 0) return;                           │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │   步骤3: 遍历所有 Edge (dim=1)                                      │    │
│  │   ┌─────────────────────────────────────────────────────────────┐   │    │
│  │   │  for(exp0.Init(shape, TopAbs_EDGE); exp0.More(); ...)       │   │    │
│  │   │      TopoDS_Edge edge = TopoDS::Edge(exp0.Current());       │   │    │
│  │   │      _bind(edge, t, recursive);                             │   │    │
│  │   │      outDimTags.push_back({1, t});                          │   │    │
│  │   └─────────────────────────────────────────────────────────────┘   │    │
│  │                                                                     │    │
│  │   if(highestDimOnly && count > 0) return;                           │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                                                                     │    │
│  │   步骤4: 遍历所有 Vertex (dim=0)                                    │    │
│  │   ┌─────────────────────────────────────────────────────────────┐   │    │
│  │   │  for(exp0.Init(shape, TopAbs_VERTEX); exp0.More(); ...)     │   │    │
│  │   │      TopoDS_Vertex vertex = TopoDS::Vertex(exp0.Current()); │   │    │
│  │   │      _bind(vertex, t, recursive);                           │   │    │
│  │   │      outDimTags.push_back({0, t});                          │   │    │
│  │   └─────────────────────────────────────────────────────────────┘   │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## _bind 绑定单个形状

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    _bind 单个形状绑定                                        │
│                                                                             │
│   以 _bind(TopoDS_Solid solid, int tag, bool recursive) 为例:               │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  1. 建立双向映射:                                                    │   │
│   │     _solidTag.Bind(solid, tag);   // Shape → Tag                    │   │
│   │     _tagSolid.Bind(tag, solid);   // Tag → Shape                    │   │
│   │                                                                     │   │
│   │  2. 更新最大标签:                                                    │   │
│   │     if(tag > _maxTag[5]) _maxTag[5] = tag;                          │   │
│   │                                                                     │   │
│   │  3. 如果 recursive=true, 递归绑定子形状:                             │   │
│   │     - Solid 的所有 Face                                             │   │
│   │     - Face 的所有 Edge                                              │   │
│   │     - Edge 的所有 Vertex                                            │   │
│   │                                                                     │   │
│   │  4. 标记已改变:                                                      │   │
│   │     _changed = true;  // 需要同步到 GModel                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   绑定后的数据结构:                                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   _solidTag:                    _tagSolid:                         │   │
│   │   ┌────────────┬────┐          ┌────┬────────────┐                 │   │
│   │   │ TopoDS_Solid│ 1 │          │ 1  │TopoDS_Solid│                 │   │
│   │   │ TopoDS_Solid│ 2 │          │ 2  │TopoDS_Solid│                 │   │
│   │   │    ...     │... │          │... │    ...     │                 │   │
│   │   └────────────┴────┘          └────┴────────────┘                 │   │
│   │                                                                     │   │
│   │   Shape → Tag 和 Tag → Shape 双向查找都是 O(1)                      │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 完整调用链路图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    importShapes 在整体流程中的位置                           │
│                                                                             │
│   用户操作:                                                                  │
│   gmsh model.step                                                           │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   main() / GmshMainBatch()                                          │   │
│   │        │                                                            │   │
│   │        ▼                                                            │   │
│   │   OpenProject(fileName)                                             │   │
│   │        │                                                            │   │
│   │        ▼                                                            │   │
│   │   MergeFile(fileName)                                               │   │
│   │        │                                                            │   │
│   │        ▼                                                            │   │
│   │   GModel::readOCCSTEP(fileName)                                     │   │
│   │        │                                                            │   │
│   │        ▼                                                            │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  OCC_Internals::importShapes(fileName, ...)  ← 当前位置     │   │   │
│   │   │                                                             │   │   │
│   │   │  1. 读取 STEP/IGES/BREP 文件                                │   │   │
│   │   │  2. _healShape() 修复几何                                   │   │   │
│   │   │  3. _multiBind() 绑定到标签                                 │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │        │                                                            │   │
│   │        ▼                                                            │   │
│   │   OCC_Internals::synchronize(GModel*)                               │   │
│   │        │                                                            │   │
│   │        ▼                                                            │   │
│   │   创建 GVertex, GEdge, GFace, GRegion                               │   │
│   │        │                                                            │   │
│   │        ▼                                                            │   │
│   │   准备就绪,可以进行网格生成                                          │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 关键代码行对照

| 行号 | 代码 | 说明 |
|------|------|------|
| 4795-4798 | `StatFile(fileName)` | 检查文件是否存在 |
| 4800 | `SplitFileName(fileName)` | 解析文件路径和扩展名 |
| 4804-4807 | `BRepTools::Read(...)` | 读取 BREP 格式 |
| 4808-4833 | `STEPControl_Reader` | 读取 STEP 格式 |
| 4834-4855 | `IGESControl_Reader` | 读取 IGES 格式 |
| 4865 | `BRepTools::Clean(result)` | 清理三角化缓存 |
| 4867-4872 | `_healShape(...)` | 几何修复 |
| 4874 | `_multiBind(...)` | 绑定形状到标签 |

---

## 两个重载版本

```cpp
// 版本1: 从文件导入 (常用)
bool importShapes(const std::string &fileName,
                  bool highestDimOnly,
                  std::vector<std::pair<int, int>> &outDimTags,
                  const std::string &format);

// 版本2: 从已有 Shape 导入 (内部使用)
bool importShapes(const TopoDS_Shape *shape,
                  bool highestDimOnly,
                  std::vector<std::pair<int, int>> &outDimTags);
```

---

## 总结

`importShapes` 是 Gmsh CAD 导入的核心方法：

| 阶段 | 操作 | 关键函数 |
|------|------|----------|
| **读取** | 根据文件格式调用对应的 OCC Reader | `STEPControl_Reader`, `IGESControl_Reader`, `BRepTools::Read` |
| **属性** | 读取标签、颜色等元数据 (需要 XCAF 支持) | `readAttributes()` |
| **修复** | 修复退化边、小边、缝隙等几何缺陷 | `_healShape()` |
| **绑定** | 将 Shape 关联到 Gmsh 标签 | `_multiBind()` → `_bind()` |
| **输出** | 返回 (维度, 标签) 列表 | `outDimTags` |

这个方法是 Gmsh 与 OpenCASCADE 几何内核交互的关键入口点，处理了从文件读取到内部表示的完整转换流程。
