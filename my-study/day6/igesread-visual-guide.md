# igesread 函数深度解析可视化指南

## 概述

`igesread` 是 OpenCASCADE 中用于解析 IGES 文件的**纯 C 语言底层解析器**，位于 `TKDEIGES/IGESFile/igesread.c`。它负责逐行读取 IGES 文件，识别五大段(S/G/D/P/T)，解析参数，并将数据存储到 C 结构体中供上层 C++ 代码使用。

---

## 一、源文件架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        IGES C 解析器源文件组成                                   │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  igesread.c   ─ 主入口函数 igesread()                                   │   │
│   │               ─ 控制整体解析流程                                         │   │
│   │               ─ 调用其他模块完成具体工作                                  │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│          ┌───────────────────────────┼───────────────────────────┐              │
│          ▼                           ▼                           ▼              │
│   ┌──────────────────┐    ┌──────────────────────┐    ┌──────────────────────┐  │
│   │  liriges.c       │    │  structiges.c        │    │  analiges.c          │  │
│   │                  │    │                      │    │                      │  │
│   │  iges_lire()     │    │  iges_initfile()     │    │  iges_Dsect()        │  │
│   │  ─ 读取单行      │    │  iges_setglobal()    │    │  iges_Psect()        │  │
│   │  ─ 识别段类型    │    │  iges_newpart()      │    │  iges_param()        │  │
│   │  ─ 提取行号      │    │  iges_newparam()     │    │  ─ 解析 D 段字段     │  │
│   │                  │    │  iges_stats()        │    │  ─ 解析 P 段参数     │  │
│   │                  │    │  iges_lirpart()      │    │  ─ 参数类型识别      │  │
│   │                  │    │  iges_lirparam()     │    │                      │  │
│   │                  │    │  iges_finfile()      │    │                      │  │
│   │                  │    │  ─ 内存管理          │    │                      │  │
│   └──────────────────┘    └──────────────────────┘    └──────────────────────┘  │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  igesread.h   ─ 头文件，定义结构体和函数声明                             │   │
│   │               ─ 参数类型常量 (ArgVide, ArgInt, ArgReal, etc.)            │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、igesread 函数原型

```c
// 文件: igesread.c, 行 55

int igesread(char* nomfic, int lesect[6], int modefnes)
```

**参数说明**:
| 参数 | 类型 | 说明 |
|------|------|------|
| `nomfic` | `char*` | IGES 文件路径 |
| `lesect` | `int[6]` | 输出：各段行数统计 `[_, S, G, D, P, T]` |
| `modefnes` | `int` | FNES 模式标志（特殊加密格式） |

**返回值**:
- `0`: 成功
- `-1`: 文件无法打开或严重错误

---

## 三、igesread 完整执行流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           igesread 主流程详解                                    │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  输入参数:                                                               │   │
│   │  nomfic = "hhh.igs"                                                     │   │
│   │  lesect = [0, 0, 0, 0, 0, 0]  (待填充)                                  │   │
│   │  modefnes = 0                                                           │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  阶段 1: 初始化                                                          ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  Line 62-63:                                                    │    ║   │
│   ║  │  int Dstat = 0;           // D段解析状态 (0=第一行, 1=第二行)   │    ║   │
│   ║  │  int Pstat = 0;           // P段解析状态                        │    ║   │
│   ║  │  char c_separ = ',';      // 参数分隔符 (默认逗号)              │    ║   │
│   ║  │  char c_fin = ';';        // 记录结束符 (默认分号)              │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │  iges_initfile();         // 初始化所有内存结构                 │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                      │                                          │
│                                      ▼                                          │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  阶段 2: 打开文件                                                        ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  Line 65-67:                                                    │    ║   │
│   ║  │  if (nomfic[0] != '\0')                                         │    ║   │
│   ║  │      lefic = OSD_OpenFile(nomfic, "r");  // 使用OCC的跨平台API  │    ║   │
│   ║  │  if (lefic == NULL)                                             │    ║   │
│   ║  │      return -1;           // 文件打开失败                       │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                      │                                          │
│                                      ▼                                          │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  阶段 3: 主循环 - 逐行读取和处理                                         ║   │
│   ║                                                                          ║   │
│   ║  Line 70: for(;;) {   // 无限循环，直到文件结束                          ║   │
│   ║                                                                          ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  3.1 读取一行                                                    │    ║   │
│   ║  │  ┌─────────────────────────────────────────────────────────┐    │    ║   │
│   ║  │  │  Line 71-72:                                            │    │    ║   │
│   ║  │  │  numl++;                   // 行计数                     │    │    ║   │
│   ║  │  │  i = iges_lire(lefic, &numsec, ligne, modefnes);        │    │    ║   │
│   ║  │  │                                                         │    │    ║   │
│   ║  │  │  返回值 i:                                              │    │    ║   │
│   ║  │  │    1 = S 段 (Start)                                     │    │    ║   │
│   ║  │  │    2 = G 段 (Global)                                    │    │    ║   │
│   ║  │  │    3 = D 段 (Directory)                                 │    │    ║   │
│   ║  │  │    4 = P 段 (Parameter)                                 │    │    ║   │
│   ║  │  │    5 = T 段 (Terminate)                                 │    │    ║   │
│   ║  │  │    0 = 文件结束                                         │    │    ║   │
│   ║  │  │   -1 = 语法错误                                         │    │    ║   │
│   ║  │  │                                                         │    │    ║   │
│   ║  │  │  numsec: 该行在段内的行号                               │    │    ║   │
│   ║  │  │  ligne:  行内容 (截断到72字符)                          │    │    ║   │
│   ║  │  └─────────────────────────────────────────────────────────┘    │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ║                                      │                                   ║   │
│   ║                                      ▼                                   ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  3.2 错误检查与行数统计                                          │    ║   │
│   ║  │  ┌─────────────────────────────────────────────────────────┐    │    ║   │
│   ║  │  │  Line 73-90:                                            │    │    ║   │
│   ║  │  │  if (i <= 0 || i < i0) {                                │    │    ║   │
│   ║  │  │      if (i == 0) break;   // 文件结束，退出循环          │    │    ║   │
│   ║  │  │      // 发送语法错误消息                                 │    │    ║   │
│   ║  │  │      IGESFile_Check2(0, "XSTEP_18", numl, str);         │    │    ║   │
│   ║  │  │  }                                                      │    │    ║   │
│   ║  │  │                                                         │    │    ║   │
│   ║  │  │  lesect[i]++;             // 该段行数 +1                 │    │    ║   │
│   ║  │  │  i0 = i;                  // 记录当前段类型              │    │    ║   │
│   ║  │  │                                                         │    │    ║   │
│   ║  │  │  // 验证行号连续性                                      │    │    ║   │
│   ║  │  │  if (numsec != lesect[i])                               │    │    ║   │
│   ║  │  │      IGESFile_Check2(0, "XSTEP_19", numl, str);         │    │    ║   │
│   ║  │  └─────────────────────────────────────────────────────────┘    │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ║                                      │                                   ║   │
│   ║                                      ▼                                   ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  3.3 根据段类型分派处理                                          │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │  ┌─────────────────────────────────────────────────────────┐    │    ║   │
│   ║  │  │  if (i == 1) {   // S 段 - Start Section                │    │    ║   │
│   ║  │  │      ligne[72] = '\0';                                  │    │    ║   │
│   ║  │  │      iges_newparam(0, 72, ligne);  // 存储整行为注释    │    │    ║   │
│   ║  │  │  }                                                      │    │    ║   │
│   ║  │  └─────────────────────────────────────────────────────────┘    │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │  ┌─────────────────────────────────────────────────────────┐    │    ║   │
│   ║  │  │  if (i == 2) {   // G 段 - Global Section               │    │    ║   │
│   ║  │  │      iges_setglobal();      // 切换到全局段             │    │    ║   │
│   ║  │  │                                                         │    │    ║   │
│   ║  │  │      // 第一行解析自定义分隔符                          │    │    ║   │
│   ║  │  │      if (lesect[i] == 1) {                              │    │    ║   │
│   ║  │  │          if (ligne[0] != ',')                           │    │    ║   │
│   ║  │  │              c_separ = ligne[2];  // 如 "1H," → ','     │    │    ║   │
│   ║  │  │          // 类似解析 c_fin                              │    │    ║   │
│   ║  │  │      }                                                  │    │    ║   │
│   ║  │  │                                                         │    │    ║   │
│   ║  │  │      // 解析参数直到行结束                              │    │    ║   │
│   ║  │  │      for (;;) {                                         │    │    ║   │
│   ║  │  │          iges_param(&Pstat, ligne, c_separ, c_fin, 72); │    │    ║   │
│   ║  │  │          if (Pstat != 2) break;                         │    │    ║   │
│   ║  │  │      }                                                  │    │    ║   │
│   ║  │  │  }                                                      │    │    ║   │
│   ║  │  └─────────────────────────────────────────────────────────┘    │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │  ┌─────────────────────────────────────────────────────────┐    │    ║   │
│   ║  │  │  if (i == 3) {   // D 段 - Directory Section            │    │    ║   │
│   ║  │  │      iges_Dsect(&Dstat, numsec, ligne);                 │    │    ║   │
│   ║  │  │      // 解析目录条目 (每个实体占2行)                    │    │    ║   │
│   ║  │  │  }                                                      │    │    ║   │
│   ║  │  └─────────────────────────────────────────────────────────┘    │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │  ┌─────────────────────────────────────────────────────────┐    │    ║   │
│   ║  │  │  if (i == 4) {   // P 段 - Parameter Section            │    │    ║   │
│   ║  │  │      iges_Psect(numsec, ligne);    // 提取D段指针       │    │    ║   │
│   ║  │  │      for (;;) {                                         │    │    ║   │
│   ║  │  │          iges_param(&Pstat, ligne, c_separ, c_fin, 64); │    │    ║   │
│   ║  │  │          if (Pstat != 2) break;                         │    │    ║   │
│   ║  │  │      }                                                  │    │    ║   │
│   ║  │  │  }                                                      │    │    ║   │
│   ║  │  └─────────────────────────────────────────────────────────┘    │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ║                                                                          ║   │
│   ║  }  // 主循环结束                                                        ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                      │                                          │
│                                      ▼                                          │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  阶段 4: 收尾工作                                                        ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  Line 124-133:                                                  │    ║   │
│   ║  │  // 检查是否有 Terminate Section                                │    ║   │
│   ║  │  if (lesect[5] == 0)                                            │    ║   │
│   ║  │      IGESFile_Check3(1, "XSTEP_20");  // 发送警告               │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │  fclose(lefic);   // 关闭文件                                   │    ║   │
│   ║  │  return 0;        // 成功返回                                   │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                      │                                          │
│                                      ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  输出:                                                                   │   │
│   │  lesect = [_, S行数, G行数, D行数, P行数, T行数]                        │   │
│   │  例如:   [0,    1,     3,    10,    15,     1]                          │   │
│   │                                                                         │   │
│   │  所有数据已存储在 C 结构体中:                                            │   │
│   │  - starts: S 段注释                                                     │   │
│   │  - header: G 段参数                                                     │   │
│   │  - firstpage→dirpart[]: D 段 + P 段数据                                 │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、iges_lire 函数详解 (行读取)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          iges_lire 行读取流程                                    │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  函数原型: int iges_lire(FILE* lefic, int *numsec, char line[100],     │   │
│   │                          int modefnes)                                  │   │
│   │                                                                         │   │
│   │  功能: 读取 IGES 文件的一行，识别段类型并提取行号                        │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│   IGES 文件行结构 (固定 80 字符):                                               │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                         │   │
│   │   位置:   1 ────────────────────────── 72  73  74 ─── 80               │   │
│   │           │                             │   │   │      │               │   │
│   │           ▼                             ▼   ▼   ▼      ▼               │   │
│   │   ┌───────────────────────────────────┬───┬────────────┐               │   │
│   │   │         数据区 (72字符)            │段 │   行号     │               │   │
│   │   │                                   │符 │  (7字符)   │               │   │
│   │   └───────────────────────────────────┴───┴────────────┘               │   │
│   │                                                                         │   │
│   │   示例行:                                                               │   │
│   │   "1H,,1H;,6HNoname,7Hhhh.igs,13HSpatial Corp.,20H3D InterOp...G      1"│   │
│   │    └──────────────────── 数据 ──────────────────────────┘└┘└── 行号 ───┘│   │
│   │                                                          段符                │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  解析流程                                                                ║   │
│   ║                                                                          ║   │
│   ║  1. 读取一行 (fgets)                                                     ║   │
│   ║     ┌─────────────────────────────────────────────────────────────┐     ║   │
│   ║     │  if (modefnes)                                              │     ║   │
│   ║     │      fgets(line, 99, lefic);      // FNES 模式              │     ║   │
│   ║     │  else                                                       │     ║   │
│   ║     │      fgets(line, 2, lefic);       // 跳过前导 \r\n          │     ║   │
│   ║     │      fgets(&line[1], 80, lefic);  // 读取主体               │     ║   │
│   ║     └─────────────────────────────────────────────────────────────┘     ║   │
│   ║                                                                          ║   │
│   ║  2. FNES 解密 (如果需要)                                                 ║   │
│   ║     ┌─────────────────────────────────────────────────────────────┐     ║   │
│   ║     │  if ((line[0] & 128) && modefnes)                           │     ║   │
│   ║     │      for (i = 0; i < 80; i++)                               │     ║   │
│   ║     │          line[i] = (char)(line[i] ^ (150 + (i & 3)));       │     ║   │
│   ║     └─────────────────────────────────────────────────────────────┘     ║   │
│   ║                                                                          ║   │
│   ║  3. 提取段类型和行号                                                     ║   │
│   ║     ┌─────────────────────────────────────────────────────────────┐     ║   │
│   ║     │  sscanf(&line[73], "%d", &result);   // 读取行号            │     ║   │
│   ║     │  typesec = line[72];                  // 读取段标识符       │     ║   │
│   ║     │                                                             │     ║   │
│   ║     │  switch (typesec) {                                         │     ║   │
│   ║     │      case 'S': line[72] = '\0'; return 1;  // Start        │     ║   │
│   ║     │      case 'G': line[72] = '\0'; return 2;  // Global       │     ║   │
│   ║     │      case 'D': line[72] = '\0'; return 3;  // Directory    │     ║   │
│   ║     │      case 'P': line[72] = '\0'; return 4;  // Parameter    │     ║   │
│   ║     │      case 'T': line[72] = '\0'; return 5;  // Terminate    │     ║   │
│   ║     │  }                                                          │     ║   │
│   ║     └─────────────────────────────────────────────────────────────┘     ║   │
│   ║                                                                          ║   │
│   ║  4. 返回值含义                                                           ║   │
│   ║     ┌─────────────────────────────────────────────────────────────┐     ║   │
│   ║     │   1-5 : 段类型 (S/G/D/P/T)                                  │     ║   │
│   ║     │     0 : 文件结束 (EOF)                                      │     ║   │
│   ║     │    -1 : 语法错误 (无法识别的行格式)                         │     ║   │
│   ║     └─────────────────────────────────────────────────────────────┘     ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、核心数据结构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          C 结构体定义 (igesread.h)                               │
│                                                                                 │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  参数链表节点                                                            ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  struct oneparam {                                              │    ║   │
│   ║  │      struct oneparam *next;  // 指向下一个参数                  │    ║   │
│   ║  │      int typarg;             // 参数类型 (见下表)               │    ║   │
│   ║  │      char *parval;           // 参数值字符串                    │    ║   │
│   ║  │  };                                                             │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                                                                 │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  参数列表                                                                ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  struct parlist {                                               │    ║   │
│   ║  │      struct oneparam *first;  // 第一个参数                     │    ║   │
│   ║  │      struct oneparam *last;   // 最后一个参数                   │    ║   │
│   ║  │      int nbparam;             // 参数总数                       │    ║   │
│   ║  │  };                                                             │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                                                                 │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  目录条目 (D 段一个实体)                                                 ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  struct dirpart {                                               │    ║   │
│   ║  │      // 第一行 (D 段奇数行)                                     │    ║   │
│   ║  │      int typ;    // 位置 1-8:   实体类型                        │    ║   │
│   ║  │      int poi;    // 位置 9-16:  参数数据指针 (P 段行号)         │    ║   │
│   ║  │      int pdef;   // 位置 17-24: Structure 指针                  │    ║   │
│   ║  │      int tra;    // 位置 25-32: Line Font Pattern              │    ║   │
│   ║  │      int niv;    // 位置 33-40: Level                          │    ║   │
│   ║  │      int vue;    // 位置 41-48: View                           │    ║   │
│   ║  │      int trf;    // 位置 49-56: Transformation Matrix          │    ║   │
│   ║  │      int aff;    // 位置 57-64: Label Display                  │    ║   │
│   ║  │      int blk;    // 位置 65-66: Blank Status                   │    ║   │
│   ║  │      int sub;    // 位置 67-68: Subordinate Switch             │    ║   │
│   ║  │      int use;    // 位置 69-70: Entity Use Flag                │    ║   │
│   ║  │      int her;    // 位置 71-72: Hierarchy                      │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │      // 第二行 (D 段偶数行)                                     │    ║   │
│   ║  │      int typ2;   // 位置 1-8:   实体类型 (重复)                 │    ║   │
│   ║  │      int epa;    // 位置 9-16:  Line Weight Number             │    ║   │
│   ║  │      int col;    // 位置 17-24: Color Number                   │    ║   │
│   ║  │      int nbl;    // 位置 25-32: Parameter Line Count           │    ║   │
│   ║  │      int form;   // 位置 33-40: Form Number                    │    ║   │
│   ║  │      char res1[10]; // 位置 41-48: Reserved                    │    ║   │
│   ║  │      char res2[10]; // 位置 49-56: Reserved                    │    ║   │
│   ║  │      char nom[10];  // 位置 57-64: Entity Label                │    ║   │
│   ║  │      char num[10];  // 位置 65-72: Entity Subscript Number     │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │      struct parlist list;  // P 段参数列表                      │    ║   │
│   ║  │      int numpart;          // D 段序列号                        │    ║   │
│   ║  │  };                                                             │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                                                                 │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  参数类型常量                                                            ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  #define ArgVide  0  // 空参数                                  │    ║   │
│   ║  │  #define ArgQuid  1  // 未知/混合类型                           │    ║   │
│   ║  │  #define ArgChar  2  // 字符串 (Hollerith格式 nH...)            │    ║   │
│   ║  │  #define ArgInt   3  // 无符号整数                              │    ║   │
│   ║  │  #define ArgSign  4  // 带符号整数                              │    ║   │
│   ║  │  #define ArgReal  5  // 实数                                    │    ║   │
│   ║  │  #define ArgExp   6  // 实数 + E (未完成的指数)                 │    ║   │
│   ║  │  #define ArgRexp  7  // 完整的科学计数法                        │    ║   │
│   ║  │  #define ArgMexp  8  // 缺少小数点的指数形式                    │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、内存管理架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          分页内存管理机制                                        │
│                                                                                 │
│   为了避免大量小内存分配，采用"页"机制批量分配                                    │
│                                                                                 │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  字符页 (carpage) - 存储参数值字符串                                     ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  #define Maxcar 10000                                           │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │  struct carpage {                                               │    ║   │
│   ║  │      struct carpage* next;   // 链表下一个页                    │    ║   │
│   ║  │      int used;               // 已使用字节数                    │    ║   │
│   ║  │      char cars[Maxcar+1];    // 字符数组 (10001 bytes)          │    ║   │
│   ║  │  };                                                             │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │  ┌───────────────────────────────────────────────────────────┐  │    ║   │
│   ║  │  │  onecarpage (当前页)                                      │  │    ║   │
│   ║  │  │  ┌─────┬─────────────────────────────────────────────────┐│  │    ║   │
│   ║  │  │  │next │ "1H," "6HNoname" "7Hhhh.igs" ... [空闲空间]     ││  │    ║   │
│   ║  │  │  └──┬──┴─────────────────────────────────────────────────┘│  │    ║   │
│   ║  │  │     │                                                     │  │    ║   │
│   ║  │  │     ▼                                                     │  │    ║   │
│   ║  │  │  ┌─────┬─────────────────────────────────────────────────┐│  │    ║   │
│   ║  │  │  │next │ [更早的字符数据...]                             ││  │    ║   │
│   ║  │  │  └──┬──┴─────────────────────────────────────────────────┘│  │    ║   │
│   ║  │  │     │                                                     │  │    ║   │
│   ║  │  │     ▼                                                     │  │    ║   │
│   ║  │  │   NULL                                                    │  │    ║   │
│   ║  │  └───────────────────────────────────────────────────────────┘  │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                                                                 │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  参数页 (parpage) - 存储 oneparam 结构体                                 ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  #define Maxpar 20000                                           │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │  struct parpage {                                               │    ║   │
│   ║  │      struct parpage* next;                                      │    ║   │
│   ║  │      int used;                                                  │    ║   │
│   ║  │      struct oneparam params[Maxpar+1];  // 20001 个参数槽位     │    ║   │
│   ║  │  };                                                             │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                                                                 │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  目录页 (dirpage) - 存储 dirpart 结构体                                  ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  #define Maxparts 1000                                          │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │  struct dirpage {                                               │    ║   │
│   ║  │      int used;                                                  │    ║   │
│   ║  │      struct dirpage *next;                                      │    ║   │
│   ║  │      struct dirpart parts[Maxparts];  // 1000 个实体槽位        │    ║   │
│   ║  │  };                                                             │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │  firstpage → page1 → page2 → ... → NULL                        │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  初始化函数: iges_initfile()                                             │   │
│   │                                                                         │   │
│   │  分配:                                                                   │   │
│   │  - 1 个 carpage (字符存储)                                               │   │
│   │  - 1 个 parpage (参数存储)                                               │   │
│   │  - 1 个 dirpage (实体存储)                                               │   │
│   │  - starts (S 段参数列表)                                                 │   │
│   │  - header (G 段参数列表)                                                 │   │
│   │                                                                         │   │
│   │  curlist = starts;  // 初始指向 S 段                                     │   │
│   │  nbparts = nbparams = 0;                                                │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、iges_Dsect 详解 (D 段解析)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        iges_Dsect D 段解析流程                                   │
│                                                                                 │
│   D 段每个实体占用 2 行，使用状态机处理:                                         │
│   - Dstat = 0: 准备读取第一行                                                    │
│   - Dstat = 1: 准备读取第二行                                                    │
│                                                                                 │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  D 段第一行格式 (奇数行 D1, D3, D5...)                                   ║   │
│   ║                                                                          ║   │
│   ║  位置:  1-8   9-16  17-24 25-32 33-40 41-48 49-56 57-64 65-66 67-68 69-70 71-72║
│   ║  字段:  typ   poi   pdef  tra   niv   vue   trf   aff   blk   sub   use   her  ║
│   ║                                                                          ║   │
│   ║  ┌────────────────────────────────────────────────────────────────────┐  ║   │
│   ║  │  typ  = Entity Type Number      (如 110=Line, 100=Arc)            │  ║   │
│   ║  │  poi  = Parameter Data Pointer  (P 段起始行号)                    │  ║   │
│   ║  │  pdef = Structure               (结构定义指针)                    │  ║   │
│   ║  │  tra  = Line Font Pattern       (线型)                            │  ║   │
│   ║  │  niv  = Level                   (图层)                            │  ║   │
│   ║  │  vue  = View                    (视图)                            │  ║   │
│   ║  │  trf  = Transformation Matrix   (变换矩阵指针)                    │  ║   │
│   ║  │  aff  = Label Display           (标签显示)                        │  ║   │
│   ║  │  blk  = Blank Status            (00=可见, 01=不可见)              │  ║   │
│   ║  │  sub  = Subordinate Switch      (独立/物理/逻辑依赖)              │  ║   │
│   ║  │  use  = Entity Use Flag         (几何/注释/定义等)                │  ║   │
│   ║  │  her  = Hierarchy               (全局推迟/全局/层次)              │  ║   │
│   ║  └────────────────────────────────────────────────────────────────────┘  ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                                                                 │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  D 段第二行格式 (偶数行 D2, D4, D6...)                                   ║   │
│   ║                                                                          ║   │
│   ║  位置:  1-8   9-16  17-24 25-32 33-40 41-48 49-56 57-64 65-72           ║   │
│   ║  字段:  typ2  epa   col   nbl   form  res1  res2  nom   num             ║   │
│   ║                                                                          ║   │
│   ║  ┌────────────────────────────────────────────────────────────────────┐  ║   │
│   ║  │  typ2 = Entity Type (重复)                                        │  ║   │
│   ║  │  epa  = Line Weight Number      (线宽等级)                        │  ║   │
│   ║  │  col  = Color Number            (颜色编号)                        │  ║   │
│   ║  │  nbl  = Parameter Line Count    (P 段行数)                        │  ║   │
│   ║  │  form = Form Number             (实体形式编号)                    │  ║   │
│   ║  │  res1 = Reserved                (保留字段)                        │  ║   │
│   ║  │  res2 = Reserved                (保留字段)                        │  ║   │
│   ║  │  nom  = Entity Label            (实体标签)                        │  ║   │
│   ║  │  num  = Entity Subscript        (实体下标号)                      │  ║   │
│   ║  └────────────────────────────────────────────────────────────────────┘  ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                                                                 │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  解析代码                                                                ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  void iges_Dsect(int *Dstat, int numsec, char* line) {          │    ║   │
│   ║  │      if (*Dstat == 0) {     // 第一行                           │    ║   │
│   ║  │          iges_newpart(numsec);  // 创建新实体                   │    ║   │
│   ║  │          curp = iges_get_curp();                                │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │          // 使用 IGES_decode 从固定位置解码整数                 │    ║   │
│   ║  │          curp->typ  = IGES_decode(line, 0, 8);   // 位置 1-8    │    ║   │
│   ║  │          curp->poi  = IGES_decode(line, 8, 8);   // 位置 9-16   │    ║   │
│   ║  │          curp->pdef = IGES_decode(line, 16, 8);  // 位置 17-24  │    ║   │
│   ║  │          // ... 其余字段 ...                                    │    ║   │
│   ║  │          curp->her  = IGES_decode(line, 70, 2);  // 位置 71-72  │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │          *Dstat = 1;  // 切换到等待第二行                       │    ║   │
│   ║  │      }                                                          │    ║   │
│   ║  │      else if (*Dstat == 1) {  // 第二行                         │    ║   │
│   ║  │          curp->typ2 = IGES_decode(line, 0, 8);                  │    ║   │
│   ║  │          curp->epa  = IGES_decode(line, 8, 8);                  │    ║   │
│   ║  │          curp->col  = IGES_decode(line, 16, 8);                 │    ║   │
│   ║  │          curp->nbl  = IGES_decode(line, 24, 8);                 │    ║   │
│   ║  │          curp->form = IGES_decode(line, 32, 8);                 │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │          // 使用 IGES_copstr 复制字符串字段                     │    ║   │
│   ║  │          IGES_copstr(line, 40, 8, curp->res1);                  │    ║   │
│   ║  │          IGES_copstr(line, 48, 8, curp->res2);                  │    ║   │
│   ║  │          IGES_copstr(line, 56, 8, curp->nom);                   │    ║   │
│   ║  │          IGES_copstr(line, 64, 8, curp->num);                   │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │          *Dstat = 0;  // 重置，准备下一个实体                   │    ║   │
│   ║  │      }                                                          │    ║   │
│   ║  │  }                                                              │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  IGES_decode 辅助函数 - 从固定位置解码整数                               │   │
│   │                                                                         │   │
│   │  static int bases[] = {1,10,100,1000,10000,100000,...};                 │   │
│   │                                                                         │   │
│   │  int IGES_decode(char* line, int depuis, int tant) {                    │   │
│   │      int val = 0;                                                       │   │
│   │      int depart = depuis + tant - 1;  // 从右向左读                     │   │
│   │      for (i = 0; i < tant; i++) {                                       │   │
│   │          char uncar = line[depart - i];                                 │   │
│   │          if (uncar == ' ') break;      // 空格结束                      │   │
│   │          else if (uncar == '+') continue;                               │   │
│   │          else if (uncar == '-') val = -val;                             │   │
│   │          else if (uncar != '0') val += (uncar - 48) * bases[i];         │   │
│   │      }                                                                  │   │
│   │      return val;                                                        │   │
│   │  }                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 八、iges_param 详解 (参数解析状态机)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        iges_param 参数解析状态机                                 │
│                                                                                 │
│   函数原型:                                                                      │
│   void iges_param(int *Pstat, char *line, char c_separ, char c_fin, int lonlin)│
│                                                                                 │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  Pstat 状态含义                                                          ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  输入状态:                                                       │    ║   │
│   ║  │    0 = 实体开始 (新实体的第一个参数)                            │    ║   │
│   ║  │    1 = 行开始 (新行的第一个参数)                                │    ║   │
│   ║  │    2 = 当前行继续 (还有更多参数)                                │    ║   │
│   ║  │    3 = Hollerith 未完成 (跨行字符串)                            │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │  输出状态:                                                       │    ║   │
│   ║  │    0 = 实体结束 (遇到 c_fin)                                    │    ║   │
│   ║  │    1 = 行结束                                                   │    ║   │
│   ║  │    2 = 解析了一个参数，还有更多                                 │    ║   │
│   ║  │    3 = Hollerith 跨行 (需要继续读取)                            │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                                                                 │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  参数类型识别流程                                                        ║   │
│   ║                                                                          ║   │
│   ║  初始: typarg = ArgVide (空)                                             ║   │
│   ║                                                                          ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  for each character in line:                                    │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │  ┌──────────────┬─────────────────────────────────────────────┐│    ║   │
│   ║  │  │  字符        │  类型转换规则                               ││    ║   │
│   ║  │  ├──────────────┼─────────────────────────────────────────────┤│    ║   │
│   ║  │  │  '0'-'9'     │  Vide → Int                                 ││    ║   │
│   ║  │  │              │  Int → Int (保持)                           ││    ║   │
│   ║  │  │              │  Exp → Rexp (完成指数)                      ││    ║   │
│   ║  │  ├──────────────┼─────────────────────────────────────────────┤│    ║   │
│   ║  │  │  '+' / '-'   │  Vide → Sign                                ││    ║   │
│   ║  │  │              │  其他 → Quid (除非在 Exp 后)                 ││    ║   │
│   ║  │  ├──────────────┼─────────────────────────────────────────────┤│    ║   │
│   ║  │  │  '.'         │  Vide/Int/Sign → Real                       ││    ║   │
│   ║  │  │              │  其他 → Quid                                ││    ║   │
│   ║  │  ├──────────────┼─────────────────────────────────────────────┤│    ║   │
│   ║  │  │  'E'/'e'/    │  Real → Exp                                 ││    ║   │
│   ║  │  │  'D'/'d'     │  Int/Sign → Mexp (无小数点的指数)           ││    ║   │
│   ║  │  │              │  其他 → Quid                                ││    ║   │
│   ║  │  ├──────────────┼─────────────────────────────────────────────┤│    ║   │
│   ║  │  │  'H'         │  Int → Char (Hollerith 格式)                ││    ║   │
│   ║  │  │              │  其他 → Quid                                ││    ║   │
│   ║  │  ├──────────────┼─────────────────────────────────────────────┤│    ║   │
│   ║  │  │  ' ' (空格)  │  前导空格跳过                               ││    ║   │
│   ║  │  │              │  尾随空格等待后续                           ││    ║   │
│   ║  │  ├──────────────┼─────────────────────────────────────────────┤│    ║   │
│   ║  │  │  c_separ     │  参数结束，输出当前参数                     ││    ║   │
│   ║  │  │  (逗号)      │  Pstat = 2                                  ││    ║   │
│   ║  │  ├──────────────┼─────────────────────────────────────────────┤│    ║   │
│   ║  │  │  c_fin       │  记录结束                                   ││    ║   │
│   ║  │  │  (分号)      │  Pstat = 0 或 1                             ││    ║   │
│   ║  │  └──────────────┴─────────────────────────────────────────────┘│    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
│                                                                                 │
│   ╔═════════════════════════════════════════════════════════════════════════╗   │
│   ║  Hollerith 字符串处理                                                    ║   │
│   ║                                                                          ║   │
│   ║  格式: nH<n个字符>                                                       ║   │
│   ║  例如: 6HNoname = "Noname"                                               ║   │
│   ║                                                                          ║   │
│   ║  ┌─────────────────────────────────────────────────────────────────┐    ║   │
│   ║  │  if (unpar == 'H' && typarg == ArgInt) {                        │    ║   │
│   ║  │      typarg = ArgChar;                                          │    ║   │
│   ║  │      nbcarH = <前面的数字>;  // 如 "6H" 中的 6                  │    ║   │
│   ║  │                                                                 │    ║   │
│   ║  │      if (当前行放不下全部字符) {                                │    ║   │
│   ║  │          // 读取本行剩余部分                                    │    ║   │
│   ║  │          iges_newparam(ArgChar, len, param);                    │    ║   │
│   ║  │          *Pstat = 3;      // 标记需要继续                       │    ║   │
│   ║  │          nbcarH = 剩余字符数;                                   │    ║   │
│   ║  │          return;                                                │    ║   │
│   ║  │      } else {                                                   │    ║   │
│   ║  │          // 读取完整字符串                                      │    ║   │
│   ║  │          for (j = 1; j <= nbcarH; j++)                          │    ║   │
│   ║  │              param[i+j] = line[numcar+i+j];                     │    ║   │
│   ║  │          i += nbcarH;                                           │    ║   │
│   ║  │      }                                                          │    ║   │
│   ║  │  }                                                              │    ║   │
│   ║  └─────────────────────────────────────────────────────────────────┘    ║   │
│   ╚═════════════════════════════════════════════════════════════════════════╝   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 九、参数类型状态转换图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        参数类型识别状态转换图                                    │
│                                                                                 │
│                              ┌─────────────────┐                                │
│                              │    ArgVide      │                                │
│                              │    (初始)       │                                │
│                              └────────┬────────┘                                │
│                                       │                                         │
│          ┌────────────────────────────┼────────────────────────────┐            │
│          │ 数字                       │ +/-                        │ .          │
│          ▼                            ▼                            ▼            │
│   ┌──────────────┐            ┌──────────────┐            ┌──────────────┐      │
│   │   ArgInt     │            │   ArgSign    │            │   ArgReal    │      │
│   │ (无符号整数)  │            │ (带符号整数)  │            │   (实数)     │      │
│   └──────┬───────┘            └──────┬───────┘            └──────┬───────┘      │
│          │                           │                           │              │
│          ├─── . ────→ ArgReal ←───── . ─────┘                    │              │
│          │                                                       │              │
│          │                           │                           │              │
│          ├─── H ────→ ArgChar (Hollerith)                        │              │
│          │                                                       │              │
│          │                           │                           │              │
│          ├─── E/D ──→ ArgMexp        ├─── E/D ──→ ArgMexp        ├─── E/D ──→ ArgExp
│          │           (无小数点指数)  │           (无小数点指数)  │           (指数)
│          │                           │                           │              │
│          │                           │                           │              │
│          ▼                           ▼                           ▼              │
│   ┌──────────────────────────────────────────────────────────────────────┐      │
│   │                          ArgRexp (完整科学计数法)                     │      │
│   │                          当 Exp/Mexp 后跟数字时                       │      │
│   └──────────────────────────────────────────────────────────────────────┘      │
│                                                                                 │
│   任何状态 + 不匹配字符 → ArgQuid (未知/混合类型)                               │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  示例:                                                                   │   │
│   │                                                                         │   │
│   │  "123"      : Vide → Int → Int → Int         最终: ArgInt              │   │
│   │  "-456"     : Vide → Sign → Int → Int → Int  最终: ArgSign             │   │
│   │  "3.14"     : Vide → Int → Real → Int → Int  最终: ArgReal             │   │
│   │  "1.0E-6"   : Vide → Int → Real → Int → Exp → Sign → Rexp              │   │
│   │  "6HNoname" : Vide → Int → Char              最终: ArgChar             │   │
│   │  "1D3"      : Vide → Int → Mexp → Rexp       最终: ArgRexp (1000)      │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 十、完整数据流示意图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          igesread 数据流完整图                                   │
│                                                                                 │
│   IGES 文件 (hhh.igs)                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  S段: "3D InterOp IGES..."                                              │   │
│   │  G段: "1H,,1H;,6HNoname,7Hhhh.igs..."                                    │   │
│   │  D段: "     110       1       0       0       0       0       0 ..."    │   │
│   │        "     110       0       0       1       0                  ..."    │   │
│   │  P段: "110,0.0,0.0,0.0,1.0,1.0,1.0;                           1P      1"│   │
│   │  T段: "S      1G      3D     10P      5                        T      1"│   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                          igesread() 主函数                               │   │
│   │                                                                         │   │
│   │   ┌──────────────────────────────────────────────────────────────────┐  │   │
│   │   │  iges_lire() - 逐行读取                                          │  │   │
│   │   │  返回: (段类型, 行号, 行内容)                                     │  │   │
│   │   └──────────────────────────────────────────────────────────────────┘  │   │
│   │                              │                                          │   │
│   │   ┌──────────────────────────┼──────────────────────────┐               │   │
│   │   ▼                          ▼                          ▼               │   │
│   │   S段                        G段                        D段+P段          │   │
│   │   ┌──────────────┐   ┌──────────────┐   ┌────────────────────────────┐  │   │
│   │   │iges_newparam │   │iges_setglobal│   │iges_Dsect + iges_Psect   │  │   │
│   │   │存储到 starts │   │iges_param    │   │iges_param                │  │   │
│   │   │              │   │存储到 header │   │存储到 firstpage→dirpart[] │  │   │
│   │   └──────────────┘   └──────────────┘   └────────────────────────────┘  │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                          内存中的 C 结构体                               │   │
│   │                                                                         │   │
│   │   starts (S段)              header (G段)           firstpage (D+P段)    │   │
│   │   ┌──────────────┐         ┌──────────────┐        ┌──────────────────┐ │   │
│   │   │parlist       │         │parlist       │        │dirpage           │ │   │
│   │   │ ┌─────────┐  │         │ ┌─────────┐  │        │ ┌──────────────┐ │ │   │
│   │   │ │oneparam │  │         │ │oneparam │  │        │ │dirpart[0]    │ │ │   │
│   │   │ │typ=0    │  │         │ │typ=2    │  │        │ │typ=110       │ │ │   │
│   │   │ │val="3D..│  │         │ │val="1H,"│  │        │ │poi=1         │ │ │   │
│   │   │ │next ────┼──┤         │ │next ────┼──┤        │ │...           │ │ │   │
│   │   │ └─────────┘  │         │ └─────────┘  │        │ │list (P段参数)│ │ │   │
│   │   │      ▼       │         │      ▼       │        │ └──────────────┘ │ │   │
│   │   │    NULL      │         │ ┌─────────┐  │        │ ┌──────────────┐ │ │   │
│   │   │              │         │ │oneparam │  │        │ │dirpart[1]    │ │ │   │
│   │   │              │         │ │typ=2    │  │        │ │...           │ │ │   │
│   │   │              │         │ │val="1H;"│  │        │ └──────────────┘ │ │   │
│   │   │              │         │ │...      │  │        │       ...        │ │   │
│   │   └──────────────┘         └──────────────┘        └──────────────────┘ │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                          供 C++ 层读取的接口                             │   │
│   │                                                                         │   │
│   │   iges_stats(&nbpart, &nbparam)  - 获取统计信息                         │   │
│   │   iges_lirpart(...)              - 读取一个 dirpart                     │   │
│   │   iges_lirparam(...)             - 读取一个参数                         │   │
│   │   iges_nextpart()                - 移动到下一个 dirpart                 │   │
│   │   iges_finfile(mode)             - 释放内存                             │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  C++ 层 (IGESFile_Read.cxx)                                              │   │
│   │  IGESData_IGESReaderData                                                 │   │
│   │  IGESData_IGESReaderTool                                                 │   │
│   │  IGESData_IGESModel                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 十一、调试技巧

### 11.1 关键断点位置

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              推荐断点位置                                        │
│                                                                                 │
│   文件: igesread.c                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  Line 55:  int igesread(...)          ← 入口点                          │   │
│   │  Line 63:  iges_initfile()            ← 初始化                          │   │
│   │  Line 72:  i = iges_lire(...)         ← 每行读取                        │   │
│   │  Line 98:  if (i == 1)                ← S 段处理                        │   │
│   │  Line 102: if (i == 2)                ← G 段处理                        │   │
│   │  Line 114: if (i == 3)                ← D 段处理                        │   │
│   │  Line 115: if (i == 4)                ← P 段处理                        │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│   文件: liriges.c                                                               │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  Line 34:  int iges_lire(...)         ← 行读取入口                      │   │
│   │  Line 48:  fgets(...)                 ← 实际文件读取                    │   │
│   │  Line 108: switch (typesec)           ← 段类型判断                      │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│   文件: analiges.c                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  Line 76:  void iges_Dsect(...)       ← D 段解析                        │   │
│   │  Line 120: void iges_Psect(...)       ← P 段预处理                      │   │
│   │  Line 150: void iges_param(...)       ← 参数解析                        │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│   文件: structiges.c                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  Line 113: void iges_initfile()       ← 内存初始化                      │   │
│   │  Line 139: void iges_newpart(...)     ← 新建 dirpart                    │   │
│   │  Line 192: void iges_newparam(...)    ← 新建参数                        │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 11.2 LLDB 调试命令

```bash
# 设置断点
breakpoint set --name igesread
breakpoint set --file igesread.c --line 72

# 查看当前行内容
p ligne

# 查看段类型
p i

# 查看当前 dirpart
p *curp

# 查看参数类型
p typarg

# 查看段行数统计
p lesect

# 单步执行
n (next) 或 s (step into)

# 继续执行
c (continue)
```

---

## 十二、总结

`igesread` 函数是 IGES 文件解析的核心，采用纯 C 语言实现以获得最佳性能。其设计特点：

| 特性 | 实现方式 |
|------|----------|
| **分层架构** | 行读取 → 段识别 → 参数解析 → 结构存储 |
| **状态机** | D 段使用 Dstat，P 段使用 Pstat 控制多行处理 |
| **内存管理** | 分页机制避免频繁小块分配 |
| **类型识别** | 字符级扫描，逐步确定参数类型 |
| **跨行处理** | Hollerith 字符串支持跨行 |
| **容错性** | 多处错误检查和警告机制 |

这种设计使得 IGES 文件解析既高效又健壮，能够处理各种格式变体和错误情况。

---

**文档版本**: 1.0
**创建日期**: 2024-12-30
**基于源码版本**: OpenCASCADE 7.x
**相关文档**: [IGESFile_Read-visual-guide.md](./IGESFile_Read-visual-guide.md)
