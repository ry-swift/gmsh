# iges_lire 函数详解：IGES 文件行级读取器

## 1. 概述

`iges_lire` 是 OpenCASCADE IGES 文件解析器中的**核心底层函数**，负责逐行读取 IGES 文件并解析每行的结构信息。

### 函数签名

```c
int iges_lire(FILE* lefic, int *numsec, char line[100], int modefnes)
```

### 参数说明

| 参数 | 类型 | 方向 | 说明 |
|------|------|------|------|
| `lefic` | `FILE*` | 输入 | 已打开的 IGES 文件指针 |
| `numsec` | `int*` | 输入/输出 | Section 内的行号 (列 74-80) |
| `line` | `char[100]` | 输出 | 读取的行内容缓冲区 |
| `modefnes` | `int` | 输入 | FNES 兼容模式标志 (0=标准, 1=FNES) |

### 函数位置

```
OCCT/src/DataExchange/TKDEIGES/IGESFile/liriges.c:34
```

---

## 2. IGES 文件格式图解

IGES 文件采用**固定 80 列**的文本格式，每行结构如下：

```
┌──────────────────────────────────────────────────────────────────────────┬───┬───────┐
│                                                                          │   │       │
│                        数据内容区域 (列 1-72)                              │ S │  001  │
│                                                                          │   │       │
│         包含：参数值、实体定义、几何数据、注释文本等                        │ e │ 行号  │
│                                                                          │ c │       │
│                                                                          │ t │ 74-80 │
│                                                                          │   │       │
└──────────────────────────────────────────────────────────────────────────┴───┴───────┘
 列1                                                                     列72 列73      列80
                                                                          ↑
                                                                    Section 标识符
```

### 列索引对照表 (C 语言从 0 开始)

```
IGES 标准列号:    1  2  3 ... 72  73  74  75  76  77  78  79  80
C 数组索引:       0  1  2 ... 71  72  73  74  75  76  77  78  79
                  └──────────────┘  │   └────────────────────────┘
                     数据内容      Section        行号
                    (72 字符)     标识符       (7 字符)
```

### IGES 文件五大 Section

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              IGES 文件结构                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  S Section (Start)     - 起始段                                          │   │
│  │  ─────────────────────────────────────────────────────────────────────   │   │
│  │  包含人类可读的注释信息，如文件来源、创建日期、作者等                      │   │
│  │  列 73 = 'S'                                                             │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                    ↓                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  G Section (Global)    - 全局段                                          │   │
│  │  ─────────────────────────────────────────────────────────────────────   │   │
│  │  定义文件级参数：分隔符、单位、精度、模型空间范围等                        │   │
│  │  列 73 = 'G'                                                             │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                    ↓                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  D Section (Directory)  - 目录段                                         │   │
│  │  ─────────────────────────────────────────────────────────────────────   │   │
│  │  每个实体占用 2 行，包含实体类型、属性、指针等元数据                       │   │
│  │  列 73 = 'D'                                                             │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                    ↓                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  P Section (Parameter)  - 参数段                                         │   │
│  │  ─────────────────────────────────────────────────────────────────────   │   │
│  │  存储实体的具体参数数据（坐标、控制点、权重等）                            │   │
│  │  列 73 = 'P'                                                             │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                    ↓                                            │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  T Section (Terminate)  - 终止段                                         │   │
│  │  ─────────────────────────────────────────────────────────────────────   │   │
│  │  仅 1 行，记录各 Section 的行数统计                                       │   │
│  │  列 73 = 'T'                                                             │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 实际 IGES 文件示例

```
                                                                        S      1
1H,,1H;,7Hexample.igs,17HOpenCASCADE 7.0.0,32,38,6,308,15,,1.0,2,2HMM,1,G      1
0.0001,15.0,,11Hunspecified,1.0,0;                                      G      2
     110       1       0       0       0       0       0       000000001D      1
     110       0       0       1       0                               0D      2
110,0.0,0.0,0.0,10.0,0.0,0.0;                                          1P      1
S      1G      2D      2P      1                                        T      1
 ↑                                                                      ↑      ↑
 数据内容                                                          Section  行号
                                                                   标识符
```

---

## 3. iges_lire 函数流程图

```
                              ┌─────────────────┐
                              │     开始        │
                              └────────┬────────┘
                                       │
                                       ▼
                        ┌──────────────────────────────┐
                        │  检查 iges_fautrelire 标志    │
                        │  (是否需要重新读取当前行)      │
                        └──────────────┬───────────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                      │
              fautrelire = 0                         fautrelire = 1
              (正常读取)                              (跳过读取)
                    │                                      │
                    ▼                                      │
        ┌───────────────────────┐                         │
        │   fgets 读取一行       │                         │
        │   (最多 80 字符)       │                         │
        └───────────┬───────────┘                         │
                    │                                      │
                    ▼                                      │
            ┌───────────────┐                              │
            │  读取成功?     │                              │
            └───────┬───────┘                              │
                    │                                      │
           ┌────────┴────────┐                             │
           │                 │                             │
         失败               成功                            │
           │                 │                             │
           ▼                 │                             │
    ┌──────────┐             │                             │
    │ 返回 0   │             │                             │
    │ (EOF)    │             │                             │
    └──────────┘             │                             │
                             ▼                             │
            ┌────────────────────────────┐                 │
            │  首行特殊处理:              │                 │
            │  检测 FNES 格式             │                 │
            │  (列72!='S' && 列79==' ')  │                 │
            └────────────────┬───────────┘                 │
                             │                             │
                             ▼                             │
            ┌────────────────────────────┐                 │
            │  处理加密/编码数据          │                 │
            │  (modefnes 模式)           │                 │
            └────────────────┬───────────┘                 │
                             │                             │
                             ◄─────────────────────────────┘
                             │
                             ▼
            ┌────────────────────────────┐
            │  检查 EOF 和特殊字符        │
            │  (0x1A = DOS EOF)          │
            └────────────────┬───────────┘
                             │
                             ▼
            ┌────────────────────────────┐
            │  行是否为空?               │
            │  (空行/换行符)              │
            └────────────────┬───────────┘
                             │
                    ┌────────┴────────┐
                    │                 │
                  空行              非空行
                    │                 │
                    ▼                 │
        ┌───────────────────┐        │
        │ 递归调用 iges_lire │        │
        │ (读取下一行)       │        │
        └───────────────────┘        │
                                      │
                                      ▼
                   ┌──────────────────────────────┐
                   │  解析列 73 的 Section 标识符   │
                   │  解析列 74-80 的行号           │
                   └──────────────┬───────────────┘
                                  │
                                  ▼
                   ┌──────────────────────────────┐
                   │     根据 Section 类型返回     │
                   └──────────────┬───────────────┘
                                  │
        ┌─────────┬─────────┬─────┴─────┬─────────┬─────────┐
        │         │         │           │         │         │
        ▼         ▼         ▼           ▼         ▼         ▼
    ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐
    │ 'S'   │ │ 'G'   │ │ 'D'   │ │ 'P'   │ │ 'T'   │ │ 其他  │
    │返回 1 │ │返回 2 │ │返回 3 │ │返回 4 │ │返回 5 │ │返回-1 │
    └───────┘ └───────┘ └───────┘ └───────┘ └───────┘ └───────┘
```

---

## 4. 返回值说明

| 返回值 | Section | 含义 |
|:------:|:-------:|------|
| **0** | - | 文件结束 (EOF) |
| **1** | S | Start Section - 起始注释段 |
| **2** | G | Global Section - 全局参数段 |
| **3** | D | Directory Section - 目录段 |
| **4** | P | Parameter Section - 参数数据段 |
| **5** | T | Terminate Section - 终止段 |
| **-1** | - | 解析错误，尝试跳过该行继续 |
| **-2** | - | 列 73 标识符格式错误 |

---

## 5. 函数调用关系图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           IGES 文件读取调用链                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │   用户程序      │
                              │  (Gmsh/OCCT)   │
                              └────────┬────────┘
                                       │
                                       ▼
                         ┌─────────────────────────┐
                         │     igesread()          │
                         │   (igesread.c:55)       │
                         │                         │
                         │  主入口函数，协调整个    │
                         │  IGES 文件读取流程      │
                         └────────────┬────────────┘
                                      │
           ┌──────────────────────────┼──────────────────────────┐
           │                          │                          │
           ▼                          ▼                          ▼
┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────────┐
│  iges_initfile()     │  │    iges_lire()       │  │  iges_finfile()      │
│  (structiges.c:113)  │  │   (liriges.c:34)     │  │  (structiges.c:288)  │
│                      │  │                      │  │                      │
│  初始化内存结构       │  │  ◀─── 循环调用 ───   │  │  清理释放内存         │
│  分配存储页面         │  │  读取每一行          │  │                      │
└──────────────────────┘  └──────────┬───────────┘  └──────────────────────┘
                                     │
                                     │ 返回 Section 类型
                                     ▼
           ┌─────────────────────────┴─────────────────────────┐
           │                                                    │
           ▼                                                    ▼
┌─────────────────────────────┐              ┌─────────────────────────────┐
│  Section-specific 处理       │              │  数据存储函数                │
├─────────────────────────────┤              ├─────────────────────────────┤
│                             │              │                             │
│  i=1 (S): iges_newparam()   │              │  iges_newparam()            │
│  ─────────────────────────  │              │   - 添加新参数               │
│  存储注释文本               │              │                             │
│                             │              │  iges_newpart()             │
│  i=2 (G): iges_param()      │              │   - 创建新实体               │
│  ─────────────────────────  │              │                             │
│  解析全局参数               │              │  iges_setglobal()           │
│                             │              │   - 切换到 Header 段        │
│  i=3 (D): iges_Dsect()      │              │                             │
│  ─────────────────────────  │              └─────────────────────────────┘
│  解析 Directory Entry       │
│                             │
│  i=4 (P): iges_Psect()      │
│  ─────────────────────────  │
│  解析参数数据               │
│                             │
│  i=5 (T): 结束循环           │
│                             │
└─────────────────────────────┘
```

---

## 6. 完整源代码 (带详细注释)

```c
// ═══════════════════════════════════════════════════════════════════════════════
// 文件: liriges.c
// 位置: OCCT/src/DataExchange/TKDEIGES/IGESFile/liriges.c
// 功能: IGES 文件基础行读取例程
// ═══════════════════════════════════════════════════════════════════════════════

#include "igesread.h"
#include <string.h>

// ───────────────────────────────────────────────────────────────────────────────
// 静态全局变量: 重读标志
// ───────────────────────────────────────────────────────────────────────────────
// 作用: 控制是否跳过文件读取，直接使用上次读取的行
// 场景: Section 切换时，已经读取了下一个 Section 的第一行，
//       需要"退回"让上层重新处理该行
// ───────────────────────────────────────────────────────────────────────────────
static int iges_fautrelire = 0;

// ═══════════════════════════════════════════════════════════════════════════════
// 函数: iges_lire
// ═══════════════════════════════════════════════════════════════════════════════
// 功能: 从 IGES 文件读取一行，解析 Section 类型和行号
//
// 参数:
//   lefic    - [输入]  文件指针
//   numsec   - [输入/输出] Section 内的行号
//   line     - [输出] 读取的行内容 (至少 100 字节)
//   modefnes - [输入]  FNES 兼容模式 (0=标准, 1=FNES)
//
// 返回值:
//   0  - 文件结束 (EOF)
//   1  - Start Section ('S')
//   2  - Global Section ('G')
//   3  - Directory Section ('D')
//   4  - Parameter Section ('P')
//   5  - Terminate Section ('T')
//   -1 - 解析错误，跳过该行
//   -2 - 列 73 格式错误
// ═══════════════════════════════════════════════════════════════════════════════
int iges_lire(FILE* lefic, int *numsec, char line[100], int modefnes)
{
  int i, result;      // i: 循环索引, result: 解析出的行号
  char typesec;       // Section 类型字符 ('S'/'G'/'D'/'P'/'T')

  // ─────────────────────────────────────────────────────────────────────────────
  // 第一部分: 行读取控制
  // ─────────────────────────────────────────────────────────────────────────────
  // 检查是否需要跳过读取 (使用上次已读取的行)
  // 当 iges_fautrelire = 1 时，表示上层调用了 iges_arelire()，
  // 要求"重新处理当前行"，此时不需要读取新行
  // ─────────────────────────────────────────────────────────────────────────────
  if (iges_fautrelire == 0)  // 正常模式: 需要读取新行
  {
    // ─────────────────────────────────────────────────────────────────────────
    // 首行初始化: 当 numsec = 0 时，说明还没有读取任何有效行
    // 预先设置 line[72] 和 line[79] 为空格，用于后续的 FNES 格式检测
    // ─────────────────────────────────────────────────────────────────────────
    if (*numsec == 0)
      line[72] = line[79] = ' ';

    // 清空缓冲区首字符 (用于后续空行检测)
    line[0] = '\0';

    // ─────────────────────────────────────────────────────────────────────────
    // 读取一行: 根据 modefnes 模式选择不同的读取策略
    // ─────────────────────────────────────────────────────────────────────────
    if (modefnes)
    {
      // FNES 兼容模式: 直接读取整行 (最多 99 字符)
      // FNES 是一种旧的 IGES 变体格式
      if (fgets(line, 99, lefic) == NULL)
        return 0;  // EOF
    }
    else
    {
      // ─────────────────────────────────────────────────────────────────────
      // 标准模式: 特殊处理仅有 \r 没有 \n 的文件
      //
      // 背景: 某些旧系统生成的 IGES 文件使用 \r (CR) 作为行结束符，
      //       而不是 Unix 的 \n (LF) 或 Windows 的 \r\n (CRLF)
      //
      // 策略: 先读取 1 个字符，跳过所有的 \r 和 \n，
      //       然后从第 2 个位置开始读取剩余内容
      // ─────────────────────────────────────────────────────────────────────
      while (fgets(line, 2, lefic) && (line[0] == '\r' || line[0] == '\n'))
      {
        // 循环跳过空白行
      }

      // 从 line[1] 开始读取剩余 79 个字符
      // 注意: line[0] 已经在上面的 while 循环中被设置
      if (fgets(&line[1], 80, lefic) == NULL)
        return 0;  // EOF
    }

    // ─────────────────────────────────────────────────────────────────────────
    // FNES 格式检测和跳过
    //
    // FNES 文件特征: 第一行不是标准 IGES 格式
    // 检测条件:
    //   - numsec = 0 (这是第一行)
    //   - line[72] != 'S' (列 73 不是 'S')
    //   - line[79] = ' ' (列 80 是空格)
    //
    // 处理: 跳过这一行，重新读取
    // ─────────────────────────────────────────────────────────────────────────
    if (*numsec == 0 && line[72] != 'S' && line[79] == ' ')
    {
      // 检测到 FNES 格式，跳过第一行
      line[0] = '\0';

      // 重新读取 (与上面相同的逻辑)
      if (modefnes)
      {
        if (fgets(line, 99, lefic) == NULL)
          return 0;
      }
      else
      {
        while (fgets(line, 2, lefic) && (line[0] == '\r' || line[0] == '\n'))
        {
        }
        if (fgets(&line[1], 80, lefic) == NULL)
          return 0;
      }
    }

    // ─────────────────────────────────────────────────────────────────────────
    // FNES 数据解密
    //
    // 某些 FNES 文件对数据进行了简单的 XOR 加密
    // 检测条件: line[0] 的最高位为 1 (line[0] & 128)
    // 解密算法: 对每个字节进行 XOR 运算
    //           line[i] = line[i] XOR (150 + (i % 4))
    // ─────────────────────────────────────────────────────────────────────────
    if ((line[0] & 128) && modefnes)
    {
      for (i = 0; i < 80; i++)
        line[i] = (char)(line[i] ^ (150 + (i & 3)));
    }
  }
  // iges_fautrelire = 1 时跳过以上所有读取，直接使用 line 中的旧数据

  // ─────────────────────────────────────────────────────────────────────────────
  // 第二部分: EOF 和特殊字符检测
  // ─────────────────────────────────────────────────────────────────────────────

  // 检查文件是否已到末尾
  if (feof(lefic))
    return 0;

  // ─────────────────────────────────────────────────────────────────────────────
  // DOS/Windows EOF 字符处理
  //
  // 0x1A (Ctrl+Z) 是 DOS/Windows 系统的文件结束标记
  // 某些文本文件可能在末尾包含这个字符
  // ─────────────────────────────────────────────────────────────────────────────
  {
    char *fc = strchr(line, 0x1A);  // 查找 EOF 字符
    if (fc != 0)
    {
      fc[0] = '\0';  // 截断字符串
      return 0;      // 视为文件结束
    }
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // 重置重读标志
  // 无论之前是否跳过了读取，现在都要清除标志
  // ─────────────────────────────────────────────────────────────────────────────
  iges_fautrelire = 0;

  // ─────────────────────────────────────────────────────────────────────────────
  // 空行处理: 递归调用自身读取下一行
  // ─────────────────────────────────────────────────────────────────────────────
  if (line[0] == '\0' || line[0] == '\n' || line[0] == '\r')
    return iges_lire(lefic, numsec, line, modefnes);

  // ─────────────────────────────────────────────────────────────────────────────
  // 第三部分: 标准 IGES 行解析
  // ─────────────────────────────────────────────────────────────────────────────
  // 标准 IGES 行格式:
  //   列 1-72:  数据内容
  //   列 73:    Section 标识符 ('S'/'G'/'D'/'P'/'T')
  //   列 74-80: 行号
  //
  // C 数组索引:
  //   line[0..71]:  数据内容
  //   line[72]:     Section 标识符
  //   line[73..79]: 行号
  // ─────────────────────────────────────────────────────────────────────────────

  // 尝试从 line[73] 开始解析行号
  if (sscanf(&line[73], "%d", &result) == 1)
  {
    *numsec = result;       // 保存行号
    typesec = line[72];     // 获取 Section 标识符

    // 根据 Section 类型返回对应的代码
    switch (typesec) {
      case 'S':  line[72] = '\0'; return (1);  // Start Section
      case 'G':  line[72] = '\0'; return (2);  // Global Section
      case 'D':  line[72] = '\0'; return (3);  // Directory Section
      case 'P':  line[72] = '\0'; return (4);  // Parameter Section
      case 'T':  line[72] = '\0'; return (5);  // Terminate Section
      default:;  // 继续尝试其他解析方法
    }

    // ─────────────────────────────────────────────────────────────────────────
    // 特殊情况: 列 72 为空，尝试修复
    //
    // 某些 IGES 文件生成器可能丢失了一个字符，导致数据整体左移
    // 检测条件:
    //   - 行长度正好 80 字符
    //   - 行末是换行符
    //   - 行首是数字
    // ─────────────────────────────────────────────────────────────────────────
    if (strlen(line) == 80
        && (line[79] == '\n' || line[79] == '\r')
        && (line[0] <= '9' && line[0] >= '0'))
    {
      int index;
      // 扫描开头的连续数字
      for (index = 1; line[index] <= '9' && line[index] >= '0'; index++)
        ;

      // 如果数字后面紧跟 'D' 或 'd'，说明是 Directory Section 行
      // 数据格式可能是: "123D45..." 而不是 ".123D45..."
      if (line[index] == 'D' || line[index] == 'd')
      {
        // 将所有字符右移一位
        for (index = 79; index > 0; index--)
          line[index] = line[index - 1];
        line[0] = '.';  // 在开头补一个点号占位
      }

      // 重新尝试解析
      typesec = line[72];
      switch (typesec) {
        case 'S':  line[72] = '\0'; return (1);
        case 'G':  line[72] = '\0'; return (2);
        case 'D':  line[72] = '\0'; return (3);
        case 'P':  line[72] = '\0'; return (4);
        case 'T':  line[72] = '\0'; return (5);
        default:;
      }
    }
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // 第四部分: 非标准格式容错解析
  // ─────────────────────────────────────────────────────────────────────────────
  // 当标准解析失败时，尝试处理不符合 80 列规范的行
  // 策略: 从行末往前扫描，找到行号和 Section 标识符
  // ─────────────────────────────────────────────────────────────────────────────

  // 从字符串末尾开始扫描
  i = (int)strlen(line);

  // 跳过末尾的空白字符 (空格、换行符、回车符、字符串结束符)
  while ((line[i] == '\0' || line[i] == '\n' ||
          line[i] == '\r' || line[i] == ' ') && i > 0)
    i--;

  // 截断末尾空白
  if (i != (int)strlen(line))
    line[i + 1] = '\0';

  // 向前扫描，找到行号的起始位置 (跳过所有数字)
  while (line[i] >= '0' && line[i] <= '9' && i > 0)
    i--;

  // 尝试解析行号
  if (sscanf(&line[i + 1], "%d", &result) != 1)
    return -1;  // 无法解析行号，返回错误
  *numsec = result;

  // 跳过行号和 Section 标识符之间的空格
  while (line[i] == ' ' && i > 0)
    i--;

  // 获取 Section 标识符
  typesec = line[i];

  // 根据 Section 类型返回
  switch (typesec) {
    case 'S':  line[i] = '\0'; return (1);
    case 'G':  line[i] = '\0'; return (2);
    case 'D':  line[i] = '\0'; return (3);
    case 'P':  line[i] = '\0'; return (4);
    case 'T':  line[i] = '\0'; return (5);
    default:;  // 无法识别的 Section 类型
  }

  return -1;  // 解析完全失败
}

// ═══════════════════════════════════════════════════════════════════════════════
// 函数: iges_arelire
// ═══════════════════════════════════════════════════════════════════════════════
// 功能: 设置"重读当前行"标志
//
// 使用场景:
//   当上层函数读取到下一个 Section 的第一行时，
//   需要"退回"让其他处理函数重新处理这一行
//
// 示例:
//   正在处理 Global Section，读取到一行发现是 'D' (Directory)
//   调用 iges_arelire()，然后返回
//   下次调用 iges_lire() 时，不会读取新行，而是返回之前读取的 'D' 行
// ═══════════════════════════════════════════════════════════════════════════════
void iges_arelire()
{
  iges_fautrelire = 1;
}
```

---

## 7. 逐行代码详解

### 7.1 静态变量 `iges_fautrelire`

```c
static int iges_fautrelire = 0;
```

**功能图解**：

```
                    iges_fautrelire = 0 (默认)
                           │
                           ▼
                    ┌─────────────┐
                    │ iges_lire() │
                    └─────────────┘
                           │
              ┌────────────┴────────────┐
              │                         │
              ▼                         ▼
    iges_fautrelire = 0         iges_fautrelire = 1
    ┌─────────────────┐         ┌─────────────────┐
    │  正常读取新行    │         │  跳过读取       │
    │  fgets(...)     │         │  使用旧数据     │
    └─────────────────┘         └─────────────────┘
                                        ▲
                                        │
                              iges_arelire() 设置
```

**使用场景**：

```
时间线:
  T1: iges_lire() 读取到 "...G      1"  → 返回 2 (Global)
  T2: 上层处理 Global Section
  T3: iges_lire() 读取到 "...D      1"  → 返回 3 (Directory)
  T4: 上层发现还在处理 Global，但已经读到 Directory
      调用 iges_arelire() 设置 iges_fautrelire = 1
  T5: 结束 Global 处理，切换到 Directory 处理
  T6: iges_lire() 被调用，由于 iges_fautrelire = 1
      跳过读取，直接返回之前的 "...D      1"
```

### 7.2 行读取策略

```c
if (modefnes)
{
  if (fgets(line, 99, lefic) == NULL)
    return 0;
}
else
{
  while (fgets(line, 2, lefic) && (line[0] == '\r' || line[0] == '\n'))
  {
  }
  if (fgets(&line[1], 80, lefic) == NULL)
    return 0;
}
```

**两种读取模式对比**：

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           modefnes = 1 (FNES 模式)                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  文件内容:  "DATA LINE CONTENT...                      S      1\n"              │
│                                                                                 │
│  fgets(line, 99, lefic)                                                         │
│  ───────────────────────────────────────────────────────────────                │
│  line[0..98]: 整行内容                                                          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                           modefnes = 0 (标准模式)                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  文件内容:  "\r\r\nDATA LINE CONTENT...                      S      1\n"        │
│                                                                                 │
│  第一步: while (fgets(line, 2, lefic) && (line[0] == '\r' || line[0] == '\n'))  │
│  ─────────────────────────────────────────────────────────────────────────────  │
│                                                                                 │
│     读取 "\r" → line[0] = '\r' → 继续循环                                       │
│     读取 "\r" → line[0] = '\r' → 继续循环                                       │
│     读取 "\n" → line[0] = '\n' → 继续循环                                       │
│     读取 "D"  → line[0] = 'D'  → 退出循环                                       │
│                                                                                 │
│  第二步: fgets(&line[1], 80, lefic)                                             │
│  ─────────────────────────────────────────────────────────────────────────────  │
│                                                                                 │
│     line[0] = 'D' (已设置)                                                      │
│     line[1..79] = "ATA LINE CONTENT...                      S      1\n"         │
│                                                                                 │
│  最终: line = "DATA LINE CONTENT...                      S      1\n"            │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 FNES 格式检测

```c
if (*numsec == 0 && line[72] != 'S' && line[79] == ' ')
```

**检测逻辑图解**：

```
                          ┌─────────────────────────────────┐
                          │     是否为第一行?                │
                          │     (*numsec == 0)              │
                          └─────────────────┬───────────────┘
                                            │
                              ┌─────────────┴─────────────┐
                              │                           │
                             是                          否
                              │                           │
                              ▼                           ▼
                ┌─────────────────────────┐      ┌─────────────────┐
                │  列 73 是否为 'S'?       │      │  正常处理        │
                │  (line[72] != 'S')      │      └─────────────────┘
                └─────────────┬───────────┘
                              │
                ┌─────────────┴─────────────┐
                │                           │
            不是 'S'                       是 'S'
                │                           │
                ▼                           ▼
    ┌─────────────────────────┐    ┌─────────────────┐
    │  列 80 是否为空格?       │    │  标准 IGES 格式  │
    │  (line[79] == ' ')      │    │  正常处理        │
    └─────────────┬───────────┘    └─────────────────┘
                  │
    ┌─────────────┴─────────────┐
    │                           │
   是空格                      不是
    │                           │
    ▼                           ▼
┌───────────────┐      ┌─────────────────┐
│  FNES 格式!    │      │  正常处理        │
│  跳过该行      │      └─────────────────┘
└───────────────┘
```

### 7.4 数据解密 (XOR)

```c
if ((line[0] & 128) && modefnes)
{
  for (i = 0; i < 80; i++)
    line[i] = (char)(line[i] ^ (150 + (i & 3)));
}
```

**XOR 解密示意**：

```
检测条件: line[0] 的最高位 (bit 7) 为 1
          line[0] & 128 = line[0] & 0b10000000

加密字节:    line[i] = 原始数据 XOR (150 + (i % 4))
解密字节:    line[i] = 加密数据 XOR (150 + (i % 4))

XOR 密钥循环:
  i=0: 150 + 0 = 150
  i=1: 150 + 1 = 151
  i=2: 150 + 2 = 152
  i=3: 150 + 3 = 153
  i=4: 150 + 0 = 150  (循环)
  ...

示例:
  原始: 'A' = 65 = 0b01000001
  密钥: 150 = 0b10010110
  加密: 65 XOR 150 = 215 = 0b11010111
  解密: 215 XOR 150 = 65 = 'A'
```

### 7.5 Section 标识符解析

```c
if (sscanf(&line[73], "%d", &result) == 1) {
  *numsec = result;
  typesec = line[72];
  switch (typesec) {
    case 'S':  line[72] = '\0'; return (1);
    // ...
  }
}
```

**内存布局详解**：

```
                             IGES 行 (80 字符)
  ┌──────────────────────────────────────────────────────────────────────────────┐
  │ D A T A   C O N T E N T . . . . . . . . . . . . . . . . │ S │     1 2 3 │ \n │
  └──────────────────────────────────────────────────────────────────────────────┘
    0 1 2 3 4 5 6 7 ...                                   71  72  73 74 75 76 77 78 79
    └───────────────────────────────────────────────────────┘  │   └──────────────────┘
                         数据内容                           Section       行号
                        (72 字符)                          标识符      (7 字符)

  解析过程:
  ┌─────────────────────────────────────────────────────────────────────────────────┐
  │                                                                                 │
  │  1. sscanf(&line[73], "%d", &result)                                            │
  │     ─────────────────────────────────                                           │
  │     从 line[73] 开始解析整数                                                     │
  │     line[73..79] = "    123\n"                                                  │
  │     result = 123                                                                │
  │                                                                                 │
  │  2. typesec = line[72]                                                          │
  │     ──────────────────                                                          │
  │     获取 Section 标识符                                                          │
  │     typesec = 'S'                                                               │
  │                                                                                 │
  │  3. line[72] = '\0'                                                             │
  │     ────────────────                                                            │
  │     截断字符串，只保留数据内容                                                    │
  │                                                                                 │
  │     之前: "DATA CONTENT...S    123\n\0"                                         │
  │     之后: "DATA CONTENT...\0    123\n\0"                                        │
  │                                 ↑                                               │
  │                            line[72]                                             │
  │                                                                                 │
  └─────────────────────────────────────────────────────────────────────────────────┘
```

### 7.6 非标准格式容错

```c
// 从行末开始扫描
i = (int)strlen(line);
while ((line[i] == '\0' || line[i] == '\n' ||
        line[i] == '\r' || line[i] == ' ') && i > 0)
  i--;
```

**容错处理示意**：

```
非标准行示例 (缺少固定列对齐):
  "110,0.0,0.0,0.0,10.0,0.0,0.0;    P 1\n"
                                    ↑ ↑ ↑
                                  Sect 行号

扫描过程:
  ┌─────────────────────────────────────────────────────────────────────────────────┐
  │                                                                                 │
  │  初始: i = strlen(line) = 36                                                    │
  │                                                                                 │
  │  步骤 1: 跳过末尾空白                                                            │
  │  ──────────────────────────────────────                                         │
  │  line[36] = '\0'  → 继续                                                        │
  │  line[35] = '\n'  → 继续                                                        │
  │  line[34] = '1'   → 停止, i = 34                                                │
  │                                                                                 │
  │  步骤 2: 跳过数字 (行号)                                                         │
  │  ──────────────────────────────────────                                         │
  │  line[34] = '1'   → 是数字, i--                                                 │
  │  line[33] = ' '   → 不是数字, 停止, i = 33                                      │
  │                                                                                 │
  │  步骤 3: 解析行号                                                                │
  │  ──────────────────────────────────────                                         │
  │  sscanf(&line[34], "%d", &result)                                               │
  │  result = 1                                                                     │
  │                                                                                 │
  │  步骤 4: 跳过空格                                                                │
  │  ──────────────────────────────────────                                         │
  │  line[33] = ' '   → 继续                                                        │
  │  line[32] = 'P'   → 停止, i = 32                                                │
  │                                                                                 │
  │  步骤 5: 获取 Section 类型                                                       │
  │  ──────────────────────────────────────                                         │
  │  typesec = line[32] = 'P'                                                       │
  │  line[32] = '\0'  (截断)                                                        │
  │  return 4         (Parameter Section)                                           │
  │                                                                                 │
  └─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 内存布局示意

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              line[100] 缓冲区布局                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  索引:  0  1  2  ...                                              71 72 73...79 │
│       ┌──┬──┬──┬─────────────────────────────────────────────────┬──┬──┬───────┐│
│       │  │  │  │                                                 │  │  │       ││
│       │ 数据内容 (72 字符)                                       │\0│S │ 行号  ││
│       │  │  │  │                                                 │  │  │       ││
│       └──┴──┴──┴─────────────────────────────────────────────────┴──┴──┴───────┘│
│                                                                   ↑  ↑          │
│                                               iges_lire 会设置为 '\0'            │
│                                               以截断数据内容                      │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 总结

`iges_lire` 函数是 IGES 文件解析的**底层行读取器**，其核心职责：

1. **逐行读取**：从文件中读取固定 80 列格式的 IGES 行
2. **格式解析**：提取列 73 的 Section 标识符和列 74-80 的行号
3. **数据截断**：将数据内容截断到 72 字符（设置 `line[72] = '\0'`）
4. **类型返回**：返回 1-5 表示 S/G/D/P/T 五种 Section
5. **容错处理**：处理非标准格式、空行、特殊字符等情况
6. **重读控制**：支持 Section 切换时的行重用

它与 `igesread` 主函数配合，实现了完整的 IGES 文件读取流程。

---

## 10. 相关函数速查

| 函数名 | 文件 | 作用 |
|--------|------|------|
| `iges_initfile()` | structiges.c:113 | 初始化内存结构 |
| `iges_lire()` | liriges.c:34 | 行级读取器 |
| `iges_arelire()` | liriges.c:169 | 设置重读标志 |
| `iges_newparam()` | structiges.c:192 | 添加新参数 |
| `iges_Dsect()` | analiges.c | 解析 Directory Entry |
| `iges_Psect()` | analiges.c | 解析 Parameter 数据 |
| `iges_finfile()` | structiges.c:288 | 释放内存 |
| `igesread()` | igesread.c:55 | 主入口函数 |
