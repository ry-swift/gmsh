# OCCAttributesRTree 类图解详析

## 概述

`OCCAttributesRTree` 是 Gmsh 中用于**高效存储和查找 OpenCASCADE 几何形状属性**的空间索引数据结构，位于 `src/geo/OCCAttributes.h:82`。

它解决的核心问题是：
- 如何快速找到某个几何形状对应的网格尺寸、拉伸参数、标签、颜色等属性
- 即使形状经过布尔运算修改后，仍能通过位置匹配找到原始属性

---

## 两个核心类的关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      OCCAttributes 与 OCCAttributesRTree 关系               │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         OCCAttributes                                │   │
│   │                        (属性存储单元)                                 │   │
│   │                                                                     │   │
│   │   存储单个几何形状的属性:                                            │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  _dim        : int           → 维度 (0=点,1=边,2=面,3=体)   │   │   │
│   │   │  _shape      : TopoDS_Shape  → 关联的几何形状                │   │   │
│   │   │  _meshSize   : double        → 网格尺寸                      │   │   │
│   │   │  _extrude    : ExtrudeParams*→ 拉伸参数                      │   │   │
│   │   │  _sourceDim  : int           → 源几何维度                    │   │   │
│   │   │  _sourceShape: TopoDS_Shape  → 源几何形状                    │   │   │
│   │   │  _label      : string        → 标签名称                      │   │   │
│   │   │  _color      : vector<double>→ 颜色 (RGBA)                   │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      │ 1:N 关系                             │
│                                      │ (一个RTree管理多个Attributes)         │
│                                      ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                       OCCAttributesRTree                             │   │
│   │                      (R-Tree 空间索引容器)                            │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  _rtree[4]  : RTree*[4]              → 4棵R-Tree (按维度)    │   │   │
│   │   │  _all       : vector<OCCAttributes*> → 所有属性的列表        │   │   │
│   │   │  _tol       : double                 → 位置容差              │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## R-Tree 空间索引原理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        什么是 R-Tree？                                       │
│                                                                             │
│   R-Tree 是一种用于空间数据的树形索引结构                                     │
│   "R" 代表 Rectangle (矩形/包围盒)                                           │
│                                                                             │
│   核心思想: 用包围盒层层嵌套来组织空间对象                                     │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   2D 示意图 (实际是3D):                                             │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │ 根节点包围盒 (覆盖所有数据)                                   │   │   │
│   │   │                                                             │   │   │
│   │   │  ┌──────────────────────┐  ┌────────────────────────────┐  │   │   │
│   │   │  │ 子节点1包围盒         │  │ 子节点2包围盒               │  │   │   │
│   │   │  │                      │  │                            │  │   │   │
│   │   │  │  ┌────┐  ┌────┐     │  │  ┌────────┐  ┌────────┐   │  │   │   │
│   │   │  │  │ A  │  │ B  │     │  │  │   C    │  │   D    │   │  │   │   │
│   │   │  │  │点  │  │边  │     │  │  │  面    │  │  体    │   │  │   │   │
│   │   │  │  └────┘  └────┘     │  │  └────────┘  └────────┘   │  │   │   │
│   │   │  │                      │  │                            │  │   │   │
│   │   │  └──────────────────────┘  └────────────────────────────┘  │   │   │
│   │   │                                                             │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   查询 "在位置 P 附近有哪些对象?":                                           │
│   1. 从根节点开始,检查 P 是否在根包围盒内                                    │
│   2. 递归检查哪些子节点的包围盒包含 P                                        │
│   3. 到达叶节点,返回匹配的对象                                               │
│                                                                             │
│   时间复杂度: O(log n) 而不是遍历的 O(n)                                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## OCCAttributesRTree 数据结构详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    OCCAttributesRTree 内部结构                               │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  _rtree[4] - 按维度分开的4棵R-Tree                                   │   │
│   │                                                                     │   │
│   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│   │  │ _rtree[0]   │ │ _rtree[1]   │ │ _rtree[2]   │ │ _rtree[3]   │   │   │
│   │  │             │ │             │ │             │ │             │   │   │
│   │  │  dim = 0    │ │  dim = 1    │ │  dim = 2    │ │  dim = 3    │   │   │
│   │  │  (点/顶点)  │ │  (边/曲线)  │ │  (面/曲面)  │ │  (体/实体)  │   │   │
│   │  │             │ │             │ │             │ │             │   │   │
│   │  │ ┌─────────┐│ │ ┌─────────┐│ │ ┌─────────┐│ │ ┌─────────┐│   │   │
│   │  │ │ Attr1   ││ │ │ Attr5   ││ │ │ Attr10  ││ │ │ Attr20  ││   │   │
│   │  │ │ Attr2   ││ │ │ Attr6   ││ │ │ Attr11  ││ │ │ Attr21  ││   │   │
│   │  │ │ Attr3   ││ │ │ Attr7   ││ │ │ Attr12  ││ │ │   ...   ││   │   │
│   │  │ │  ...    ││ │ │  ...    ││ │ │  ...    ││ │ │         ││   │   │
│   │  │ └─────────┘│ │ └─────────┘│ │ └─────────┘│ │ └─────────┘│   │   │
│   │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │   │
│   │                                                                     │   │
│   │  为什么按维度分开?                                                   │   │
│   │  • 查询时只在对应维度的树中搜索,减少搜索范围                          │   │
│   │  • 不同维度的几何不会混在一起                                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  _all - 所有属性的线性列表 (用于遍历和清理)                          │   │
│   │                                                                     │   │
│   │  _all: [Attr1, Attr2, Attr3, ..., AttrN]                           │   │
│   │         ↓                                                           │   │
│   │  用途: 析构时释放所有属性对象的内存                                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  _tol - 位置容差 (默认 1e-8)                                        │   │
│   │                                                                     │   │
│   │  用于:                                                              │   │
│   │  • 构建查询包围盒时的扩展范围                                        │   │
│   │  • 判断两个包围盒是否"相同"                                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 核心操作流程图解

### 1. insert() - 插入属性

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           insert(OCCAttributes *v)                          │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  输入: OCCAttributes 对象 (包含 Shape 和属性)                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  步骤1: 添加到 _all 列表                                            │   │
│   │                                                                     │   │
│   │  _all.push_back(v);                                                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  步骤2: 计算 Shape 的包围盒                                          │   │
│   │                                                                     │   │
│   │  Bnd_Box box;                                                       │   │
│   │  BRepBndLib::Add(v->getShape(), box);                               │   │
│   │                                                                     │   │
│   │         ┌──────────────────────────────────────┐                    │   │
│   │         │       几何形状的包围盒                │                    │   │
│   │         │                                      │                    │   │
│   │         │   (xmin,ymax,zmax)───(xmax,ymax,zmax)│                    │   │
│   │         │        │                    │        │                    │   │
│   │         │        │    ┌────────┐     │        │                    │   │
│   │         │        │    │ Shape  │     │        │                    │   │
│   │         │        │    └────────┘     │        │                    │   │
│   │         │        │                    │        │                    │   │
│   │         │   (xmin,ymin,zmin)───(xmax,ymin,zmin)│                    │   │
│   │         └──────────────────────────────────────┘                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  步骤3: 计算包围盒中心点                                             │   │
│   │                                                                     │   │
│   │  x = 0.5 * (xmin + xmax);                                           │   │
│   │  y = 0.5 * (ymin + ymax);                                           │   │
│   │  z = 0.5 * (zmin + zmax);                                           │   │
│   │                                                                     │   │
│   │         ┌──────────────────────────────────────┐                    │   │
│   │         │                                      │                    │   │
│   │         │                 ●                    │  ← 中心点(x,y,z)   │   │
│   │         │              (center)                │                    │   │
│   │         │                                      │                    │   │
│   │         └──────────────────────────────────────┘                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  步骤4: 构建索引包围盒 (中心点 ± 容差)                               │   │
│   │                                                                     │   │
│   │  bmin[3] = {x - _tol, y - _tol, z - _tol};                          │   │
│   │  bmax[3] = {x + _tol, y + _tol, z + _tol};                          │   │
│   │                                                                     │   │
│   │         ┌──────────────────┐                                        │   │
│   │         │   索引包围盒      │                                        │   │
│   │         │   (很小的立方体)  │                                        │   │
│   │         │      ┌──┐        │                                        │   │
│   │         │      │● │        │ ← 边长 = 2 * _tol                      │   │
│   │         │      └──┘        │                                        │   │
│   │         └──────────────────┘                                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  步骤5: 插入到对应维度的 R-Tree                                      │   │
│   │                                                                     │   │
│   │  _rtree[v->getDim()]->Insert(bmin, bmax, v);                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   关键设计: 使用中心点而不是完整包围盒作为索引                               │
│   原因: 即使 Shape 被布尔运算修改,中心点位置通常保持不变                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2. _find() - 查找属性

```
┌─────────────────────────────────────────────────────────────────────────────┐
│         _find(dim, shape, attr, requireMeshSize, requireExtrudeParams,      │
│               requireLabel, requireColor, excludeSame)                       │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  输入: 要查找属性的 Shape 和过滤条件                                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  步骤1: 计算查询 Shape 的包围盒和中心点                              │   │
│   │                                                                     │   │
│   │  BRepBndLib::Add(shape, box);                                       │   │
│   │  x = 0.5 * (xmin + xmax);                                           │   │
│   │  y = 0.5 * (ymin + ymax);                                           │   │
│   │  z = 0.5 * (zmin + zmax);                                           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  步骤2: 构建查询包围盒                                               │   │
│   │                                                                     │   │
│   │  bmin[3] = {x - _tol, y - _tol, z - _tol};                          │   │
│   │  bmax[3] = {x + _tol, y + _tol, z + _tol};                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  步骤3: 在 R-Tree 中搜索                                             │   │
│   │                                                                     │   │
│   │  _rtree[dim]->Search(bmin, bmax, rtree_callback, &tmp);             │   │
│   │                                                                     │   │
│   │  ┌───────────────────────────────────────────────────────────────┐  │   │
│   │  │                        R-Tree                                  │  │   │
│   │  │                                                               │  │   │
│   │  │   ┌───────────────────────────────────────────────────────┐   │  │   │
│   │  │   │           ● A        ● B                               │   │  │   │
│   │  │   │                                                       │   │  │   │
│   │  │   │              ┌─────────┐                              │   │  │   │
│   │  │   │     ● C      │ Query   │   ● D                        │   │  │   │
│   │  │   │              │  Box    │                              │   │  │   │
│   │  │   │              └─────────┘                              │   │  │   │
│   │  │   │                                                       │   │  │   │
│   │  │   │       ● E              ● F                            │   │  │   │
│   │  │   └───────────────────────────────────────────────────────┘   │  │   │
│   │  │                                                               │  │   │
│   │  │   返回: 所有索引包围盒与查询包围盒相交的属性                    │  │   │
│   │  └───────────────────────────────────────────────────────────────┘  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  步骤4: 精确匹配检查 (如果不是 excludeSame)                          │   │
│   │                                                                     │   │
│   │  for each candidate:                                                │   │
│   │      if(shape.IsSame(candidate->getShape())) {                      │   │
│   │          // 精确匹配: 是同一个 Shape 对象                            │   │
│   │          return candidate;                                          │   │
│   │      }                                                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  步骤5: 包围盒匹配 (模糊匹配)                                        │   │
│   │                                                                     │   │
│   │  for each candidate:                                                │   │
│   │      计算 candidate 的包围盒                                         │   │
│   │      if(所有6个边界值都在 _tol 范围内相等) {                          │   │
│   │          // 包围盒匹配: 可能是同一个几何,只是 Shape 对象不同          │   │
│   │          attr.push_back(candidate);                                 │   │
│   │      }                                                              │   │
│   │                                                                     │   │
│   │  ┌───────────────────────────────────────────────────────────────┐  │   │
│   │  │  为什么需要模糊匹配?                                           │  │   │
│   │  │                                                               │  │   │
│   │  │  布尔运算(如 Fragment)会创建新的 Shape 对象                    │  │   │
│   │  │  虽然几何位置相同,但 IsSame() 会返回 false                     │  │   │
│   │  │  通过比较包围盒可以找到"位置相同"的属性                         │  │   │
│   │  └───────────────────────────────────────────────────────────────┘  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 属性查询接口

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         公共查询方法                                         │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  getMeshSize(dim, shape)                                            │   │
│   │  ─────────────────────────                                          │   │
│   │  功能: 获取形状的网格尺寸                                            │   │
│   │  返回: double (网格尺寸值,如果没有则返回 MAX_LC)                     │   │
│   │                                                                     │   │
│   │  调用链: getMeshSize → _find(..., requireMeshSize=true, ...)        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  getExtrudeParams(dim, shape, &sourceDim, &sourceShape)             │   │
│   │  ──────────────────────────────────────────────────────             │   │
│   │  功能: 获取拉伸参数                                                  │   │
│   │  返回: ExtrudeParams* (拉伸参数指针)                                │   │
│   │  输出: sourceDim, sourceShape (拉伸的源几何)                        │   │
│   │                                                                     │   │
│   │  用途: 实现拉伸网格时保持源几何网格的连续性                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  getLabels(dim, shape, &labels)                                     │   │
│   │  ──────────────────────────────                                     │   │
│   │  功能: 获取形状的标签列表                                            │   │
│   │  输出: vector<string> labels                                        │   │
│   │                                                                     │   │
│   │  用途: 从 STEP 文件导入时保留原始命名                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  getColor(dim, shape, &color, &boundary)                            │   │
│   │  ───────────────────────────────────────                            │   │
│   │  功能: 获取形状的颜色                                                │   │
│   │  输出: color (打包的RGBA值), boundary (边界标志)                    │   │
│   │                                                                     │   │
│   │  用途: 从 CAD 文件导入时保留颜色信息                                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  getSimilarShapes(dim, shape, &other)                               │   │
│   │  ────────────────────────────────────                               │   │
│   │  功能: 获取与给定形状位置相同的其他形状                              │   │
│   │  输出: vector<TopoDS_Shape> other                                   │   │
│   │                                                                     │   │
│   │  参数: excludeSame=true (排除完全相同的 Shape)                      │   │
│   │  用途: 在布尔运算后找到对应的原始形状                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 为什么使用中心点索引？

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   为什么使用包围盒中心点作为索引键？                          │
│                                                                             │
│   问题场景: 布尔运算 Fragment 后,Shape 对象会改变                            │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   布尔运算前:                                                       │   │
│   │   ┌──────────────────────────────────────────────────────────────┐  │   │
│   │   │                                                              │  │   │
│   │   │     ┌───────────┐            ┌───────────┐                   │  │   │
│   │   │     │  Shape A  │            │  Shape B  │                   │  │   │
│   │   │     │  tag=1    │   重叠区域 │  tag=2    │                   │  │   │
│   │   │     │           │◄──────────►│           │                   │  │   │
│   │   │     │  size=0.1 │            │  size=0.2 │                   │  │   │
│   │   │     └───────────┘            └───────────┘                   │  │   │
│   │   │                                                              │  │   │
│   │   │   属性已存储: A→meshSize=0.1, B→meshSize=0.2                 │  │   │
│   │   └──────────────────────────────────────────────────────────────┘  │   │
│   │                                                                     │   │
│   │   Fragment 操作后:                                                  │   │
│   │   ┌──────────────────────────────────────────────────────────────┐  │   │
│   │   │                                                              │  │   │
│   │   │     ┌────────┬──┬────────┐                                   │  │   │
│   │   │     │ Shape  │重│ Shape  │                                   │  │   │
│   │   │     │  A'    │叠│  B'    │                                   │  │   │
│   │   │     │ (新对象)│区│(新对象) │                                   │  │   │
│   │   │     │        │域│        │                                   │  │   │
│   │   │     └────────┴──┴────────┘                                   │  │   │
│   │   │                                                              │  │   │
│   │   │   A' 和 B' 是新创建的 TopoDS_Shape 对象                      │  │   │
│   │   │   A'.IsSame(A) = false  (虽然几何一样,但对象不同)             │  │   │
│   │   └──────────────────────────────────────────────────────────────┘  │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   解决方案: 使用包围盒中心点                                                 │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   A 和 A' 的包围盒中心点相同 → 可以通过位置匹配找到属性              │   │
│   │                                                                     │   │
│   │   查询 A' 的 meshSize:                                              │   │
│   │   1. 计算 A' 的包围盒中心点                                         │   │
│   │   2. 在 R-Tree 中搜索该位置附近的属性                               │   │
│   │   3. 找到 A 的属性 (因为中心点相同)                                 │   │
│   │   4. 比较包围盒确认匹配                                             │   │
│   │   5. 返回 meshSize = 0.1                                           │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 完整调用流程示例

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    实际使用场景: 设置网格尺寸                                 │
│                                                                             │
│   用户操作: SetFactory("OpenCASCADE");                                      │
│            Box(1) = {0,0,0, 1,1,1};                                         │
│            MeshSize{1} = 0.1;  // 设置点1的网格尺寸为0.1                    │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  步骤1: 创建属性并插入 R-Tree                                        │   │
│   │                                                                     │   │
│   │  // 在 OCC_Internals 中                                             │   │
│   │  TopoDS_Vertex vertex = ...; // 点1对应的顶点                       │   │
│   │  OCCAttributes *attr = new OCCAttributes(0, vertex, 0.1);           │   │
│   │  _attributes->insert(attr);                                         │   │
│   │                                                                     │   │
│   │  insert() 执行:                                                     │   │
│   │  ┌─────────────────────────────────────────────────────────────┐   │   │
│   │  │  1. 计算 vertex 的包围盒                                     │   │   │
│   │  │  2. 计算中心点 (0, 0, 0)                                     │   │   │
│   │  │  3. 构建索引盒 ([-tol,-tol,-tol], [tol,tol,tol])            │   │   │
│   │  │  4. _rtree[0]->Insert(bmin, bmax, attr)                     │   │   │
│   │  └─────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  步骤2: 网格生成时查询属性                                           │   │
│   │                                                                     │   │
│   │  // 同步到 GModel 时                                                │   │
│   │  for each OCC vertex:                                               │   │
│   │      double size = _attributes->getMeshSize(0, vertex);             │   │
│   │      if(size < MAX_LC) {                                            │   │
│   │          gVertex->setPrescribedMeshSizeAtVertex(size);              │   │
│   │      }                                                              │   │
│   │                                                                     │   │
│   │  getMeshSize() 执行:                                                │   │
│   │  ┌─────────────────────────────────────────────────────────────┐   │   │
│   │  │  1. 计算查询 vertex 的中心点                                 │   │   │
│   │  │  2. 在 _rtree[0] 中搜索                                      │   │   │
│   │  │  3. 找到匹配的属性                                           │   │   │
│   │  │  4. 返回 meshSize = 0.1                                      │   │   │
│   │  └─────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 类结构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      OCCAttributesRTree 类结构                               │
│                                                                             │
│  class OCCAttributesRTree {                                                 │
│  private:                                                                   │
│      // 4棵R-Tree,按维度分开                                                │
│      RTree<OCCAttributes*, double, 3, double> *_rtree[4];                   │
│      // dim=0: 点, dim=1: 边, dim=2: 面, dim=3: 体                          │
│                                                                             │
│      vector<OCCAttributes*> _all;  // 所有属性的列表 (用于内存管理)          │
│      double _tol;                  // 位置容差 (默认1e-8)                    │
│                                                                             │
│      // 回调函数 (R-Tree搜索结果收集)                                        │
│      static bool rtree_callback(OCCAttributes *v, void *ctx);               │
│                                                                             │
│      // 核心查找方法                                                         │
│      void _find(int dim, const TopoDS_Shape &shape,                         │
│                 vector<OCCAttributes*> &attr,                               │
│                 bool requireMeshSize, bool requireExtrudeParams,            │
│                 bool requireLabel, bool requireColor, bool excludeSame);    │
│                                                                             │
│  public:                                                                    │
│      // 构造/析构                                                            │
│      OCCAttributesRTree(double tolerance = 1.e-8);                          │
│      ~OCCAttributesRTree();                                                 │
│                                                                             │
│      // 基本操作                                                             │
│      void clear();                          // 清空所有数据                  │
│      void insert(OCCAttributes *v);         // 插入属性                     │
│      void remove(OCCAttributes *v);         // 删除属性                     │
│      void print(const string &fileName);    // 输出调试信息                 │
│                                                                             │
│      // 查询接口                                                             │
│      double getMeshSize(int dim, TopoDS_Shape shape);                       │
│      ExtrudeParams* getExtrudeParams(...);                                  │
│      void getLabels(int dim, TopoDS_Shape shape, vector<string> &labels);   │
│      bool getColor(int dim, TopoDS_Shape shape, uint &color, uint &boundary);│
│      void getSimilarShapes(int dim, TopoDS_Shape shape, vector<Shape> &other);│
│  };                                                                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 总结

| 特性 | 说明 |
|------|------|
| **数据结构** | R-Tree 空间索引 (4棵,按维度分开) |
| **索引键** | 几何形状包围盒的中心点 |
| **存储内容** | 网格尺寸、拉伸参数、标签、颜色 |
| **查找策略** | 先精确匹配(IsSame)，再模糊匹配(包围盒比较) |
| **核心优势** | 即使 Shape 被布尔运算修改,仍能通过位置找到原始属性 |
| **时间复杂度** | 查找 O(log n)，插入 O(log n) |

这个类是 Gmsh OCC 模块中属性管理的核心，解决了布尔运算后属性丢失的问题。
