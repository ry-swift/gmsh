# OpenProject 方法图解详析

## 概述

`OpenProject` 是 Gmsh 中用于**打开项目文件**的核心入口函数，位于 `src/common/OpenFile.cpp:725`。

它的主要职责是：
1. 准备干净的环境来加载新项目
2. 管理多模型状态
3. 协调文件解析和加载
4. 维护最近文件历史
5. 更新 GUI 状态

---

## 整体流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           OpenProject(fileName)                              │
│                           文件路径: 如 "model.geo"                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第1步: 并发锁检查                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  if(CTX::instance()->lock) {                                        │    │
│  │      Msg::Info("I'm busy! Ask me that later...");                   │    │
│  │      return;  // 正在忙碌,拒绝新请求                                  │    │
│  │  }                                                                   │    │
│  │  CTX::instance()->lock = 1;  // 获取锁                               │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第2步: 重置错误计数器                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Msg::ResetErrorCounter();                                          │    │
│  │  // 清除之前累积的错误,为新项目提供干净的错误追踪                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第3步: 模型状态处理 (关键决策点)                                              │
│                                                                              │
│         ┌───────────────────────────────────────────────────┐               │
│         │          GModel::current()->empty() ?             │               │
│         │              当前模型是否为空?                      │               │
│         └───────────────────────────────────────────────────┘               │
│                    │                           │                            │
│                 是 (空)                      否 (非空)                       │
│                    │                           │                            │
│                    ▼                           ▼                            │
│     ┌─────────────────────────┐    ┌─────────────────────────────┐         │
│     │  清理并重用当前模型       │    │  创建新模型                   │         │
│     │                         │    │                             │         │
│     │  current()->destroy();  │    │  new GModel();              │         │
│     │  getGEOInternals()      │    │  current(list.size()-1);   │         │
│     │    ->destroy();         │    │                             │         │
│     │                         │    │  原有模型保持不可见           │         │
│     │  重用节省内存!           │    │  新模型变为当前模型           │         │
│     └─────────────────────────┘    └─────────────────────────────┘         │
│                                                                              │
│  [设计意图: 如果当前模型是空的,没必要创建新对象,直接重用更高效]                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第4步: 清除解析器状态 (仅当 HAVE_PARSER 定义时)                               │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                        解析器变量重置                               │     │
│  │                                                                    │     │
│  │   gmsh_yysymbols.clear();         // 清除数值变量                   │     │
│  │   gmsh_yystringsymbols.clear();   // 清除字符串变量                 │     │
│  │   gmsh_yyfactory.clear();         // 清除工厂设置                   │     │
│  │   gmsh_yynamespaces.clear();      // 清除命名空间                   │     │
│  │   FunctionManager::Instance()->clear();  // 清除函数定义            │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                      │                                       │
│                                      ▼                                       │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                   但是保留命令行参数!                               │     │
│  │                                                                    │     │
│  │   例如: gmsh -setnumber lc 0.1 model.geo                          │     │
│  │                                                                    │     │
│  │   命令行的 -setnumber/-setstring 参数会被保留:                      │     │
│  │   cln = Msg::GetCommandLineNumbers();                             │     │
│  │   for(auto it : cln)                                              │     │
│  │       gmsh_yysymbols[it->first].value = it->second;               │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
│  [设计意图: 每次打开新项目时解析器状态需要干净,但命令行参数应该贯穿整个会话]       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第5步: 重置临时边界盒                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  ResetTemporaryBoundingBox();                                       │    │
│  │  // 临时边界盒用于在解析过程中动态计算几何范围                          │    │
│  │  // 打开新项目前需要重置,防止旧数据影响新计算                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第6步: 核心 - 合并文件 ⭐⭐⭐                                                │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    MergeFile(fileName, errorIfMissing)              │    │
│  │                                                                     │    │
│  │    这是真正执行文件读取和解析的地方!                                  │    │
│  │    详见下方 MergeFile 流程图                                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第7步: 更新最近文件列表                                                      │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  最近文件列表管理 (最多保留10个)                                      │    │
│  │                                                                     │    │
│  │  操作前:  [file1, file2, file3, fileName, file5, ...]              │    │
│  │  操作后:  [fileName, file1, file2, file3, file5, ...]              │    │
│  │                                                                     │    │
│  │  1. 保存原有列表到临时变量                                           │    │
│  │  2. 清空列表                                                        │    │
│  │  3. 把当前文件放在第一位                                             │    │
│  │  4. 追加其他文件(跳过重复的)                                         │    │
│  │  5. 截断到10个                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第8步: 关闭可能遗留的文件句柄                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  if(openedFiles.size()) {                                           │    │
│  │      for(auto f : openedFiles) fclose(f);                          │    │
│  │      openedFiles.clear();                                           │    │
│  │  }                                                                  │    │
│  │  // ParseFile 可能会留下打开的文件,这里统一清理                        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第9步: 释放并发锁                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  CTX::instance()->lock = 0;  // 解锁,允许其他操作                    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第10步: 自动拉伸处理 (可选/临时功能)                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  if(CTX::instance()->geom.autoExtrude) {                            │    │
│  │      GModel::current()->addAutomaticExtrusionConstraints(...);      │    │
│  │  }                                                                  │    │
│  │  // FIXME注释表明这是用于自动拉伸测试的临时代码                        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  第11步: GUI更新 (仅当 HAVE_FLTK 且 GUI 可用时)                               │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  file_watch_cb(nullptr, nullptr);     // 文件监视回调                │    │
│  │  FlGui::instance()->resetVisibility(); // 重置可见性设置             │    │
│  │  FlGui::instance()->updateViews(true, false); // 更新视图            │    │
│  │  FlGui::instance()->updateFields();   // 更新场                      │    │
│  │  GModel::current()->setSelection(0);  // 清除选择                    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
                               ┌──────────────┐
                               │   函数结束    │
                               └──────────────┘
```

---

## MergeFile 详细流程图

`MergeFile` 是 `OpenProject` 中调用的核心函数，负责实际的文件读取和解析：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                MergeFile(fileName, errorIfMissing, ...)                      │
│                        位置: OpenFile.cpp:296                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step A: 打开文件并读取头部                                                   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  FILE *fp = Fopen(fileName.c_str(), "rb");  // 二进制模式打开        │    │
│  │  if(!fp) {                                                          │    │
│  │      if(errorIfMissing) Msg::Error("Unable to open file...");       │    │
│  │      return 0;                                                      │    │
│  │  }                                                                  │    │
│  │  fgets(header, sizeof(header), fp);  // 读取前256字节               │    │
│  │  fclose(fp);                          // 关闭文件                    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  [为什么读取header? 用于判断某些格式,如.dat可能是ACTRAN/SAMCEF/BDF格式]        │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step B: 提取文件扩展名                                                       │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  split = SplitFileName(fileName);                                   │    │
│  │  // split[0] = 路径, split[1] = 文件名, split[2] = 扩展名           │    │
│  │                                                                     │    │
│  │  例如: "/path/to/model.step"                                        │    │
│  │       split[0] = "/path/to/"                                        │    │
│  │       split[1] = "model"                                            │    │
│  │       split[2] = ".step"                                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step C: 处理压缩文件                                                        │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  if(ext == ".gz") {                                                 │    │
│  │      DoSystemUncompress(fileName, noExt);  // 解压                  │    │
│  │      return MergeFile(noExt, false);       // 递归处理解压后的文件   │    │
│  │  }                                                                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step D: 根据扩展名分发到对应的读取器 (核心路由)                               │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         文件格式路由表                               │    │
│  │                                                                     │    │
│  │  ┌─────────────────┬────────────────────────────────────────┐       │    │
│  │  │    扩展名        │           调用的读取方法               │       │    │
│  │  ├─────────────────┼────────────────────────────────────────┤       │    │
│  │  │ .geo, .GEO      │ ParseFile() - 解析Gmsh脚本文件         │       │    │
│  │  │ .msh, .MSH      │ readMSH() - 读取Gmsh网格文件           │       │    │
│  │  ├─────────────────┼────────────────────────────────────────┤       │    │
│  │  │ .step, .stp     │ readOCCSTEP() - OpenCASCADE STEP      │       │    │
│  │  │ .iges, .igs     │ readOCCIGES() - OpenCASCADE IGES      │       │    │
│  │  │ .brep, .brp     │ readOCCBREP() - OpenCASCADE BREP      │       │    │
│  │  ├─────────────────┼────────────────────────────────────────┤       │    │
│  │  │ .stl, .STL      │ readSTL() - 三角面片格式               │       │    │
│  │  │ .obj, .OBJ      │ readOBJ() - Wavefront格式              │       │    │
│  │  │ .off, .OFF      │ readOFF() - Object File Format        │       │    │
│  │  ├─────────────────┼────────────────────────────────────────┤       │    │
│  │  │ .vtk, .VTK      │ readVTK() - VTK格式                    │       │    │
│  │  │ .unv, .UNV      │ readUNV() - I-deas格式                 │       │    │
│  │  │ .med, .MED      │ readMED() - MED/Salome格式             │       │    │
│  │  │ .bdf, .nas      │ readBDF() - Nastran格式                │       │    │
│  │  ├─────────────────┼────────────────────────────────────────┤       │    │
│  │  │ .pos, .POS      │ PView::readPOS() - 后处理数据          │       │    │
│  │  │ .cgns, .CGNS    │ readCGNS() - CGNS格式                  │       │    │
│  │  └─────────────────┴────────────────────────────────────────┘       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  [这是策略模式的典型应用: 根据文件类型选择不同的处理策略]                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step E: 设置边界盒和更新状态                                                 │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  if(setBoundingBox)                                                 │    │
│  │      SetBoundingBox();  // 计算并设置几何边界                        │    │
│  │                                                                     │    │
│  │  CTX::instance()->geom.draw = 1;  // 允许绘制几何                   │    │
│  │                                                                     │    │
│  │  Msg::StatusBar(true, "Done reading '%s'", fileName.c_str());      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 多模型管理图解

```
                        GModel 模型管理机制

    ┌─────────────────────────────────────────────────────────────────┐
    │                      GModel::list (模型列表)                     │
    │                                                                 │
    │   index: 0              1               2              ...     │
    │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
    │   │  GModel #0  │ │  GModel #1  │ │  GModel #2  │              │
    │   │             │ │             │ │             │              │
    │   │  cube.geo   │ │ sphere.step │ │  pipe.iges  │              │
    │   │  (empty)    │ │  (loaded)   │ │  (loaded)   │              │
    │   └─────────────┘ └─────────────┘ └─────────────┘              │
    │                                      ↑                         │
    │                             GModel::current()                   │
    │                             当前活动模型                         │
    └─────────────────────────────────────────────────────────────────┘


    场景1: 当前模型为空时打开新项目
    ────────────────────────────────────────────────────────

    之前:                          之后:
    ┌─────────────┐               ┌─────────────┐
    │  GModel #0  │               │  GModel #0  │
    │   (empty)   │    ──────►    │  new.step   │
    │      ↑      │               │  (loaded)   │
    │   current   │               │      ↑      │
    └─────────────┘               │   current   │
                                  └─────────────┘

    [重用模型对象,节省内存分配]


    场景2: 当前模型非空时打开新项目
    ────────────────────────────────────────────────────────

    之前:                          之后:
    ┌─────────────┐               ┌─────────────┐ ┌─────────────┐
    │  GModel #0  │               │  GModel #0  │ │  GModel #1  │
    │  cube.geo   │    ──────►    │  cube.geo   │ │  new.step   │
    │  (loaded)   │               │  (hidden)   │ │  (loaded)   │
    │      ↑      │               └─────────────┘ │      ↑      │
    │   current   │                               │   current   │
    └─────────────┘                               └─────────────┘

    [保留原模型,创建新模型,新模型成为当前模型]
```

---

## 解析器变量管理图解

```
    ┌─────────────────────────────────────────────────────────────────┐
    │                     解析器变量清理与保留                          │
    └─────────────────────────────────────────────────────────────────┘

    命令行启动: gmsh -setnumber lc 0.1 -setstring name "test" model.geo


    ┌──────────────────────────────────────────────────────────────────┐
    │  清理前 (上一个项目的变量)                                        │
    │                                                                  │
    │  gmsh_yysymbols:                                                │
    │  ┌─────────────────────────────────────────────────────────┐    │
    │  │  "a" → [1.0, 2.0, 3.0]      // 上个项目定义的数组        │    │
    │  │  "lc" → [0.5]               // 上个项目定义的网格尺寸    │    │
    │  │  "x" → [100]                // 上个项目定义的变量        │    │
    │  └─────────────────────────────────────────────────────────┘    │
    │                                                                  │
    │  gmsh_yystringsymbols:                                          │
    │  ┌─────────────────────────────────────────────────────────┐    │
    │  │  "filename" → ["old.geo"]                               │    │
    │  │  "name" → ["old_test"]                                  │    │
    │  └─────────────────────────────────────────────────────────┘    │
    └──────────────────────────────────────────────────────────────────┘
                                    │
                                    │  OpenProject()
                                    │  清理 + 恢复命令行参数
                                    ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  清理后 (只保留命令行参数)                                        │
    │                                                                  │
    │  gmsh_yysymbols:                                                │
    │  ┌─────────────────────────────────────────────────────────┐    │
    │  │  "lc" → [0.1]    ← 来自命令行 -setnumber lc 0.1         │    │
    │  └─────────────────────────────────────────────────────────┘    │
    │                                                                  │
    │  gmsh_yystringsymbols:                                          │
    │  ┌─────────────────────────────────────────────────────────┐    │
    │  │  "name" → ["test"]  ← 来自命令行 -setstring name "test" │    │
    │  └─────────────────────────────────────────────────────────┘    │
    │                                                                  │
    │  [设计理念: 命令行参数应该在整个会话中有效]                        │
    └──────────────────────────────────────────────────────────────────┘
```

---

## 调用链路图

```
    用户操作                        代码调用链
    ────────                       ────────────

    ┌──────────────────┐
    │  GUI: File > Open │
    │       或          │
    │  gmsh model.geo   │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │   OpenProject()   │ ◄─── src/common/OpenFile.cpp:725
    │                   │
    │  1. 锁定检查       │
    │  2. 模型状态处理   │
    │  3. 解析器重置     │
    │  4. 调用MergeFile │
    └────────┬─────────┘
             │
             ▼
    ┌──────────────────┐
    │    MergeFile()    │ ◄─── src/common/OpenFile.cpp:296
    │                   │
    │  根据扩展名路由    │
    │  到具体读取器      │
    └────────┬─────────┘
             │
             ├────────────────┬───────────────────┬──────────────────┐
             │                │                   │                  │
             ▼                ▼                   ▼                  ▼
    ┌───────────────┐ ┌───────────────┐  ┌───────────────┐  ┌───────────────┐
    │  ParseFile()  │ │ readOCCSTEP() │  │  readMSH()    │  │   其他...     │
    │  (.geo文件)   │ │ (.step文件)   │  │  (.msh文件)   │  │               │
    └───────┬───────┘ └───────┬───────┘  └───────┬───────┘  └───────────────┘
            │                 │                  │
            ▼                 ▼                  ▼
    ┌────────────────────────────────────────────────────────────────┐
    │                         GModel                                  │
    │   ┌─────────────┐ ┌──────────────┐ ┌───────────────────┐       │
    │   │  GVertex    │ │   GEdge      │ │   GFace           │       │
    │   │  几何顶点    │ │   几何边      │ │   几何面          │       │
    │   └─────────────┘ └──────────────┘ └───────────────────┘       │
    │   ┌─────────────┐ ┌──────────────┐                             │
    │   │  MVertex    │ │   MElement   │                             │
    │   │  网格顶点    │ │   网格单元    │                             │
    │   └─────────────┘ └──────────────┘                             │
    └────────────────────────────────────────────────────────────────┘
```

---

## 关键代码行对照

| 行号 | 代码片段 | 说明 |
|------|----------|------|
| 727-731 | `if(CTX::instance()->lock)` | 并发锁检查，防止重入 |
| 733 | `Msg::ResetErrorCounter()` | 重置错误计数器 |
| 735-745 | `if(GModel::current()->empty())` | 模型状态分支处理 |
| 750-762 | `gmsh_yysymbols.clear()` | 清理解析器变量 |
| 752-759 | `Msg::GetCommandLineNumbers()` | 恢复命令行参数 |
| 766 | `ResetTemporaryBoundingBox()` | 重置边界盒 |
| 769 | `MergeFile(fileName, ...)` | **核心调用** - 实际文件读取 |
| 772-778 | `CTX::instance()->recentFiles` | 最近文件列表管理 |
| 784-787 | `fclose(openedFiles[i])` | 清理遗留文件句柄 |
| 789 | `CTX::instance()->lock = 0` | 释放并发锁 |
| 796-802 | `FlGui::instance()->...` | GUI状态更新 |

---

## 设计模式分析

### 1. 单例模式 (Singleton)
```cpp
CTX::instance()      // 全局上下文
GModel::current()    // 当前模型
FlGui::instance()    // GUI实例
```

### 2. 策略模式 (Strategy)
```
MergeFile 根据文件扩展名选择不同的读取策略:
.step → readOCCSTEP()
.geo  → ParseFile()
.msh  → readMSH()
```

### 3. 模板方法模式 (Template Method)
```
OpenProject 定义了打开项目的骨架流程:
1. 准备环境
2. 调用MergeFile (由具体读取器实现)
3. 收尾工作
```

---

## 调试建议

在断点调试 `OpenProject` 时，建议关注以下关键变量：

1. **fileName** - 正在打开的文件路径
2. **CTX::instance()->lock** - 并发锁状态
3. **GModel::current()->empty()** - 当前模型是否为空
4. **GModel::list.size()** - 模型列表大小
5. **gmsh_yysymbols** - 解析器数值变量
6. **openedFiles** - 遗留的文件句柄列表

通过观察这些变量，可以清楚地跟踪 `OpenProject` 的执行状态和数据流。

---

## 总结

`OpenProject` 是 Gmsh 文件打开的入口点，它：

1. **不直接读取文件** - 而是协调和准备环境
2. **管理多模型状态** - 智能决定重用还是创建新模型
3. **维护解析器状态** - 清理旧变量但保留命令行参数
4. **委托给 MergeFile** - 由 MergeFile 根据文件格式分发到具体读取器
5. **更新 UI 状态** - 保持 GUI 与数据同步

这种设计遵循了**单一职责原则**：OpenProject 负责环境准备和协调，MergeFile 负责文件格式识别和分发，具体读取器负责实际的文件解析。
