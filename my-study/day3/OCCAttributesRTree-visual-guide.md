# OCCAttributesRTree 图形化深度解析

## 1. 核心问题：为什么需要这个类？

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        布尔操作导致的属性丢失问题                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

    【操作前】                              【操作后】

    ┌─────────────────────┐               ┌─────────────────────┐
    │   TopoDS_Vertex A   │               │   TopoDS_Vertex A'  │  ← 新对象!
    │   地址: 0x1234      │   ─────────►  │   地址: 0x5678      │
    │   meshSize = 0.1    │   布尔操作     │   meshSize = ???    │  ← 属性丢失!
    └─────────────────────┘               └─────────────────────┘

    问题: 布尔操作(如 BooleanFragments)会销毁原始形状对象，
          创建新的形状对象，导致绑定在原对象上的属性丢失
```

### 1.1 典型场景演示

```
    用户代码:
    ─────────────────────────────────────────────────────────────
    Point(1) = {0, 0, 0, 0.1};     // 创建点，meshSize = 0.1
    Circle(1) = {0, 0, 0, 1, ...}; // 创建圆1
    Circle(2) = {1, 0, 0, 1, ...}; // 创建圆2
    BooleanFragments{ ... }        // 布尔碎片化
    ─────────────────────────────────────────────────────────────


    执行过程:

    ┌──────────────────────────────────────────────────────────────────────────┐
    │ 第1步: 创建点                                                            │
    │                                                                          │
    │    TopoDS_Vertex (0x1234)                                               │
    │    ┌────────────────────┐                                               │
    │    │ 位置: (0, 0, 0)    │                                               │
    │    │ meshSize: 0.1     │  ← 用户设置的网格尺寸                           │
    │    └────────────────────┘                                               │
    └──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌──────────────────────────────────────────────────────────────────────────┐
    │ 第2步: 创建圆弧                                                          │
    │                                                                          │
    │         Circle 1                    Circle 2                            │
    │           ╭───╮                       ╭───╮                             │
    │          ╱     ╲                     ╱     ╲                            │
    │         │   •   │                   │   •   │                           │
    │          ╲     ╱                     ╲     ╱                            │
    │           ╰───╯                       ╰───╯                             │
    │        中心(0,0,0)                 中心(1,0,0)                           │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌──────────────────────────────────────────────────────────────────────────┐
    │ 第3步: BooleanFragments 执行                                             │
    │                                                                          │
    │    原始形状被销毁           新形状被创建                                   │
    │    ────────────           ────────────                                   │
    │    TopoDS_Vertex          TopoDS_Vertex'                                │
    │    (0x1234) ──────X       (0x5678) ← 新地址                              │
    │       ↓                      ↓                                          │
    │    meshSize = 0.1         meshSize = ??? (丢失!)                        │
    │                                                                          │
    └──────────────────────────────────────────────────────────────────────────┘
```

### 1.2 OCCAttributesRTree 的解决方案

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            解决方案: 空间位置匹配                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

    核心思想:
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │   不依赖 TopoDS_Shape 的对象地址                                         │
    │   而是通过形状的【包围盒中心点】进行空间匹配                               │
    │                                                                         │
    │   即使形状对象被替换，只要位置相同，就能找回属性                            │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘


    工作原理:

    ┌───────────────────────────────────────────────────────────────────────────┐
    │                                                                           │
    │  【存储阶段】                                                              │
    │                                                                           │
    │     TopoDS_Vertex A                    OCCAttributesRTree                │
    │     ┌──────────────┐                   ┌──────────────────────┐          │
    │     │ 位置(0,0,0)  │ ──── 计算中心 ───► │  R-Tree 索引          │          │
    │     │ meshSize=0.1 │       (0,0,0)     │  ┌────────────────┐  │          │
    │     └──────────────┘                   │  │ key: (0,0,0)   │  │          │
    │                                        │  │ val: meshSize  │  │          │
    │                                        │  │      = 0.1     │  │          │
    │                                        │  └────────────────┘  │          │
    │                                        └──────────────────────┘          │
    │                                                                           │
    └───────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 布尔操作
                                    ▼
    ┌───────────────────────────────────────────────────────────────────────────┐
    │                                                                           │
    │  【查询阶段】                                                              │
    │                                                                           │
    │     TopoDS_Vertex A' (新对象)          OCCAttributesRTree                │
    │     ┌──────────────┐                   ┌──────────────────────┐          │
    │     │ 位置(0,0,0)  │ ──── 计算中心 ───► │  R-Tree 搜索          │          │
    │     │ meshSize=??? │       (0,0,0)     │  ┌────────────────┐  │          │
    │     └──────────────┘           │       │  │ key: (0,0,0)   │  │          │
    │           ▲                    └──────►│  │ val: meshSize  │──┼──┐      │
    │           │                            │  │      = 0.1     │  │  │      │
    │           │        找到了!              │  └────────────────┘  │  │      │
    │           └─────────────────────────────┴──────────────────────┘  │      │
    │                                                                    │      │
    │     meshSize = 0.1  ◄─────────────────────────────────────────────┘      │
    │                                                                           │
    └───────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 数据结构总览

### 2.1 OCCAttributesRTree 结构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          OCCAttributesRTree 类结构                               │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────────────────────────────────────────┐
    │  class OCCAttributesRTree                                                 │
    │  ────────────────────────                                                 │
    │                                                                           │
    │  private:                                                                 │
    │  ┌─────────────────────────────────────────────────────────────────────┐ │
    │  │  _rtree[4]  ─── 四棵独立的 R-Tree                                    │ │
    │  │                                                                      │ │
    │  │     ┌─────────────────────────────────────────────────────────────┐ │ │
    │  │     │                                                             │ │ │
    │  │     │  _rtree[0] ────► 顶点 (Vertex, dim=0) 属性树                 │ │ │
    │  │     │       │                                                     │ │ │
    │  │     │       ├── 网格尺寸                                          │ │ │
    │  │     │       ├── 标签                                              │ │ │
    │  │     │       └── 颜色                                              │ │ │
    │  │     │                                                             │ │ │
    │  │     │  _rtree[1] ────► 边 (Edge, dim=1) 属性树                     │ │ │
    │  │     │       │                                                     │ │ │
    │  │     │       ├── 拉伸参数                                          │ │ │
    │  │     │       ├── 标签                                              │ │ │
    │  │     │       └── 颜色                                              │ │ │
    │  │     │                                                             │ │ │
    │  │     │  _rtree[2] ────► 面 (Face, dim=2) 属性树                     │ │ │
    │  │     │       │                                                     │ │ │
    │  │     │       ├── 拉伸参数                                          │ │ │
    │  │     │       ├── 标签                                              │ │ │
    │  │     │       └── 颜色                                              │ │ │
    │  │     │                                                             │ │ │
    │  │     │  _rtree[3] ────► 体 (Solid, dim=3) 属性树                    │ │ │
    │  │     │       │                                                     │ │ │
    │  │     │       ├── 标签                                              │ │ │
    │  │     │       └── 颜色                                              │ │ │
    │  │     │                                                             │ │ │
    │  │     └─────────────────────────────────────────────────────────────┘ │ │
    │  └─────────────────────────────────────────────────────────────────────┘ │
    │                                                                           │
    │  ┌─────────────────────────────────────────────────────────────────────┐ │
    │  │  _all  ─── 所有属性对象的列表                                        │ │
    │  │                                                                      │ │
    │  │     vector<OCCAttributes*>                                           │ │
    │  │     ┌────┬────┬────┬────┬────┬─────┐                                │ │
    │  │     │ A0 │ A1 │ A2 │ A3 │ A4 │ ... │                                │ │
    │  │     └────┴────┴────┴────┴────┴─────┘                                │ │
    │  │                                                                      │ │
    │  │     用途: 统一内存管理，clear() 时释放所有对象                         │ │
    │  └─────────────────────────────────────────────────────────────────────┘ │
    │                                                                           │
    │  ┌─────────────────────────────────────────────────────────────────────┐ │
    │  │  _tol  ─── 匹配容差                                                  │ │
    │  │                                                                      │ │
    │  │     默认值: 1e-8                                                     │ │
    │  │     来源: CTX::instance()->geom.tolerance                            │ │
    │  │     作用: 空间搜索时的模糊匹配范围                                     │ │
    │  └─────────────────────────────────────────────────────────────────────┘ │
    │                                                                           │
    └───────────────────────────────────────────────────────────────────────────┘
```

### 2.2 为什么分成 4 棵树？

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          维度分离存储的优势                                       │
└─────────────────────────────────────────────────────────────────────────────────┘


    【方案对比】

    ┌───────────────────────────────────────────────────────────────────────────┐
    │  方案A: 单一 R-Tree (所有维度混存)                                         │
    │  ─────────────────────────────────                                        │
    │                                                                           │
    │       ┌─────────────────────────────────────┐                            │
    │       │          单棵 R-Tree                 │                            │
    │       │  ┌─────┬─────┬─────┬─────┬─────┐   │                            │
    │       │  │顶点1│ 边1 │顶点2│ 面1 │ 体1 │...│                            │
    │       │  └─────┴─────┴─────┴─────┴─────┘   │                            │
    │       └─────────────────────────────────────┘                            │
    │                                                                           │
    │       问题:                                                               │
    │       • 搜索空间大，效率低                                                 │
    │       • 点和体的中心可能重合，导致误匹配                                    │
    │         例: 立方体中心点 (0.5, 0.5, 0.5) 和                               │
    │             位于该位置的顶点 可能混淆                                       │
    │                                                                           │
    └───────────────────────────────────────────────────────────────────────────┘


    ┌───────────────────────────────────────────────────────────────────────────┐
    │  方案B: 四棵独立 R-Tree (按维度分离) ✓ 采用                                 │
    │  ─────────────────────────────────────────────                            │
    │                                                                           │
    │       ┌──────────────┐  ┌──────────────┐                                 │
    │       │ _rtree[0]    │  │ _rtree[1]    │                                 │
    │       │ 顶点专用      │  │ 边专用        │                                 │
    │       │ ┌────┬────┐  │  │ ┌────┬────┐  │                                 │
    │       │ │ V1 │ V2 │  │  │ │ E1 │ E2 │  │                                 │
    │       │ └────┴────┘  │  │ └────┴────┘  │                                 │
    │       └──────────────┘  └──────────────┘                                 │
    │                                                                           │
    │       ┌──────────────┐  ┌──────────────┐                                 │
    │       │ _rtree[2]    │  │ _rtree[3]    │                                 │
    │       │ 面专用        │  │ 体专用        │                                 │
    │       │ ┌────┬────┐  │  │ ┌────┬────┐  │                                 │
    │       │ │ F1 │ F2 │  │  │ │ S1 │ S2 │  │                                 │
    │       │ └────┴────┘  │  │ └────┴────┘  │                                 │
    │       └──────────────┘  └──────────────┘                                 │
    │                                                                           │
    │       优势:                                                               │
    │       ✓ 搜索范围缩小 4 倍                                                 │
    │       ✓ 不同维度实体不会互相干扰                                           │
    │       ✓ 按维度独立管理，逻辑清晰                                           │
    │                                                                           │
    └───────────────────────────────────────────────────────────────────────────┘
```

### 2.3 OCCAttributes 属性类结构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           OCCAttributes 属性容器                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────────────────────────────────────────┐
    │  class OCCAttributes                                                      │
    │  ───────────────────                                                      │
    │                                                                           │
    │  ┌─────────────────────────────────────────────────────────────────────┐ │
    │  │  基本信息                                                            │ │
    │  │  ─────────                                                           │ │
    │  │                                                                      │ │
    │  │  ┌────────────────┬─────────────────────────────────────────────┐  │ │
    │  │  │ _dim           │ 维度: 0=点, 1=边, 2=面, 3=体                 │  │ │
    │  │  ├────────────────┼─────────────────────────────────────────────┤  │ │
    │  │  │ _shape         │ 关联的 TopoDS_Shape 对象                     │  │ │
    │  │  └────────────────┴─────────────────────────────────────────────┘  │ │
    │  └─────────────────────────────────────────────────────────────────────┘ │
    │                                                                           │
    │  ┌─────────────────────────────────────────────────────────────────────┐ │
    │  │  网格属性                                                            │ │
    │  │  ─────────                                                           │ │
    │  │                                                                      │ │
    │  │  ┌────────────────┬─────────────────────────────────────────────┐  │ │
    │  │  │ _meshSize      │ 网格尺寸 (默认 MAX_LC = 1e22)                │  │ │
    │  │  └────────────────┴─────────────────────────────────────────────┘  │ │
    │  └─────────────────────────────────────────────────────────────────────┘ │
    │                                                                           │
    │  ┌─────────────────────────────────────────────────────────────────────┐ │
    │  │  拉伸参数 (用于 Extrude/Revolve 操作)                                │ │
    │  │  ───────────────────────────────────                                 │ │
    │  │                                                                      │ │
    │  │  ┌────────────────┬─────────────────────────────────────────────┐  │ │
    │  │  │ _extrude       │ 拉伸参数指针 (ExtrudeParams*)                │  │ │
    │  │  ├────────────────┼─────────────────────────────────────────────┤  │ │
    │  │  │ _sourceDim     │ 拉伸源实体的维度                             │  │ │
    │  │  ├────────────────┼─────────────────────────────────────────────┤  │ │
    │  │  │ _sourceShape   │ 拉伸源实体的形状                             │  │ │
    │  │  └────────────────┴─────────────────────────────────────────────┘  │ │
    │  └─────────────────────────────────────────────────────────────────────┘ │
    │                                                                           │
    │  ┌─────────────────────────────────────────────────────────────────────┐ │
    │  │  显示属性 (来自 STEP/IGES 文件)                                      │ │
    │  │  ────────────────────────────────                                    │ │
    │  │                                                                      │ │
    │  │  ┌────────────────┬─────────────────────────────────────────────┐  │ │
    │  │  │ _label         │ 实体名称/标签 (string)                       │  │ │
    │  │  ├────────────────┼─────────────────────────────────────────────┤  │ │
    │  │  │ _color         │ 颜色 [r, g, b, a, boundary] (vector<double>)│  │ │
    │  │  └────────────────┴─────────────────────────────────────────────┘  │ │
    │  └─────────────────────────────────────────────────────────────────────┘ │
    │                                                                           │
    └───────────────────────────────────────────────────────────────────────────┘


    【构造函数重载】

    ┌───────────────────────────────────────────────────────────────────────────┐
    │                                                                           │
    │  OCCAttributes(dim, shape)              ─► 仅绑定形状                     │
    │       │                                                                   │
    │       ▼                                                                   │
    │  OCCAttributes(dim, shape, meshSize)    ─► 绑定形状 + 网格尺寸            │
    │       │                                                                   │
    │       ▼                                                                   │
    │  OCCAttributes(dim, shape, extrude,     ─► 绑定形状 + 拉伸参数            │
    │                sourceDim, sourceShape)                                    │
    │       │                                                                   │
    │       ▼                                                                   │
    │  OCCAttributes(dim, shape, label)       ─► 绑定形状 + 标签                │
    │       │                                                                   │
    │       ▼                                                                   │
    │  OCCAttributes(dim, shape, r,g,b,a)     ─► 绑定形状 + 颜色                │
    │                                                                           │
    └───────────────────────────────────────────────────────────────────────────┘
```

---

## 3. R-Tree 空间索引原理

### 3.1 R-Tree 基本概念

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              R-Tree 空间索引结构                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

    R-Tree (Rectangle Tree) - 矩形树
    由 Antonin Guttman 于 1984 年提出
    专门用于多维空间数据的索引

    【2D 示例: 存储 6 个点】

    空间分布:                           R-Tree 结构:
    ────────────                        ────────────

    Y                                          ┌─────────────┐
    │                                          │   根节点     │
    │  ┌─────────────────────────────┐        │  整个空间    │
    │  │ ┌───────────┐ ┌───────────┐ │        └──────┬──────┘
    │  │ │    A      │ │     B     │ │               │
    │  │ │  P1  P2   │ │  P3  P4   │ │        ┌──────┴──────┐
    │  │ └───────────┘ └───────────┘ │        │             │
    │  │ ┌─────────────────────────┐ │    ┌───▼───┐     ┌───▼───┐
    │  │ │          C              │ │    │ 节点A │     │ 节点B │
    │  │ │      P5      P6         │ │    │P1, P2 │     │P3, P4 │
    │  │ └─────────────────────────┘ │    └───────┘     └───────┘
    │  └─────────────────────────────┘         │
    │                                      ┌───▼───┐
    └────────────────────────────────X     │ 节点C │
                                           │P5, P6 │
                                           └───────┘

    【时间复杂度】

    ┌────────────┬─────────────┬─────────────┐
    │   操作     │  列表遍历    │   R-Tree    │
    ├────────────┼─────────────┼─────────────┤
    │   插入     │    O(1)     │  O(log n)   │
    │   删除     │    O(n)     │  O(log n)   │
    │   搜索     │    O(n)     │  O(log n)   │ ← 关键优势
    │   范围查询  │    O(n)     │  O(log n)   │
    └────────────┴─────────────┴─────────────┘
```

### 3.2 在 OCCAttributesRTree 中的应用

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        R-Tree 在属性存储中的应用                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

    【3D 空间中的形状属性存储】

                        Z
                        │
                        │    ┌────────────────────────────────┐
                        │   ╱                                ╱│
                        │  ╱     R-Tree 覆盖空间             ╱ │
                        │ ╱                                ╱  │
                        │┌────────────────────────────────┐   │
                        ││                                │   │
                        ││    • P1 (顶点, meshSize=0.1)   │   │
                        ││                                │   │
                        ││         ─── E1 (边, label)     │   │
                        ││                                │   │
                        ││    ┌───┐ F1 (面, color=red)    │  ╱
                        ││    └───┘                       │ ╱
                        │└────────────────────────────────┘╱
                        └─────────────────────────────────────── Y
                       ╱
                      ╱
                     X

    【索引键: 包围盒中心点】

    ┌───────────────────────────────────────────────────────────────────────────┐
    │                                                                           │
    │  为什么用包围盒中心而不是整个包围盒?                                        │
    │                                                                           │
    │  ┌─────────────────────────┐      ┌─────────────────────────┐            │
    │  │ 使用整个包围盒           │      │ 使用中心点 + 容差        │            │
    │  │                         │      │                         │            │
    │  │   ┌─────────────┐       │      │         •               │            │
    │  │   │             │       │      │     [中心±tol]          │            │
    │  │   │   形状      │       │      │                         │            │
    │  │   │             │       │      │  更精确的空间定位         │            │
    │  │   └─────────────┘       │      │  减少误匹配概率          │            │
    │  │                         │      │                         │            │
    │  │  索引范围过大            │      │  ✓ 采用此方案            │            │
    │  │  可能产生大量候选        │      │                         │            │
    │  └─────────────────────────┘      └─────────────────────────┘            │
    │                                                                           │
    └───────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 核心操作流程图

### 4.1 插入操作 `insert()`

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              insert() 流程图                                     │
└─────────────────────────────────────────────────────────────────────────────────┘


    输入: OCCAttributes* v (一个属性对象)
                │
                ▼
    ┌───────────────────────────────────────┐
    │  1. 加入内存管理列表                    │
    │     _all.push_back(v)                 │
    └───────────────────┬───────────────────┘
                        │
                        ▼
    ┌───────────────────────────────────────┐
    │  2. 检查维度有效性                      │
    │     if(dim < 0 || dim > 3) return     │
    └───────────────────┬───────────────────┘
                        │ 有效
                        ▼
    ┌───────────────────────────────────────┐
    │  3. 计算形状的包围盒                    │
    │                                       │
    │     Bnd_Box box;                      │
    │     BRepBndLib::Add(shape, box);      │
    │                                       │
    │         ┌─────────────┐               │
    │         │  TopoDS_    │               │
    │         │   Shape     │  ──►  Bnd_Box │
    │         └─────────────┘               │
    └───────────────────┬───────────────────┘
                        │
                        ▼
    ┌───────────────────────────────────────┐
    │  4. 检查包围盒是否有效                  │
    │     if(box.IsVoid()) return           │
    └───────────────────┬───────────────────┘
                        │ 有效
                        ▼
    ┌───────────────────────────────────────┐
    │  5. 获取包围盒边界                      │
    │                                       │
    │     box.Get(xmin, ymin, zmin,         │
    │             xmax, ymax, zmax)          │
    │                                       │
    │     ┌─────────────────────────────┐   │
    │     │        (xmax,ymax,zmax)     │   │
    │     │            ┌────────────────┤   │
    │     │            │                │   │
    │     │            │   Bnd_Box      │   │
    │     │            │                │   │
    │     ├────────────┘                │   │
    │     │ (xmin,ymin,zmin)            │   │
    │     └─────────────────────────────┘   │
    └───────────────────┬───────────────────┘
                        │
                        ▼
    ┌───────────────────────────────────────┐
    │  6. 计算中心点                         │
    │                                       │
    │     x = (xmin + xmax) / 2             │
    │     y = (ymin + ymax) / 2             │
    │     z = (zmin + zmax) / 2             │
    │                                       │
    │     ┌─────────────────────────────┐   │
    │     │            ┌────────────────┤   │
    │     │            │      • (x,y,z) │   │
    │     │            │    中心点       │   │
    │     │            │                │   │
    │     ├────────────┘                │   │
    │     └─────────────────────────────┘   │
    └───────────────────┬───────────────────┘
                        │
                        ▼
    ┌───────────────────────────────────────┐
    │  7. 构造索引范围 [中心 ± 容差]          │
    │                                       │
    │     bmin = [x-tol, y-tol, z-tol]      │
    │     bmax = [x+tol, y+tol, z+tol]      │
    │                                       │
    │           ┌───┐                       │
    │           │ • │  ← 中心点 ± tol       │
    │           └───┘                       │
    │          极小的索引范围                 │
    └───────────────────┬───────────────────┘
                        │
                        ▼
    ┌───────────────────────────────────────┐
    │  8. 插入到对应维度的 R-Tree             │
    │                                       │
    │     _rtree[dim]->Insert(bmin, bmax, v)│
    │                                       │
    │     dim=0 → _rtree[0] (顶点树)        │
    │     dim=1 → _rtree[1] (边树)          │
    │     dim=2 → _rtree[2] (面树)          │
    │     dim=3 → _rtree[3] (体树)          │
    └───────────────────────────────────────┘
                        │
                        ▼
                   插入完成
```

### 4.2 查找操作 `_find()` - 两级匹配策略

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         _find() 两级匹配流程图                                    │
└─────────────────────────────────────────────────────────────────────────────────┘


    输入: dim (维度), shape (目标形状), 各种筛选条件
                │
                ▼
    ┌───────────────────────────────────────────────────────────────────────────┐
    │  第一阶段: R-Tree 范围搜索                                                  │
    └───────────────────────────────────────────────────────────────────────────┘
                │
                ▼
    ┌───────────────────────────────────────┐
    │  1. 计算目标形状的包围盒中心            │
    │                                       │
    │     Bnd_Box box;                      │
    │     BRepBndLib::Add(shape, box);      │
    │     box.Get(xmin, ymin, zmin,         │
    │             xmax, ymax, zmax);         │
    │                                       │
    │     x = (xmin + xmax) / 2             │
    │     y = (ymin + ymax) / 2             │
    │     z = (zmin + zmax) / 2             │
    └───────────────────┬───────────────────┘
                        │
                        ▼
    ┌───────────────────────────────────────┐
    │  2. 在 R-Tree 中搜索候选               │
    │                                       │
    │     bmin = [x-tol, y-tol, z-tol]      │
    │     bmax = [x+tol, y+tol, z+tol]      │
    │                                       │
    │     _rtree[dim]->Search(bmin, bmax,   │
    │                         callback,     │
    │                         &candidates)  │
    │                                       │
    │     返回: 候选列表 tmp[]               │
    └───────────────────┬───────────────────┘
                        │
                        ▼
    ┌───────────────────────────────────────────────────────────────────────────┐
    │  第二阶段: 精确匹配 (第一级)                                                 │
    │  ─────────────────────────────                                             │
    │  适用场景: 形状对象未被布尔操作修改                                           │
    └───────────────────────────────────────────────────────────────────────────┘
                │
                ▼
    ┌───────────────────────────────────────┐
    │  3. 遍历候选，检查精确匹配              │
    │                                       │
    │     for(each candidate in tmp) {      │
    │                                       │
    │         // 检查属性条件                 │
    │         if(需要meshSize &&             │
    │            candidate无meshSize)        │
    │             continue;                 │
    │                                       │
    │         // 精确匹配: 同一个对象         │
    │         if(shape.IsSame(              │
    │            candidate->getShape()))    │
    │         {                             │
    │             attr.push_back(candidate);│
    │             return;  ← 立即返回        │
    │         }                             │
    │     }                                 │
    └───────────────────┬───────────────────┘
                        │
                没有精确匹配
                        │
                        ▼
    ┌───────────────────────────────────────────────────────────────────────────┐
    │  第三阶段: 包围盒匹配 (第二级)                                               │
    │  ─────────────────────────────                                             │
    │  适用场景: 形状被布尔操作替换，但位置和大小相同                                │
    └───────────────────────────────────────────────────────────────────────────┘
                │
                ▼
    ┌───────────────────────────────────────┐
    │  4. 比较候选的包围盒边界               │
    │                                       │
    │     for(each candidate in tmp) {      │
    │                                       │
    │         // 获取候选的包围盒            │
    │         Bnd_Box box2;                 │
    │         BRepBndLib::Add(              │
    │             candidate->getShape(),    │
    │             box2);                    │
    │         box2.Get(xmin2, ymin2, zmin2, │
    │                  xmax2, ymax2, zmax2);│
    │                                       │
    │         // 比较 6 个边界值             │
    │         if(|xmin-xmin2| < tol &&      │
    │            |xmax-xmax2| < tol &&      │
    │            |ymin-ymin2| < tol &&      │
    │            |ymax-ymax2| < tol &&      │
    │            |zmin-zmin2| < tol &&      │
    │            |zmax-zmax2| < tol)        │
    │         {                             │
    │             attr.push_back(candidate);│
    │         }                             │
    │     }                                 │
    └───────────────────┬───────────────────┘
                        │
                        ▼
               返回匹配结果 attr[]
```

### 4.3 两级匹配策略可视化

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           两级匹配策略图解                                        │
└─────────────────────────────────────────────────────────────────────────────────┘


    【情况1: 精确匹配成功】
    ──────────────────────
    形状对象未被修改

    存储的属性:                     查询的形状:
    ┌───────────────────┐          ┌───────────────────┐
    │ shape: 0x1234     │          │ shape: 0x1234     │ ← 同一个对象
    │ center: (1,2,3)   │          │ center: (1,2,3)   │
    │ meshSize: 0.1     │          └───────────────────┘
    └───────────────────┘
            │                               │
            └───────────┬───────────────────┘
                        │
                        ▼
                ┌───────────────┐
                │ IsSame()=true │ ─► 精确匹配 ─► 返回属性
                └───────────────┘


    【情况2: 包围盒匹配成功】
    ──────────────────────────
    形状对象被布尔操作替换

    存储的属性:                     查询的形状:
    ┌───────────────────┐          ┌───────────────────┐
    │ shape: 0x1234     │          │ shape: 0x5678     │ ← 不同对象!
    │ center: (1,2,3)   │          │ center: (1,2,3)   │ ← 位置相同
    │ bbox: [0,0,0]-    │          │ bbox: [0,0,0]-    │ ← 包围盒相同
    │       [2,4,6]     │          │       [2,4,6]     │
    │ meshSize: 0.1     │          └───────────────────┘
    └───────────────────┘
            │                               │
            └───────────┬───────────────────┘
                        │
                        ▼
                ┌───────────────┐
                │ IsSame()=false│
                └───────┬───────┘
                        │
                        ▼
                ┌───────────────┐
                │ 包围盒比较     │
                │ 6个边界值相同  │ ─► 包围盒匹配 ─► 返回属性
                └───────────────┘


    【流程总图】

                    ┌─────────────────────────────────────────┐
                    │         R-Tree 范围搜索                  │
                    │         找到候选列表                     │
                    └────────────────┬────────────────────────┘
                                     │
                                     ▼
                    ┌─────────────────────────────────────────┐
                    │      第一级: 精确匹配                     │
                    │      shape.IsSame()                     │
                    └────────────────┬────────────────────────┘
                                     │
                         ┌───────────┴───────────┐
                         │                       │
                      匹配成功                  匹配失败
                         │                       │
                         ▼                       ▼
                    ┌─────────┐     ┌─────────────────────────────┐
                    │ 返回!   │     │   第二级: 包围盒匹配          │
                    └─────────┘     │   比较 6 个边界值            │
                                    └────────────────┬────────────┘
                                                     │
                                         ┌───────────┴───────────┐
                                         │                       │
                                      匹配成功                  匹配失败
                                         │                       │
                                         ▼                       ▼
                                    ┌─────────┐            ┌─────────┐
                                    │ 返回!   │            │ 返回空  │
                                    └─────────┘            └─────────┘
```

---

## 5. 在 OCC_Internals 中的使用场景

### 5.1 属性插入时机

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           属性插入时机图解                                        │
└─────────────────────────────────────────────────────────────────────────────────┘


    【场景1: 创建顶点时设置网格尺寸】

    用户调用:
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  gmsh.model.occ.addPoint(0, 0, 0, meshSize=0.1)                         │
    └─────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  OCC_Internals::addVertex(tag, x, y, z, meshSize)                       │
    │                                                                         │
    │      // 创建 OCC 顶点                                                    │
    │      TopoDS_Vertex vertex = BRepBuilderAPI_MakeVertex(gp_Pnt(x,y,z));   │
    │                                                                         │
    │      // 如果指定了网格尺寸，插入属性                                       │
    │      if(meshSize < MAX_LC) {                                            │
    │          _attributes->insert(                                           │
    │              new OCCAttributes(0, vertex, meshSize)  ◄── 插入属性       │
    │          );                                                             │
    │      }                                                                  │
    └─────────────────────────────────────────────────────────────────────────┘


    【场景2: 绑定形状时自动插入基本属性】

    ┌─────────────────────────────────────────────────────────────────────────┐
    │  OCC_Internals::_bind(vertex, tag, recursive)                           │
    │  {                                                                      │
    │      // ... 其他绑定逻辑 ...                                             │
    │                                                                         │
    │      _attributes->insert(                                               │
    │          new OCCAttributes(0, vertex)  ◄── 基本绑定属性                  │
    │      );                                                                 │
    │  }                                                                      │
    └─────────────────────────────────────────────────────────────────────────┘


    【场景3: 拉伸操作传递属性】

    用户调用:
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  gmsh.model.occ.extrude([(2, face_tag)], dx, dy, dz)                    │
    └─────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  拉伸操作内部                                                            │
    │                                                                         │
    │      bottom_face ────────────────────► top_face                        │
    │           │                                 │                           │
    │           │         拉伸                     │                           │
    │           ▼                                 ▼                           │
    │      ┌─────────┐                      ┌─────────┐                       │
    │      │ meshSize│     ──────────►      │ meshSize│  ◄── 属性传递         │
    │      │ = 0.1   │     属性复制          │ = 0.1   │                       │
    │      └─────────┘                      └─────────┘                       │
    │                                                                         │
    │      _attributes->insert(new OCCAttributes(2, top, meshSize));          │
    │      _attributes->insert(new OCCAttributes(2, top, extrudeParams));     │
    └─────────────────────────────────────────────────────────────────────────┘


    【场景4: 从 STEP/IGES 文件导入属性】

    文件内容:
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  STEP 文件:                                                             │
    │  #123 = PRODUCT('Inlet', ...);        ← 实体名称                        │
    │  #456 = COLOUR_RGB(1.0, 0.0, 0.0);    ← 颜色定义                        │
    └─────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  导入过程                                                                │
    │                                                                         │
    │      // 读取标签                                                         │
    │      string label = "Inlet";                                            │
    │      _attributes->insert(new OCCAttributes(dim, shape, label));         │
    │                                                                         │
    │      // 读取颜色                                                         │
    │      double r=1.0, g=0.0, b=0.0;                                        │
    │      _attributes->insert(new OCCAttributes(dim, shape, r, g, b));       │
    └─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 属性查询与应用

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         synchronize() 中属性的应用                               │
└─────────────────────────────────────────────────────────────────────────────────┘


    OCC_Internals::synchronize(GModel *model)
    {
        ┌─────────────────────────────────────────────────────────────────────┐
        │  遍历所有顶点                                                        │
        │                                                                     │
        │  for(each vertex in _vmap) {                                        │
        │                                                                     │
        │      // 创建 GVertex                                                │
        │      GVertex *gv = new OCCVertex(model, vertex, tag);               │
        │                                                                     │
        └───────────────────────────┬─────────────────────────────────────────┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            │                       │                       │
            ▼                       ▼                       ▼
    ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐
    │ 1. 获取网格尺寸    │  │ 2. 获取标签        │  │ 3. 获取颜色        │
    │                   │  │                   │  │                   │
    │ double lc =       │  │ vector<string>    │  │ unsigned int col; │
    │   _attributes->   │  │   labels;         │  │ _attributes->     │
    │   getMeshSize(    │  │ _attributes->     │  │   getColor(       │
    │     0, vertex);   │  │   getLabels(      │  │     0, vertex,    │
    │                   │  │     0, vertex,    │  │     col);         │
    │ if(lc < MAX_LC)   │  │     labels);      │  │                   │
    │   gv->setMesh     │  │                   │  │ if(有颜色)         │
    │   SizeAtVertex    │  │ if(labels.size()) │  │   gv->setColor    │
    │   (lc);           │  │   model->setName  │  │   (col);          │
    │                   │  │   (labels[0]);    │  │                   │
    └───────────────────┘  └───────────────────┘  └───────────────────┘
            │                       │                       │
            └───────────────────────┼───────────────────────┘
                                    │
                                    ▼
        ┌─────────────────────────────────────────────────────────────────────┐
        │      // 对边、面、体重复同样的过程...                                  │
        │  }                                                                  │
        └─────────────────────────────────────────────────────────────────────┘
    }


    【数据流向图】

    ┌─────────────┐                              ┌─────────────┐
    │ 用户设置     │                              │  网格生成    │
    │ meshSize    │                              │  使用属性    │
    └──────┬──────┘                              └──────▲──────┘
           │                                            │
           │                                            │
           ▼                                            │
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │   ┌─────────────────┐    synchronize()    ┌─────────────────┐          │
    │   │                 │                     │                 │          │
    │   │  OCC_Internals  │ ──────────────────► │     GModel      │          │
    │   │                 │                     │                 │          │
    │   │  _attributes    │    属性传递          │   GVertex       │          │
    │   │  (R-Tree)       │ ──────────────────► │   GEdge         │          │
    │   │                 │                     │   GFace         │          │
    │   │  TopoDS_Shape   │                     │   GRegion       │          │
    │   │                 │                     │                 │          │
    │   └─────────────────┘                     └─────────────────┘          │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 设计亮点与工程考量

### 6.1 方案对比

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                             存储方案对比                                         │
└─────────────────────────────────────────────────────────────────────────────────┘


    ┌─────────────────────────────────────────────────────────────────────────┐
    │  方案 A: 哈希表 (map<TopoDS_Shape, Attributes>)                          │
    │  ───────────────────────────────────────────────                         │
    │                                                                         │
    │      优点: O(1) 精确查找                                                 │
    │                                                                         │
    │      缺点:                                                               │
    │      ┌─────────────┐      布尔操作      ┌─────────────┐                 │
    │      │ Shape 0x1234│  ──────────────►  │ Shape 0x5678│                 │
    │      │     ↓       │     对象替换       │     ↓       │                 │
    │      │ 找到属性    │                   │ 找不到!!!   │                 │
    │      └─────────────┘                   └─────────────┘                 │
    │                                                                         │
    │      ✗ 无法处理形状替换后的模糊匹配                                       │
    └─────────────────────────────────────────────────────────────────────────┘


    ┌─────────────────────────────────────────────────────────────────────────┐
    │  方案 B: 列表遍历 (vector<pair<Shape, Attributes>>)                      │
    │  ────────────────────────────────────────────────                        │
    │                                                                         │
    │      优点: 实现简单                                                      │
    │                                                                         │
    │      缺点:                                                               │
    │      ┌────┬────┬────┬────┬────┬─────┐                                  │
    │      │ A1 │ A2 │ A3 │ A4 │ A5 │ ... │  ← 线性扫描 O(n)                  │
    │      └────┴────┴────┴────┴────┴─────┘                                  │
    │                                                                         │
    │      对于包含 100000 个实体的大模型：                                     │
    │      每次查询都要遍历整个列表 ✗                                           │
    └─────────────────────────────────────────────────────────────────────────┘


    ┌─────────────────────────────────────────────────────────────────────────┐
    │  方案 C: R-Tree 空间索引  ✓ 采用                                         │
    │  ────────────────────────────────                                        │
    │                                                                         │
    │      优点:                                                               │
    │      • O(log n) 范围查询                                                 │
    │      • 支持模糊匹配 (空间位置)                                            │
    │      • 两级匹配策略兼顾效率和鲁棒性                                        │
    │                                                                         │
    │                  ┌─────────────┐                                        │
    │                  │   R-Tree    │                                        │
    │                  │   ╱    ╲    │                                        │
    │                  │  ╱      ╲   │  ← 树形结构 O(log n)                   │
    │                  │ ╱        ╲  │                                        │
    │                  │○  ○  ○  ○│                                        │
    │                  └─────────────┘                                        │
    │                                                                         │
    │      布尔操作后:                                                         │
    │      ┌─────────────┐              ┌─────────────┐                       │
    │      │ Shape 0x1234│   形状替换   │ Shape 0x5678│                       │
    │      │ center(1,2,3)│ ──────────► │ center(1,2,3)│ ← 位置相同           │
    │      └─────────────┘              └──────┬──────┘                       │
    │                                          │                              │
    │                                          ▼                              │
    │                                   ┌─────────────┐                       │
    │                                   │ 包围盒匹配   │ ✓ 找到属性            │
    │                                   └─────────────┘                       │
    └─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 容差设计

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              容差参数设计                                        │
└─────────────────────────────────────────────────────────────────────────────────┘


    OCCAttributesRTree(double tolerance = 1.e-8)

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │  来源: CTX::instance()->geom.tolerance                                  │
    │  默认值: 1e-8                                                           │
    │  作用: 空间搜索和包围盒比较的模糊范围                                      │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘


    【容差影响分析】

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │  容差过大 (如 0.1)                                                       │
    │  ──────────────────                                                     │
    │                                                                         │
    │       搜索范围                                                           │
    │      ┌─────────────────────────────┐                                   │
    │      │                             │                                   │
    │      │    • A      • B      • C    │  ← 三个不同的点都在范围内           │
    │      │                             │                                   │
    │      └─────────────────────────────┘                                   │
    │                                                                         │
    │      问题: 可能匹配到错误的实体 (误匹配)                                   │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘


    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │  容差过小 (如 1e-15)                                                     │
    │  ────────────────────                                                   │
    │                                                                         │
    │       存储位置         查询位置                                          │
    │           •               •  ← 浮点误差导致位置微小差异                   │
    │       (1.0, 2.0, 3.0)    (1.0+ε, 2.0+ε, 3.0+ε)                         │
    │                                                                         │
    │      问题: 相同位置的点可能因浮点误差而匹配失败 (漏匹配)                    │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘


    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │  合适的容差 (1e-8)  ✓                                                    │
    │  ────────────────────                                                   │
    │                                                                         │
    │       • 大于典型的浮点计算误差                                            │
    │       • 小于最小几何特征尺寸                                              │
    │       • 与 OpenCASCADE 的内部精度一致                                     │
    │                                                                         │
    │       ┌───┐                                                             │
    │       │ • │ ← 刚好匹配单个点，不会误匹配邻近点                            │
    │       └───┘                                                             │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 完整工作流程示例

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           完整工作流程示例                                        │
└─────────────────────────────────────────────────────────────────────────────────┘


    用户代码:
    ═══════════════════════════════════════════════════════════════════════════

    gmsh.initialize()
    gmsh.model.add("test")

    # 创建点，设置网格尺寸
    p1 = gmsh.model.occ.addPoint(0, 0, 0, meshSize=0.1)
    p2 = gmsh.model.occ.addPoint(1, 0, 0, meshSize=0.2)

    # 创建两个相交的圆
    c1 = gmsh.model.occ.addCircle(0, 0, 0, 0.5)
    c2 = gmsh.model.occ.addCircle(0.3, 0, 0, 0.5)

    # 布尔碎片化（会替换形状对象）
    gmsh.model.occ.fragment(...)

    # 同步到 GModel
    gmsh.model.occ.synchronize()

    # 网格生成
    gmsh.model.mesh.generate(1)

    ═══════════════════════════════════════════════════════════════════════════


    内部执行流程:

    ┌─────────────────────────────────────────────────────────────────────────┐
    │  T1: addPoint(0, 0, 0, meshSize=0.1)                                    │
    │                                                                         │
    │      TopoDS_Vertex v1 = MakeVertex(0, 0, 0)                             │
    │                                                                         │
    │      _attributes->insert(                                               │
    │          new OCCAttributes(0, v1, 0.1)                                  │
    │      )                                                                  │
    │                                                                         │
    │      R-Tree 状态:                                                        │
    │      ┌────────────────────────────────────┐                            │
    │      │ _rtree[0] (顶点树)                  │                            │
    │      │                                    │                            │
    │      │   key: center(0, 0, 0)             │                            │
    │      │   val: { shape=v1, meshSize=0.1 }  │                            │
    │      └────────────────────────────────────┘                            │
    └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  T2: addPoint(1, 0, 0, meshSize=0.2)                                    │
    │                                                                         │
    │      TopoDS_Vertex v2 = MakeVertex(1, 0, 0)                             │
    │                                                                         │
    │      _attributes->insert(                                               │
    │          new OCCAttributes(0, v2, 0.2)                                  │
    │      )                                                                  │
    │                                                                         │
    │      R-Tree 状态:                                                        │
    │      ┌────────────────────────────────────┐                            │
    │      │ _rtree[0] (顶点树)                  │                            │
    │      │                                    │                            │
    │      │   key: center(0, 0, 0)             │                            │
    │      │   val: { shape=v1, meshSize=0.1 }  │                            │
    │      │                                    │                            │
    │      │   key: center(1, 0, 0)             │                            │
    │      │   val: { shape=v2, meshSize=0.2 }  │                            │
    │      └────────────────────────────────────┘                            │
    └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  T3: fragment(...) 布尔碎片化                                            │
    │                                                                         │
    │      原始形状被销毁，新形状被创建:                                         │
    │                                                                         │
    │      v1 (0x1234) ─────X──────► v1' (0x5678)  新对象                     │
    │      v2 (0x2345) ─────X──────► v2' (0x6789)  新对象                     │
    │                                                                         │
    │      R-Tree 状态不变 (存储的是旧的形状对象):                               │
    │      ┌────────────────────────────────────┐                            │
    │      │ _rtree[0] (顶点树)                  │                            │
    │      │                                    │                            │
    │      │   key: center(0, 0, 0)             │                            │
    │      │   val: { shape=v1(旧), meshSize=0.1}│                            │
    │      │                                    │                            │
    │      │   key: center(1, 0, 0)             │                            │
    │      │   val: { shape=v2(旧), meshSize=0.2}│                            │
    │      └────────────────────────────────────┘                            │
    └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  T4: synchronize()                                                      │
    │                                                                         │
    │      对于新顶点 v1' (位于 0, 0, 0):                                       │
    │                                                                         │
    │      double lc = _attributes->getMeshSize(0, v1')                       │
    │                                                                         │
    │      查找过程:                                                           │
    │      ┌─────────────────────────────────────────────────────────────┐   │
    │      │ 1. 计算 v1' 的中心: (0, 0, 0)                                │   │
    │      │                                                             │   │
    │      │ 2. R-Tree 搜索 [(0,0,0) ± tol]                              │   │
    │      │    找到候选: { shape=v1(旧), meshSize=0.1 }                  │   │
    │      │                                                             │   │
    │      │ 3. 精确匹配: v1'.IsSame(v1) = false  (不同对象)              │   │
    │      │                                                             │   │
    │      │ 4. 包围盒匹配:                                               │   │
    │      │    v1' 的 bbox ≈ v1 的 bbox  ✓ 匹配成功!                    │   │
    │      │                                                             │   │
    │      │ 5. 返回 meshSize = 0.1                                      │   │
    │      └─────────────────────────────────────────────────────────────┘   │
    │                                                                         │
    │      GVertex *gv1 = new OCCVertex(model, v1', tag)                      │
    │      gv1->setPrescribedMeshSizeAtVertex(0.1)  ← 属性成功恢复!            │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  T5: mesh.generate(1)                                                   │
    │                                                                         │
    │      网格生成器使用 GVertex 上的 meshSize 属性:                           │
    │                                                                         │
    │      v1' ────► meshSize = 0.1 ────► 在该点附近生成密集网格               │
    │      v2' ────► meshSize = 0.2 ────► 在该点附近生成稀疏网格               │
    │                                                                         │
    │      属性在布尔操作后成功保留!  ✓                                         │
    └─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 总结

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           OCCAttributesRTree 总结                               │
└─────────────────────────────────────────────────────────────────────────────────┘


    ┌─────────────────────────────────────────────────────────────────────────┐
    │  核心问题                                                                │
    │  ─────────                                                              │
    │                                                                         │
    │  布尔操作会销毁原始形状对象，导致绑定在其上的属性丢失                        │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  解决方案                                                                │
    │  ─────────                                                              │
    │                                                                         │
    │  不依赖对象地址，而是通过空间位置（包围盒中心）进行匹配                      │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  关键技术                                                                │
    │  ─────────                                                              │
    │                                                                         │
    │  1. R-Tree 空间索引                                                      │
    │     • 高效的范围查询 O(log n)                                            │
    │     • 支持模糊匹配                                                       │
    │                                                                         │
    │  2. 两级匹配策略                                                         │
    │     • 第一级: 精确匹配 shape.IsSame()                                    │
    │     • 第二级: 包围盒边界匹配                                              │
    │                                                                         │
    │  3. 维度分离存储                                                         │
    │     • 4 棵独立的 R-Tree (点/边/面/体)                                    │
    │     • 减少误匹配，提高效率                                                │
    │                                                                         │
    │  4. 容差控制                                                             │
    │     • 默认 1e-8                                                         │
    │     • 与几何建模精度一致                                                  │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │  应用场景                                                                │
    │  ─────────                                                              │
    │                                                                         │
    │  • 网格尺寸控制 (meshSize)                                               │
    │  • 拉伸操作参数传递 (ExtrudeParams)                                      │
    │  • CAD 文件导入的颜色和标签保留                                           │
    │  • 布尔操作后的属性恢复                                                   │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
```

---

**文档创建日期**: 2025-12-25
**原始文档**: `/Users/renyuxiao/Documents/gmsh/gmsh-4.14.0-source/my-study/day2/OCCAttributesRTree-analysis.md`
