# OCC_Internals 构造函数深度解析

## 1. 构造函数代码

```cpp
OCC_Internals::OCC_Internals()
{
  for(int i = 0; i < 6; i++)
    _maxTag[i] = CTX::instance()->geom.firstEntityTag - 1;
  _changed = true;
  _attributes = new OCCAttributesRTree(CTX::instance()->geom.tolerance);
}
```

---

## 2. 整体架构关系图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Gmsh 几何系统架构                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                        用户 API 层                                        │  │
│   │   gmsh::model::occ::addPoint()  gmsh::model::occ::addLine()  ...         │  │
│   └──────────────────────────────┬──────────────────────────────────────────┘   │
│                                  │                                              │
│                                  ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                      OCC_Internals (桥梁层)                               │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌────────────────────────┐           │   │
│   │  │  _maxTag[6] │  │  _changed   │  │    _attributes         │           │   │
│   │  │  标签管理器  │  │  变化追踪器  │  │  (OCCAttributesRTree)  │           │   │
│   │  └─────────────┘  └─────────────┘  └────────────────────────┘           │   │
│   │                                                                          │   │
│   │  ┌──────────────────────────────────────────────────────────────┐       │   │
│   │  │           形状映射表 (Shape ↔ Tag)                            │       │   │
│   │  │  _tagVertex, _tagEdge, _tagFace, _tagSolid                   │       │   │
│   │  │  _vertexTag, _edgeTag, _faceTag, _solidTag                   │       │   │
│   │  └──────────────────────────────────────────────────────────────┘       │   │
│   └──────────────────────────────┬──────────────────────────────────────────┘   │
│                                  │                                              │
│                   ┌──────────────┼──────────────┐                              │
│                   │              │              │                              │
│                   ▼              ▼              ▼                              │
│   ┌───────────────────┐  ┌─────────────┐  ┌──────────────────────┐            │
│   │   OpenCASCADE     │  │   GModel    │  │   Mesh Generation    │            │
│   │   TopoDS_Shape    │  │   GEntity   │  │      网格生成         │            │
│   │   几何内核         │  │   几何模型   │  │                      │            │
│   └───────────────────┘  └─────────────┘  └──────────────────────┘            │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. _maxTag[6] 详解 - 标签管理系统

### 3.1 数组结构与维度映射

```
                    _maxTag 数组结构
    ┌────────────────────────────────────────────────┐
    │                                                │
    │  索引:    [0]    [1]    [2]    [3]    [4]    [5]  │
    │           │      │      │      │      │      │   │
    │  维度:   dim=-2 dim=-1 dim=0  dim=1  dim=2  dim=3 │
    │           │      │      │      │      │      │   │
    │  类型:  Shell  Wire  Vertex  Edge   Face  Solid │
    │  说明:   壳体   线环   顶点    边     面     体   │
    │                                                │
    └────────────────────────────────────────────────┘

    访问公式: _maxTag[dim + 2]

    例如:
    - 获取顶点最大标签: _maxTag[0 + 2] = _maxTag[2]
    - 获取边最大标签:   _maxTag[1 + 2] = _maxTag[3]
    - 获取面最大标签:   _maxTag[2 + 2] = _maxTag[4]
```

### 3.2 初始化流程

```
    ┌──────────────────────────────────────────────────────────────┐
    │                     初始化过程                                 │
    └──────────────────────────────────────────────────────────────┘

    CTX::instance()->geom.firstEntityTag = 1  (默认值)
                         │
                         ▼
    ┌─────────────────────────────────────────────────────────────┐
    │  for(int i = 0; i < 6; i++)                                 │
    │      _maxTag[i] = firstEntityTag - 1 = 1 - 1 = 0           │
    └─────────────────────────────────────────────────────────────┘
                         │
                         ▼
    ┌──────────────────────────────────────────────────────────────┐
    │  初始状态:                                                    │
    │  _maxTag[0] = 0  (Shell 最大标签)                            │
    │  _maxTag[1] = 0  (Wire 最大标签)                             │
    │  _maxTag[2] = 0  (Vertex 最大标签)                           │
    │  _maxTag[3] = 0  (Edge 最大标签)                             │
    │  _maxTag[4] = 0  (Face 最大标签)                             │
    │  _maxTag[5] = 0  (Solid 最大标签)                            │
    └──────────────────────────────────────────────────────────────┘
```

### 3.3 标签自动分配机制

```
                    自动标签分配流程

    用户调用: occ->addVertex(tag, x, y, z, meshSize)
                         │
                         ▼
                 ┌───────────────┐
                 │  tag < 0 ?    │  (用户传入 -1 表示自动分配)
                 └───────┬───────┘
                         │ 是
                         ▼
    ┌──────────────────────────────────────────────────────────┐
    │    tag = getMaxTag(0) + 1                                │
    │         = _maxTag[0 + 2] + 1                             │
    │         = _maxTag[2] + 1                                 │
    │         = 0 + 1 = 1  (第一个顶点)                         │
    └──────────────────────────────────────────────────────────┘
                         │
                         ▼
    ┌──────────────────────────────────────────────────────────┐
    │    _bind(vertex, tag, true)                              │
    │        └─> setMaxTag(0, tag)                             │
    │               └─> _maxTag[2] = max(0, 1) = 1             │
    └──────────────────────────────────────────────────────────┘
                         │
                         ▼
    ┌──────────────────────────────────────────────────────────┐
    │    更新后状态:                                             │
    │    _maxTag[2] = 1  (下次自动分配将得到 2)                   │
    └──────────────────────────────────────────────────────────┘
```

### 3.4 连续创建实体示例

```
    创建多个顶点的标签演变:

    ┌─────────────────────────────────────────────────────────────────┐
    │ 时间线                                                          │
    │   │                                                             │
    │   ▼                                                             │
    │ T0: 初始化                                                       │
    │     _maxTag[2] = 0                                              │
    │                                                                 │
    │   ▼                                                             │
    │ T1: addVertex(tag=-1, ...)  →  tag = 1, _maxTag[2] = 1          │
    │                                                                 │
    │   ▼                                                             │
    │ T2: addVertex(tag=-1, ...)  →  tag = 2, _maxTag[2] = 2          │
    │                                                                 │
    │   ▼                                                             │
    │ T3: addVertex(tag=10, ...) →  tag = 10, _maxTag[2] = 10         │
    │     (用户指定标签)                                                │
    │                                                                 │
    │   ▼                                                             │
    │ T4: addVertex(tag=-1, ...)  →  tag = 11, _maxTag[2] = 11        │
    │     (自动分配跳过已用标签)                                         │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
```

---

## 4. _changed 详解 - 变化追踪标志

### 4.1 状态机模型

```
                    _changed 状态转换图

    ┌───────────────────────────────────────────────────────────────┐
    │                                                               │
    │     ┌──────────────────┐         ┌──────────────────┐        │
    │     │                  │         │                  │        │
    │     │   _changed=true  │ ──────► │  _changed=false  │        │
    │     │   (需要同步)      │   同步   │   (已同步)        │        │
    │     │                  │ ◄────── │                  │        │
    │     └────────┬─────────┘   修改   └──────────────────┘        │
    │              │                          │                    │
    │              │ 初始化                    │                    │
    │              │                          │                    │
    │     ┌────────┴─────────┐               │                    │
    │     │   构造函数        │               │                    │
    │     │   OCC_Internals() │               │                    │
    │     └──────────────────┘               │                    │
    │                                         │                    │
    │     任何几何操作: ◄─────────────────────┘                    │
    │     - addVertex()                                            │
    │     - addLine()                                              │
    │     - addSurface()                                           │
    │     - booleanUnion()                                         │
    │     - ...                                                    │
    │                                                               │
    └───────────────────────────────────────────────────────────────┘
```

### 4.2 工作流程

```
                    变化追踪与同步流程

    ┌─────────────────────────────────────────────────────────────────┐
    │  用户代码                                                        │
    │  ─────────                                                      │
    │                                                                 │
    │  // 1. 创建 OCC 内部对象                                         │
    │  model->createOCCInternals();                                   │
    │                                                                 │
    │  // 2. 执行多个几何操作 (不会立即同步到 GModel)                     │
    │  occ->addVertex(...);   // _changed = true                      │
    │  occ->addLine(...);     // _changed = true                      │
    │  occ->addSurface(...);  // _changed = true                      │
    │                                                                 │
    │  // 3. 一次性同步所有变化                                         │
    │  gmsh::model::occ::synchronize();                               │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │  同步过程                                                        │
    │  ─────────                                                      │
    │                                                                 │
    │  if(occ->getChanged()) {           // 检查是否有变化             │
    │      occ->synchronize(model);       // 执行同步                  │
    │      // 内部: 创建 GVertex, GEdge, GFace, GRegion                │
    │      // 内部: 应用属性 (网格大小、标签、颜色)                       │
    │      // _changed = false (隐含重置)                              │
    │  }                                                              │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
```

### 4.3 设计意图

```
                    为什么需要 _changed?

    ┌─────────────────────────────────────────────────────────────────┐
    │                                                                 │
    │   问题: OpenCASCADE 的几何操作开销大,频繁同步效率低                 │
    │                                                                 │
    │   ┌───────────────────────────────────────────────────────┐    │
    │   │  不好的方式 (无 _changed):                              │    │
    │   │                                                        │    │
    │   │  addVertex() → 同步 → addLine() → 同步 → addSurface()  │    │
    │   │       ↓            ↓            ↓            ↓         │    │
    │   │    同步到         同步到        同步到       同步到       │    │
    │   │    GModel        GModel       GModel      GModel      │    │
    │   │                                                        │    │
    │   │  缺点: 每次操作都同步,性能差                              │    │
    │   └───────────────────────────────────────────────────────┘    │
    │                                                                 │
    │   ┌───────────────────────────────────────────────────────┐    │
    │   │  好的方式 (有 _changed):                                │    │
    │   │                                                        │    │
    │   │  addVertex() → addLine() → addSurface() → synchronize()│    │
    │   │       ↓            ↓            ↓              ↓        │    │
    │   │  _changed=true _changed=true _changed=true  批量同步    │    │
    │   │                                             到 GModel   │    │
    │   │                                                        │    │
    │   │  优点: 批量操作后一次性同步,高效                          │    │
    │   └───────────────────────────────────────────────────────┘    │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
```

---

## 5. _attributes 详解 - R-Tree 属性存储系统

### 5.1 OCCAttributesRTree 结构

```
                    OCCAttributesRTree 内部结构

    ┌─────────────────────────────────────────────────────────────────┐
    │  OCCAttributesRTree                                             │
    │  ──────────────────                                             │
    │                                                                 │
    │  ┌─────────────────────────────────────────────────────────┐   │
    │  │  _rtree[4]  - 四棵 R-Tree (每个维度一棵)                   │   │
    │  │                                                          │   │
    │  │   _rtree[0] ─── Vertex (顶点) 属性树                      │   │
    │  │        │                                                  │   │
    │  │   _rtree[1] ─── Edge (边) 属性树                          │   │
    │  │        │                                                  │   │
    │  │   _rtree[2] ─── Face (面) 属性树                          │   │
    │  │        │                                                  │   │
    │  │   _rtree[3] ─── Solid (体) 属性树                         │   │
    │  │                                                          │   │
    │  └─────────────────────────────────────────────────────────┘   │
    │                                                                 │
    │  ┌─────────────────────────────────────────────────────────┐   │
    │  │  _all  - 所有属性的平面列表 (用于遍历和清理)                 │   │
    │  │  vector<OCCAttributes*>                                   │   │
    │  └─────────────────────────────────────────────────────────┘   │
    │                                                                 │
    │  ┌─────────────────────────────────────────────────────────┐   │
    │  │  _tol  - 容差参数 (默认 1e-8)                              │   │
    │  │  用于模糊匹配,处理浮点精度问题                               │   │
    │  └─────────────────────────────────────────────────────────┘   │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
```

### 5.2 OCCAttributes 属性类

```
                    OCCAttributes 属性存储

    ┌─────────────────────────────────────────────────────────────────┐
    │  class OCCAttributes                                            │
    │  ───────────────────                                            │
    │                                                                 │
    │  ┌─────────────────┐   ┌─────────────────────────────────────┐ │
    │  │ _dim            │   │ 维度 (0=顶点, 1=边, 2=面, 3=体)       │ │
    │  └─────────────────┘   └─────────────────────────────────────┘ │
    │                                                                 │
    │  ┌─────────────────┐   ┌─────────────────────────────────────┐ │
    │  │ _shape          │   │ 关联的 OpenCASCADE 形状               │ │
    │  │ (TopoDS_Shape)  │   │                                      │ │
    │  └─────────────────┘   └─────────────────────────────────────┘ │
    │                                                                 │
    │  ┌─────────────────┐   ┌─────────────────────────────────────┐ │
    │  │ _meshSize       │   │ 网格大小约束 (如 0.1, 0.5)            │ │
    │  └─────────────────┘   └─────────────────────────────────────┘ │
    │                                                                 │
    │  ┌─────────────────┐   ┌─────────────────────────────────────┐ │
    │  │ _extrude        │   │ 拉伸参数 (ExtrudeParams*)             │ │
    │  └─────────────────┘   └─────────────────────────────────────┘ │
    │                                                                 │
    │  ┌─────────────────┐   ┌─────────────────────────────────────┐ │
    │  │ _label          │   │ 实体标签/名称 (如 "inlet", "wall")    │ │
    │  └─────────────────┘   └─────────────────────────────────────┘ │
    │                                                                 │
    │  ┌─────────────────┐   ┌─────────────────────────────────────┐ │
    │  │ _color          │   │ RGBA 颜色值                          │ │
    │  │ vector<double>  │   │                                      │ │
    │  └─────────────────┘   └─────────────────────────────────────┘ │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
```

### 5.3 R-Tree 空间索引原理

```
                    R-Tree 空间索引结构

    ┌─────────────────────────────────────────────────────────────────┐
    │                                                                 │
    │    R-Tree 是一种用于空间数据的树形索引结构                          │
    │    每个节点存储一个边界框 (Bounding Box)                           │
    │                                                                 │
    │             ┌────────────────────────────────────┐              │
    │             │           根节点                    │              │
    │             │     包含整个空间的边界框             │              │
    │             └───────────────┬────────────────────┘              │
    │                             │                                   │
    │          ┌──────────────────┼──────────────────┐               │
    │          │                  │                  │               │
    │          ▼                  ▼                  ▼               │
    │    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐        │
    │    │  子区域 A    │   │  子区域 B    │   │  子区域 C    │        │
    │    └──────┬──────┘   └──────┬──────┘   └──────┬──────┘        │
    │           │                 │                 │               │
    │     ┌─────┴─────┐     ┌─────┴─────┐     ┌─────┴─────┐        │
    │     │           │     │           │     │           │        │
    │     ▼           ▼     ▼           ▼     ▼           ▼        │
    │   ┌───┐       ┌───┐ ┌───┐       ┌───┐ ┌───┐       ┌───┐     │
    │   │ P1│       │ P2│ │ P3│       │ P4│ │ P5│       │ P6│     │
    │   │属性│       │属性│ │属性│       │属性│ │属性│       │属性│     │
    │   └───┘       └───┘ └───┘       └───┘ └───┘       └───┘     │
    │                                                                 │
    │   优势: 查询复杂度 O(log n),而非线性扫描的 O(n)                    │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
```

### 5.4 属性查询流程

```
                    基于空间位置查询属性

    ┌─────────────────────────────────────────────────────────────────┐
    │                                                                 │
    │  输入: TopoDS_Shape (一个几何形状)                                │
    │                                                                 │
    │        ┌─────────────────────────────────────────────────┐     │
    │   1.   │  计算形状的边界框 (Bounding Box)                   │     │
    │        │  BRepBndLib::Add(shape, box)                     │     │
    │        │  box.Get(xmin, ymin, zmin, xmax, ymax, zmax)     │     │
    │        └─────────────────────────────────────────────────┘     │
    │                             │                                   │
    │                             ▼                                   │
    │        ┌─────────────────────────────────────────────────┐     │
    │   2.   │  计算边界框中心点                                  │     │
    │        │  x = (xmin + xmax) / 2                           │     │
    │        │  y = (ymin + ymax) / 2                           │     │
    │        │  z = (zmin + zmax) / 2                           │     │
    │        └─────────────────────────────────────────────────┘     │
    │                             │                                   │
    │                             ▼                                   │
    │        ┌─────────────────────────────────────────────────┐     │
    │   3.   │  扩展搜索范围 (±容差)                              │     │
    │        │  bmin = [x - tol, y - tol, z - tol]              │     │
    │        │  bmax = [x + tol, y + tol, z + tol]              │     │
    │        └─────────────────────────────────────────────────┘     │
    │                             │                                   │
    │                             ▼                                   │
    │        ┌─────────────────────────────────────────────────┐     │
    │   4.   │  R-Tree 搜索                                     │     │
    │        │  _rtree[dim]->Search(bmin, bmax, callback)       │     │
    │        │  返回范围内的所有候选属性                          │     │
    │        └─────────────────────────────────────────────────┘     │
    │                             │                                   │
    │                             ▼                                   │
    │        ┌─────────────────────────────────────────────────┐     │
    │   5.   │  精确匹配过滤                                     │     │
    │        │  if(shape.IsSame(candidate->getShape()))         │     │
    │        │      return candidate;  // 找到精确匹配           │     │
    │        │  或者: 边界框完全相同的作为备选                     │     │
    │        └─────────────────────────────────────────────────┘     │
    │                             │                                   │
    │                             ▼                                   │
    │  输出: 匹配的 OCCAttributes (包含 meshSize, label, color 等)    │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
```

### 5.5 属性在同步时的应用

```
                    synchronize() 中属性的应用

    ┌─────────────────────────────────────────────────────────────────┐
    │                                                                 │
    │  OCC_Internals::synchronize(GModel *model)                      │
    │                                                                 │
    │  for(每个绑定的顶点 vertex) {                                    │
    │                                                                 │
    │      // 创建对应的 GVertex                                       │
    │      GVertex *gv = new OCCVertex(model, vertex, tag);           │
    │                                                                 │
    │      ┌───────────────────────────────────────────────────────┐ │
    │      │  1. 获取网格大小约束                                    │ │
    │      │     double lc = _attributes->getMeshSize(0, vertex);   │ │
    │      │     if(lc != MAX_LC)                                   │ │
    │      │         gv->setPrescribedMeshSizeAtVertex(lc);         │ │
    │      └───────────────────────────────────────────────────────┘ │
    │                                                                 │
    │      ┌───────────────────────────────────────────────────────┐ │
    │      │  2. 获取实体标签                                       │ │
    │      │     vector<string> labels;                             │ │
    │      │     _attributes->getLabels(0, vertex, labels);         │ │
    │      │     if(labels.size())                                  │ │
    │      │         model->setElementaryName(0, tag, labels[0]);   │ │
    │      └───────────────────────────────────────────────────────┘ │
    │                                                                 │
    │      ┌───────────────────────────────────────────────────────┐ │
    │      │  3. 获取颜色                                           │ │
    │      │     unsigned int col;                                  │ │
    │      │     if(_attributes->getColor(0, vertex, col))          │ │
    │      │         gv->setColor(col);                             │ │
    │      └───────────────────────────────────────────────────────┘ │
    │  }                                                              │
    │                                                                 │
    │  // 对边、面、体重复相同过程...                                   │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
```

---

## 6. 构造函数初始化流程总图

```
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                      OCC_Internals 构造函数流程图                         │
    └─────────────────────────────────────────────────────────────────────────┘


              ┌───────────────────────────────────────────┐
              │         GModel::createOCCInternals()      │
              │                                           │
              │  _occ_internals = new OCC_Internals();    │
              └───────────────────────┬───────────────────┘
                                      │
                                      ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │    OCC_Internals::OCC_Internals()                                       │
    │    {                                                                    │
    │                                                                         │
    │        ┌─────────────────────────────────────────────────────────────┐  │
    │        │  步骤 1: 初始化标签管理器                                     │  │
    │        │                                                              │  │
    │        │  for(int i = 0; i < 6; i++)                                  │  │
    │        │      _maxTag[i] = CTX::instance()->geom.firstEntityTag - 1;  │  │
    │        │                                                              │  │
    │        │  ┌───────────────────────────────────────────────────────┐  │  │
    │        │  │ CTX::instance()   获取全局上下文单例                    │  │  │
    │        │  │       │                                                │  │  │
    │        │  │       ▼                                                │  │  │
    │        │  │ ->geom            获取几何配置选项                      │  │  │
    │        │  │       │                                                │  │  │
    │        │  │       ▼                                                │  │  │
    │        │  │ .firstEntityTag   获取起始实体标签 (默认=1)             │  │  │
    │        │  │       │                                                │  │  │
    │        │  │       ▼                                                │  │  │
    │        │  │  - 1              减1以便第一个自动分配标签为1          │  │  │
    │        │  └───────────────────────────────────────────────────────┘  │  │
    │        └─────────────────────────────────────────────────────────────┘  │
    │                                      │                                  │
    │                                      ▼                                  │
    │        ┌─────────────────────────────────────────────────────────────┐  │
    │        │  步骤 2: 设置变化标志                                        │  │
    │        │                                                              │  │
    │        │  _changed = true;                                            │  │
    │        │                                                              │  │
    │        │  ┌───────────────────────────────────────────────────────┐  │  │
    │        │  │ 表示内部数据有变化,需要在首次使用时同步到 GModel          │  │  │
    │        │  └───────────────────────────────────────────────────────┘  │  │
    │        └─────────────────────────────────────────────────────────────┘  │
    │                                      │                                  │
    │                                      ▼                                  │
    │        ┌─────────────────────────────────────────────────────────────┐  │
    │        │  步骤 3: 创建属性存储树                                      │  │
    │        │                                                              │  │
    │        │  _attributes = new OCCAttributesRTree(                       │  │
    │        │      CTX::instance()->geom.tolerance                         │  │
    │        │  );                                                          │  │
    │        │                                                              │  │
    │        │  ┌───────────────────────────────────────────────────────┐  │  │
    │        │  │ 创建四棵 R-Tree (dim=0,1,2,3)                          │  │  │
    │        │  │ 使用全局几何容差作为模糊匹配参数                         │  │  │
    │        │  └───────────────────────────────────────────────────────┘  │  │
    │        └─────────────────────────────────────────────────────────────┘  │
    │                                                                         │
    │    }                                                                    │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
              ┌───────────────────────────────────────────┐
              │           初始化完成                       │
              │                                           │
              │  OCC_Internals 对象准备好接收几何操作       │
              └───────────────────────────────────────────┘
```

---

## 7. OCC_Internals 在 Gmsh 中的位置

```
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                         Gmsh 几何管理层次                                 │
    └─────────────────────────────────────────────────────────────────────────┘


    ┌─────────────────────────────────────────────────────────────────────────┐
    │                           用户代码层                                     │
    │                                                                         │
    │   gmsh.initialize()                                                     │
    │   gmsh.model.add("my_model")                                            │
    │   gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1)                               │
    │   gmsh.model.occ.synchronize()                                          │
    │   gmsh.model.mesh.generate(3)                                           │
    │   gmsh.write("mesh.msh")                                                │
    │   gmsh.finalize()                                                       │
    │                                                                         │
    └─────────────────────────────────────┬───────────────────────────────────┘
                                          │
                                          ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                           C++ API 层                                    │
    │                                                                         │
    │   namespace gmsh::model::occ {                                          │
    │       void addBox(...) {                                                │
    │           GModel::current()->getOCCInternals()->addBox(...);            │
    │       }                                                                 │
    │       void synchronize() {                                              │
    │           GModel::current()->getOCCInternals()->synchronize(...);       │
    │       }                                                                 │
    │   }                                                                     │
    │                                                                         │
    └─────────────────────────────────────┬───────────────────────────────────┘
                                          │
                                          ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                            GModel 层                                    │
    │                                                                         │
    │   class GModel {                                                        │
    │       OCC_Internals *_occ_internals;  // OCC 几何核心                    │
    │       GEO_Internals *_geo_internals;  // 内置几何核心                    │
    │                                                                         │
    │       std::vector<GVertex*> vertices;  // 几何顶点                       │
    │       std::vector<GEdge*> edges;       // 几何边                         │
    │       std::vector<GFace*> faces;       // 几何面                         │
    │       std::vector<GRegion*> regions;   // 几何体                         │
    │   };                                                                    │
    │                                                                         │
    └─────────────────────────────────────┬───────────────────────────────────┘
                                          │
                                          ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                        OCC_Internals 层 (本文档重点)                      │
    │                                                                         │
    │   class OCC_Internals {                                                 │
    │       int _maxTag[6];                    // 标签管理                      │
    │       bool _changed;                     // 变化追踪                      │
    │       OCCAttributesRTree *_attributes;   // 属性存储                     │
    │                                                                         │
    │       // TopoDS_Shape ↔ int tag 映射                                    │
    │       TopTools_DataMapOfIntegerShape _tagVertex, _tagEdge, ...;         │
    │       TopTools_DataMapOfShapeInteger _vertexTag, _edgeTag, ...;         │
    │                                                                         │
    │       // 几何操作方法                                                    │
    │       bool addVertex(), addLine(), addSurface(), ...;                   │
    │       bool booleanUnion(), booleanDifference(), ...;                    │
    │       bool synchronize(GModel *model);                                  │
    │   };                                                                    │
    │                                                                         │
    └─────────────────────────────────────┬───────────────────────────────────┘
                                          │
                                          ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                        OpenCASCADE 层                                   │
    │                                                                         │
    │   TopoDS_Shape     - 几何形状基类                                        │
    │   TopoDS_Vertex    - 顶点                                               │
    │   TopoDS_Edge      - 边                                                 │
    │   TopoDS_Face      - 面                                                 │
    │   TopoDS_Solid     - 体                                                 │
    │                                                                         │
    │   BRepPrimAPI_MakeBox    - 创建长方体                                    │
    │   BRepBuilderAPI_MakeEdge - 创建边                                      │
    │   BRepAlgoAPI_Fuse       - 布尔合并                                      │
    │   ...                                                                   │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 完整使用场景示例

```
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                      完整使用流程示例                                     │
    └─────────────────────────────────────────────────────────────────────────┘


    // 第1步: 创建模型和 OCC 内部对象
    GModel *model = new GModel();
    model->createOCCInternals();

    // 此时 OCC_Internals 构造函数执行:
    // - _maxTag[0..5] = 0
    // - _changed = true
    // - _attributes = new OCCAttributesRTree(...)


                                      │
                                      ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │  // 第2步: 创建几何实体                                                  │
    │  OCC_Internals *occ = model->getOCCInternals();                         │
    │                                                                         │
    │  int p1 = -1, p2 = -1, p3 = -1;                                         │
    │  occ->addVertex(p1, 0, 0, 0, 0.1);  // p1=1, _maxTag[2]=1               │
    │  occ->addVertex(p2, 1, 0, 0, 0.1);  // p2=2, _maxTag[2]=2               │
    │  occ->addVertex(p3, 1, 1, 0, 0.1);  // p3=3, _maxTag[2]=3               │
    │                                                                         │
    │  int l1 = -1, l2 = -1, l3 = -1;                                         │
    │  occ->addLine(l1, p1, p2);          // l1=1, _maxTag[3]=1               │
    │  occ->addLine(l2, p2, p3);          // l2=2, _maxTag[3]=2               │
    │  occ->addLine(l3, p3, p1);          // l3=3, _maxTag[3]=3               │
    │                                                                         │
    │  int wire = -1, surf = -1;                                              │
    │  occ->addWire(wire, {l1, l2, l3});  // wire=1, _maxTag[1]=1             │
    │  occ->addPlaneSurface(surf, {wire}); // surf=1, _maxTag[4]=1            │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │  // 第3步: 同步到 GModel                                                 │
    │  occ->synchronize(model);                                               │
    │                                                                         │
    │  // 此时:                                                                │
    │  // - 创建 GVertex (tag=1,2,3)                                          │
    │  // - 创建 GEdge (tag=1,2,3)                                            │
    │  // - 创建 GFace (tag=1)                                                │
    │  // - 应用网格大小约束 0.1                                               │
    │  // - _changed = false                                                  │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │  // 第4步: 网格生成                                                      │
    │  model->mesh(2);  // 2D 网格                                            │
    │                                                                         │
    │  // 此时使用 GModel 中的几何实体进行网格化                                 │
    │  // 网格大小约束 0.1 影响网格密度                                          │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘


    状态变化时间线:
    ─────────────────────────────────────────────────────────────────────────

    T0: 构造
        _maxTag = [0,0,0,0,0,0]
        _changed = true
        _attributes = 空 R-Tree

    T1: addVertex(p1)
        _maxTag = [0,0,1,0,0,0]
        _changed = true
        _attributes = { (dim=0, vertex1, meshSize=0.1) }

    T2: addVertex(p2,p3)
        _maxTag = [0,0,3,0,0,0]
        _changed = true
        _attributes = { vertex1, vertex2, vertex3 属性 }

    T3: addLine(l1,l2,l3)
        _maxTag = [0,0,3,3,0,0]
        _changed = true
        _attributes = { vertices + edges 属性 }

    T4: addWire, addPlaneSurface
        _maxTag = [0,1,3,3,1,0]
        _changed = true
        _attributes = { 完整几何树的所有属性 }

    T5: synchronize()
        _maxTag = [0,1,3,3,1,0]  (不变)
        _changed = false          (重置)
        _attributes = (属性已应用到 GModel)

    ─────────────────────────────────────────────────────────────────────────
```

---

## 9. 总结

### 9.1 构造函数三步初始化

| 步骤 | 代码 | 作用 |
|------|------|------|
| 1 | `_maxTag[i] = firstEntityTag - 1` | 初始化标签管理器，使首次自动分配标签等于 firstEntityTag |
| 2 | `_changed = true` | 标记需要同步，触发首次 synchronize 执行 |
| 3 | `_attributes = new OCCAttributesRTree(...)` | 创建 R-Tree 空间索引，高效存储和查询属性 |

### 9.2 核心设计思想

1. **惰性同步**: 批量几何操作后一次性同步，减少开销
2. **自动标签管理**: 用户无需手动分配标签，避免冲突
3. **空间索引**: R-Tree 支持高效的基于位置的属性查询
4. **容错机制**: 模糊匹配处理布尔操作导致的形状变化

### 9.3 OCC_Internals 的职责

- 作为 OpenCASCADE 和 GModel 之间的**桥梁**
- 维护 TopoDS_Shape 到整数标签的**双向映射**
- 管理几何实体的**属性** (网格大小、颜色、标签等)
- 追踪**变化状态**，优化同步性能
- 执行 OCC **几何操作** (创建、布尔、变换等)

---

**文档创建日期**: 2025-12-25
**源文件位置**: `/Users/renyuxiao/Documents/gmsh/gmsh-4.14.0-source/src/geo/GModelIO_OCC.cpp`
