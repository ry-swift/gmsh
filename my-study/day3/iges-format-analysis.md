# IGES文件格式深度解析

本文档详细分析 `hhh.igs` 文件的数据格式，解释IGES规范中如何定义点、线、面等几何实体。

## 1. IGES文件整体结构

IGES (Initial Graphics Exchange Specification) 文件由5个固定格式的段组成，每行80个字符，最后一列标识段类型：

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│ 段名称              │ 标识符 │ 功能描述                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ Start Section       │   S    │ 人类可读的文件描述信息                       │
│ Global Section      │   G    │ 文件全局参数（单位、精度、日期等）           │
│ Directory Entry     │   D    │ 实体目录索引，每个实体占2行                  │
│ Parameter Data      │   P    │ 实体的具体参数数据                           │
│ Terminate Section   │   T    │ 文件结束标记，统计各段行数                   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.1 Start Section (S段) - 起始段

```
3D InterOp IGES (v. 2021 1.0.0), Spatial Corp. Copyright (c) 1999-2020. S      1
```

- **作用**: 包含人类可读的注释信息
- **内容**: 标识生成该文件的软件版本信息

### 1.2 Global Section (G段) - 全局段

```
1H,,1H;,6HNoname,7Hhhh.igs,13HSpatial Corp.,20H3D InterOp ACIS/IGES,32, G      1
38, 6,308,15,6HNoname,1.000,2,2HMM,1,1.000,15H20251222.182956,1.0e-06,  G      2
0.00,6HNoname,6HNoname,11,0,15H20251222.182956;                         G      3
```

**关键参数解析**:

| 参数位置 | 值 | 含义 |
|---------|----|----|
| 1 | 1H, | 参数分隔符 (逗号) |
| 2 | 1H; | 记录分隔符 (分号) |
| 3 | 6HNoname | 发送系统产品ID |
| 4 | 7Hhhh.igs | 文件名 |
| 5 | 13HSpatial Corp. | 发送系统ID |
| 13 | 2HMM | 单位名称 (毫米) |
| 14 | 1 | 单位系数 |
| 19 | 1.0e-06 | 模型空间最小分辨率 |

**Hollerith字符串格式**: `nHstring` 表示n个字符的字符串，如 `7Hhhh.igs` 表示7个字符 "hhh.igs"

### 1.3 Directory Entry Section (D段) - 目录段

每个实体占用2行，固定格式（每字段8个字符）：

```
     110       1       0       0       0       0       0       000010001D      1
     110       0       0       1       0       0       0               0D      2
```

**第一行字段**:

| 位置 | 字段名 | 本例值 | 含义 |
|-----|-------|-------|-----|
| 1-8 | Entity Type | 110 | 实体类型号 (直线) |
| 9-16 | Parameter Data | 1 | P段起始行号 |
| 17-24 | Structure | 0 | 结构指针 |
| 25-32 | Line Font Pattern | 0 | 线型 |
| 33-40 | Level | 0 | 层号 |
| 41-48 | View | 0 | 视图指针 |
| 49-56 | Transformation | 0 | 变换矩阵指针 |
| 57-64 | Label Display | 0 | 标签显示 |
| 65-72 | Status Number | 000010001 | 状态标志 |
| 73-80 | D + Sequence | D1 | D段序号 |

**第二行字段**:

| 位置 | 字段名 | 本例值 | 含义 |
|-----|-------|-------|-----|
| 1-8 | Entity Type | 110 | 重复实体类型 |
| 9-16 | Line Weight | 0 | 线宽 |
| 17-24 | Color | 0 | 颜色 |
| 25-32 | Parameter Line Count | 1 | P段占用行数 |
| 33-40 | Form Number | 0 | 形式号 |

**实体指针计算**: D段序号是奇数，实体指针 = (D段行号 + 1) / 2 × 2 - 1

### 1.4 Parameter Data Section (P段) - 参数段

```
110,0.,0.,0.,0.,0.,1000.;                                              1P      1
```

- **格式**: `实体类型号,参数1,参数2,...,参数n;`
- **行尾**: `行号P序号` (行号是该参数数据在P段中的起始行)

### 1.5 Terminate Section (T段) - 终止段

```
S      1G      3D    220P    123                                        T      1
```

统计各段行数: S段1行, G段3行, D段220行, P段123行

---

## 2. 实体类型详解 - 点、线、面的定义规则

### 2.1 Type 116 - 点 (Point Entity)

**格式**: `116, X, Y, Z [, PTR];`

**参数说明**:
- X, Y, Z: 点在模型空间中的三维坐标
- PTR: 可选，指向子图实体的指针

**文件中的实例**:

```
116,0.,0.,5000.;                                                      41P     21
```

**解析**: 定义一个点，坐标为 (0, 0, 5000)

```
116,2500.,500.,5000.;                                                117P     63
```

**解析**: 定义一个点，坐标为 (2500, 500, 5000)

### 2.2 Type 110 - 直线 (Line Entity)

**格式**: `110, X1, Y1, Z1, X2, Y2, Z2;`

**参数说明**:
- (X1, Y1, Z1): 起点坐标
- (X2, Y2, Z2): 终点坐标

**文件中的实例**:

```
110,0.,0.,0.,0.,0.,1000.;                                              1P      1
```

**解析**: 从点(0, 0, 0)到点(0, 0, 1000)的直线段（Z轴方向，长度1000mm）

```
110,2000.,1000.,0.,4000.,1000.,0.;                                   143P     81
```

**解析**: 从点(2000, 1000, 0)到点(4000, 1000, 0)的直线段（X轴方向，长度2000mm）

### 2.3 Type 100 - 圆弧 (Circular Arc Entity)

**格式**: `100, ZT, X1, Y1, X2, Y2, X3, Y3;`

**参数说明**:
- ZT: 平行于XY平面的Z位移
- (X1, Y1): 圆心坐标
- (X2, Y2): 起点坐标
- (X3, Y3): 终点坐标

**文件中的实例**:

```
100,0.,0.,0.,1000.,0.,-1000.,0.00000000000012;                         5P      3
```

**解析**:
- ZT = 0 (在XY平面上)
- 圆心 = (0, 0)
- 起点 = (1000, 0)
- 终点 ≈ (-1000, 0)
- 这是一个半径1000mm的半圆弧

### 2.4 Type 123 - 方向向量 (Direction Entity)

**格式**: `123, X, Y, Z;`

**参数说明**:
- (X, Y, Z): 单位方向向量的分量

**文件中的实例**:

```
123,0.,0.,-1.;                                                        43P     22
```

**解析**: 方向向量 (0, 0, -1)，指向Z轴负方向

```
123,0.,1.,0.;                                                         45P     23
```

**解析**: 方向向量 (0, 1, 0)，指向Y轴正方向

### 2.5 Type 124 - 变换矩阵 (Transformation Matrix Entity)

**格式**: `124, R11, R12, R13, T1, R21, R22, R23, T2, R31, R32, R33, T3;`

**参数说明**:
- Rij: 3×3旋转矩阵的元素
- Ti: 平移向量分量

**变换公式**:
```
[X']   [R11 R12 R13] [X]   [T1]
[Y'] = [R21 R22 R23] [Y] + [T2]
[Z']   [R31 R32 R33] [Z]   [T3]
```

**文件中的实例**:

```
124,0.,1.,0.,0.,0.,0.,1.,0.,1.,0.,0.,0.;                               3P      2
```

**解析**:
```
旋转矩阵:        平移向量:
[0  1  0]        [0]
[0  0  1]        [0]
[1  0  0]        [0]
```
这是一个绕对角线旋转的变换

### 2.6 Type 120 - 旋转曲面 (Surface of Revolution Entity)

**格式**: `120, L, C, SA, TA;`

**参数说明**:
- L: 指向旋转轴直线实体的指针
- C: 指向母线曲线的指针
- SA: 起始角度（弧度）
- TA: 终止角度（弧度）

**文件中的实例**:

```
120,1,5,0.,6.28318530717959;                                           7P      4
```

**解析**:
- L = 1: 旋转轴是D段第1个实体（P段第1行的直线）
- C = 5: 母线是D段第5个实体（圆弧）
- SA = 0: 起始角0°
- TA ≈ 2π: 终止角360°（完整旋转）

**几何意义**: 将圆弧绕直线旋转360°，生成一个**圆环面或球面**

---

## 3. B-Rep拓扑实体 - 复杂曲面和实体的定义

### 3.1 Type 502 - 顶点列表 (Vertex List Entity)

**格式**: `502, N, X1, Y1, Z1, X2, Y2, Z2, ..., Xn, Yn, Zn;`

**参数说明**:
- N: 顶点数量
- (Xi, Yi, Zi): 第i个顶点的坐标

**文件中的实例**:

```
502,2,0.00000000000012,0.,-1000.,0.,0.,1000.;                         13P      7
```

**解析**:
- N = 2: 包含2个顶点
- 顶点1: (0.00000000000012, 0, -1000) ≈ (0, 0, -1000)
- 顶点2: (0, 0, 1000)

```
502,8,2500.,-500.,5000.,4000.,1000.,0.,3500.,-500.,5000.,2000.,      127P     69
-1000.,0.,2500.,500.,5000.,3500.,500.,5000.,2000.,1000.,0.,          127P     70
4000.,-1000.,0.;                                                     127P     71
```

**解析**:
- N = 8: 包含8个顶点，定义了一个立方体形状的8个角点

### 3.2 Type 504 - 边列表 (Edge List Entity)

**格式**: `504, N, C1, SVP1, SV1, TVP1, TV1, ..., Cn, SVPn, SVn, TVPn, TVn;`

**参数说明**:
- N: 边的数量
- Ci: 第i条边的模型空间曲线指针
- SVPi: 起始顶点所在顶点列表的指针
- SVi: 起始顶点在顶点列表中的索引
- TVPi: 终止顶点所在顶点列表的指针
- TVi: 终止顶点在顶点列表中的索引

**文件中的实例**:

```
504,2,11,13,2,13,1,17,13,1,13,2;                                      19P     10
```

**解析**:
- N = 2: 包含2条边
- 边1: 曲线D#11, 从顶点列表D#13的第2个顶点到第1个顶点
- 边2: 曲线D#17, 从顶点列表D#13的第1个顶点到第2个顶点

### 3.3 Type 508 - 环 (Loop Entity)

**格式**: `508, N, TYPE1, EDGE1, NDXE1, OF1, ISO1, ..., TYPEn, EDGEn, NDXEn, OFn, ISOn;`

**参数说明**:
- N: 边的数量
- TYPEi: 边类型 (0=边指针, 1=参数曲线)
- EDGEi: 边列表指针
- NDXEi: 边在边列表中的索引
- OFi: 方向标志 (0=正向, 1=反向)
- ISOi: 参数曲线ISO标志

**文件中的实例**:

```
508,2,0,19,2,0,0,0,19,1,0,0;                                          21P     11
```

**解析**:
- N = 2: 环由2条边组成
- 边1: 类型0(边指针), 边列表D#19, 第2条边, 正向
- 边2: 类型0(边指针), 边列表D#19, 第1条边, 正向
- 形成一个封闭的环

### 3.4 Type 510 - 面 (Face Entity)

**格式**: `510, SURF, N, OF, LP1, ..., LPn;`

**参数说明**:
- SURF: 指向底层曲面的指针
- N: 环的数量
- OF: 外部标志 (1=外部边界在前)
- LPi: 指向环实体的指针

**文件中的实例**:

```
510,7,1,1,21;                                                         23P     12
```

**解析**:
- SURF = 7: 底层曲面是D段第7个实体（旋转曲面）
- N = 1: 只有1个环
- OF = 1: 第一个环是外部边界
- LP1 = 21: 环指针D#21
- **几何意义**: 这是一个由旋转曲面构成的面，边界是一个环

### 3.5 Type 514 - 壳 (Shell Entity)

**格式**: `514, N, F1, OF1, ..., Fn, OFn;`

**参数说明**:
- N: 面的数量
- Fi: 指向面实体的指针
- OFi: 方向标志

**文件中的实例**:

```
514,2,23,1,35,1;                                                      37P     19
```

**解析**:
- N = 2: 壳由2个面组成
- 面1: D#23, 正向
- 面2: D#35, 正向

### 3.6 Type 186 - 实体模型 (Manifold Solid B-Rep Object)

**格式**: `186, SHELL, SOF, NVOID, VOID1, VOF1, ...;`

**参数说明**:
- SHELL: 外部壳的指针
- SOF: 壳的方向
- NVOID: 空洞壳数量
- VOIDi: 空洞壳指针
- VOFi: 空洞壳方向

**文件中的实例**:

```
186,37,1,0;                                                           39P     20
```

**解析**:
- SHELL = 37: 外部壳是D#37（Type 514）
- SOF = 1: 正向
- NVOID = 0: 无空洞
- **几何意义**: 这是一个完整的实体模型，由壳D#37定义

---

## 4. 平面和曲面实体

### 4.1 Type 190 - 平面 (Plane Surface Entity)

**格式**: `190, LOCATION, NORMAL, REFD;`

**参数说明**:
- LOCATION: 平面上一点的指针（Type 116）
- NORMAL: 法向量的指针（Type 123）
- REFD: 参考方向的指针（Type 123）

**文件中的实例**:

```
190,77,79,81;                                                         83P     46
```

**解析**:
- LOCATION = 77: 点 D#77 → (0, 0, 2000)
- NORMAL = 79: 方向 D#79 → (0, 0, -1)
- REFD = 81: 参考方向 D#81 → (-1, 0, 0)
- **几何意义**: Z = 2000处的水平面，法向量朝下

### 4.2 Type 194 - 圆柱/圆锥面 (Right Circular Cylindrical Surface)

**格式**: `194, LOCATION, AXIS, RADIUS, SEMIANGLE, REFD;`

**参数说明**:
- LOCATION: 轴上一点的指针
- AXIS: 轴方向的指针
- RADIUS: 半径
- SEMIANGLE: 半角（圆柱=0，圆锥≠0）
- REFD: 参考方向的指针

**文件中的实例**:

```
194,41,43,500.,9.46232220802561,45;                                   47P     24
```

**解析**:
- LOCATION = 41: 点 D#41 → (0, 0, 5000)
- AXIS = 43: 方向 D#43 → (0, 0, -1)
- RADIUS = 500: 半径500mm
- SEMIANGLE ≈ 9.46°: 半角（这是一个圆锥面，不是圆柱）
- REFD = 45: 参考方向

---

## 5. 该文件的几何结构总结

### 5.1 整体模型构成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         hhh.igs 几何模型结构                                │
├─────────────────────────────────────────────────────────────────────────────┤
│ 实体1 (D#39, Type 186): Manifold Solid B-Rep                               │
│   └── 壳 (D#37, Type 514): 2个面                                           │
│       ├── 面1 (D#23, Type 510): 旋转曲面                                   │
│       │   └── 曲面 (D#7, Type 120): 圆弧绕Z轴旋转360°                      │
│       └── 面2 (D#35, Type 510): 旋转曲面                                   │
│           └── 曲面 (D#31, Type 120): 另一个旋转曲面                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ 实体2 (D#47, Type 194): 圆锥面                                              │
│   └── 位于Z=5000，轴向-Z，半径500，半角9.46°                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ 实体3 (D#115, Type 186): 另一个Manifold Solid B-Rep                        │
│   └── 壳 (D#113, Type 514): 4个面                                          │
│       ├── 面1-4: 包含平面、圆锥面等多种曲面类型                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ 实体4 (D#219, Type 186): 第三个Manifold Solid B-Rep (六面体)                │
│   └── 壳 (D#217, Type 514): 6个面                                          │
│       └── 由直线边界组成的平面面                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 坐标范围

根据顶点数据分析：
- X坐标范围: 0 ~ 4000 mm
- Y坐标范围: -1000 ~ 1000 mm
- Z坐标范围: 0 ~ 5000 mm

### 5.3 主要几何特征

1. **旋转体**: 由圆弧绕轴旋转形成的曲面（如球面、圆环面）
2. **圆锥面**: 半角约9.46°的圆锥曲面
3. **平面**: 多个水平和垂直平面
4. **六面体结构**: 由8个顶点、12条边、6个面组成

---

## 6. IGES实体指针系统

### 6.1 指针计算规则

IGES使用一种特殊的指针系统来引用实体：

```
D段指针 = D段行号（奇数）
例如: D      1 → 指针为 1
      D      3 → 指针为 3
      D      5 → 指针为 5
```

### 6.2 P段行号与D段的关系

D段的Parameter Data字段指向P段的起始行号：

```
D段第1-2行:  110       1  →  P段第1行 (110,0.,0.,0.,0.,0.,1000.;)
D段第3-4行:  124       2  →  P段第2行 (124,0.,1.,0.,...)
D段第5-6行:  100       3  →  P段第3行 (100,0.,0.,0.,...)
```

---

## 7. 附录：该文件中所有实体类型统计

| 类型号 | 名称 | 数量 | 用途 |
|-------|------|-----|------|
| 100 | Circular Arc | 8 | 定义圆弧曲线 |
| 110 | Line | 18 | 定义直线段 |
| 116 | Point | 10 | 定义空间点 |
| 120 | Surface of Revolution | 2 | 定义旋转曲面 |
| 123 | Direction | 20 | 定义方向向量 |
| 124 | Transformation Matrix | 8 | 定义坐标变换 |
| 186 | Manifold Solid B-Rep | 3 | 定义实体模型 |
| 190 | Plane Surface | 8 | 定义平面 |
| 194 | Right Circular Conical Surface | 2 | 定义圆锥面 |
| 502 | Vertex List | 4 | 定义顶点列表 |
| 504 | Edge List | 4 | 定义边列表 |
| 508 | Loop | 14 | 定义面的边界环 |
| 510 | Face | 14 | 定义B-Rep面 |
| 514 | Shell | 3 | 定义壳 |

---

## 8. 参考资料

1. IGES 5.3 Specification - US PRO/IPO-100
2. OpenCASCADE IGES Interface Documentation
3. Gmsh源码: `src/geo/GModelIO_IGES.cpp`
