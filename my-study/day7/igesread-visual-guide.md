# OCCT igesread 函数深度分析与可视化指南

> 本文档详细分析 OpenCASCADE Technology (OCCT) 中 IGES 文件读取的核心 C 语言实现。
> 源码位置: `OCCT/src/DataExchange/TKDEIGES/IGESFile/`

## 目录

1. [整体架构概览](#1-整体架构概览)
2. [函数调用关系图](#2-函数调用关系图)
3. [igesread 主函数流程图](#3-igesread-主函数流程图)
4. [数据流图](#4-数据流图)
5. [源码逐行详解](#5-源码逐行详解)
6. [辅助函数详解](#6-辅助函数详解)
7. [调试要点](#7-调试要点)

---

## 1. 整体架构概览

### 1.1 模块组成

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         IGES 文件读取模块架构                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐   │
│  │  igesread.c     │     │  liriges.c      │     │  analiges.c     │   │
│  │  ─────────────  │     │  ────────────   │     │  ────────────   │   │
│  │  主入口函数      │────▶│  底层行读取      │────▶│  段解析逻辑      │   │
│  │  igesread()     │     │  iges_lire()    │     │  iges_Dsect()   │   │
│  │                 │     │                 │     │  iges_Psect()   │   │
│  │                 │     │                 │     │  iges_param()   │   │
│  └────────┬────────┘     └─────────────────┘     └─────────────────┘   │
│           │                                                             │
│           ▼                                                             │
│  ┌─────────────────┐     ┌─────────────────┐                           │
│  │  structiges.c   │     │  igesread.h     │                           │
│  │  ─────────────  │     │  ────────────   │                           │
│  │  内存数据结构    │◀────│  数据结构定义    │                           │
│  │  管理           │     │  函数声明       │                           │
│  │  - 字符页管理    │     │  参数类型枚举    │                           │
│  │  - 参数页管理    │     │                 │                           │
│  │  - 目录页管理    │     │                 │                           │
│  └─────────────────┘     └─────────────────┘                           │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  IGESFile_Read.cxx (C++ 封装层)                                  │   │
│  │  ───────────────────────────────────────────────────────────────│   │
│  │  · 调用 igesread() 完成底层解析                                   │   │
│  │  · 将结果转换为 IGESData_IGESReaderData 对象                      │   │
│  │  · 集成到 OCCT Interface 框架                                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 IGES 文件五段结构

```
┌────────────────────────────────────────────────────────────────────────┐
│                          IGES 文件结构                                  │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│   每行固定 80 字符                                                      │
│   ├── 第 1-72 位: 数据内容                                              │
│   ├── 第 73 位:   段标识符 (S/G/D/P/T)                                  │
│   └── 第 74-80 位: 段内行号                                             │
│                                                                        │
│   ┌────────────────────────────────────────────────────────────────┐  │
│   │ Start Section (S段)                                            │  │
│   │ ────────────────────                                           │  │
│   │ 自由格式的注释/描述文本，可跨多行                                 │  │
│   │ 例: "This file was created by ..."                             │  │
│   └────────────────────────────────────────────────────────────────┘  │
│                         ▼                                              │
│   ┌────────────────────────────────────────────────────────────────┐  │
│   │ Global Section (G段)                                           │  │
│   │ ────────────────────                                           │  │
│   │ 25个全局参数，用分隔符分开：                                      │  │
│   │  [1] 参数分隔符 (默认 ,)                                         │  │
│   │  [2] 记录分隔符 (默认 ;)                                         │  │
│   │  [3] 发送系统产品ID                                              │  │
│   │  [4] 文件名                                                     │  │
│   │  [5] 原生系统ID                                                 │  │
│   │  [6] 预处理器版本                                               │  │
│   │  ... (共25个参数)                                               │  │
│   └────────────────────────────────────────────────────────────────┘  │
│                         ▼                                              │
│   ┌────────────────────────────────────────────────────────────────┐  │
│   │ Directory Entry Section (D段)                                  │  │
│   │ ────────────────────────────                                   │  │
│   │ 每个实体占用 2 行，每行 8 个字段（各 8 字符宽）                    │  │
│   │                                                                │  │
│   │  Line 1: |typ|poi|pdef|tra|niv|vue|trf|aff|blk+sub+use+her|   │  │
│   │          | 8 | 8 | 8  | 8 | 8 | 8 | 8 | 8 |   4+4+2+2     |   │  │
│   │                                                                │  │
│   │  Line 2: |typ2|epa|col|nbl|form|res1|res2|nom |num |         │  │
│   │          |  8 | 8 | 8 | 8 | 8  | 8  | 8  | 8  | 8  |         │  │
│   └────────────────────────────────────────────────────────────────┘  │
│                         ▼                                              │
│   ┌────────────────────────────────────────────────────────────────┐  │
│   │ Parameter Data Section (P段)                                   │  │
│   │ ───────────────────────────                                    │  │
│   │ 实体参数，格式: typeid,param1,param2,...,paramN;               │  │
│   │ 支持 Hollerith 字符串格式: nH<n个字符>                          │  │
│   │ 例: 110,0.0,0.0,0.0,1.0,1.0,1.0; (直线起点终点)                │  │
│   │                                                                │  │
│   │ 第 65-72 位: 对应的 D 段序号                                    │  │
│   └────────────────────────────────────────────────────────────────┘  │
│                         ▼                                              │
│   ┌────────────────────────────────────────────────────────────────┐  │
│   │ Terminate Section (T段)                                        │  │
│   │ ─────────────────────                                          │  │
│   │ 单行，统计各段行数                                               │  │
│   │ 格式: Snnn Gnnn Dnnn Pnnn                                      │  │
│   └────────────────────────────────────────────────────────────────┘  │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 函数调用关系图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          函数调用关系                                    │
└─────────────────────────────────────────────────────────────────────────┘

IGESFile_Read() [C++入口]
       │
       ▼
   igesread(nomfic, lesect, modefnes)  ←─ 核心入口函数
       │
       ├──▶ iges_initfile()            ←─ 初始化所有内存结构
       │         │
       │         ├──▶ malloc(carpage)   ←─ 分配字符页
       │         ├──▶ malloc(parpage)   ←─ 分配参数页
       │         ├──▶ malloc(starts)    ←─ 分配 Start Section 列表
       │         ├──▶ malloc(header)    ←─ 分配 Global Section 列表
       │         └──▶ malloc(dirpage)   ←─ 分配目录页
       │
       ├──▶ OSD_OpenFile(nomfic, "r")  ←─ 打开文件
       │
       └──▶ [主循环] iges_lire(...)     ←─ 逐行读取
                │
                ├── 返回 1 (S段) ──▶ iges_newparam(0, 72, ligne)
                │                        │
                │                        └──▶ iges_newchar()  ←─ 分配字符空间
                │
                ├── 返回 2 (G段) ──▶ iges_setglobal()
                │                  ──▶ iges_param(&Pstat, ...)
                │                        │
                │                        └──▶ iges_newparam() / iges_addparam()
                │
                ├── 返回 3 (D段) ──▶ iges_Dsect(&Dstat, numsec, ligne)
                │                        │
                │                        ├──▶ iges_newpart(numsec) [第1行]
                │                        │         │
                │                        │         └──▶ 创建新 dirpart
                │                        │
                │                        └──▶ IGES_decode() × 17 个字段
                │
                ├── 返回 4 (P段) ──▶ iges_Psect(numsec, ligne)
                │                        │
                │                        └──▶ iges_curpart(dnum)
                │
                │                  ──▶ iges_param(&Pstat, ...)
                │                        │
                │                        ├──▶ iges_newparam()
                │                        └──▶ iges_addparam() [跨行Hollerith]
                │
                └── 返回 5 (T段) ──▶ (验证终止段)

       ▼
   返回 0 (成功) / -1 (失败)
```

---

## 3. igesread 主函数流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     igesread() 执行流程详解                              │
└─────────────────────────────────────────────────────────────────────────┘

                              开始
                                │
                                ▼
               ┌────────────────────────────────┐
               │    初始化变量:                  │
               │    Dstat=0, Pstat=0            │
               │    c_separ=',', c_fin=';'      │
               └────────────────────────────────┘
                                │
                                ▼
               ┌────────────────────────────────┐
               │    iges_initfile()              │
               │    分配所有内存页               │
               └────────────────────────────────┘
                                │
                                ▼
               ┌────────────────────────────────┐
               │   文件名为空?                   │
               └────────────────────────────────┘
                      │                 │
                   是 │                 │ 否
                      ▼                 ▼
              使用 stdin      OSD_OpenFile(nomfic,"r")
                      │                 │
                      └────────┬────────┘
                               │
                               ▼
               ┌────────────────────────────────┐
               │   文件打开失败?                 │──是──▶ 返回 -1
               └────────────────────────────────┘
                               │ 否
                               ▼
               ┌────────────────────────────────┐
               │   初始化 lesect[1..5] = 0      │
               │   初始化 ligne[0..99] = 0      │
               └────────────────────────────────┘
                               │
         ┌─────────────────────┴─────────────────────┐
         │                                           │
         │           ╔═══════════════════╗          │
         │           ║    主读取循环     ║          │
         │           ╚═══════════════════╝          │
         │                     │                     │
         │                     ▼                     │
         │    ┌────────────────────────────────┐    │
         │    │  numl++                        │    │
         │    │  i = iges_lire(lefic,          │    │
         │    │      &numsec, ligne, modefnes) │    │
         │    └────────────────────────────────┘    │
         │                     │                     │
         │                     ▼                     │
         │    ┌────────────────────────────────┐    │
         │    │   i <= 0 或 i < i0 ?           │    │
         │    └────────────────────────────────┘    │
         │          │                    │          │
         │       是 │                    │ 否       │
         │          ▼                    ▼          │
         │    ┌────────────┐    ┌────────────────┐  │
         │    │ i == 0 ?   │    │ lesect[i]++    │  │
         │    └────────────┘    │ i0 = i         │  │
         │      │       │       └────────────────┘  │
         │   是 │       │ 否           │            │
         │      │       ▼              ▼            │
         │      │  报错并继续    ┌──────────────────┴──────────────────┐
         │      │               │                                      │
         │      ▼               ▼                                      │
         │   跳出循环     ┌─────────────────────────────────────────┐ │
         │               │ 根据 i 值分发处理                        │ │
         │               │                                         │ │
         │               │  i=1 (S段): ───▶ iges_newparam(0,72,ligne)│
         │               │                   记录注释文本           │ │
         │               │                                         │ │
         │               │  i=2 (G段): ───▶ iges_setglobal()       │ │
         │               │                   解析分隔符            │ │
         │               │                   循环: iges_param()    │ │
         │               │                   直到 Pstat != 2       │ │
         │               │                                         │ │
         │               │  i=3 (D段): ───▶ iges_Dsect()           │ │
         │               │                   解析17个固定格式字段   │ │
         │               │                                         │ │
         │               │  i=4 (P段): ───▶ iges_Psect()           │ │
         │               │                   循环: iges_param()    │ │
         │               │                   直到 Pstat != 2       │ │
         │               └─────────────────────────────────────────┘ │
         │                              │                            │
         │                              │                            │
         └──────────────────────────────┴────────────────────────────┘
                                        │
                                        ▼
               ┌────────────────────────────────┐
               │   lesect[5] == 0 ?             │──是──▶ 警告: 无终止段
               └────────────────────────────────┘
                               │
                               ▼
               ┌────────────────────────────────┐
               │   fclose(lefic)                │
               │   返回 0                       │
               └────────────────────────────────┘
                               │
                               ▼
                              结束
```

---

## 4. 数据流图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          数据流转图                                      │
└─────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────┐
                    │   IGES 文件      │
                    │   (.igs/.iges)  │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │   iges_lire()   │
                    │   逐行读取       │
                    └────────┬────────┘
                             │
            ┌────────────────┼────────────────┬────────────────┐
            │                │                │                │
            ▼                ▼                ▼                ▼
    ┌───────────┐    ┌───────────┐    ┌───────────┐    ┌───────────┐
    │  S 段      │    │  G 段      │    │  D 段      │    │  P 段      │
    │  注释文本  │    │  全局参数  │    │  目录条目  │    │  实体参数  │
    └─────┬─────┘    └─────┬─────┘    └─────┬─────┘    └─────┬─────┘
          │                │                │                │
          ▼                ▼                ▼                ▼
    ┌───────────┐    ┌───────────┐    ┌───────────┐    ┌───────────┐
    │ starts    │    │ header    │    │ dirpage   │    │ parlist   │
    │ (parlist) │    │ (parlist) │    │ (dirpart) │    │ in each   │
    │           │    │           │    │ 数组      │    │ dirpart   │
    └─────┬─────┘    └─────┬─────┘    └─────┬─────┘    └─────┬─────┘
          │                │                │                │
          │                │                └────────┬───────┘
          │                │                         │
          ▼                ▼                         ▼
    ┌─────────────────────────────────────────────────────────────┐
    │                     内存数据结构                             │
    │  ┌─────────────────────────────────────────────────────┐   │
    │  │  struct carpage (字符页链表)                         │   │
    │  │  ├── used: 已使用字符数                              │   │
    │  │  ├── next: 下一页指针                                │   │
    │  │  └── cars[Maxcar]: 字符缓冲区                        │   │
    │  └─────────────────────────────────────────────────────┘   │
    │                                                             │
    │  ┌─────────────────────────────────────────────────────┐   │
    │  │  struct parpage (参数页链表)                         │   │
    │  │  ├── used: 已使用参数数                              │   │
    │  │  ├── next: 下一页指针                                │   │
    │  │  └── params[Maxpar]: oneparam 数组                   │   │
    │  └─────────────────────────────────────────────────────┘   │
    │                                                             │
    │  ┌─────────────────────────────────────────────────────┐   │
    │  │  struct dirpage (目录页链表)                         │   │
    │  │  ├── used: 已使用实体数                              │   │
    │  │  ├── next: 下一页指针                                │   │
    │  │  └── parts[Maxparts]: dirpart 数组                   │   │
    │  └─────────────────────────────────────────────────────┘   │
    │                                                             │
    └─────────────────────────────────────────────────────────────┘
                             │
                             ▼
    ┌─────────────────────────────────────────────────────────────┐
    │                C++ 层读取与转换                              │
    │  ┌─────────────────────────────────────────────────────┐   │
    │  │  IGESFile_ReadHeader(IR)                             │   │
    │  │  ├── iges_lirparam() 读取 S 段 → IR->AddStartLine()  │   │
    │  │  └── iges_lirparam() 读取 G 段 → IR->AddGlobal()     │   │
    │  └─────────────────────────────────────────────────────┘   │
    │  ┌─────────────────────────────────────────────────────┐   │
    │  │  IGESFile_ReadContent(IR)                            │   │
    │  │  ├── iges_lirpart() 读取 D 段 → IR->SetDirPart()     │   │
    │  │  └── iges_lirparam() 读取 P 段 → IR->AddParam()      │   │
    │  └─────────────────────────────────────────────────────┘   │
    └─────────────────────────────────────────────────────────────┘
                             │
                             ▼
                ┌─────────────────────────┐
                │  IGESData_IGESReaderData │
                │  (OCCT 内部数据结构)      │
                └─────────────────────────┘
                             │
                             ▼
                ┌─────────────────────────┐
                │  IGESData_IGESModel      │
                │  (最终几何模型)          │
                └─────────────────────────┘
```

---

## 5. 源码逐行详解

### 5.1 igesread.c 主文件

```c
/*======================================================================
 * 文件: igesread.c
 * 功能: IGES 文件读取的主入口，协调整个解析流程
 * 作者: Open CASCADE SAS
 * 许可: LGPL 2.1
 *======================================================================*/

#include <stdio.h>
#include "igesread.h"
#include <OSD_OpenFile.hxx>

/*----------------------------------------------------------------------
 * 前向声明: 错误检查函数（在 IGESFile_Read.cxx 中实现）
 *----------------------------------------------------------------------*/
void IGESFile_Check3 (int mode, char * code);
void IGESFile_Check2 (int mode, char * code, int num, char * str);

/*----------------------------------------------------------------------
 * 前向声明: 内部解析函数（分别在不同源文件中实现）
 *----------------------------------------------------------------------*/
void iges_initfile();                                    // structiges.c - 初始化所有内存结构
int  iges_lire (FILE* lefic, int *numsec,
                char ligne[100], int modefnes);          // liriges.c - 读取单行
void iges_newparam(int typarg, int longval,
                   char *parval);                        // structiges.c - 创建新参数
void iges_param(int *Pstat, char *ligne,
                char c_separ, char c_fin, int lonlin);   // analiges.c - 解析参数
void iges_Dsect (int *Dstat, int numsec, char* ligne);   // analiges.c - 解析 D 段
void iges_Psect(int numsec, char ligne[80]);             // analiges.c - 解析 P 段前处理

/*----------------------------------------------------------------------
 * 段标识符映射表
 * 索引: 1=S, 2=G, 3=D, 4=P, 5=T
 * 用于生成错误消息时显示段名称
 *----------------------------------------------------------------------*/
static char sects [] = " SGDPT ";


/*======================================================================
 * 函数: igesread
 * 描述: IGES 文件读取的主入口函数
 *
 * 参数:
 *   nomfic   - 文件名 (空字符串表示从 stdin 读取)
 *   lesect[6]- 输出参数，记录各段的行数:
 *              lesect[1]=S段行数, lesect[2]=G段行数,
 *              lesect[3]=D段行数, lesect[4]=P段行数,
 *              lesect[5]=T段行数
 *   modefnes - FNES 模式标志 (0=标准, 1=FNES 兼容)
 *
 * 返回值:
 *   0  - 成功
 *  -1  - 文件无法打开或格式错误
 *======================================================================*/
int igesread (char* nomfic, int lesect[6], int modefnes)
{
  /* 变量声明 */
  FILE* lefic;           /* 文件指针 */
  char ligne[100];       /* 行缓冲区 (80字符 + 余量) */
  int numsec;            /* 当前行在其段内的序号 */
  int numl;              /* 总行号计数器 */
  int i;                 /* iges_lire 返回的段类型 (1-5) */
  int i0;                /* 上一次的段类型，用于检测段切换 */
  int j;                 /* 循环变量 */
  char str[2];           /* 临时字符串，用于错误消息 */

  /* 状态机变量 */
  int Dstat = 0;         /* D 段解析状态: 0=等待第1行, 1=等待第2行 */
  int Pstat = 0;         /* P/G 段参数解析状态 */
  char c_separ = ',';    /* 参数分隔符 (默认逗号) */
  char c_fin = ';';      /* 记录结束符 (默认分号) */

  /*--------------------------------------------------------------------
   * 步骤1: 初始化内存数据结构
   * 分配字符页、参数页、目录页等所有必需的内存
   *--------------------------------------------------------------------*/
  iges_initfile();

  /*--------------------------------------------------------------------
   * 步骤2: 打开文件
   * 如果文件名为空，则使用标准输入
   *--------------------------------------------------------------------*/
  lefic = stdin;
  i0 = numsec = 0;
  numl = 0;

  if (nomfic[0] != '\0')
    lefic = OSD_OpenFile(nomfic, "r");

  if (lefic == NULL)
    return -1;    /* 文件无法打开 */

  /*--------------------------------------------------------------------
   * 步骤3: 初始化计数器和缓冲区
   *--------------------------------------------------------------------*/
  for (i = 1; i < 6; i++)
    lesect[i] = 0;        /* 清零各段行计数 */

  for (j = 0; j < 100; j++)
    ligne[j] = 0;         /* 清零行缓冲区 */

  /*====================================================================
   * 步骤4: 主读取循环
   * 逐行读取文件，根据段类型分发到相应的处理函数
   *====================================================================*/
  for(;;) {
    numl++;  /* 行号递增 */

    /*------------------------------------------------------------------
     * 调用 iges_lire 读取一行
     * 返回值:
     *   0  - 文件结束
     *   1  - S 段 (Start)
     *   2  - G 段 (Global)
     *   3  - D 段 (Directory)
     *   4  - P 段 (Parameter)
     *   5  - T 段 (Terminate)
     *  -1  - 解析错误
     *------------------------------------------------------------------*/
    i = iges_lire(lefic, &numsec, ligne, modefnes);

    /*------------------------------------------------------------------
     * 错误处理: 文件结束或段序号错误
     * i0 记录前一行的段类型，正常情况下段只能按 S→G→D→P→T 顺序出现
     *------------------------------------------------------------------*/
    if (i <= 0 || i < i0) {
      if (i == 0)
        break;  /* 正常文件结束，跳出循环 */

      /* 语法错误: 段类型无效或段顺序错误 */
      {
        str[1] = '\0';
        str[0] = sects[i0];
        IGESFile_Check2(0, "XSTEP_18", numl, str);  /* 发送错误消息 */
      }

      if (i0 == 0) {
        /* 第一行就出错，无法继续 */
        fclose(lefic);
        return -1;
      }

      /* 尝试跳过错误行，继续处理 */
      lesect[i0]++;
      continue;
    }

    /*------------------------------------------------------------------
     * 更新段行计数和段类型记录
     *------------------------------------------------------------------*/
    lesect[i]++;
    i0 = i;       /* 记录当前段类型供下次比较 */

    /*------------------------------------------------------------------
     * 行号验证: 段内行号应该连续递增
     *------------------------------------------------------------------*/
    if (numsec != lesect[i]) {
      str[1] = '\0';
      str[0] = sects[i0];
      IGESFile_Check2(0, "XSTEP_19", numl, str);  /* 行号不连续警告 */
    }

    /*==================================================================
     * 根据段类型分发处理
     *==================================================================*/

    /*------------------------------------------------------------------
     * S 段 (Start Section): 注释文本
     * 截取前72字符作为注释内容存储
     *------------------------------------------------------------------*/
    if (i == 1) {
      ligne[72] = '\0';                    /* 截断到72字符 */
      iges_newparam(0, 72, ligne);         /* 存储为参数 */
    }

    /*------------------------------------------------------------------
     * G 段 (Global Section): 全局参数
     * 需要解析分隔符，然后逐个提取参数
     *------------------------------------------------------------------*/
    if (i == 2) {
      iges_setglobal();  /* 切换到全局段参数列表 */

      for (;;) {
        /* 第一行需要特殊处理，提取分隔符定义 */
        if (lesect[i] == 1) {
          int n0 = 0;

          /* 检查参数分隔符是否自定义
           * 格式: 1H<sep> 表示使用 <sep> 作为分隔符
           * 如果第一个字符不是逗号，则取第3个字符作为分隔符
           */
          if (ligne[0] != ',') {
            c_separ = ligne[2];
            n0 = 3;
          }

          /* 检查记录结束符是否自定义 */
          if (ligne[n0+1] != c_separ) {
            c_fin = ligne[n0+3];
          }
        }

        /* 解析参数 */
        iges_param(&Pstat, ligne, c_separ, c_fin, 72);

        /* Pstat==2 表示当前行还有更多参数，继续解析
         * 否则说明本记录结束，需要读取下一行
         */
        if (Pstat != 2)
          break;
      }
    }

    /*------------------------------------------------------------------
     * D 段 (Directory Entry Section): 实体目录
     * 每个实体占用2行，包含17个固定格式字段
     *------------------------------------------------------------------*/
    if (i == 3) {
      iges_Dsect(&Dstat, numsec, ligne);
    }

    /*------------------------------------------------------------------
     * P 段 (Parameter Data Section): 实体参数
     * 提取 D 段序号，定位到对应实体，然后解析参数
     *------------------------------------------------------------------*/
    if (i == 4) {
      iges_Psect(numsec, ligne);  /* 提取 D 段序号并定位 */

      /* 循环解析参数直到记录结束 */
      for (;;) {
        iges_param(&Pstat, ligne, c_separ, c_fin, 64);
        if (Pstat != 2)
          break;
      }
    }

    /* T 段只需统计，不做特殊处理 */
  }

  /*--------------------------------------------------------------------
   * 步骤5: 验证终止段存在
   *--------------------------------------------------------------------*/
  if (lesect[5] == 0) {
    IGESFile_Check3(1, "XSTEP_20");  /* 警告: 缺少终止段 */
  }

  /*--------------------------------------------------------------------
   * 步骤6: 关闭文件并返回
   *--------------------------------------------------------------------*/
  fclose(lefic);
  return 0;
}
```

---

## 6. 辅助函数详解

### 6.1 iges_lire() - 行读取函数 (liriges.c)

```c
/*======================================================================
 * 函数: iges_lire
 * 描述: 从 IGES 文件读取一行，解析段标识和行号
 *
 * 参数:
 *   lefic    - 文件指针
 *   numsec   - 输出，段内行号
 *   line     - 输出，行内容 (截断到72字符)
 *   modefnes - FNES 兼容模式
 *
 * 返回值:
 *   0  - 文件结束 (EOF)
 *   1  - S 段
 *   2  - G 段
 *   3  - D 段
 *   4  - P 段
 *   5  - T 段
 *  -1  - 行格式错误
 *
 * 工作原理:
 *   1. 使用 fgets 读取最多99字符
 *   2. 处理特殊情况 (FNES格式、回车换行差异)
 *   3. 从第73位提取段标识符 (S/G/D/P/T)
 *   4. 从第74-80位解析行号
 *   5. 截断第73位为 '\0' 返回数据部分
 *======================================================================*/
int iges_lire (FILE* lefic, int *numsec, char line[100], int modefnes)
{
  int i, result;
  char typesec;

  /* 静态变量: 控制"重读"机制 (用于段切换时) */
  static int iges_fautrelire = 0;

  /*--------------------------------------------------------------------
   * 除非设置了"重读"标志，否则从文件读取新行
   *--------------------------------------------------------------------*/
  if (iges_fautrelire == 0)
  {
    /* 首次读取时初始化关键位置 */
    if (*numsec == 0)
      line[72] = line[79] = ' ';

    line[0] = '\0';

    if(modefnes)
    {
      /* FNES 模式: 直接读取99字符 */
      if (fgets(line, 99, lefic) == NULL)
        return 0;
    }
    else
    {
      /* 标准模式: 处理 \r\n 差异
       * 某些文件只有 \r 没有 \n (如 Mac 旧格式)
       */
      while (fgets(line, 2, lefic) && (line[0] == '\r' || line[0] == '\n'))
      {
        /* 跳过空行 */
      }

      if (fgets(&line[1], 80, lefic) == NULL)
        return 0;
    }

    /*------------------------------------------------------------------
     * FNES 检测: 如果第73位不是 'S' 但第80位是空格
     * 说明这是 FNES 格式，需要跳过第一行
     *------------------------------------------------------------------*/
    if (*numsec == 0 && line[72] != 'S' && line[79] == ' ')
    {
      line[0] = '\0';
      /* 再读一行... (代码省略，类似上面) */
    }

    /*------------------------------------------------------------------
     * FNES 解密: 如果最高位设置，进行 XOR 解密
     *------------------------------------------------------------------*/
    if ((line[0] & 128) && modefnes)
    {
      for (i = 0; i < 80; i++)
        line[i] = (char)(line[i] ^ (150 + (i & 3)));
    }
  }

  if (feof(lefic))
    return 0;

  /*--------------------------------------------------------------------
   * DOS/Windows 文件结束符处理 (0x1A)
   *--------------------------------------------------------------------*/
  {
    char *fc = strchr(line, 0x1A);
    if(fc != 0)
    {
      fc[0] = '\0';
      return 0;
    }
  }

  iges_fautrelire = 0;

  /* 跳过空行 */
  if (line[0] == '\0' || line[0] == '\n' || line[0] == '\r')
    return iges_lire(lefic, numsec, line, modefnes);

  /*--------------------------------------------------------------------
   * 解析标准格式: 第73位为段标识，第74-80为行号
   *--------------------------------------------------------------------*/
  if (sscanf(&line[73], "%d", &result) == 1) {
    *numsec = result;
    typesec = line[72];

    switch (typesec) {
      case 'S': line[72] = '\0'; return (1);
      case 'G': line[72] = '\0'; return (2);
      case 'D': line[72] = '\0'; return (3);
      case 'P': line[72] = '\0'; return (4);
      case 'T': line[72] = '\0'; return (5);
      default:;
    }

    /* 尝试修复: 某些文件第72列为空，尝试邻近列 */
    /* ... 容错代码 ... */
  }

  /*--------------------------------------------------------------------
   * 非标准格式修复: 查找末尾的行号和段标识
   *--------------------------------------------------------------------*/
  i = (int)strlen(line);
  while ((line[i] == '\0' || line[i] == '\n' ||
          line[i] == '\r' || line[i] == ' ') && i > 0)
    i--;

  if (i != (int)strlen(line))
    line[i + 1] = '\0';

  /* 逆向查找行号 */
  while (line[i] >= '0' && line[i] <= '9' && i > 0)
    i--;

  if (sscanf(&line[i + 1], "%d", &result) != 1)
    return -1;

  *numsec = result;

  /* 查找段标识 */
  while (line[i] == ' ' && i > 0)
    i--;

  typesec = line[i];
  switch (typesec) {
    case 'S': line[i] = '\0'; return (1);
    case 'G': line[i] = '\0'; return (2);
    case 'D': line[i] = '\0'; return (3);
    case 'P': line[i] = '\0'; return (4);
    case 'T': line[i] = '\0'; return (5);
    default:;
  }

  return -1;  /* 无法识别 */
}
```

### 6.2 iges_Dsect() - D 段解析 (analiges.c)

```c
/*======================================================================
 * 函数: iges_Dsect
 * 描述: 解析 Directory Entry Section 的一行
 *       每个 IGES 实体在 D 段占用两行
 *
 * 参数:
 *   Dstat  - 状态指针: 0=等待第1行, 1=等待第2行
 *   numsec - 当前行在 D 段内的序号
 *   line   - 行内容 (72字符)
 *
 * D段布局 (每行72字符，8列×9字符，最后4个2字符字段):
 *
 *   第1行 (奇数行号):
 *   ┌────┬────┬────┬────┬────┬────┬────┬────┬──┬──┬──┬──┐
 *   │typ │poi │pdef│tra │niv │vue │trf │aff │bl│su│us│he│
 *   │ 8  │ 8  │ 8  │ 8  │ 8  │ 8  │ 8  │ 8  │2 │2 │2 │2 │
 *   └────┴────┴────┴────┴────┴────┴────┴────┴──┴──┴──┴──┘
 *    0-7  8-15 16-23 24-31 32-39 40-47 48-55 56-63 64-71
 *
 *   第2行 (偶数行号):
 *   ┌────┬────┬────┬────┬────┬────┬────┬────┬────┐
 *   │typ2│epa │col │nbl │form│res1│res2│nom │num │
 *   │ 8  │ 8  │ 8  │ 8  │ 8  │ 8  │ 8  │ 8  │ 8  │
 *   └────┴────┴────┴────┴────┴────┴────┴────┴────┘
 *    0-7  8-15 16-23 24-31 32-39 40-47 48-55 56-63 64-71
 *======================================================================*/
void iges_Dsect (int *Dstat, int numsec, char* line)
{
  struct dirpart *curp;

  if (*Dstat == 0) {
    /*------------------------------------------------------------------
     * 第1行处理: 创建新的实体条目
     *------------------------------------------------------------------*/
    iges_newpart(numsec);       /* 分配新的 dirpart 结构 */
    curp = iges_get_curp();     /* 获取当前 dirpart 指针 */

    /* 解析17个字段中的前12个 (第1行) */
    curp->typ  = IGES_decode(line, 0, 8);   /* 实体类型号 (如 110=线) */
    curp->poi  = IGES_decode(line, 8, 8);   /* 参数数据指针 (P段行号) */
    curp->pdef = IGES_decode(line, 16, 8);  /* 结构定义 */
    curp->tra  = IGES_decode(line, 24, 8);  /* 线型模式 */
    curp->niv  = IGES_decode(line, 32, 8);  /* 层级 */
    curp->vue  = IGES_decode(line, 40, 8);  /* 视图 */
    curp->trf  = IGES_decode(line, 48, 8);  /* 变换矩阵指针 */
    curp->aff  = IGES_decode(line, 56, 8);  /* 标签显示关联 */
    curp->blk  = IGES_decode(line, 64, 2);  /* 空白状态 */
    curp->sub  = IGES_decode(line, 66, 2);  /* 从属实体开关 */
    curp->use  = IGES_decode(line, 68, 2);  /* 实体使用标志 */
    curp->her  = IGES_decode(line, 70, 2);  /* 层次结构 */

    *Dstat = 1;  /* 切换到等待第2行状态 */
  }
  else if (*Dstat == 1) {
    /*------------------------------------------------------------------
     * 第2行处理: 补充实体信息
     *------------------------------------------------------------------*/
    curp = iges_get_curp();

    /* 解析剩余5个数字字段和4个字符串字段 */
    curp->typ2 = IGES_decode(line, 0, 8);   /* 实体类型 (应与第1行相同) */
    curp->epa  = IGES_decode(line, 8, 8);   /* 线粗 */
    curp->col  = IGES_decode(line, 16, 8);  /* 颜色号 */
    curp->nbl  = IGES_decode(line, 24, 8);  /* 参数行数 */
    curp->form = IGES_decode(line, 32, 8);  /* 形式号 */

    /* 复制保留字段和标签 */
    IGES_copstr(line, 40, 8, curp->res1);   /* 保留字段1 */
    IGES_copstr(line, 48, 8, curp->res2);   /* 保留字段2 */
    IGES_copstr(line, 56, 8, curp->nom);    /* 实体标签 */
    IGES_copstr(line, 64, 8, curp->num);    /* 实体下标 */

    *Dstat = 0;  /* 复位状态，准备处理下一个实体 */
  }
}

/*======================================================================
 * 函数: IGES_decode
 * 描述: 从固定格式字段中解码整数
 *       处理空格、正负号、右对齐数字
 *======================================================================*/
static int IGES_decode (char* line, int depuis, int tant)
{
  int val = 0;
  int i;
  int depart = depuis + tant - 1;  /* 从右向左解析 */

  /* 权重表: 1, 10, 100, 1000, ... */
  static int bases[] = {1, 10, 100, 1000, 10000, 100000,
                        1000000, 10000000, 100000000, 1000000000};

  for (i = 0; i < tant; i++) {
    char uncar = line[depart - i];

    if (uncar == ' ')
      break;           /* 空格表示数字结束 */
    else if (uncar == '+')
      continue;        /* 忽略正号 */
    else if (uncar == '-')
      val = -val;      /* 负号取反 */
    else if (uncar != '0')
      val += (uncar - 48) * bases[i];  /* 累加数字 */
  }

  return val;
}
```

### 6.3 iges_param() - 参数解析 (analiges.c)

```c
/*======================================================================
 * 函数: iges_param
 * 描述: 解析 G 段或 P 段的参数
 *       处理逗号/分号分隔的参数序列
 *       支持 Hollerith 格式的字符串 (nH<n个字符>)
 *
 * 参数:
 *   Pstat   - 状态指针:
 *             0 = 新实体开始
 *             1 = 新行开始
 *             2 = 行中间 (有更多参数)
 *             3 = Hollerith 未完成 (跨行)
 *   line    - 当前行内容
 *   c_separ - 参数分隔符 (通常是 ',')
 *   c_fin   - 记录结束符 (通常是 ';')
 *   lonlin  - 有效内容长度 (G段72, P段64)
 *
 * 参数类型识别 (typarg):
 *   ArgVide  = 0  空参数
 *   ArgQuid  = 1  未知类型
 *   ArgChar  = 2  Hollerith 字符串
 *   ArgInt   = 3  无符号整数
 *   ArgSign  = 4  有符号整数
 *   ArgReal  = 5  实数
 *   ArgExp   = 6  实数 + E (等待确认)
 *   ArgRexp  = 7  实数 + 完整指数
 *   ArgMexp  = 8  实数 + 不完整指数
 *======================================================================*/
void iges_param (int *Pstat, char *line, char c_separ, char c_fin, int lonlin)
{
  int i, i0, j;
  char param[80];
  char unpar;

  static int nbcarH = 0;  /* Hollerith 剩余字符数 */
  static int numcar = 0;  /* 当前位置 */
  static int reste = 0;   /* 0=正常, 1=追加参数, -1=跳过 */
  static int typarg;      /* 参数类型 */

  /* 状态初始化 */
  if (*Pstat == 0) reste = 0;
  if (*Pstat != 2) numcar = 0;
  if (*Pstat < 3) nbcarH = 0;
  else {
    /* 继续处理跨行的 Hollerith */
    numcar = nbcarH;
    if (numcar > lonlin) {
      iges_addparam(lonlin, line);
      nbcarH -= lonlin;
      return;
    } else {
      iges_addparam(nbcarH, line);
      nbcarH = 0;
    }
  }

  i0 = 0;              /* 有效参数起始位置 */
  typarg = ArgVide;    /* 初始类型: 空 */

  /*--------------------------------------------------------------------
   * 逐字符扫描，识别参数类型并提取值
   *--------------------------------------------------------------------*/
  for (i = 0; (unpar = line[numcar + i]) != '\0'; i++) {

    /*------------------------------------------------------------------
     * 遇到分隔符: 完成当前参数
     *------------------------------------------------------------------*/
    if (unpar == c_separ) {
      *Pstat = 2;
      param[i] = '\0';

      if (reste == 0)
        iges_newparam(typarg, i - i0 + 1, &param[i0]);
      else if (reste > 0)
        iges_addparam(i - i0 + 1, &param[i0]);

      reste = 0;

      /* 检查是否还有更多参数 */
      for (j = i + 1; (unpar = line[numcar + j]) != '\0'; j++) {
        if (unpar != ' ') {
          numcar += i + 1;
          return;
        }
      }

      *Pstat = 1;  /* 行结束 */
      return;
    }

    /*------------------------------------------------------------------
     * 遇到记录结束符: 完成当前参数和记录
     *------------------------------------------------------------------*/
    if (unpar == c_fin) {
      *Pstat = 1;
      param[i] = '\0';

      if (reste == 0)
        iges_newparam(typarg, i - i0 + 1, &param[i0]);
      else if (reste > 0)
        iges_addparam(i - i0 + 1, &param[i0]);

      reste = 0;
      return;
    }

    param[i] = unpar;

    /*------------------------------------------------------------------
     * 参数类型推断 (状态机)
     *------------------------------------------------------------------*/
    if (unpar >= '0' && unpar <= '9') {
      /* 数字字符 */
      if (typarg == ArgInt) continue;
      if (typarg == ArgVide) typarg = ArgInt;
      else if (typarg == ArgExp) typarg = ArgRexp;  /* E后有数字 */
    }
    else if (unpar == '+' || unpar == '-') {
      /* 符号 */
      if (typarg == ArgVide) typarg = ArgSign;
      else if (typarg != ArgExp && typarg != ArgMexp) typarg = ArgQuid;
    }
    else if (unpar == '.') {
      /* 小数点 */
      if (typarg == ArgVide) typarg = ArgReal;
      else if (typarg == ArgInt || typarg == ArgSign) typarg = ArgReal;
      else typarg = ArgQuid;
    }
    else if (unpar == 'E' || unpar == 'e' || unpar == 'D' || unpar == 'd') {
      /* 指数标记 */
      if (typarg == ArgReal) typarg = ArgExp;
      else if (typarg == ArgInt || typarg == ArgSign) typarg = ArgMexp;
      else typarg = ArgQuid;
    }
    else if (unpar == 'H') {
      /*----------------------------------------------------------------
       * Hollerith 格式: nH<n个字符>
       * 例如: 4HLINE 表示字符串 "LINE"
       *----------------------------------------------------------------*/
      if (typarg != ArgInt) { typarg = ArgQuid; continue; }

      typarg = ArgChar;
      nbcarH = 0;

      /* 从前面的数字中解析长度 */
      for (j = i0; j < i; j++) {
        if (param[j] >= '0' && param[j] <= '9')
          nbcarH = nbcarH * 10 + (param[j] - '0');
        else {
          nbcarH = 0;
          break;
        }
      }

      /* 检查是否跨行 */
      if (numcar + i + nbcarH >= lonlin) {
        /* 文本跨越多行 */
        for (j = 1; j < lonlin - numcar - i; j++)
          param[i + j] = line[numcar + i + j];

        param[lonlin - numcar] = '\0';
        nbcarH = (numcar + i + nbcarH + 1 - lonlin);
        *Pstat = 3;  /* 标记为"未完成 Hollerith" */

        iges_newparam(typarg, lonlin - i0, &param[i0]);
        reste = 1;
        return;
      } else {
        /* 文本在本行内 */
        for (j = 1; j <= nbcarH; j++)
          param[i + j] = line[numcar + i + j];
        i += nbcarH;
      }
    }
    else if (unpar == ' ') {
      /* 空格处理 */
      if (typarg == ArgVide)
        i0 = i + 1;  /* 前导空格，跳过 */
      else {
        /* 检查是否为尾随空格 */
        for (j = i + 1; (unpar = line[numcar + j]) != '\0'; j++) {
          if (unpar == c_separ || unpar == c_fin) break;
          if (unpar != ' ') { typarg = ArgQuid; break; }
        }
      }
    }
    else {
      typarg = ArgQuid;  /* 其他字符: 未知类型 */
    }
  }

  /* 行结束但未遇到分隔符: 保存状态 */
  *Pstat = 1;
  param[i] = '\0';
  reste = -1;

  if (i > i0)
    iges_newparam(typarg, i - i0 + 1, &param[i0]);
}
```

---

## 7. 调试要点

### 7.1 关键断点位置

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          调试断点建议                                    │
├────────────────────────────────────────┬────────────────────────────────┤
│ 断点位置                               │ 观察目的                       │
├────────────────────────────────────────┼────────────────────────────────┤
│ igesread.c:55  (函数入口)              │ 检查文件名和参数               │
│ igesread.c:72  (iges_lire 调用后)      │ 观察每行解析结果               │
│ igesread.c:98  (S段处理)               │ 验证注释文本                   │
│ igesread.c:102 (G段处理)               │ 检查分隔符解析                 │
│ igesread.c:114 (D段处理)               │ 验证实体目录解析               │
│ igesread.c:115 (P段处理)               │ 检查实体参数                   │
├────────────────────────────────────────┼────────────────────────────────┤
│ liriges.c:34   (iges_lire 入口)        │ 跟踪行读取逻辑                 │
│ liriges.c:105  (段标识解析)            │ 验证段类型识别                 │
├────────────────────────────────────────┼────────────────────────────────┤
│ analiges.c:76  (iges_Dsect 入口)       │ 跟踪 D 段解析                  │
│ analiges.c:150 (iges_param 入口)       │ 跟踪参数解析状态机             │
├────────────────────────────────────────┼────────────────────────────────┤
│ structiges.c:139 (iges_newpart)        │ 观察实体创建                   │
│ structiges.c:192 (iges_newparam)       │ 跟踪参数存储                   │
└────────────────────────────────────────┴────────────────────────────────┘
```

### 7.2 常见问题诊断

| 问题现象 | 可能原因 | 排查方法 |
|---------|---------|---------|
| 返回 -1 | 文件无法打开 | 检查文件路径和权限 |
| 返回 -1 且 i0=0 | 首行格式错误 | 检查文件是否为有效 IGES |
| 实体数量不对 | D 段解析问题 | 断点观察 iges_Dsect |
| 参数丢失 | Hollerith 跨行处理错误 | 断点观察 iges_param Pstat=3 分支 |
| 分隔符错误 | G 段首行解析失败 | 检查 c_separ 和 c_fin 变量 |

---

## 附录: 相关文件路径

```
OCCT/src/DataExchange/TKDEIGES/IGESFile/
├── igesread.c        # 主入口函数
├── igesread.h        # 头文件与数据结构定义
├── liriges.c         # 底层行读取
├── structiges.c      # 内存数据结构管理
├── analiges.c        # D/P 段解析
└── IGESFile_Read.cxx # C++ 封装层
```

---

*文档生成时间: 2024-12-31*
*源码版本: OpenCASCADE Technology*
