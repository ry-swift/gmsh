# 安装与配置

本文档介绍如何在不同操作系统上安装和配置Gmsh。

## 安装方式概览

| 方式 | 适用场景 | 难度 |
|-----|---------|------|
| pip安装 | Python API开发（推荐） | ⭐ |
| 二进制安装 | GUI使用、命令行 | ⭐ |
| 源码编译 | 自定义功能、开发 | ⭐⭐⭐ |

## 方式一：pip 安装（推荐）

这是最简单的安装方式，适合使用Python API的用户。

### 安装命令

```bash
# 基础安装
pip install gmsh

# 升级到最新版本
pip install --upgrade gmsh

# 指定版本安装
pip install gmsh==4.14.0
```

### 使用conda安装

```bash
# 使用conda-forge频道
conda install -c conda-forge gmsh
```

### 验证安装

```python
import gmsh

# 初始化
gmsh.initialize()

# 打印版本信息
print(f"Gmsh版本: {gmsh.GMSH_API_VERSION}")
print(f"Gmsh API版本: {gmsh.GMSH_API_VERSION_MAJOR}.{gmsh.GMSH_API_VERSION_MINOR}.{gmsh.GMSH_API_VERSION_PATCH}")

# 清理
gmsh.finalize()
```

预期输出：
```
Gmsh版本: 4.14.0
Gmsh API版本: 4.14.0
```

## 方式二：二进制安装

### Windows

1. 访问 [Gmsh官网下载页面](https://gmsh.info/#Download)
2. 下载 `gmsh-*-Windows64.zip`
3. 解压到目标目录（如 `C:\Program Files\gmsh`）
4. 将 `bin` 目录添加到系统 PATH 环境变量

**添加环境变量**：
```
系统属性 → 高级 → 环境变量 → Path → 编辑 → 新建
添加: C:\Program Files\gmsh\bin
```

### macOS

**使用Homebrew安装**（推荐）：
```bash
brew install gmsh
```

**手动安装**：
1. 下载 `gmsh-*-MacOSX.dmg`
2. 打开DMG文件，将 Gmsh.app 拖入 Applications
3. 可选：创建命令行符号链接
```bash
sudo ln -s /Applications/Gmsh.app/Contents/MacOS/gmsh /usr/local/bin/gmsh
```

### Linux

**Debian/Ubuntu**：
```bash
sudo apt-get update
sudo apt-get install gmsh
```

**Fedora/CentOS**：
```bash
sudo dnf install gmsh
```

**Arch Linux**：
```bash
sudo pacman -S gmsh
```

**手动安装**：
```bash
# 下载并解压
wget https://gmsh.info/bin/Linux/gmsh-4.14.0-Linux64.tgz
tar -xzf gmsh-4.14.0-Linux64.tgz
sudo mv gmsh-4.14.0-Linux64 /opt/gmsh

# 创建符号链接
sudo ln -s /opt/gmsh/bin/gmsh /usr/local/bin/gmsh

# 设置库路径（如需要）
echo 'export LD_LIBRARY_PATH=/opt/gmsh/lib:$LD_LIBRARY_PATH' >> ~/.bashrc
source ~/.bashrc
```

## 方式三：源码编译

适用于需要自定义功能或开发Gmsh的用户。

### 依赖项

**必需**：
- CMake 3.10+
- C++14 兼容编译器（GCC 5+, Clang 3.4+, MSVC 2017+）

**可选**（增强功能）：
- OpenCASCADE（推荐，用于高级CAD功能）
- FLTK（GUI界面）
- OpenGL（图形渲染）
- PETSc、MUMPS（求解器）
- HDF5（CGNS、MED格式支持）

### 编译步骤

```bash
# 1. 获取源码
git clone https://gitlab.onelab.info/gmsh/gmsh.git
cd gmsh

# 或下载发布版源码
wget https://gmsh.info/src/gmsh-4.14.0-source.tgz
tar -xzf gmsh-4.14.0-source.tgz
cd gmsh-4.14.0-source

# 2. 创建构建目录
mkdir build && cd build

# 3. 配置（基础）
cmake ..

# 3. 配置（带OpenCASCADE）
cmake -DENABLE_OCC=1 ..

# 3. 配置（完整功能）
cmake -DENABLE_OCC=1 \
      -DENABLE_FLTK=1 \
      -DENABLE_PETSC=1 \
      -DENABLE_BUILD_SHARED=1 \
      ..

# 4. 编译
make -j$(nproc)

# 5. 安装（可选）
sudo make install
```

### 常用CMake选项

| 选项 | 默认值 | 描述 |
|-----|-------|------|
| `ENABLE_FLTK` | ON | 启用GUI界面 |
| `ENABLE_OCC` | ON（如果检测到） | 启用OpenCASCADE |
| `ENABLE_BUILD_LIB` | OFF | 构建静态库 |
| `ENABLE_BUILD_SHARED` | OFF | 构建共享库 |
| `ENABLE_BUILD_DYNAMIC` | OFF | 构建动态可执行文件 |
| `ENABLE_PETSC` | OFF | 启用PETSc求解器 |
| `ENABLE_CGNS` | ON | 启用CGNS格式 |
| `ENABLE_MED` | ON | 启用MED格式 |
| `CMAKE_INSTALL_PREFIX` | /usr/local | 安装路径 |

**查看所有选项**：
```bash
ccmake ..  # 交互式配置
# 或
cmake -LA .. | grep ENABLE
```

## Python SDK 详细配置

### 环境隔离（推荐）

```bash
# 创建虚拟环境
python -m venv gmsh_env

# 激活环境
# Windows:
gmsh_env\Scripts\activate
# macOS/Linux:
source gmsh_env/bin/activate

# 安装gmsh
pip install gmsh numpy
```

### 与NumPy集成

Gmsh的Python API自动检测NumPy，并在可用时返回NumPy数组而非Python列表，提升性能。

```python
import gmsh
import numpy as np

gmsh.initialize()
gmsh.model.add("test")

# 创建简单几何
gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1)
gmsh.model.occ.synchronize()
gmsh.model.mesh.generate(3)

# 获取节点（如果安装了numpy，返回numpy数组）
nodeTags, nodeCoords, _ = gmsh.model.mesh.getNodes()
print(f"节点坐标类型: {type(nodeCoords)}")  # numpy.ndarray
print(f"节点数量: {len(nodeTags)}")

gmsh.finalize()
```

### Jupyter Notebook 集成

```python
# 在Jupyter中使用Gmsh
import gmsh

gmsh.initialize()
gmsh.model.add("notebook_example")

# 创建几何
gmsh.model.occ.addSphere(0, 0, 0, 1)
gmsh.model.occ.synchronize()
gmsh.model.mesh.generate(3)

# 保存网格
gmsh.write("sphere.msh")

# 注意：在Jupyter中不要调用 gmsh.fltk.run()
# 它会阻塞notebook

gmsh.finalize()
```

## IDE 配置

### VS Code

1. 安装 Python 扩展
2. 创建 `.vscode/settings.json`：
```json
{
    "python.analysis.extraPaths": [
        "${workspaceFolder}"
    ],
    "python.linting.enabled": true,
    "python.linting.pylintEnabled": true
}
```

### PyCharm

1. File → Settings → Project → Python Interpreter
2. 点击 "+" 添加 gmsh 包
3. 确保解释器路径正确

## 常见问题

### Q1: ImportError: DLL load failed

**Windows常见问题**，通常是缺少Visual C++ Redistributable。

**解决方案**：
```
下载并安装 Microsoft Visual C++ Redistributable
https://aka.ms/vs/17/release/vc_redist.x64.exe
```

### Q2: OpenCASCADE 未启用

**检查方法**：
```python
import gmsh
gmsh.initialize()

# 检查OCC是否可用
try:
    gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1)
    print("OpenCASCADE 已启用")
except:
    print("OpenCASCADE 未启用")

gmsh.finalize()
```

**解决方案**：
- pip安装的gmsh默认包含OCC
- 源码编译时确保 `-DENABLE_OCC=1`

### Q3: GUI无法启动

**检查FLTK**：
```bash
# Linux: 安装FLTK
sudo apt-get install libfltk1.3-dev

# 重新编译gmsh
cmake -DENABLE_FLTK=1 ..
make
```

### Q4: 找不到共享库

**Linux解决方案**：
```bash
# 方法1：设置LD_LIBRARY_PATH
export LD_LIBRARY_PATH=/path/to/gmsh/lib:$LD_LIBRARY_PATH

# 方法2：添加到ldconfig
echo "/path/to/gmsh/lib" | sudo tee /etc/ld.so.conf.d/gmsh.conf
sudo ldconfig
```

### Q5: Python版本不兼容

Gmsh支持Python 3.7+，推荐3.10+。

```bash
# 检查Python版本
python --version

# 使用特定版本的pip
python3.10 -m pip install gmsh
```

## 测试安装完整性

运行以下脚本验证安装是否完整：

```python
#!/usr/bin/env python3
"""Gmsh 安装完整性测试"""

import sys

def test_gmsh():
    print("=" * 50)
    print("Gmsh 安装测试")
    print("=" * 50)

    # 1. 导入测试
    print("\n1. 导入gmsh模块...")
    try:
        import gmsh
        print("   ✓ 成功")
    except ImportError as e:
        print(f"   ✗ 失败: {e}")
        return False

    # 2. 初始化测试
    print("\n2. 初始化gmsh...")
    try:
        gmsh.initialize()
        print("   ✓ 成功")
    except Exception as e:
        print(f"   ✗ 失败: {e}")
        return False

    # 3. 版本信息
    print(f"\n3. 版本信息:")
    print(f"   API版本: {gmsh.GMSH_API_VERSION}")

    # 4. 内置几何内核测试
    print("\n4. 测试内置几何内核 (geo)...")
    try:
        gmsh.model.add("geo_test")
        gmsh.model.geo.addPoint(0, 0, 0, 0.1, 1)
        gmsh.model.geo.synchronize()
        print("   ✓ 成功")
        gmsh.model.remove()
    except Exception as e:
        print(f"   ✗ 失败: {e}")

    # 5. OpenCASCADE内核测试
    print("\n5. 测试OpenCASCADE内核 (occ)...")
    try:
        gmsh.model.add("occ_test")
        gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1)
        gmsh.model.occ.synchronize()
        print("   ✓ 成功 - OpenCASCADE已启用")
        gmsh.model.remove()
    except Exception as e:
        print(f"   ⚠ OpenCASCADE未启用: {e}")

    # 6. 网格生成测试
    print("\n6. 测试网格生成...")
    try:
        gmsh.model.add("mesh_test")
        gmsh.model.occ.addRectangle(0, 0, 0, 1, 1)
        gmsh.model.occ.synchronize()
        gmsh.model.mesh.generate(2)
        nodes, _, _ = gmsh.model.mesh.getNodes()
        print(f"   ✓ 成功 - 生成了 {len(nodes)} 个节点")
        gmsh.model.remove()
    except Exception as e:
        print(f"   ✗ 失败: {e}")

    # 7. NumPy集成测试
    print("\n7. 测试NumPy集成...")
    try:
        import numpy as np
        gmsh.model.add("numpy_test")
        gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1)
        gmsh.model.occ.synchronize()
        gmsh.model.mesh.generate(3)
        _, coords, _ = gmsh.model.mesh.getNodes()
        if isinstance(coords, np.ndarray):
            print(f"   ✓ NumPy已启用 - 返回类型: {type(coords).__name__}")
        else:
            print(f"   ⚠ NumPy未启用 - 返回类型: {type(coords).__name__}")
        gmsh.model.remove()
    except ImportError:
        print("   ⚠ NumPy未安装")
    except Exception as e:
        print(f"   ✗ 失败: {e}")

    # 清理
    gmsh.finalize()

    print("\n" + "=" * 50)
    print("测试完成！")
    print("=" * 50)
    return True

if __name__ == "__main__":
    success = test_gmsh()
    sys.exit(0 if success else 1)
```

保存为 `test_gmsh_install.py` 并运行：
```bash
python test_gmsh_install.py
```

## 下一步

安装完成后，请继续阅读：
- [03-第一个网格](./03-第一个网格.md) - 5分钟快速体验Gmsh
