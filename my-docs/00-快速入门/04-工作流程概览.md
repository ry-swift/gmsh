# 工作流程概览

本文档详细介绍Gmsh的完整工作流程，帮助您理解从几何建模到网格输出的各个环节。

## 标准工作流程

```
┌──────────────────────────────────────────────────────────────────────┐
│                         Gmsh 工作流程                                │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────┐    ┌──────────┐    ┌─────────┐    ┌──────────┐         │
│  │ 初始化   │ -> │ 几何建模 │ -> │ 同步    │ -> │ 物理组   │         │
│  │initialize│    │ geo/occ  │    │synchronize│  │(可选)    │         │
│  └─────────┘    └──────────┘    └─────────┘    └──────────┘         │
│                                                       │              │
│                                                       v              │
│  ┌─────────┐    ┌──────────┐    ┌─────────┐    ┌──────────┐         │
│  │ 清理    │ <- │ 输出     │ <- │ 后处理  │ <- │ 网格生成 │         │
│  │finalize │    │ write    │    │(可选)   │    │ generate │         │
│  └─────────┘    └──────────┘    └─────────┘    └──────────┘         │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

## 详细步骤说明

### 1. 初始化 (Initialize)

```python
import gmsh

# 初始化Gmsh - 必须第一步调用
gmsh.initialize()

# 可选：传入命令行参数
# gmsh.initialize(sys.argv)

# 可选：设置全局选项
gmsh.option.setNumber("General.Verbosity", 3)  # 输出级别
gmsh.option.setNumber("General.NumThreads", 4)  # 并行线程数
```

**作用**：
- 加载Gmsh库
- 初始化内部数据结构
- 设置默认选项

### 2. 创建模型 (Create Model)

```python
# 创建新模型
gmsh.model.add("model_name")

# 可以创建多个模型
gmsh.model.add("model1")
gmsh.model.add("model2")

# 切换当前模型
gmsh.model.setCurrent("model1")

# 获取当前模型名
current = gmsh.model.getCurrent()
```

**要点**：
- 每个几何/网格属于一个模型
- 可以同时管理多个模型
- 默认操作当前模型

### 3. 几何建模 (Geometry)

Gmsh提供两个几何内核：

#### 3.1 内置几何内核 (geo)

```python
# 创建点
gmsh.model.geo.addPoint(x, y, z, meshSize, tag)

# 创建曲线
gmsh.model.geo.addLine(startTag, endTag, tag)
gmsh.model.geo.addCircleArc(startTag, centerTag, endTag, tag)
gmsh.model.geo.addSpline(pointTags, tag)

# 创建曲面
gmsh.model.geo.addCurveLoop(curveTags, tag)
gmsh.model.geo.addPlaneSurface([wireTag], tag)

# 创建体积
gmsh.model.geo.addSurfaceLoop(surfaceTags, tag)
gmsh.model.geo.addVolume([shellTag], tag)

# 几何变换
gmsh.model.geo.translate(dimTags, dx, dy, dz)
gmsh.model.geo.rotate(dimTags, x, y, z, ax, ay, az, angle)

# 拉伸操作
gmsh.model.geo.extrude(dimTags, dx, dy, dz)
gmsh.model.geo.revolve(dimTags, x, y, z, ax, ay, az, angle)
```

#### 3.2 OpenCASCADE几何内核 (occ)

```python
# 基本图元（直接创建完整实体）
gmsh.model.occ.addPoint(x, y, z, meshSize, tag)
gmsh.model.occ.addLine(startTag, endTag, tag)
gmsh.model.occ.addRectangle(x, y, z, dx, dy, tag)
gmsh.model.occ.addDisk(xc, yc, zc, rx, ry, tag)
gmsh.model.occ.addBox(x, y, z, dx, dy, dz, tag)
gmsh.model.occ.addSphere(xc, yc, zc, radius, tag)
gmsh.model.occ.addCylinder(x, y, z, dx, dy, dz, r, tag)
gmsh.model.occ.addCone(x, y, z, dx, dy, dz, r1, r2, tag)
gmsh.model.occ.addTorus(xc, yc, zc, r1, r2, tag)

# 布尔运算（仅OCC支持）
gmsh.model.occ.fuse(objectDimTags, toolDimTags, tag)       # 并集
gmsh.model.occ.cut(objectDimTags, toolDimTags, tag)        # 差集
gmsh.model.occ.intersect(objectDimTags, toolDimTags, tag)  # 交集
gmsh.model.occ.fragment(objectDimTags, toolDimTags, tag)   # 分片

# CAD导入（仅OCC支持）
gmsh.model.occ.importShapes("model.step")
gmsh.model.occ.importShapes("model.iges")

# 高级操作
gmsh.model.occ.fillet(volumeTags, curveTags, radii)   # 圆角
gmsh.model.occ.chamfer(volumeTags, curveTags, ...)    # 倒角
gmsh.model.occ.addThruSections(wiresTags)             # 通过截面
gmsh.model.occ.addPipe(dimTags, wireTag)              # 管道
```

#### 两个内核的对比

| 特性 | geo (内置) | occ (OpenCASCADE) |
|------|-----------|-------------------|
| 布尔运算 | ❌ 不支持 | ✅ 完全支持 |
| CAD导入 | 有限 | ✅ STEP/IGES/BREP |
| 基本图元 | 需手动构建 | ✅ 直接创建 |
| 圆角/倒角 | ❌ 不支持 | ✅ 支持 |
| 学习曲线 | 简单 | 中等 |
| 依赖 | 无 | 需要OpenCASCADE |

### 4. 同步 (Synchronize) - 关键步骤！

```python
# 内置内核同步
gmsh.model.geo.synchronize()

# OpenCASCADE内核同步
gmsh.model.occ.synchronize()
```

**为什么需要同步？**
- 几何内核（geo/occ）内部维护自己的数据结构
- Gmsh模型是独立的数据层
- `synchronize()` 将几何内核数据复制到Gmsh模型
- **必须在网格生成前调用**

```
┌───────────────┐           ┌───────────────┐
│   几何内核    │           │   Gmsh模型    │
│  (geo/occ)    │           │               │
│               │           │               │
│  点、线、面   │──同步──>  │  实体数据     │
│  布尔运算结果 │           │  拓扑关系     │
└───────────────┘           └───────────────┘
```

### 5. 定义物理组 (Physical Groups) - 可选

```python
# 创建物理组
# addPhysicalGroup(dim, tags, tag=-1, name="")
inlet_tag = gmsh.model.addPhysicalGroup(1, [1, 2], name="inlet")
outlet_tag = gmsh.model.addPhysicalGroup(1, [3], name="outlet")
domain_tag = gmsh.model.addPhysicalGroup(2, [1], name="domain")
solid_tag = gmsh.model.addPhysicalGroup(3, [1, 2], name="solid")

# 也可以事后命名
gmsh.model.setPhysicalName(2, domain_tag, "fluid_domain")
```

**作用**：
- 将几何实体组织成有意义的集合
- 用于定义边界条件（inlet, outlet, wall等）
- 用于指定材料区域
- 控制网格输出内容

### 6. 网格约束 (Mesh Constraints) - 可选

```python
# 设置网格尺寸
gmsh.model.mesh.setSize([(0, 1), (0, 2)], 0.05)  # 点尺寸

# 结构化网格（Transfinite）
gmsh.model.mesh.setTransfiniteCurve(lineTag, numNodes)
gmsh.model.mesh.setTransfiniteSurface(surfaceTag)
gmsh.model.mesh.setTransfiniteVolume(volumeTag)

# 四边形/六面体网格
gmsh.model.mesh.setRecombine(2, surfaceTag)

# 网格尺寸场
field_id = gmsh.model.mesh.field.add("Distance")
gmsh.model.mesh.field.setNumbers(field_id, "CurvesList", [1, 2])
gmsh.model.mesh.field.setAsBackgroundMesh(field_id)
```

### 7. 网格生成 (Mesh Generation)

```python
# 生成网格
gmsh.model.mesh.generate(dim)  # dim = 1, 2, 或 3

# 分步生成
gmsh.model.mesh.generate(1)  # 先1D
gmsh.model.mesh.generate(2)  # 再2D
gmsh.model.mesh.generate(3)  # 最后3D

# 网格优化（可选）
gmsh.model.mesh.optimize("Netgen")      # 使用Netgen优化
gmsh.model.mesh.optimize("HighOrder")   # 高阶网格优化

# 细化网格（可选）
gmsh.model.mesh.refine()

# 改变元素阶数（可选）
gmsh.model.mesh.setOrder(2)  # 转为2阶元素

# 网格分区（可选，用于并行计算）
gmsh.model.mesh.partition(numParts)
```

**网格算法选项**：
```python
# 2D网格算法
gmsh.option.setNumber("Mesh.Algorithm", 6)  # Frontal-Delaunay
# 1=MeshAdapt, 2=Automatic, 5=Delaunay, 6=Frontal-Delaunay, 7=BAMG, 8=Frontal-Delaunay for Quads

# 3D网格算法
gmsh.option.setNumber("Mesh.Algorithm3D", 10)  # HXT
# 1=Delaunay, 4=Frontal, 7=MMG3D, 9=R-tree, 10=HXT
```

### 8. 后处理 (Post-processing) - 可选

```python
# 创建数据视图
view_tag = gmsh.view.add("Result")

# 添加数据（基于节点）
gmsh.view.addHomogeneousModelData(
    view_tag,
    step=0,
    modelName="model_name",
    dataType="NodeData",
    tags=node_tags,
    data=node_values
)

# 保存视图
gmsh.view.write(view_tag, "result.pos")
```

### 9. 输出 (Output)

```python
# 保存网格
gmsh.write("output.msh")      # Gmsh原生格式（推荐）
gmsh.write("output.vtk")      # VTK格式
gmsh.write("output.stl")      # STL格式
gmsh.write("output.mesh")     # Medit格式
gmsh.write("output.cgns")     # CGNS格式
gmsh.write("output.med")      # MED格式

# 控制MSH版本
gmsh.option.setNumber("Mesh.MshFileVersion", 4.1)  # MSH 4.1
gmsh.option.setNumber("Mesh.MshFileVersion", 2.2)  # MSH 2.2（兼容性）

# 控制输出内容
gmsh.option.setNumber("Mesh.SaveAll", 1)  # 保存所有元素（不仅物理组）
gmsh.option.setNumber("Mesh.Binary", 1)   # 二进制格式
```

### 10. 可视化 (Visualization) - 可选

```python
# 启动GUI
gmsh.fltk.run()

# 仅更新显示
gmsh.fltk.update()

# 设置GUI选项
gmsh.option.setNumber("Mesh.SurfaceEdges", 1)   # 显示面的边
gmsh.option.setNumber("Mesh.SurfaceFaces", 1)   # 显示面
gmsh.option.setNumber("Mesh.VolumeEdges", 0)    # 不显示体的边
gmsh.option.setNumber("Mesh.ColorCarousel", 2)  # 颜色方案
```

### 11. 清理 (Finalize)

```python
# 清理资源 - 必须最后调用
gmsh.finalize()
```

## 完整示例：3D模型工作流

```python
#!/usr/bin/env python3
"""
完整的3D网格生成工作流示例
创建带圆孔的立方体
"""
import gmsh

# ============ 1. 初始化 ============
gmsh.initialize()
gmsh.option.setNumber("General.Verbosity", 3)

# ============ 2. 创建模型 ============
gmsh.model.add("cube_with_hole")

# ============ 3. 几何建模（使用OCC） ============
# 创建立方体
box = gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1, 1)

# 创建圆柱孔
cylinder = gmsh.model.occ.addCylinder(0.5, 0.5, 0, 0, 0, 1, 0.2, 2)

# 布尔差运算：从立方体中挖出圆柱孔
gmsh.model.occ.cut([(3, box)], [(3, cylinder)], 3)

# ============ 4. 同步 ============
gmsh.model.occ.synchronize()

# ============ 5. 定义物理组 ============
# 获取所有边界面
surfaces = gmsh.model.getEntities(2)
volumes = gmsh.model.getEntities(3)

# 找到孔的表面（通过几何查询）
hole_surfaces = []
for dim, tag in surfaces:
    # 获取面的包围盒
    bbox = gmsh.model.occ.getBoundingBox(dim, tag)
    xmin, ymin, zmin, xmax, ymax, zmax = bbox
    # 孔的面是弯曲的，可以通过其他特征识别
    # 这里简化处理，假设所有非平面的面是孔
    mass = gmsh.model.occ.getMass(dim, tag)
    # 圆柱面面积约为 2*π*0.2*1 ≈ 1.26
    if abs(mass - 1.2566) < 0.1:
        hole_surfaces.append(tag)

# 定义物理组
all_surface_tags = [s[1] for s in surfaces]
gmsh.model.addPhysicalGroup(2, all_surface_tags, name="boundary")
gmsh.model.addPhysicalGroup(3, [v[1] for v in volumes], name="volume")

# ============ 6. 网格约束 ============
# 设置全局网格尺寸
gmsh.option.setNumber("Mesh.MeshSizeMin", 0.02)
gmsh.option.setNumber("Mesh.MeshSizeMax", 0.1)

# 孔周围细化
if hole_surfaces:
    field1 = gmsh.model.mesh.field.add("Distance")
    gmsh.model.mesh.field.setNumbers(field1, "SurfacesList", hole_surfaces)

    field2 = gmsh.model.mesh.field.add("Threshold")
    gmsh.model.mesh.field.setNumber(field2, "InField", field1)
    gmsh.model.mesh.field.setNumber(field2, "SizeMin", 0.02)
    gmsh.model.mesh.field.setNumber(field2, "SizeMax", 0.1)
    gmsh.model.mesh.field.setNumber(field2, "DistMin", 0.05)
    gmsh.model.mesh.field.setNumber(field2, "DistMax", 0.2)

    gmsh.model.mesh.field.setAsBackgroundMesh(field2)

# ============ 7. 网格生成 ============
gmsh.model.mesh.generate(3)

# 网格优化
gmsh.model.mesh.optimize("Netgen")

# ============ 8. 输出 ============
# 获取统计信息
nodes, _, _ = gmsh.model.mesh.getNodes()
print(f"节点数: {len(nodes)}")

# 保存
gmsh.write("cube_with_hole.msh")
gmsh.write("cube_with_hole.vtk")

# ============ 9. 可视化（可选） ============
# gmsh.fltk.run()

# ============ 10. 清理 ============
gmsh.finalize()

print("完成！")
```

## 工作流程检查清单

使用Gmsh时，按以下检查清单确保流程正确：

- [ ] 调用 `gmsh.initialize()`
- [ ] 调用 `gmsh.model.add("name")`
- [ ] 创建几何（geo或occ）
- [ ] 调用 `synchronize()`（**关键！**）
- [ ] 定义物理组（如需要）
- [ ] 设置网格约束（如需要）
- [ ] 调用 `gmsh.model.mesh.generate(dim)`
- [ ] 调用 `gmsh.write("output.msh")`
- [ ] 调用 `gmsh.finalize()`

## 下一步

现在您已经理解了Gmsh的完整工作流程，接下来请学习：
- [01-几何建模基础](../01-几何建模基础/01-基本概念.md) - 深入学习几何建模
