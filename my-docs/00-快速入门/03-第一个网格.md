# 第一个网格：5分钟快速体验

本教程将带您在5分钟内创建第一个Gmsh网格，体验从几何建模到网格生成的完整流程。

## 目标

创建一个简单的2D矩形网格：

```
(0,1)───────────(1,1)
  │               │
  │    网格区域    │
  │               │
(0,0)───────────(1,0)
```

## 完整代码

```python
#!/usr/bin/env python3
"""
第一个Gmsh网格示例
创建一个1x1的矩形并生成2D三角形网格
"""

import gmsh

# ============================================
# 第1步：初始化Gmsh
# ============================================
# initialize() 必须是第一个调用的函数
gmsh.initialize()

# 设置控制台输出级别（可选）
# 0: 静默, 1: 错误, 2: 警告, 3: 信息, 4: 进度, 5: 调试
gmsh.option.setNumber("General.Verbosity", 3)

# ============================================
# 第2步：创建新模型
# ============================================
# 每个几何/网格都属于一个模型
gmsh.model.add("first_mesh")

# ============================================
# 第3步：定义几何 - 创建点
# ============================================
# addPoint(x, y, z, meshSize, tag)
# - x, y, z: 点的坐标
# - meshSize: 该点处的目标网格尺寸
# - tag: 点的标识符（正整数），-1表示自动分配

lc = 0.1  # 目标网格单元尺寸

# 创建矩形的四个顶点
p1 = gmsh.model.geo.addPoint(0, 0, 0, lc, 1)  # 左下角
p2 = gmsh.model.geo.addPoint(1, 0, 0, lc, 2)  # 右下角
p3 = gmsh.model.geo.addPoint(1, 1, 0, lc, 3)  # 右上角
p4 = gmsh.model.geo.addPoint(0, 1, 0, lc, 4)  # 左上角

print(f"创建了4个点: {p1}, {p2}, {p3}, {p4}")

# ============================================
# 第4步：定义几何 - 创建线
# ============================================
# addLine(startPoint, endPoint, tag)
# - startPoint: 起点的tag
# - endPoint: 终点的tag
# - tag: 线的标识符

l1 = gmsh.model.geo.addLine(1, 2, 1)  # 底边
l2 = gmsh.model.geo.addLine(2, 3, 2)  # 右边
l3 = gmsh.model.geo.addLine(3, 4, 3)  # 顶边
l4 = gmsh.model.geo.addLine(4, 1, 4)  # 左边

print(f"创建了4条线: {l1}, {l2}, {l3}, {l4}")

# ============================================
# 第5步：定义几何 - 创建曲线环
# ============================================
# addCurveLoop(curveTags, tag)
# - curveTags: 组成闭合环的曲线列表
#   - 正数表示曲线正向（起点→终点）
#   - 负数表示曲线反向（终点→起点）
# - 曲线必须首尾相连形成闭合环

cl = gmsh.model.geo.addCurveLoop([1, 2, 3, 4], 1)
print(f"创建了曲线环: {cl}")

# ============================================
# 第6步：定义几何 - 创建平面曲面
# ============================================
# addPlaneSurface(wireTagsList, tag)
# - wireTagsList: 曲线环列表
#   - 第一个是外边界
#   - 后续的是孔洞

s = gmsh.model.geo.addPlaneSurface([1], 1)
print(f"创建了平面曲面: {s}")

# ============================================
# 第7步：同步几何数据（关键步骤！）
# ============================================
# synchronize() 将内置CAD数据同步到Gmsh模型
# 在网格生成前必须调用！
gmsh.model.geo.synchronize()
print("几何同步完成")

# ============================================
# 第8步：生成网格
# ============================================
# generate(dim) 生成指定维度的网格
# - dim=1: 只生成1D网格（曲线离散化）
# - dim=2: 生成2D网格（包含1D）
# - dim=3: 生成3D网格（包含1D、2D）

gmsh.model.mesh.generate(2)
print("2D网格生成完成")

# ============================================
# 第9步：获取网格统计信息
# ============================================
# 获取节点
nodeTags, nodeCoords, _ = gmsh.model.mesh.getNodes()
numNodes = len(nodeTags)

# 获取元素
elemTypes, elemTags, _ = gmsh.model.mesh.getElements()
numElements = sum(len(tags) for tags in elemTags)

print(f"\n=== 网格统计 ===")
print(f"节点数量: {numNodes}")
print(f"元素数量: {numElements}")

# ============================================
# 第10步：保存网格文件
# ============================================
# 支持多种格式：.msh, .vtk, .stl, .mesh, .cgns, .med 等
gmsh.write("first_mesh.msh")
print("\n网格已保存到 first_mesh.msh")

# 同时保存VTK格式（可用ParaView查看）
gmsh.write("first_mesh.vtk")
print("网格已保存到 first_mesh.vtk")

# ============================================
# 第11步：可视化（可选）
# ============================================
# 取消下行注释以启动GUI查看网格
# gmsh.fltk.run()

# ============================================
# 第12步：清理资源
# ============================================
# finalize() 必须是最后调用的函数
gmsh.finalize()
print("\nGmsh已正确关闭")
```

## 运行结果

```
创建了4个点: 1, 2, 3, 4
创建了4条线: 1, 2, 3, 4
创建了曲线环: 1
创建了平面曲面: 1
几何同步完成
2D网格生成完成

=== 网格统计 ===
节点数量: 121
元素数量: 200

网格已保存到 first_mesh.msh
网格已保存到 first_mesh.vtk

Gmsh已正确关闭
```

## 代码详解

### 核心概念

1. **实体层次结构**
   ```
   点 (Point, 0D) → 线 (Line, 1D) → 曲线环 (CurveLoop) → 曲面 (Surface, 2D)
   ```

2. **标签系统 (Tag)**
   - 每个实体有唯一的正整数标签
   - 同维度实体标签不能重复
   - 可以自动分配（传入-1）或手动指定

3. **同步操作**
   - `synchronize()` 是关键步骤
   - 将几何内核的数据同步到Gmsh模型
   - 必须在网格生成前调用

### 工作流程图

```
初始化           定义几何                同步        网格生成      保存
  │                │                    │              │          │
  ▼                ▼                    ▼              ▼          ▼
initialize() → addPoint() → addLine() → synchronize() → generate() → write()
             → addCurveLoop()
             → addPlaneSurface()
```

## 改变网格尺寸

网格尺寸由点处的 `meshSize` 参数控制：

```python
# 细网格 (lc = 0.05)
lc = 0.05
gmsh.model.geo.addPoint(0, 0, 0, lc, 1)

# 粗网格 (lc = 0.2)
lc = 0.2
gmsh.model.geo.addPoint(0, 0, 0, lc, 1)
```

**不同网格尺寸效果对比**：

| lc值 | 节点数（约） | 元素数（约） | 效果 |
|------|------------|------------|------|
| 0.2  | 36         | 50         | 粗网格 |
| 0.1  | 121        | 200        | 中等 |
| 0.05 | 441        | 800        | 细网格 |
| 0.02 | 2601       | 5000       | 很细 |

## 使用OpenCASCADE内核

上面的例子使用了内置几何内核 (`geo`)。对于更复杂的几何，推荐使用OpenCASCADE内核 (`occ`)：

```python
import gmsh

gmsh.initialize()
gmsh.model.add("occ_example")

# 使用OCC内核直接创建矩形（一行代码！）
# addRectangle(x, y, z, dx, dy, tag=-1, roundedRadius=0)
gmsh.model.occ.addRectangle(0, 0, 0, 1, 1, 1)

# 同步OCC几何
gmsh.model.occ.synchronize()

# 生成网格
gmsh.model.mesh.generate(2)

gmsh.write("occ_rectangle.msh")
gmsh.finalize()
```

## 查看网格

### 方法1：使用Gmsh GUI

```python
# 在 gmsh.finalize() 之前添加
gmsh.fltk.run()
```

### 方法2：使用ParaView

```bash
# 打开VTK文件
paraview first_mesh.vtk
```

### 方法3：使用Python可视化

```python
import gmsh
import matplotlib.pyplot as plt
import numpy as np

gmsh.initialize()
gmsh.model.add("viz_example")
gmsh.model.occ.addRectangle(0, 0, 0, 1, 1)
gmsh.model.occ.synchronize()
gmsh.model.mesh.generate(2)

# 获取节点和三角形
_, coords, _ = gmsh.model.mesh.getNodes()
coords = np.array(coords).reshape(-1, 3)

elemTypes, _, nodeTagsPerElem = gmsh.model.mesh.getElements(2)  # dim=2
triangles = []
for i, elemType in enumerate(elemTypes):
    if elemType == 2:  # 三角形元素类型
        nodeTags = np.array(nodeTagsPerElem[i]).reshape(-1, 3) - 1
        triangles.extend(nodeTags)

gmsh.finalize()

# 绘制
plt.figure(figsize=(8, 8))
plt.triplot(coords[:, 0], coords[:, 1], triangles, 'b-', lw=0.5)
plt.axis('equal')
plt.title('2D Mesh Visualization')
plt.xlabel('X')
plt.ylabel('Y')
plt.savefig('mesh_plot.png', dpi=150)
plt.show()
```

## 练习

### 练习1：改变网格尺寸
修改 `lc` 值为 0.05，观察网格变化。

### 练习2：创建更大的矩形
将矩形改为 2x1 的尺寸。

### 练习3：使用自动标签
将所有 `tag` 参数改为 `-1`，让Gmsh自动分配标签。

```python
p1 = gmsh.model.geo.addPoint(0, 0, 0, lc)  # 自动分配tag
```

## 常见错误

### 错误1：忘记同步

```python
# 错误：没有调用 synchronize()
gmsh.model.geo.addPlaneSurface([1], 1)
gmsh.model.mesh.generate(2)  # 失败：几何未同步
```

**解决**：确保在 `generate()` 前调用 `synchronize()`

### 错误2：曲线环不闭合

```python
# 错误：曲线没有首尾相连
gmsh.model.geo.addCurveLoop([1, 2, 3], 1)  # 缺少第4条线
```

**解决**：确保曲线环中的曲线首尾相连

### 错误3：重复的标签

```python
# 错误：标签重复
gmsh.model.geo.addPoint(0, 0, 0, lc, 1)
gmsh.model.geo.addPoint(1, 0, 0, lc, 1)  # 错误：tag=1已存在
```

**解决**：使用不同的标签或使用 `-1` 自动分配

## 下一步

恭喜您完成了第一个Gmsh网格！接下来请阅读：
- [04-工作流程概览](./04-工作流程概览.md) - 深入理解Gmsh工作流程
