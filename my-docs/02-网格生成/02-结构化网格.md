# 结构化网格 (Transfinite)

Transfinite网格提供对网格节点分布的精确控制，生成结构化或半结构化网格。

## 什么是Transfinite网格？

```
非结构化网格              结构化(Transfinite)网格
┌─────────────┐          ┌─────────────┐
│ \  /\  / \  │          │ │ │ │ │ │ │ │
│  \/  \/   \ │          ├─┼─┼─┼─┼─┼─┼─┤
│  /\  /\    \│          │ │ │ │ │ │ │ │
│ /  \/  \  / │   vs     ├─┼─┼─┼─┼─┼─┼─┤
│/   /\   \/  │          │ │ │ │ │ │ │ │
└─────────────┘          └─────────────┘
  节点位置随机              节点排列规则
```

## Transfinite曲线

### 基本用法

```python
# setTransfiniteCurve(tag, numNodes, meshType="Progression", coef=1.0)
# tag: 曲线tag
# numNodes: 节点数量（包括端点）
# meshType: 节点分布类型
# coef: 分布系数

import gmsh

gmsh.initialize()
gmsh.model.add("transfinite_curve")

# 创建简单曲线
p1 = gmsh.model.geo.addPoint(0, 0, 0, 1)
p2 = gmsh.model.geo.addPoint(1, 0, 0, 1)
line = gmsh.model.geo.addLine(p1, p2)

gmsh.model.geo.synchronize()

# 设置曲线为Transfinite，10个节点
gmsh.model.mesh.setTransfiniteCurve(line, 10)

gmsh.model.mesh.generate(1)
gmsh.finalize()
```

### 节点分布类型

#### Progression（等比级数）

```python
# 从起点到终点按比例增加/减少间距
# coef > 1: 起点密，终点疏
# coef < 1: 起点疏，终点密
# coef = 1: 均匀分布

# 起点加密（coef=1.2）
gmsh.model.mesh.setTransfiniteCurve(line, 20, "Progression", 1.2)

# 终点加密（coef=0.8）
gmsh.model.mesh.setTransfiniteCurve(line, 20, "Progression", 0.8)

# 均匀分布（coef=1.0）
gmsh.model.mesh.setTransfiniteCurve(line, 20, "Progression", 1.0)
```

```
Progression (coef=1.2):
|--|---|-----|-------|---------|
  密                     疏

Progression (coef=0.8):
|---------|-------|-----|---|--|
  疏                     密
```

#### Bump（两端加密）

```python
# 两端密，中间疏
# coef: 控制中间部分的相对尺寸

gmsh.model.mesh.setTransfiniteCurve(line, 20, "Bump", 0.1)
```

```
Bump (coef=0.1):
|--|---|------|------|---|--|
密        疏       疏        密
```

#### Beta（双端不同加密）

```python
# 使用Beta分布控制
gmsh.model.mesh.setTransfiniteCurve(line, 20, "Beta", 1.5)
```

## Transfinite曲面

### 基本要求

1. 曲面必须有3或4条边界曲线
2. 相对边的节点数必须相等（4边情况）

```python
# setTransfiniteSurface(tag, arrangement="Left", cornerTags=[])
# tag: 曲面tag
# arrangement: 三角形排列方式
# cornerTags: 角点列表（可选）

gmsh.initialize()
gmsh.model.add("transfinite_surface")

# 创建矩形
p1 = gmsh.model.geo.addPoint(0, 0, 0, 1)
p2 = gmsh.model.geo.addPoint(2, 0, 0, 1)
p3 = gmsh.model.geo.addPoint(2, 1, 0, 1)
p4 = gmsh.model.geo.addPoint(0, 1, 0, 1)

l1 = gmsh.model.geo.addLine(p1, p2)  # 底边
l2 = gmsh.model.geo.addLine(p2, p3)  # 右边
l3 = gmsh.model.geo.addLine(p3, p4)  # 顶边
l4 = gmsh.model.geo.addLine(p4, p1)  # 左边

cl = gmsh.model.geo.addCurveLoop([l1, l2, l3, l4])
s = gmsh.model.geo.addPlaneSurface([cl])

gmsh.model.geo.synchronize()

# 设置曲线节点数（相对边节点数必须相等）
gmsh.model.mesh.setTransfiniteCurve(l1, 20)  # 底边
gmsh.model.mesh.setTransfiniteCurve(l3, 20)  # 顶边（与底边相同）
gmsh.model.mesh.setTransfiniteCurve(l2, 10)  # 右边
gmsh.model.mesh.setTransfiniteCurve(l4, 10)  # 左边（与右边相同）

# 设置曲面为Transfinite
gmsh.model.mesh.setTransfiniteSurface(s)

gmsh.model.mesh.generate(2)
gmsh.finalize()
```

### 三角形排列方式

```python
# "Left": 对角线从左下到右上
# "Right": 对角线从右下到左上
# "Alternate": 交替
# "AlternateLeft"
# "AlternateRight"

gmsh.model.mesh.setTransfiniteSurface(s, "Left")
```

```
Left:                Right:
┌─┬─┬─┐              ┌─┬─┬─┐
│/│/│/│              │\│\│\│
├─┼─┼─┤              ├─┼─┼─┤
│/│/│/│              │\│\│\│
└─┴─┴─┘              └─┴─┴─┘

Alternate:
┌─┬─┬─┐
│/│\│/│
├─┼─┼─┤
│\│/│\│
└─┴─┴─┘
```

### 指定角点

当边界有多于4个点时，需要指定哪些是角点：

```python
# 5个边界点的情况
gmsh.model.mesh.setTransfiniteSurface(s, "Left", [p1, p2, p3, p4])
```

## 四边形网格 (Recombine)

将三角形重组为四边形。

```python
# setRecombine(dim, tag)

# 设置Transfinite后重组为四边形
gmsh.model.mesh.setTransfiniteSurface(s)
gmsh.model.mesh.setRecombine(2, s)
```

```
三角形:              四边形:
┌─┬─┬─┐              ┌─┬─┬─┐
│/│/│/│              │ │ │ │
├─┼─┼─┤      ->      ├─┼─┼─┤
│/│/│/│              │ │ │ │
└─┴─┴─┘              └─┴─┴─┘
```

### 全局四边形设置

```python
# 全局启用四边形重组
gmsh.option.setNumber("Mesh.RecombineAll", 1)

# 四边形重组算法
gmsh.option.setNumber("Mesh.RecombinationAlgorithm", 1)
# 0: simple
# 1: blossom
# 2: simple full-quad
# 3: blossom full-quad
```

## Transfinite体积

### 基本要求

- 六面体：6个面，8个角点
- 棱柱：5个面（2个三角形+3个四边形），6个角点

```python
# setTransfiniteVolume(tag, cornerTags=[])

gmsh.initialize()
gmsh.model.add("transfinite_volume")

# 创建立方体（使用拉伸）
rect = gmsh.model.occ.addRectangle(0, 0, 0, 1, 1)
gmsh.model.occ.extrude([(2, rect)], 0, 0, 1, numElements=[10])
gmsh.model.occ.synchronize()

# 获取所有曲线和曲面
curves = gmsh.model.getEntities(1)
surfaces = gmsh.model.getEntities(2)
volumes = gmsh.model.getEntities(3)

# 设置所有曲线为Transfinite
for dim, tag in curves:
    # 根据曲线长度设置节点数
    length = gmsh.model.occ.getMass(1, tag)
    nodes = max(2, int(length * 10) + 1)
    gmsh.model.mesh.setTransfiniteCurve(tag, nodes)

# 设置所有曲面为Transfinite并重组
for dim, tag in surfaces:
    try:
        gmsh.model.mesh.setTransfiniteSurface(tag)
        gmsh.model.mesh.setRecombine(2, tag)
    except:
        pass  # 某些曲面可能不满足条件

# 设置体积为Transfinite
for dim, tag in volumes:
    try:
        gmsh.model.mesh.setTransfiniteVolume(tag)
    except:
        pass

gmsh.model.mesh.generate(3)
gmsh.write("transfinite_volume.msh")
gmsh.finalize()
```

## 自动Transfinite

Gmsh可以自动设置Transfinite约束。

```python
# setTransfiniteAutomatic(dimTags=[], cornerAngle=2.35, recombine=True)
# cornerAngle: 角点检测角度阈值（弧度）
# recombine: 是否自动重组为四边形/六面体

gmsh.model.mesh.setTransfiniteAutomatic()

# 只对特定实体
gmsh.model.mesh.setTransfiniteAutomatic([(2, 1), (2, 2)])
```

## 完整示例：结构化管道网格

```python
#!/usr/bin/env python3
"""
创建结构化的管道网格
"""
import gmsh
import math

gmsh.initialize()
gmsh.model.add("structured_pipe")

# 参数
R_inner = 0.5   # 内径
R_outer = 1.0   # 外径
length = 5.0    # 长度
n_radial = 10   # 径向节点数
n_circum = 32   # 周向节点数
n_axial = 50    # 轴向节点数

# 创建2D截面（1/4圆环，将通过旋转完成整圆）
# 内圆弧
p_inner_1 = gmsh.model.occ.addPoint(R_inner, 0, 0)
p_inner_2 = gmsh.model.occ.addPoint(0, R_inner, 0)
p_center = gmsh.model.occ.addPoint(0, 0, 0)
arc_inner = gmsh.model.occ.addCircleArc(p_inner_1, p_center, p_inner_2)

# 外圆弧
p_outer_1 = gmsh.model.occ.addPoint(R_outer, 0, 0)
p_outer_2 = gmsh.model.occ.addPoint(0, R_outer, 0)
arc_outer = gmsh.model.occ.addCircleArc(p_outer_1, p_center, p_outer_2)

# 连接线
line_1 = gmsh.model.occ.addLine(p_inner_1, p_outer_1)
line_2 = gmsh.model.occ.addLine(p_inner_2, p_outer_2)

# 创建曲面
loop = gmsh.model.occ.addCurveLoop([arc_inner, line_2, -arc_outer, -line_1])
section = gmsh.model.occ.addPlaneSurface([loop])

# 旋转拉伸创建完整环形截面
# 先同步以获取正确的实体
gmsh.model.occ.synchronize()

# 沿X轴拉伸
pipe = gmsh.model.occ.extrude([(2, section)], length, 0, 0)
gmsh.model.occ.synchronize()

# 设置结构化网格
curves = gmsh.model.getEntities(1)
for dim, tag in curves:
    length_curve = gmsh.model.occ.getMass(1, tag)
    # 根据曲线类型设置节点数
    if abs(length_curve - 2*math.pi*R_inner/4) < 0.01 or \
       abs(length_curve - 2*math.pi*R_outer/4) < 0.01:
        # 圆弧
        gmsh.model.mesh.setTransfiniteCurve(tag, n_circum // 4 + 1)
    elif abs(length_curve - (R_outer - R_inner)) < 0.01:
        # 径向线
        gmsh.model.mesh.setTransfiniteCurve(tag, n_radial)
    elif abs(length_curve - 5.0) < 0.01:
        # 轴向线
        gmsh.model.mesh.setTransfiniteCurve(tag, n_axial)
    else:
        gmsh.model.mesh.setTransfiniteCurve(tag, 10)

# 设置所有曲面为Transfinite
surfaces = gmsh.model.getEntities(2)
for dim, tag in surfaces:
    try:
        gmsh.model.mesh.setTransfiniteSurface(tag)
        gmsh.model.mesh.setRecombine(2, tag)
    except Exception as e:
        print(f"曲面{tag}无法设置Transfinite: {e}")

# 设置体积为Transfinite
volumes = gmsh.model.getEntities(3)
for dim, tag in volumes:
    try:
        gmsh.model.mesh.setTransfiniteVolume(tag)
    except Exception as e:
        print(f"体积{tag}无法设置Transfinite: {e}")

# 生成网格
gmsh.model.mesh.generate(3)

# 统计
nodes, _, _ = gmsh.model.mesh.getNodes()
print(f"节点数: {len(nodes)}")

gmsh.write("structured_pipe.msh")
gmsh.finalize()
```

## 常见问题

### Q1: Transfinite设置无效

**原因**：相对边节点数不相等
**解决**：确保四边形面的对边节点数相同

### Q2: 无法生成六面体

**原因**：体积不满足Transfinite条件（需要6个四边形面）
**解决**：确保所有面都是四边形，且满足拓扑要求

### Q3: 曲面有多于4条边

**原因**：Transfinite曲面只支持3或4条边
**解决**：使用复合曲线或重新设计几何

## 下一步

- [03-非结构化网格](./03-非结构化网格.md) - 学习自动网格生成算法
