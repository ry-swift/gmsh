# 边界层网格

边界层网格是CFD分析中捕捉壁面附近流动特征的关键技术。

## 边界层概念

```
壁面
════════════════════════════════════
║ │ │ │ │ │ │ │ │ │  第1层（最薄）
║───────────────────
║   │   │   │   │    第2层
║─────────────────────
║     │     │     │   第3层
║───────────────────────
║         │         │  第n层（最厚）
═══════════════════════════════════════
       流场主体
```

## BoundaryLayer场

### 基本用法

```python
import gmsh

gmsh.initialize()
gmsh.model.add("boundary_layer")

# 创建几何
rect = gmsh.model.occ.addRectangle(0, 0, 0, 10, 2)
gmsh.model.occ.synchronize()

# 假设壁面曲线为曲线1
wall_curves = [1, 3]  # 上下壁面

# 创建边界层场
bl = gmsh.model.mesh.field.add("BoundaryLayer")

# 设置边界层曲线
gmsh.model.mesh.field.setNumbers(bl, "CurvesList", wall_curves)

# 边界层参数
gmsh.model.mesh.field.setNumber(bl, "Size", 0.01)       # 第一层高度
gmsh.model.mesh.field.setNumber(bl, "Ratio", 1.2)       # 增长比
gmsh.model.mesh.field.setNumber(bl, "NbLayers", 10)     # 层数
gmsh.model.mesh.field.setNumber(bl, "Thickness", 0.5)   # 总厚度（可选）

# 设置为边界层场
gmsh.model.mesh.field.setAsBoundaryLayer(bl)

# 生成网格
gmsh.model.mesh.generate(2)
gmsh.write("boundary_layer.msh")
gmsh.finalize()
```

### BoundaryLayer参数

| 参数 | 描述 | 默认值 |
|-----|------|-------|
| CurvesList | 边界层曲线列表 | [] |
| PointsList | 边界层点列表（曲线端点） | [] |
| SurfacesList | 边界层曲面列表（3D） | [] |
| Size | 第一层高度 | 0.1 |
| Ratio | 层间增长比 | 1.1 |
| NbLayers | 层数 | 1 |
| Thickness | 总厚度（与NbLayers二选一） | - |
| AnisoMax | 最大各向异性比 | 1e10 |
| Quads | 生成四边形（1）还是三角形（0） | 0 |
| IntersectMetrics | 是否与背景场交叉 | 0 |

## 完整CFD边界层示例

```python
#!/usr/bin/env python3
"""
NACA翼型边界层网格
"""
import gmsh
import math

gmsh.initialize()
gmsh.model.add("naca_bl")

# NACA 0012 翼型函数
def naca0012(x):
    t = 0.12  # 厚度
    return 5*t*(0.2969*math.sqrt(x) - 0.1260*x - 0.3516*x**2 +
                0.2843*x**3 - 0.1015*x**4)

# 创建翼型点
n_points = 50
chord = 1.0
points_upper = []
points_lower = []

for i in range(n_points + 1):
    x = (1 - math.cos(i * math.pi / n_points)) / 2  # 余弦分布
    y = naca0012(x)
    points_upper.append(gmsh.model.occ.addPoint(x * chord, y * chord, 0))
    if 0 < i < n_points:
        points_lower.append(gmsh.model.occ.addPoint(x * chord, -y * chord, 0))

# 创建翼型曲线
spline_upper = gmsh.model.occ.addSpline(points_upper)
spline_lower = gmsh.model.occ.addSpline([points_upper[0]] + points_lower + [points_upper[-1]])

# 创建外部边界（远场）
far = 20 * chord
outer = gmsh.model.occ.addRectangle(-far, -far, 0, 2*far + chord, 2*far)

# 创建翼型区域
airfoil_loop = gmsh.model.occ.addCurveLoop([spline_upper, -spline_lower])
airfoil_surface = gmsh.model.occ.addPlaneSurface([airfoil_loop])

# 从外部减去翼型
gmsh.model.occ.cut([(2, outer)], [(2, airfoil_surface)], removeObject=True, removeTool=True)

gmsh.model.occ.synchronize()

# 获取翼型曲线
airfoil_curves = []
for curve in gmsh.model.getEntities(1):
    length = gmsh.model.occ.getMass(1, curve[1])
    if length < 2:  # 翼型曲线相对较短
        airfoil_curves.append(curve[1])

# 创建边界层
bl = gmsh.model.mesh.field.add("BoundaryLayer")
gmsh.model.mesh.field.setNumbers(bl, "CurvesList", airfoil_curves)
gmsh.model.mesh.field.setNumber(bl, "Size", 0.001)      # 第一层：0.001*chord
gmsh.model.mesh.field.setNumber(bl, "Ratio", 1.15)      # 增长比1.15
gmsh.model.mesh.field.setNumber(bl, "NbLayers", 20)     # 20层
gmsh.model.mesh.field.setNumber(bl, "Quads", 1)         # 四边形
gmsh.model.mesh.field.setAsBoundaryLayer(bl)

# 远场尺寸控制
f_dist = gmsh.model.mesh.field.add("Distance")
gmsh.model.mesh.field.setNumbers(f_dist, "CurvesList", airfoil_curves)

f_thresh = gmsh.model.mesh.field.add("Threshold")
gmsh.model.mesh.field.setNumber(f_thresh, "InField", f_dist)
gmsh.model.mesh.field.setNumber(f_thresh, "SizeMin", 0.02)
gmsh.model.mesh.field.setNumber(f_thresh, "SizeMax", 1.0)
gmsh.model.mesh.field.setNumber(f_thresh, "DistMin", 0.5)
gmsh.model.mesh.field.setNumber(f_thresh, "DistMax", 5.0)

gmsh.model.mesh.field.setAsBackgroundMesh(f_thresh)

# 网格选项
gmsh.option.setNumber("Mesh.MeshSizeFromPoints", 0)
gmsh.option.setNumber("Mesh.MeshSizeFromCurvature", 0)

# 生成网格
gmsh.model.mesh.generate(2)

# 统计
nodes, _, _ = gmsh.model.mesh.getNodes()
print(f"节点数: {len(nodes)}")

gmsh.write("naca_bl.msh")

# 可视化
# gmsh.fltk.run()

gmsh.finalize()
```

## 3D边界层

```python
# 3D边界层使用曲面列表
bl = gmsh.model.mesh.field.add("BoundaryLayer")
gmsh.model.mesh.field.setNumbers(bl, "SurfacesList", wall_surfaces)
gmsh.model.mesh.field.setNumber(bl, "Size", 0.001)
gmsh.model.mesh.field.setNumber(bl, "Ratio", 1.2)
gmsh.model.mesh.field.setNumber(bl, "NbLayers", 15)
gmsh.model.mesh.field.setAsBoundaryLayer(bl)
```

## 边界层质量检查

```python
# 检查边界层网格质量
qualities = gmsh.model.mesh.getElementQualities([], "minSJ")
print(f"最小质量: {min(qualities):.4f}")
print(f"平均质量: {sum(qualities)/len(qualities):.4f}")

# 边界层应该有较高的质量（接近1）
```

## 常见问题

### Q1: 边界层与主网格不连续
**解决**：检查CurvesList/SurfacesList是否正确

### Q2: 边界层在角点处重叠
**解决**：使用PointsList排除角点，或调整增长参数

### Q3: 边界层穿透几何
**解决**：减少层数或总厚度

## 下一步

- [07-高阶网格与优化](./07-高阶网格与优化.md) - 学习高阶元素和网格优化
