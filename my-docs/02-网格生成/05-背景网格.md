# 背景网格

背景网格允许使用现有网格或数据文件来控制新网格的尺寸分布。

## 背景网格概念

```
背景网格（带尺寸信息）
┌─────────────────────┐
│  0.1  0.1  0.05 0.05│     新几何
│  0.1  0.1  0.05 0.05│  ┌─────────┐
│  0.2  0.2  0.1  0.1 │ →│ 生成的   │
│  0.2  0.2  0.1  0.1 │  │ 网格     │
└─────────────────────┘  └─────────┘
    尺寸信息             尺寸由背景网格插值
```

## 使用POS文件作为背景网格

### POS文件格式

```
// view.pos
View "size" {
SP(x1, y1, z1){size1};
SP(x2, y2, z2){size2};
// ...
};
```

### 示例

```python
#!/usr/bin/env python3
"""
使用POS文件作为背景网格
"""
import gmsh

gmsh.initialize()
gmsh.model.add("background_mesh")

# 创建几何
gmsh.model.occ.addRectangle(0, 0, 0, 1, 1)
gmsh.model.occ.synchronize()

# 创建背景网格POS文件
with open("bgmesh.pos", "w") as f:
    f.write('View "size" {\n')
    for i in range(11):
        for j in range(11):
            x, y = i/10, j/10
            # 中心细，边缘粗
            dist = ((x-0.5)**2 + (y-0.5)**2)**0.5
            size = 0.02 + 0.08 * dist
            f.write(f"SP({x}, {y}, 0){{{size}}};\n")
    f.write("};\n")

# 合并背景网格
gmsh.merge("bgmesh.pos")

# 使用PostView场
f = gmsh.model.mesh.field.add("PostView")
gmsh.model.mesh.field.setNumber(f, "ViewIndex", 0)

gmsh.model.mesh.field.setAsBackgroundMesh(f)

# 禁用其他尺寸源
gmsh.option.setNumber("Mesh.MeshSizeFromPoints", 0)
gmsh.option.setNumber("Mesh.MeshSizeExtendFromBoundary", 0)

gmsh.model.mesh.generate(2)
gmsh.write("from_background.msh")
gmsh.finalize()
```

## 使用MSH文件作为背景网格

```python
# 加载包含尺寸信息的MSH文件
gmsh.merge("background.msh")

# 使用PostView场
view_tag = gmsh.view.getTags()[0]
f = gmsh.model.mesh.field.add("PostView")
gmsh.model.mesh.field.setNumber(f, "ViewTag", view_tag)
gmsh.model.mesh.field.setAsBackgroundMesh(f)
```

## 从现有网格提取尺寸

```python
#!/usr/bin/env python3
"""
从现有网格提取尺寸场
"""
import gmsh
import numpy as np

# 第一步：创建参考网格
gmsh.initialize()
gmsh.model.add("reference")
gmsh.model.occ.addDisk(0, 0, 0, 1, 1)
gmsh.model.occ.synchronize()
gmsh.option.setNumber("Mesh.MeshSizeMin", 0.02)
gmsh.option.setNumber("Mesh.MeshSizeMax", 0.2)
gmsh.option.setNumber("Mesh.MeshSizeFromCurvature", 20)
gmsh.model.mesh.generate(2)

# 获取节点和元素
node_tags, node_coords, _ = gmsh.model.mesh.getNodes()
node_coords = np.array(node_coords).reshape(-1, 3)

# 计算每个节点处的局部网格尺寸
elem_types, elem_tags, elem_nodes = gmsh.model.mesh.getElements(2)
node_sizes = {}

for elem_type, elem_tag_list, elem_node_list in zip(elem_types, elem_tags, elem_nodes):
    props = gmsh.model.mesh.getElementProperties(elem_type)
    num_nodes = props[3]
    elem_node_list = np.array(elem_node_list).reshape(-1, num_nodes)

    for nodes in elem_node_list:
        # 计算元素平均边长
        coords = node_coords[nodes.astype(int) - 1]
        edges = []
        for i in range(len(coords)):
            for j in range(i+1, len(coords)):
                edges.append(np.linalg.norm(coords[i] - coords[j]))
        avg_size = np.mean(edges)

        for n in nodes:
            if n not in node_sizes:
                node_sizes[n] = []
            node_sizes[n].append(avg_size)

# 平均尺寸
final_sizes = {n: np.mean(s) for n, s in node_sizes.items()}

# 创建POS文件
with open("extracted_size.pos", "w") as f:
    f.write('View "size" {\n')
    for tag, size in final_sizes.items():
        idx = np.where(node_tags == tag)[0][0]
        x, y, z = node_coords[idx]
        f.write(f"SP({x}, {y}, {z}){{{size}}};\n")
    f.write("};\n")

gmsh.finalize()

# 第二步：使用提取的尺寸
gmsh.initialize()
gmsh.model.add("new_mesh")
gmsh.model.occ.addRectangle(-0.5, -0.5, 0, 2, 2)  # 不同几何
gmsh.model.occ.synchronize()

gmsh.merge("extracted_size.pos")

f = gmsh.model.mesh.field.add("PostView")
gmsh.model.mesh.field.setNumber(f, "ViewIndex", 0)
gmsh.model.mesh.field.setAsBackgroundMesh(f)

gmsh.option.setNumber("Mesh.MeshSizeFromPoints", 0)
gmsh.option.setNumber("Mesh.MeshSizeExtendFromBoundary", 0)

gmsh.model.mesh.generate(2)
gmsh.write("new_with_bg.msh")
gmsh.finalize()
```

## 编程创建背景数据

### 使用View API

```python
# 创建数据视图
view_tag = gmsh.view.add("size_field")

# 添加点数据
data = []
for i in range(10):
    for j in range(10):
        x, y = i/9, j/9
        size = 0.02 + 0.08 * ((x-0.5)**2 + (y-0.5)**2)**0.5
        data.extend([x, y, 0, size])  # x, y, z, value

gmsh.view.addListData(view_tag, "SP", len(data)//4, data)

# 使用为背景场
f = gmsh.model.mesh.field.add("PostView")
gmsh.model.mesh.field.setNumber(f, "ViewTag", view_tag)
gmsh.model.mesh.field.setAsBackgroundMesh(f)
```

## 各向异性背景网格

对于各向异性网格，背景数据需要包含张量信息：

```python
# 各向异性尺寸需要3x3张量（2D情况为主方向和两个尺寸）
# 使用Tensor格式的POS数据

# 示例：ST (Scalar Triangle) 或 TT (Tensor Triangle)
```

## 下一步

- [06-边界层网格](./06-边界层网格.md) - 学习边界层网格生成
