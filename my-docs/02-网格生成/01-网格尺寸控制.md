# 网格尺寸控制

网格尺寸控制是生成高质量网格的关键。本文档介绍Gmsh中控制网格尺寸的各种方法。

## 尺寸控制概述

Gmsh提供多层次的网格尺寸控制：

```
优先级（从高到低）：
1. 全局最小/最大尺寸限制
2. 尺寸场 (Fields)
3. 曲率自适应
4. 点尺寸
5. 默认尺寸
```

## 点尺寸 (Point Size)

最基本的尺寸控制方式，在创建点时指定。

```python
import gmsh

gmsh.initialize()
gmsh.model.add("point_size")

# 在创建点时指定网格尺寸
# addPoint(x, y, z, meshSize, tag)
p1 = gmsh.model.geo.addPoint(0, 0, 0, 0.1)    # 尺寸0.1
p2 = gmsh.model.geo.addPoint(1, 0, 0, 0.05)   # 尺寸0.05（更细）
p3 = gmsh.model.geo.addPoint(1, 1, 0, 0.2)    # 尺寸0.2（更粗）
p4 = gmsh.model.geo.addPoint(0, 1, 0, 0.1)    # 尺寸0.1

# 使用OCC内核
# gmsh.model.occ.addPoint(x, y, z, meshSize, tag)

gmsh.model.geo.synchronize()
gmsh.finalize()
```

### 网格尺寸继承

网格尺寸从点向曲线、曲面传播：

```
点尺寸 → 曲线网格 → 曲面网格 → 体积网格
```

## 全局尺寸选项

### 最小和最大尺寸

```python
# 设置全局最小网格尺寸
gmsh.option.setNumber("Mesh.MeshSizeMin", 0.01)

# 设置全局最大网格尺寸
gmsh.option.setNumber("Mesh.MeshSizeMax", 1.0)

# 最终尺寸会被限制在 [MeshSizeMin, MeshSizeMax] 范围内
```

### 全局缩放因子

```python
# 所有尺寸乘以此因子
gmsh.option.setNumber("Mesh.MeshSizeFactor", 0.5)  # 细化一倍

# 最终尺寸 = 计算尺寸 × MeshSizeFactor
```

### 尺寸来源控制

```python
# 是否使用点尺寸
gmsh.option.setNumber("Mesh.MeshSizeFromPoints", 1)  # 1=使用, 0=忽略

# 尺寸是否从边界向内部扩展
gmsh.option.setNumber("Mesh.MeshSizeExtendFromBoundary", 1)
# 0: 不扩展
# 1: 1D边界向2D扩展
# 2: 2D边界向3D扩展
```

## 基于曲率的尺寸

根据几何曲率自动调整网格尺寸。

```python
# 设置每2π弧度的最少单元数
gmsh.option.setNumber("Mesh.MeshSizeFromCurvature", 20)

# 值越大，曲率大的地方网格越细
# 0表示禁用曲率自适应
```

### 曲率控制示例

```python
import gmsh

gmsh.initialize()
gmsh.model.add("curvature_example")

# 创建有曲率变化的几何
gmsh.model.occ.addSphere(0, 0, 0, 1)
gmsh.model.occ.synchronize()

# 启用曲率自适应
gmsh.option.setNumber("Mesh.MeshSizeFromCurvature", 30)
gmsh.option.setNumber("Mesh.MeshSizeMin", 0.01)
gmsh.option.setNumber("Mesh.MeshSizeMax", 0.3)

gmsh.model.mesh.generate(2)
gmsh.write("sphere_curvature.msh")
gmsh.finalize()
```

## 实体尺寸约束

使用`setSize`函数为特定实体设置尺寸。

```python
# setSize(dimTags, size)
# 为指定实体设置网格尺寸

# 为特定点设置尺寸
gmsh.model.mesh.setSize([(0, 1), (0, 2)], 0.05)

# 为所有点设置尺寸
points = gmsh.model.getEntities(0)
gmsh.model.mesh.setSize(points, 0.1)
```

## 尺寸场 (Fields) - 最灵活的方式

尺寸场提供空间变化的网格尺寸控制。详见[04-网格尺寸场](./04-网格尺寸场.md)。

```python
# 快速示例：距离场+阈值场
f1 = gmsh.model.mesh.field.add("Distance")
gmsh.model.mesh.field.setNumbers(f1, "CurvesList", [1, 2])

f2 = gmsh.model.mesh.field.add("Threshold")
gmsh.model.mesh.field.setNumber(f2, "InField", f1)
gmsh.model.mesh.field.setNumber(f2, "SizeMin", 0.01)
gmsh.model.mesh.field.setNumber(f2, "SizeMax", 0.1)
gmsh.model.mesh.field.setNumber(f2, "DistMin", 0.05)
gmsh.model.mesh.field.setNumber(f2, "DistMax", 0.3)

gmsh.model.mesh.field.setAsBackgroundMesh(f2)
```

## 尺寸计算公式

最终网格尺寸的计算：

```
size = clamp(computed_size, MeshSizeMin, MeshSizeMax) × MeshSizeFactor

其中 computed_size 取决于：
- 点尺寸（如果 MeshSizeFromPoints=1）
- 曲率尺寸（如果 MeshSizeFromCurvature>0）
- 尺寸场（如果设置了背景场）
- 边界扩展（如果 MeshSizeExtendFromBoundary>0）
```

## 禁用默认尺寸源

使用尺寸场时，通常需要禁用其他尺寸源：

```python
# 禁用点尺寸
gmsh.option.setNumber("Mesh.MeshSizeFromPoints", 0)

# 禁用曲率尺寸
gmsh.option.setNumber("Mesh.MeshSizeFromCurvature", 0)

# 禁用边界扩展
gmsh.option.setNumber("Mesh.MeshSizeExtendFromBoundary", 0)

# 现在只有尺寸场生效
```

## 完整示例：局部加密

```python
#!/usr/bin/env python3
"""
在特定区域局部加密网格
"""
import gmsh

gmsh.initialize()
gmsh.model.add("local_refinement")

# 创建带孔板
plate = gmsh.model.occ.addRectangle(0, 0, 0, 10, 10)
hole = gmsh.model.occ.addDisk(5, 5, 0, 1, 1)
gmsh.model.occ.cut([(2, plate)], [(2, hole)])
gmsh.model.occ.synchronize()

# 获取孔的边界曲线
hole_curves = []
for curve in gmsh.model.getEntities(1):
    com = gmsh.model.occ.getCenterOfMass(1, curve[1])
    dist = ((com[0]-5)**2 + (com[1]-5)**2)**0.5
    if dist < 1.5:
        hole_curves.append(curve[1])

# 创建距离场
f_dist = gmsh.model.mesh.field.add("Distance")
gmsh.model.mesh.field.setNumbers(f_dist, "CurvesList", hole_curves)

# 创建阈值场
f_thresh = gmsh.model.mesh.field.add("Threshold")
gmsh.model.mesh.field.setNumber(f_thresh, "InField", f_dist)
gmsh.model.mesh.field.setNumber(f_thresh, "SizeMin", 0.05)   # 孔附近细
gmsh.model.mesh.field.setNumber(f_thresh, "SizeMax", 0.5)    # 远处粗
gmsh.model.mesh.field.setNumber(f_thresh, "DistMin", 0.2)    # 开始过渡的距离
gmsh.model.mesh.field.setNumber(f_thresh, "DistMax", 2.0)    # 结束过渡的距离

# 设置为背景场
gmsh.model.mesh.field.setAsBackgroundMesh(f_thresh)

# 禁用其他尺寸源
gmsh.option.setNumber("Mesh.MeshSizeFromPoints", 0)
gmsh.option.setNumber("Mesh.MeshSizeFromCurvature", 0)
gmsh.option.setNumber("Mesh.MeshSizeExtendFromBoundary", 0)

# 生成网格
gmsh.model.mesh.generate(2)

# 统计
nodes, _, _ = gmsh.model.mesh.getNodes()
print(f"节点数: {len(nodes)}")

gmsh.write("local_refinement.msh")
gmsh.finalize()
```

## 常用尺寸设置模板

### 均匀网格

```python
lc = 0.1
gmsh.option.setNumber("Mesh.MeshSizeMin", lc)
gmsh.option.setNumber("Mesh.MeshSizeMax", lc)
```

### 曲率自适应

```python
gmsh.option.setNumber("Mesh.MeshSizeFromCurvature", 30)
gmsh.option.setNumber("Mesh.MeshSizeMin", 0.01)
gmsh.option.setNumber("Mesh.MeshSizeMax", 0.5)
```

### 边界层细化

```python
# 边界细，内部粗
gmsh.option.setNumber("Mesh.MeshSizeExtendFromBoundary", 1)
# 在边界点设置小尺寸，内部自动变粗
```

## 下一步

- [02-结构化网格](./02-结构化网格.md) - 学习Transfinite结构化网格
