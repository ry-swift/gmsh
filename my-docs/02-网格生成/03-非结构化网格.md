# 非结构化网格

非结构化网格是Gmsh的默认网格类型，能自动适应复杂几何。

## 网格生成基础

### 生成网格

```python
import gmsh

gmsh.initialize()
gmsh.model.add("unstructured")

# 创建几何
gmsh.model.occ.addSphere(0, 0, 0, 1)
gmsh.model.occ.synchronize()

# 生成网格
gmsh.model.mesh.generate(3)  # 3D网格

# 或分步生成
gmsh.model.mesh.generate(1)  # 先1D（曲线）
gmsh.model.mesh.generate(2)  # 再2D（曲面）
gmsh.model.mesh.generate(3)  # 最后3D（体积）

gmsh.finalize()
```

### 维度含义

| 维度 | 含义 | 元素类型 |
|-----|------|---------|
| 1 | 1D网格 | 线段 |
| 2 | 2D网格 | 三角形、四边形 |
| 3 | 3D网格 | 四面体、六面体、棱柱、金字塔 |

## 2D网格算法

### 算法选项

```python
# Mesh.Algorithm: 2D网格算法
gmsh.option.setNumber("Mesh.Algorithm", value)
```

| 值 | 名称 | 描述 |
|---|------|------|
| 1 | MeshAdapt | 自适应算法 |
| 2 | Automatic | 自动选择（默认） |
| 5 | Delaunay | Delaunay三角化 |
| 6 | Frontal-Delaunay | 前沿Delaunay（推荐） |
| 7 | BAMG | 各向异性自适应 |
| 8 | Frontal-Delaunay for Quads | 四边形前沿 |
| 9 | Packing of Parallelograms | 平行四边形填充 |
| 11 | Quasi-structured Quad | 准结构化四边形 |

### 推荐算法

```python
# 一般情况：Frontal-Delaunay
gmsh.option.setNumber("Mesh.Algorithm", 6)

# 各向异性网格：BAMG
gmsh.option.setNumber("Mesh.Algorithm", 7)

# 四边形为主
gmsh.option.setNumber("Mesh.Algorithm", 8)
```

## 3D网格算法

### 算法选项

```python
# Mesh.Algorithm3D: 3D网格算法
gmsh.option.setNumber("Mesh.Algorithm3D", value)
```

| 值 | 名称 | 描述 |
|---|------|------|
| 1 | Delaunay | Delaunay四面体化（默认） |
| 4 | Frontal | 前沿算法 |
| 7 | MMG3D | MMG3D优化 |
| 9 | R-tree | R-tree优化 |
| 10 | HXT | 高性能并行（推荐大模型） |

### 推荐算法

```python
# 一般情况
gmsh.option.setNumber("Mesh.Algorithm3D", 1)

# 大型模型，并行
gmsh.option.setNumber("Mesh.Algorithm3D", 10)  # HXT
gmsh.option.setNumber("General.NumThreads", 8)  # 8线程

# 需要优化质量
gmsh.option.setNumber("Mesh.Algorithm3D", 4)  # Frontal
```

## 元素类型

### 2D元素

```python
# 默认：三角形
# 启用四边形重组
gmsh.option.setNumber("Mesh.RecombineAll", 1)

# 四边形算法
gmsh.option.setNumber("Mesh.RecombinationAlgorithm", 1)  # blossom
```

### 3D元素

```python
# 默认：四面体
# 启用六面体（需要满足条件）
gmsh.option.setNumber("Mesh.Recombine3DAll", 1)

# 3D细分算法
gmsh.option.setNumber("Mesh.SubdivisionAlgorithm", 2)
# 0: none
# 1: all quads
# 2: all hexas (subdivides tets into 4 hexas)
```

## 网格优化

### 内置优化

```python
# optimize(method="", force=False, dimTags=[])

# 使用Netgen优化（推荐）
gmsh.model.mesh.optimize("Netgen")

# 使用Laplace平滑
gmsh.model.mesh.optimize("Laplace2D")

# 高阶网格优化
gmsh.model.mesh.optimize("HighOrder")

# 优化特定实体
gmsh.model.mesh.optimize("Netgen", dimTags=[(3, 1)])
```

### 优化选项

```python
# 优化步数
gmsh.option.setNumber("Mesh.OptimizeNetgen", 1)

# 质量阈值
gmsh.option.setNumber("Mesh.OptimizeThreshold", 0.3)

# Lloyd平滑迭代次数
gmsh.option.setNumber("Mesh.Lloyd", 10)
```

## 网格细化

### 均匀细化

```python
# refine()
# 将每个元素细分

gmsh.model.mesh.generate(2)
gmsh.model.mesh.refine()  # 细化一次
gmsh.model.mesh.refine()  # 再细化一次
```

### 局部细化

使用尺寸场实现局部细化（见[04-网格尺寸场](./04-网格尺寸场.md)）。

## 高阶元素

### 改变元素阶数

```python
# setOrder(order)
# order=1: 线性元素
# order=2: 二次元素
# order=3: 三次元素...

gmsh.model.mesh.generate(3)
gmsh.model.mesh.setOrder(2)  # 转为二次元素
```

### 高阶元素选项

```python
# 高阶元素类型
gmsh.option.setNumber("Mesh.ElementOrder", 2)

# 高阶节点分布
gmsh.option.setNumber("Mesh.SecondOrderLinear", 0)  # 0=曲面上, 1=线性

# 不完整高阶元素（减少节点）
gmsh.option.setNumber("Mesh.SecondOrderIncomplete", 1)
```

## 网格质量

### 获取元素质量

```python
# getElementQualities(elementTags=[], qualityName="minSJ")
# qualityName: "minSJ", "minSICN", "minSIGE", "gamma", "eta"

qualities = gmsh.model.mesh.getElementQualities([], "minSJ")
# minSJ: 最小缩放Jacobian [-1, 1]，越接近1越好
```

### 质量统计

```python
import numpy as np

qualities = gmsh.model.mesh.getElementQualities([], "minSJ")
qualities = np.array(qualities)

print(f"最小质量: {qualities.min():.4f}")
print(f"最大质量: {qualities.max():.4f}")
print(f"平均质量: {qualities.mean():.4f}")
print(f"质量<0.3的元素: {np.sum(qualities < 0.3)}")
```

## 完整示例

```python
#!/usr/bin/env python3
"""
非结构化网格生成完整示例
"""
import gmsh

gmsh.initialize()
gmsh.model.add("unstructured_demo")

# 创建复杂几何
box = gmsh.model.occ.addBox(0, 0, 0, 2, 2, 2)
sphere = gmsh.model.occ.addSphere(1, 1, 1, 0.5)
cyl = gmsh.model.occ.addCylinder(1, 1, 0, 0, 0, 2, 0.3)

# 布尔运算
gmsh.model.occ.cut([(3, box)], [(3, sphere), (3, cyl)])
gmsh.model.occ.synchronize()

# 网格设置
gmsh.option.setNumber("Mesh.Algorithm", 6)       # Frontal-Delaunay 2D
gmsh.option.setNumber("Mesh.Algorithm3D", 10)    # HXT 3D
gmsh.option.setNumber("Mesh.MeshSizeMin", 0.05)
gmsh.option.setNumber("Mesh.MeshSizeMax", 0.2)
gmsh.option.setNumber("Mesh.MeshSizeFromCurvature", 20)

# 生成网格
gmsh.model.mesh.generate(3)

# 优化
gmsh.model.mesh.optimize("Netgen")

# 质量统计
qualities = gmsh.model.mesh.getElementQualities([], "minSJ")
print(f"元素数: {len(qualities)}")
print(f"最小质量: {min(qualities):.4f}")
print(f"平均质量: {sum(qualities)/len(qualities):.4f}")

# 保存
gmsh.write("unstructured_demo.msh")

gmsh.finalize()
```

## 下一步

- [04-网格尺寸场](./04-网格尺寸场.md) - 学习灵活的尺寸控制
