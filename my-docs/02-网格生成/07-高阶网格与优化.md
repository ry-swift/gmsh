# 高阶网格与优化

高阶元素在有限元分析中提供更高的精度，网格优化则改善元素质量。

## 高阶元素基础

### 元素阶数

```
线性（1阶）       二次（2阶）       三次（3阶）
    •───────•       •────●────•       •──●──●──•
    2节点          3节点            4节点

三角形:
    •               •               •
   / \             / \             /|\
  /   \           ●   ●           ● ● ●
 /     \         /     \         /  |  \
•───────•       •───●───•       •──●─●──•
3节点           6节点           10节点
```

### 设置元素阶数

```python
import gmsh

gmsh.initialize()
gmsh.model.add("high_order")

# 创建几何
gmsh.model.occ.addSphere(0, 0, 0, 1)
gmsh.model.occ.synchronize()

# 方法1：先生成网格，再提升阶数
gmsh.model.mesh.generate(3)
gmsh.model.mesh.setOrder(2)  # 转为二阶元素

# 方法2：生成前设置阶数
gmsh.option.setNumber("Mesh.ElementOrder", 2)
gmsh.model.mesh.generate(3)

gmsh.finalize()
```

### 高阶元素选项

```python
# 元素阶数
gmsh.option.setNumber("Mesh.ElementOrder", 2)

# 高阶节点分布
# 0: 在曲面上（曲边元素）
# 1: 线性分布
gmsh.option.setNumber("Mesh.SecondOrderLinear", 0)

# 不完整高阶元素（减少节点数）
# 0: 完整
# 1: 不完整（如20节点六面体代替27节点）
gmsh.option.setNumber("Mesh.SecondOrderIncomplete", 0)

# 高阶优化
gmsh.option.setNumber("Mesh.HighOrderOptimize", 1)

# 高阶优化器
# 0: none
# 1: optimization
# 2: elastic+optimization
# 3: elastic
# 4: fast curving
gmsh.option.setNumber("Mesh.HighOrderOptimize", 2)
```

## 曲边元素

高阶元素可以更好地表示曲面几何：

```python
# 启用曲边元素
gmsh.option.setNumber("Mesh.SecondOrderLinear", 0)

# 曲边元素精度
gmsh.option.setNumber("Mesh.HighOrderThresholdMin", 0.8)
gmsh.option.setNumber("Mesh.HighOrderThresholdMax", 2.0)
```

## 网格优化

### 内置优化器

```python
# optimize(method="", force=False, dimTags=[])

# Netgen优化（3D四面体）
gmsh.model.mesh.optimize("Netgen")

# Laplace平滑（2D）
gmsh.model.mesh.optimize("Laplace2D")

# 高阶优化
gmsh.model.mesh.optimize("HighOrder")

# 高阶弹性优化
gmsh.model.mesh.optimize("HighOrderElastic")

# 多轮优化
for _ in range(3):
    gmsh.model.mesh.optimize("Netgen")
```

### 优化选项

```python
# Netgen优化级别
gmsh.option.setNumber("Mesh.OptimizeNetgen", 1)

# 优化阈值
gmsh.option.setNumber("Mesh.OptimizeThreshold", 0.3)

# Lloyd平滑迭代次数
gmsh.option.setNumber("Mesh.Lloyd", 10)

# 重定位优化
gmsh.option.setNumber("Mesh.Smoothing", 10)
```

## 网格质量评估

### 质量指标

```python
# getElementQualities(elementTags=[], qualityName="minSJ")

# minSJ: 最小缩放Jacobian [-1, 1]
qualities = gmsh.model.mesh.getElementQualities([], "minSJ")

# minSICN: 最小缩放条件数反
qualities = gmsh.model.mesh.getElementQualities([], "minSICN")

# minSIGE: 最小缩放等效应变
qualities = gmsh.model.mesh.getElementQualities([], "minSIGE")

# gamma: 形状正则性
qualities = gmsh.model.mesh.getElementQualities([], "gamma")
```

### 质量统计

```python
import numpy as np

def print_quality_stats(qualities, name="Quality"):
    q = np.array(qualities)
    print(f"\n{name} Statistics:")
    print(f"  Min:  {q.min():.4f}")
    print(f"  Max:  {q.max():.4f}")
    print(f"  Mean: {q.mean():.4f}")
    print(f"  Std:  {q.std():.4f}")
    print(f"  Elements with quality < 0.1: {np.sum(q < 0.1)}")
    print(f"  Elements with quality < 0.3: {np.sum(q < 0.3)}")

qualities = gmsh.model.mesh.getElementQualities([], "minSJ")
print_quality_stats(qualities, "minSJ")
```

## 完整示例：高阶优化网格

```python
#!/usr/bin/env python3
"""
高阶网格生成与优化
"""
import gmsh
import numpy as np

gmsh.initialize()
gmsh.model.add("high_order_opt")

# 创建复杂几何
box = gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1)
sphere = gmsh.model.occ.addSphere(0.5, 0.5, 0.5, 0.3)
gmsh.model.occ.cut([(3, box)], [(3, sphere)])
gmsh.model.occ.synchronize()

# 网格尺寸设置
gmsh.option.setNumber("Mesh.MeshSizeMin", 0.05)
gmsh.option.setNumber("Mesh.MeshSizeMax", 0.15)
gmsh.option.setNumber("Mesh.MeshSizeFromCurvature", 20)

# 生成线性网格
print("生成线性网格...")
gmsh.model.mesh.generate(3)

# 检查线性网格质量
q1 = gmsh.model.mesh.getElementQualities([], "minSJ")
print(f"线性网格 - 元素数: {len(q1)}, 最小质量: {min(q1):.4f}")

# 优化线性网格
print("优化线性网格...")
gmsh.model.mesh.optimize("Netgen")

q2 = gmsh.model.mesh.getElementQualities([], "minSJ")
print(f"优化后 - 最小质量: {min(q2):.4f}")

# 转换为二阶元素
print("转换为二阶元素...")
gmsh.model.mesh.setOrder(2)

# 检查高阶网格质量
q3 = gmsh.model.mesh.getElementQualities([], "minSJ")
print(f"二阶转换后 - 最小质量: {min(q3):.4f}")

# 高阶优化
print("高阶优化...")
gmsh.model.mesh.optimize("HighOrderElastic")

q4 = gmsh.model.mesh.getElementQualities([], "minSJ")
print(f"高阶优化后 - 最小质量: {min(q4):.4f}")

# 保存
gmsh.write("high_order.msh")

# 详细统计
print("\n最终网格质量统计:")
q = np.array(q4)
print(f"  节点数: {len(gmsh.model.mesh.getNodes()[0])}")
print(f"  元素数: {len(q)}")
print(f"  质量范围: [{q.min():.4f}, {q.max():.4f}]")
print(f"  平均质量: {q.mean():.4f}")

gmsh.finalize()
```

## 自适应网格细化

```python
# 基于误差估计的自适应细化
def adaptive_refine(error_field, threshold):
    """
    error_field: 包含误差值的视图
    threshold: 细化阈值
    """
    # 获取需要细化的元素
    # 根据误差场细化
    pass

# 简单的均匀细化
gmsh.model.mesh.refine()
```

## 网格分区

```python
# partition(numParts, method="metis", elementTags=[])
# 用于并行计算的网格分区

gmsh.model.mesh.partition(4)  # 分为4个部分

# 分区方法
gmsh.option.setNumber("Mesh.PartitionAlgorithm", 1)
# 1: METIS
# 2: Simple
```

## 质量要求参考

| 应用 | 推荐最小质量(minSJ) |
|-----|-------------------|
| CFD边界层 | > 0.5 |
| 结构力学 | > 0.3 |
| 热传导 | > 0.2 |
| 电磁场 | > 0.3 |

## 下一步

完成网格生成学习后，请继续：
- [03-高级几何建模](../03-高级几何建模/01-曲线类型详解.md) - 学习高级几何建模技术
