# 网格尺寸场 (Mesh Size Fields)

尺寸场是Gmsh中最灵活的网格尺寸控制方式，允许定义空间变化的尺寸函数。

## 尺寸场基础

### 创建和管理尺寸场

```python
import gmsh

gmsh.initialize()
gmsh.model.add("fields")

# 添加尺寸场
field_id = gmsh.model.mesh.field.add("FieldType")

# 设置场参数
gmsh.model.mesh.field.setNumber(field_id, "ParamName", value)
gmsh.model.mesh.field.setString(field_id, "ParamName", "value")
gmsh.model.mesh.field.setNumbers(field_id, "ParamName", [v1, v2, v3])

# 获取场参数
value = gmsh.model.mesh.field.getNumber(field_id, "ParamName")

# 删除尺寸场
gmsh.model.mesh.field.remove(field_id)

# 设置为背景场
gmsh.model.mesh.field.setAsBackgroundMesh(field_id)

gmsh.finalize()
```

## 常用尺寸场类型

### Distance（距离场）

返回到指定实体的距离。

```python
# 创建距离场
f = gmsh.model.mesh.field.add("Distance")

# 设置参考实体
gmsh.model.mesh.field.setNumbers(f, "PointsList", [1, 2, 3])
gmsh.model.mesh.field.setNumbers(f, "CurvesList", [1, 2])
gmsh.model.mesh.field.setNumbers(f, "SurfacesList", [1])

# 采样精度（曲线/曲面）
gmsh.model.mesh.field.setNumber(f, "Sampling", 100)
```

### Threshold（阈值场）

基于另一个场创建尺寸梯度。

```python
# 创建阈值场
f = gmsh.model.mesh.field.add("Threshold")
gmsh.model.mesh.field.setNumber(f, "InField", distance_field)

# 尺寸范围
gmsh.model.mesh.field.setNumber(f, "SizeMin", 0.01)   # 最小尺寸
gmsh.model.mesh.field.setNumber(f, "SizeMax", 0.1)    # 最大尺寸

# 距离范围
gmsh.model.mesh.field.setNumber(f, "DistMin", 0.05)   # 开始过渡的距离
gmsh.model.mesh.field.setNumber(f, "DistMax", 0.5)    # 结束过渡的距离

# 插值方式
gmsh.model.mesh.field.setNumber(f, "Sigmoid", 0)  # 0=线性, 1=sigmoid
```

```
尺寸
  ^
  |     SizeMax ─────────────────────
  |              \
  |               \  过渡区
  |                \
  |     SizeMin ────\────────────────
  └──────────────────────────────> 距离
         DistMin  DistMax
```

### MathEval（数学表达式场）

用数学表达式定义尺寸。

```python
f = gmsh.model.mesh.field.add("MathEval")
gmsh.model.mesh.field.setString(f, "F", "0.1 + 0.05*sin(10*x)*cos(10*y)")

# 可用变量：x, y, z
# 可用函数：sin, cos, tan, exp, log, sqrt, abs, etc.
```

### Box（立方体场）

在立方体区域内外使用不同尺寸。

```python
f = gmsh.model.mesh.field.add("Box")
gmsh.model.mesh.field.setNumber(f, "VIn", 0.02)     # 内部尺寸
gmsh.model.mesh.field.setNumber(f, "VOut", 0.1)    # 外部尺寸
gmsh.model.mesh.field.setNumber(f, "XMin", 0.3)
gmsh.model.mesh.field.setNumber(f, "XMax", 0.7)
gmsh.model.mesh.field.setNumber(f, "YMin", 0.3)
gmsh.model.mesh.field.setNumber(f, "YMax", 0.7)
gmsh.model.mesh.field.setNumber(f, "ZMin", 0)
gmsh.model.mesh.field.setNumber(f, "ZMax", 1)
gmsh.model.mesh.field.setNumber(f, "Thickness", 0.1)  # 过渡厚度
```

### Ball（球形场）

在球形区域内外使用不同尺寸。

```python
f = gmsh.model.mesh.field.add("Ball")
gmsh.model.mesh.field.setNumber(f, "VIn", 0.02)
gmsh.model.mesh.field.setNumber(f, "VOut", 0.1)
gmsh.model.mesh.field.setNumber(f, "XCenter", 0.5)
gmsh.model.mesh.field.setNumber(f, "YCenter", 0.5)
gmsh.model.mesh.field.setNumber(f, "ZCenter", 0.5)
gmsh.model.mesh.field.setNumber(f, "Radius", 0.3)
gmsh.model.mesh.field.setNumber(f, "Thickness", 0.1)
```

### Cylinder（圆柱场）

在圆柱形区域内外使用不同尺寸。

```python
f = gmsh.model.mesh.field.add("Cylinder")
gmsh.model.mesh.field.setNumber(f, "VIn", 0.02)
gmsh.model.mesh.field.setNumber(f, "VOut", 0.1)
gmsh.model.mesh.field.setNumber(f, "XCenter", 0)
gmsh.model.mesh.field.setNumber(f, "YCenter", 0)
gmsh.model.mesh.field.setNumber(f, "ZCenter", 0)
gmsh.model.mesh.field.setNumber(f, "XAxis", 1)
gmsh.model.mesh.field.setNumber(f, "YAxis", 0)
gmsh.model.mesh.field.setNumber(f, "ZAxis", 0)
gmsh.model.mesh.field.setNumber(f, "Radius", 0.5)
```

### Min（最小值场）

取多个场的最小值。

```python
f = gmsh.model.mesh.field.add("Min")
gmsh.model.mesh.field.setNumbers(f, "FieldsList", [f1, f2, f3])
```

### Max（最大值场）

取多个场的最大值。

```python
f = gmsh.model.mesh.field.add("Max")
gmsh.model.mesh.field.setNumbers(f, "FieldsList", [f1, f2, f3])
```

### Restrict（限制场）

将场限制到特定区域。

```python
f = gmsh.model.mesh.field.add("Restrict")
gmsh.model.mesh.field.setNumber(f, "InField", source_field)
gmsh.model.mesh.field.setNumbers(f, "SurfacesList", [1, 2])
gmsh.model.mesh.field.setNumbers(f, "VolumesList", [1])
```

## 组合尺寸场

### 典型模式：距离+阈值

```python
# 在孔洞周围细化
hole_curves = [5, 6, 7, 8]

# 距离场
f1 = gmsh.model.mesh.field.add("Distance")
gmsh.model.mesh.field.setNumbers(f1, "CurvesList", hole_curves)

# 阈值场
f2 = gmsh.model.mesh.field.add("Threshold")
gmsh.model.mesh.field.setNumber(f2, "InField", f1)
gmsh.model.mesh.field.setNumber(f2, "SizeMin", 0.01)
gmsh.model.mesh.field.setNumber(f2, "SizeMax", 0.1)
gmsh.model.mesh.field.setNumber(f2, "DistMin", 0.02)
gmsh.model.mesh.field.setNumber(f2, "DistMax", 0.2)

gmsh.model.mesh.field.setAsBackgroundMesh(f2)
```

### 多区域细化

```python
# 多个细化区域
fields = []

# 区域1
f1 = gmsh.model.mesh.field.add("Ball")
gmsh.model.mesh.field.setNumber(f1, "VIn", 0.02)
gmsh.model.mesh.field.setNumber(f1, "VOut", 1e10)  # 大值，由Min取最小
gmsh.model.mesh.field.setNumber(f1, "XCenter", 0.2)
gmsh.model.mesh.field.setNumber(f1, "YCenter", 0.2)
gmsh.model.mesh.field.setNumber(f1, "ZCenter", 0)
gmsh.model.mesh.field.setNumber(f1, "Radius", 0.1)
fields.append(f1)

# 区域2
f2 = gmsh.model.mesh.field.add("Ball")
gmsh.model.mesh.field.setNumber(f2, "VIn", 0.02)
gmsh.model.mesh.field.setNumber(f2, "VOut", 1e10)
gmsh.model.mesh.field.setNumber(f2, "XCenter", 0.8)
gmsh.model.mesh.field.setNumber(f2, "YCenter", 0.8)
gmsh.model.mesh.field.setNumber(f2, "ZCenter", 0)
gmsh.model.mesh.field.setNumber(f2, "Radius", 0.1)
fields.append(f2)

# 背景尺寸
f3 = gmsh.model.mesh.field.add("MathEval")
gmsh.model.mesh.field.setString(f3, "F", "0.1")
fields.append(f3)

# 取最小值
f_min = gmsh.model.mesh.field.add("Min")
gmsh.model.mesh.field.setNumbers(f_min, "FieldsList", fields)

gmsh.model.mesh.field.setAsBackgroundMesh(f_min)
```

## 完整示例：多尺度网格

```python
#!/usr/bin/env python3
"""
使用尺寸场创建多尺度网格
"""
import gmsh

gmsh.initialize()
gmsh.model.add("multiscale")

# 创建几何：带多个孔的板
plate = gmsh.model.occ.addRectangle(0, 0, 0, 10, 10)
holes = []
positions = [(2, 2), (8, 2), (5, 5), (2, 8), (8, 8)]
for x, y in positions:
    hole = gmsh.model.occ.addDisk(x, y, 0, 0.3, 0.3)
    holes.append((2, hole))

gmsh.model.occ.cut([(2, plate)], holes)
gmsh.model.occ.synchronize()

# 获取孔的边界曲线
hole_curves = []
for curve in gmsh.model.getEntities(1):
    com = gmsh.model.occ.getCenterOfMass(1, curve[1])
    for x, y in positions:
        if ((com[0]-x)**2 + (com[1]-y)**2)**0.5 < 0.5:
            hole_curves.append(curve[1])
            break

# 创建尺寸场
fields = []

# 1. 每个孔周围的局部细化
for i, (x, y) in enumerate(positions):
    # 到孔的距离
    f_dist = gmsh.model.mesh.field.add("Distance")
    gmsh.model.mesh.field.setNumbers(f_dist, "CurvesList",
        [c for c in hole_curves if abs(gmsh.model.occ.getCenterOfMass(1, c)[0]-x) < 0.5])

    # 阈值
    f_thresh = gmsh.model.mesh.field.add("Threshold")
    gmsh.model.mesh.field.setNumber(f_thresh, "InField", f_dist)
    gmsh.model.mesh.field.setNumber(f_thresh, "SizeMin", 0.02)
    gmsh.model.mesh.field.setNumber(f_thresh, "SizeMax", 1e10)
    gmsh.model.mesh.field.setNumber(f_thresh, "DistMin", 0.05)
    gmsh.model.mesh.field.setNumber(f_thresh, "DistMax", 1.0)

    fields.append(f_thresh)

# 2. 中心区域额外细化
f_center = gmsh.model.mesh.field.add("Ball")
gmsh.model.mesh.field.setNumber(f_center, "VIn", 0.1)
gmsh.model.mesh.field.setNumber(f_center, "VOut", 1e10)
gmsh.model.mesh.field.setNumber(f_center, "XCenter", 5)
gmsh.model.mesh.field.setNumber(f_center, "YCenter", 5)
gmsh.model.mesh.field.setNumber(f_center, "ZCenter", 0)
gmsh.model.mesh.field.setNumber(f_center, "Radius", 2)
gmsh.model.mesh.field.setNumber(f_center, "Thickness", 1)
fields.append(f_center)

# 3. 背景尺寸
f_bg = gmsh.model.mesh.field.add("MathEval")
gmsh.model.mesh.field.setString(f_bg, "F", "0.5")
fields.append(f_bg)

# 4. 取最小值
f_min = gmsh.model.mesh.field.add("Min")
gmsh.model.mesh.field.setNumbers(f_min, "FieldsList", fields)

# 设置为背景场
gmsh.model.mesh.field.setAsBackgroundMesh(f_min)

# 禁用其他尺寸源
gmsh.option.setNumber("Mesh.MeshSizeFromPoints", 0)
gmsh.option.setNumber("Mesh.MeshSizeFromCurvature", 0)
gmsh.option.setNumber("Mesh.MeshSizeExtendFromBoundary", 0)

# 生成网格
gmsh.model.mesh.generate(2)

nodes, _, _ = gmsh.model.mesh.getNodes()
print(f"节点数: {len(nodes)}")

gmsh.write("multiscale.msh")
gmsh.finalize()
```

## 下一步

- [05-背景网格](./05-背景网格.md) - 学习使用现有网格控制尺寸
