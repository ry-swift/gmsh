# 曲线类型详解

Gmsh支持多种曲线类型，从简单的直线到复杂的B样条曲线。

## 曲线类型概览

```
直线          圆弧          椭圆弧        样条曲线      B样条曲线
•─────────•   •     •       •   •         •             •
             ╭─────╮       ╭─────╮       ╭─╮           ╭──╮
            •       •     •       •     •   ╰─•       •    ╰•
                                           ╰─•         ╰──•
```

## 直线 (Line)

### 基本直线

```python
import gmsh

gmsh.initialize()
gmsh.model.add("lines")

# 创建点
p1 = gmsh.model.occ.addPoint(0, 0, 0)
p2 = gmsh.model.occ.addPoint(1, 0, 0)
p3 = gmsh.model.occ.addPoint(1, 1, 0)

# 创建直线
line1 = gmsh.model.occ.addLine(p1, p2)
line2 = gmsh.model.occ.addLine(p2, p3)

gmsh.model.occ.synchronize()
gmsh.finalize()
```

### 折线 (Polyline)

```python
# 使用Spline连接多点创建折线效果
# 或使用多条直线

points = []
for i in range(5):
    p = gmsh.model.occ.addPoint(i, i % 2, 0)
    points.append(p)

# 方法1：多条直线
lines = []
for i in range(len(points) - 1):
    line = gmsh.model.occ.addLine(points[i], points[i+1])
    lines.append(line)

# 方法2：使用Wire
wire = gmsh.model.occ.addWire(lines)
```

## 圆弧 (Circle Arc)

### 三点圆弧

```python
# addCircleArc(startTag, centerTag, endTag)
# 从起点到终点，经过圆心定义的圆弧

p_start = gmsh.model.occ.addPoint(1, 0, 0)
p_center = gmsh.model.occ.addPoint(0, 0, 0)
p_end = gmsh.model.occ.addPoint(0, 1, 0)

# 90度圆弧
arc = gmsh.model.occ.addCircleArc(p_start, p_center, p_end)
```

### 完整圆

```python
# addCircle(x, y, z, r, angle1=0, angle2=2*pi)
# 创建完整圆或圆弧

# 完整圆
circle = gmsh.model.occ.addCircle(0, 0, 0, 1)

# 半圆
import math
semicircle = gmsh.model.occ.addCircle(0, 0, 0, 1, angle1=0, angle2=math.pi)

# 90度弧
quarter = gmsh.model.occ.addCircle(0, 0, 0, 1, angle1=0, angle2=math.pi/2)
```

### 3D空间中的圆

```python
# addCircle(x, y, z, r, angle1=0, angle2=2*pi,
#           nx=0, ny=0, nz=1)  # 法向量定义平面

# XY平面上的圆（默认）
circle_xy = gmsh.model.occ.addCircle(0, 0, 0, 1)

# XZ平面上的圆
circle_xz = gmsh.model.occ.addCircle(0, 0, 0, 1, nx=0, ny=1, nz=0)

# YZ平面上的圆
circle_yz = gmsh.model.occ.addCircle(0, 0, 0, 1, nx=1, ny=0, nz=0)

# 任意平面上的圆
circle_tilted = gmsh.model.occ.addCircle(0, 0, 0, 1, nx=1, ny=1, nz=1)
```

## 椭圆弧 (Ellipse Arc)

### 三点椭圆弧

```python
# addEllipseArc(startTag, centerTag, majorTag, endTag)
# majorTag: 长轴端点

p_start = gmsh.model.occ.addPoint(2, 0, 0)   # 起点（在椭圆上）
p_center = gmsh.model.occ.addPoint(0, 0, 0)  # 中心
p_major = gmsh.model.occ.addPoint(2, 0, 0)   # 长轴端点
p_end = gmsh.model.occ.addPoint(0, 1, 0)     # 终点（在椭圆上）

arc = gmsh.model.occ.addEllipseArc(p_start, p_center, p_major, p_end)
```

### 完整椭圆

```python
# addEllipse(x, y, z, r1, r2, angle1=0, angle2=2*pi)
# r1: 长轴半径, r2: 短轴半径

import math

# 完整椭圆
ellipse = gmsh.model.occ.addEllipse(0, 0, 0, 2, 1)

# 椭圆弧
ellipse_arc = gmsh.model.occ.addEllipse(0, 0, 0, 2, 1,
                                         angle1=0, angle2=math.pi)

# 3D空间中的椭圆（指定法向量）
ellipse_3d = gmsh.model.occ.addEllipse(0, 0, 0, 2, 1,
                                        nx=0, ny=0, nz=1)
```

## 样条曲线 (Spline)

### Catmull-Rom样条

```python
# addSpline(pointTags)
# 通过所有控制点的光滑曲线

points = []
import math
for i in range(10):
    x = i * 0.5
    y = math.sin(x)
    p = gmsh.model.occ.addPoint(x, y, 0)
    points.append(p)

# 创建样条（通过所有点）
spline = gmsh.model.occ.addSpline(points)
```

### 闭合样条

```python
# 首尾相连形成闭合曲线
points = []
n = 8
for i in range(n):
    angle = 2 * math.pi * i / n
    r = 1 + 0.3 * math.sin(3 * angle)  # 变化半径
    x = r * math.cos(angle)
    y = r * math.sin(angle)
    points.append(gmsh.model.occ.addPoint(x, y, 0))

# 添加首点形成闭合
points.append(points[0])
closed_spline = gmsh.model.occ.addSpline(points)
```

## B样条曲线 (BSpline)

### 基本B样条

```python
# addBSpline(pointTags, tag=-1, degree=3,
#            weights=[], knots=[], multiplicities=[])

# 控制点（曲线不一定通过这些点）
ctrl_points = [
    gmsh.model.occ.addPoint(0, 0, 0),
    gmsh.model.occ.addPoint(1, 1, 0),
    gmsh.model.occ.addPoint(2, 0, 0),
    gmsh.model.occ.addPoint(3, 1, 0),
    gmsh.model.occ.addPoint(4, 0, 0),
]

# 3次B样条（默认）
bspline = gmsh.model.occ.addBSpline(ctrl_points)
```

### 带权重的B样条（NURBS）

```python
# 权重影响曲线对控制点的吸引程度
ctrl_points = [
    gmsh.model.occ.addPoint(0, 0, 0),
    gmsh.model.occ.addPoint(1, 1, 0),
    gmsh.model.occ.addPoint(2, 0, 0),
]

# 中间点权重更大，曲线更靠近它
weights = [1, 2, 1]
bspline = gmsh.model.occ.addBSpline(ctrl_points, weights=weights)
```

### 指定次数的B样条

```python
# 2次B样条
bspline_2 = gmsh.model.occ.addBSpline(ctrl_points, degree=2)

# 4次B样条（需要更多控制点）
ctrl_points_5 = [gmsh.model.occ.addPoint(i, i%2, 0) for i in range(6)]
bspline_4 = gmsh.model.occ.addBSpline(ctrl_points_5, degree=4)
```

### 指定节点向量

```python
# 自定义节点向量可以控制曲线的参数化
ctrl_points = [gmsh.model.occ.addPoint(i, i%2, 0) for i in range(5)]

# 均匀B样条
knots = [0, 0, 0, 0, 0.5, 1, 1, 1, 1]
multiplicities = [1] * len(knots)
bspline = gmsh.model.occ.addBSpline(ctrl_points, degree=3,
                                     knots=knots,
                                     multiplicities=multiplicities)
```

## 贝塞尔曲线 (Bezier)

```python
# addBezier(pointTags)
# 贝塞尔曲线是B样条的特例

# 3次贝塞尔（4个控制点）
ctrl_points = [
    gmsh.model.occ.addPoint(0, 0, 0),   # 起点
    gmsh.model.occ.addPoint(1, 2, 0),   # 控制点1
    gmsh.model.occ.addPoint(2, 2, 0),   # 控制点2
    gmsh.model.occ.addPoint(3, 0, 0),   # 终点
]

bezier = gmsh.model.occ.addBezier(ctrl_points)
```

## 螺旋线 (Helix)

OpenCASCADE不直接支持螺旋线，但可以用参数化方式创建：

```python
#!/usr/bin/env python3
"""
创建螺旋线
"""
import gmsh
import math

gmsh.initialize()
gmsh.model.add("helix")

# 参数
radius = 1.0      # 半径
pitch = 0.5       # 螺距
turns = 3         # 圈数
n_points = 100    # 点数

# 创建螺旋线上的点
points = []
for i in range(n_points):
    t = turns * 2 * math.pi * i / (n_points - 1)
    x = radius * math.cos(t)
    y = radius * math.sin(t)
    z = pitch * t / (2 * math.pi)
    p = gmsh.model.occ.addPoint(x, y, z)
    points.append(p)

# 用样条连接
helix = gmsh.model.occ.addSpline(points)

gmsh.model.occ.synchronize()
gmsh.write("helix.brep")
gmsh.finalize()
```

## 偏移曲线 (Offset Curve)

```python
# 从现有曲线创建偏移曲线
# 需要先创建基础曲线，然后用Wire和ThruSections

# 基础曲线
base_curve = gmsh.model.occ.addCircle(0, 0, 0, 1)

# 创建偏移：通过创建偏移的点
# 或使用管道操作
```

## 曲线操作

### 曲线分割

```python
# 在指定参数处分割曲线
# 获取曲线参数范围
bounds = gmsh.model.getParametrizationBounds(1, curve_tag)
u_min, u_max = bounds[0][0], bounds[1][0]

# 在中点分割（需要创建点）
u_mid = (u_min + u_max) / 2
point_at_mid = gmsh.model.getValue(1, curve_tag, [u_mid])
split_point = gmsh.model.occ.addPoint(*point_at_mid)

# 使用布尔运算分割
```

### 曲线连接

```python
# 使用Wire连接多条曲线
wire = gmsh.model.occ.addWire([curve1, curve2, curve3])

# 创建曲线环
loop = gmsh.model.occ.addCurveLoop([curve1, curve2, curve3, curve4])
```

### 曲线信息

```python
# 获取曲线长度
length = gmsh.model.occ.getMass(1, curve_tag)

# 获取曲线上的点
bounds = gmsh.model.getParametrizationBounds(1, curve_tag)
u = bounds[0][0]  # 起点参数
point = gmsh.model.getValue(1, curve_tag, [u])

# 获取曲线的边界框
bbox = gmsh.model.occ.getBoundingBox(1, curve_tag)
# 返回 (xmin, ymin, zmin, xmax, ymax, zmax)
```

## 完整示例：复杂轮廓

```python
#!/usr/bin/env python3
"""
使用多种曲线类型创建复杂轮廓
"""
import gmsh
import math

gmsh.initialize()
gmsh.model.add("complex_profile")

# 创建各种曲线组成的轮廓
# 部分1：直线底边
p1 = gmsh.model.occ.addPoint(0, 0, 0)
p2 = gmsh.model.occ.addPoint(3, 0, 0)
line1 = gmsh.model.occ.addLine(p1, p2)

# 部分2：圆弧过渡
p3 = gmsh.model.occ.addPoint(4, 1, 0)
arc1 = gmsh.model.occ.addCircle(3, 1, 0, 1, angle1=-math.pi/2, angle2=0)

# 部分3：样条曲线
spline_points = [
    gmsh.model.occ.addPoint(4, 1, 0),
    gmsh.model.occ.addPoint(4.5, 2, 0),
    gmsh.model.occ.addPoint(4, 3, 0),
    gmsh.model.occ.addPoint(3, 3.5, 0),
]
spline1 = gmsh.model.occ.addSpline(spline_points)

# 部分4：贝塞尔曲线
bezier_points = [
    gmsh.model.occ.addPoint(3, 3.5, 0),
    gmsh.model.occ.addPoint(2, 4, 0),
    gmsh.model.occ.addPoint(1, 3.5, 0),
]
bezier1 = gmsh.model.occ.addBezier(bezier_points)

# 部分5：B样条
bspline_points = [
    gmsh.model.occ.addPoint(1, 3.5, 0),
    gmsh.model.occ.addPoint(0.5, 3, 0),
    gmsh.model.occ.addPoint(0, 2, 0),
    gmsh.model.occ.addPoint(0, 1, 0),
]
bspline1 = gmsh.model.occ.addBSpline(bspline_points)

# 部分6：闭合直线
p_last = gmsh.model.occ.addPoint(0, 1, 0)
line2 = gmsh.model.occ.addLine(p_last, p1)

gmsh.model.occ.synchronize()

# 创建曲线环和曲面
curves = gmsh.model.getEntities(1)
curve_tags = [c[1] for c in curves]
print(f"曲线数量: {len(curve_tags)}")

# 尝试创建曲线环
try:
    loop = gmsh.model.occ.addCurveLoop(curve_tags)
    surface = gmsh.model.occ.addPlaneSurface([loop])
    gmsh.model.occ.synchronize()
except:
    print("曲线可能不连续，请检查")

# 网格生成
gmsh.option.setNumber("Mesh.MeshSizeMin", 0.1)
gmsh.option.setNumber("Mesh.MeshSizeMax", 0.3)
gmsh.model.mesh.generate(2)

gmsh.write("complex_profile.msh")
gmsh.finalize()
```

## 内置内核 vs OCC内核

| 曲线类型 | geo内核 | occ内核 |
|---------|---------|---------|
| 直线 | addLine | addLine |
| 圆弧 | addCircleArc | addCircleArc, addCircle |
| 椭圆弧 | addEllipseArc | addEllipseArc, addEllipse |
| 样条 | addSpline | addSpline |
| B样条 | addBSpline | addBSpline |
| 贝塞尔 | addBezier | addBezier |
| Wire | - | addWire |

## 下一步

- [02-曲面类型详解](./02-曲面类型详解.md) - 学习各种曲面的创建方法
