# 曲面类型详解

Gmsh支持多种曲面类型，从简单的平面到复杂的NURBS曲面。

## 曲面类型概览

```
平面曲面        规则曲面        旋转曲面        放样曲面        填充曲面
┌─────────┐    ╭─────────╮    ╭───────╮      ╭─────╮        ╭───────╮
│         │   ╱           ╲   │       │      │     │       ╱         ╲
│         │  │             │  │       │     ╱       ╲     │           │
│         │   ╲           ╱   ╰───────╯    ╱         ╲    ╰───────────╯
└─────────┘    ╰─────────╯                 ╰─────────╯
```

## 平面曲面 (Plane Surface)

### 基本平面

```python
import gmsh
import math

gmsh.initialize()
gmsh.model.add("surfaces")

# 创建边界曲线
p1 = gmsh.model.occ.addPoint(0, 0, 0)
p2 = gmsh.model.occ.addPoint(1, 0, 0)
p3 = gmsh.model.occ.addPoint(1, 1, 0)
p4 = gmsh.model.occ.addPoint(0, 1, 0)

l1 = gmsh.model.occ.addLine(p1, p2)
l2 = gmsh.model.occ.addLine(p2, p3)
l3 = gmsh.model.occ.addLine(p3, p4)
l4 = gmsh.model.occ.addLine(p4, p1)

# 创建曲线环
loop = gmsh.model.occ.addCurveLoop([l1, l2, l3, l4])

# 创建平面曲面
surface = gmsh.model.occ.addPlaneSurface([loop])

gmsh.model.occ.synchronize()
gmsh.finalize()
```

### 带孔的平面

```python
# 外边界
outer_loop = gmsh.model.occ.addCurveLoop([l1, l2, l3, l4])

# 内边界（孔）
circle = gmsh.model.occ.addCircle(0.5, 0.5, 0, 0.2)
inner_loop = gmsh.model.occ.addCurveLoop([circle])

# 带孔的平面（外环在前，内环在后）
surface = gmsh.model.occ.addPlaneSurface([outer_loop, inner_loop])
```

### 多孔平面

```python
# 外边界
outer = gmsh.model.occ.addRectangle(0, 0, 0, 10, 10)

# 多个孔
holes = []
positions = [(2, 2), (5, 5), (8, 2), (2, 8), (8, 8)]
for x, y in positions:
    hole = gmsh.model.occ.addDisk(x, y, 0, 0.5, 0.5)
    holes.append((2, hole))

# 布尔差集
gmsh.model.occ.cut([(2, outer)], holes)
```

## 圆盘 (Disk)

```python
# addDisk(xc, yc, zc, rx, ry)
# 椭圆盘，rx=ry时为圆盘

# 圆盘
disk = gmsh.model.occ.addDisk(0, 0, 0, 1, 1)

# 椭圆盘
ellipse_disk = gmsh.model.occ.addDisk(0, 0, 0, 2, 1)

# 3D空间中的圆盘（指定法向量）
disk_3d = gmsh.model.occ.addDisk(0, 0, 0, 1, 1, nx=1, ny=0, nz=0)
```

## 矩形 (Rectangle)

```python
# addRectangle(x, y, z, dx, dy, roundedRadius=0)

# 普通矩形
rect = gmsh.model.occ.addRectangle(0, 0, 0, 2, 1)

# 圆角矩形
rounded_rect = gmsh.model.occ.addRectangle(0, 0, 0, 2, 1, roundedRadius=0.1)
```

## 旋转曲面 (Surface of Revolution)

### 使用revolve

```python
# revolve(dimTags, x, y, z, ax, ay, az, angle)
# 绕轴旋转曲线生成曲面

# 创建轮廓曲线
p1 = gmsh.model.occ.addPoint(1, 0, 0)
p2 = gmsh.model.occ.addPoint(2, 0, 0)
p3 = gmsh.model.occ.addPoint(2, 1, 0)
p4 = gmsh.model.occ.addPoint(1, 1, 0)

l1 = gmsh.model.occ.addLine(p1, p2)
l2 = gmsh.model.occ.addLine(p2, p3)
l3 = gmsh.model.occ.addLine(p3, p4)
l4 = gmsh.model.occ.addLine(p4, p1)

loop = gmsh.model.occ.addCurveLoop([l1, l2, l3, l4])
profile = gmsh.model.occ.addPlaneSurface([loop])

# 绕Z轴旋转180度
result = gmsh.model.occ.revolve([(2, profile)], 0, 0, 0, 0, 0, 1, math.pi)
```

### 创建旋转体

```python
# 创建花瓶形状的轮廓
points = [
    (0.5, 0),
    (1.0, 0.5),
    (0.8, 1.0),
    (0.6, 1.5),
    (0.7, 2.0),
    (1.0, 2.5),
    (0.3, 3.0),
]

pts = [gmsh.model.occ.addPoint(r, 0, z) for r, z in points]
spline = gmsh.model.occ.addSpline(pts)

# 添加轴线
axis_bottom = gmsh.model.occ.addPoint(0, 0, 0)
axis_top = gmsh.model.occ.addPoint(0, 0, 3)
axis_line = gmsh.model.occ.addLine(axis_bottom, axis_top)

# 闭合轮廓
bottom_line = gmsh.model.occ.addLine(pts[0], axis_bottom)
top_line = gmsh.model.occ.addLine(axis_top, pts[-1])

loop = gmsh.model.occ.addCurveLoop([spline, top_line, -axis_line, -bottom_line])
profile = gmsh.model.occ.addPlaneSurface([loop])

# 旋转360度
gmsh.model.occ.revolve([(2, profile)], 0, 0, 0, 0, 0, 1, 2*math.pi)
```

## 拉伸曲面 (Extruded Surface)

### 线性拉伸

```python
# extrude(dimTags, dx, dy, dz)

# 创建曲线
circle = gmsh.model.occ.addCircle(0, 0, 0, 1)
loop = gmsh.model.occ.addCurveLoop([circle])
disk = gmsh.model.occ.addPlaneSurface([loop])

# 拉伸创建圆柱面
result = gmsh.model.occ.extrude([(2, disk)], 0, 0, 2)
# result包含生成的体积和曲面
```

### 扭转拉伸

```python
# extrude(dimTags, dx, dy, dz, numElements=[],
#         heights=[], recombine=False)
# 结合旋转实现扭转

# 需要使用twist拉伸
# OCC不直接支持twist，但可以分段旋转+拉伸
```

## 放样曲面 (Lofted Surface / ThruSections)

### 基本放样

```python
# addThruSections(wireTags, makeSolid=True, makeRuled=False)

# 创建多个截面
sections = []

# 底部圆
circle1 = gmsh.model.occ.addCircle(0, 0, 0, 1)
wire1 = gmsh.model.occ.addWire([circle1])
sections.append(wire1)

# 中间方形
p1 = gmsh.model.occ.addPoint(-0.7, -0.7, 1)
p2 = gmsh.model.occ.addPoint(0.7, -0.7, 1)
p3 = gmsh.model.occ.addPoint(0.7, 0.7, 1)
p4 = gmsh.model.occ.addPoint(-0.7, 0.7, 1)
l1 = gmsh.model.occ.addLine(p1, p2)
l2 = gmsh.model.occ.addLine(p2, p3)
l3 = gmsh.model.occ.addLine(p3, p4)
l4 = gmsh.model.occ.addLine(p4, p1)
wire2 = gmsh.model.occ.addWire([l1, l2, l3, l4])
sections.append(wire2)

# 顶部圆
circle2 = gmsh.model.occ.addCircle(0, 0, 2, 0.5)
wire3 = gmsh.model.occ.addWire([circle2])
sections.append(wire3)

# 创建放样实体
solid = gmsh.model.occ.addThruSections(sections, makeSolid=True)
```

### 规则放样

```python
# makeRuled=True 创建直纹面（更简单的几何）
surface = gmsh.model.occ.addThruSections(sections,
                                          makeSolid=False,
                                          makeRuled=True)
```

## 管道曲面 (Pipe Surface)

### 沿路径扫掠

```python
# addPipe(dimTags, wireTag, trihedron="")

# 创建路径
helix_points = []
for i in range(50):
    t = i * 0.2
    x = math.cos(t)
    y = math.sin(t)
    z = t * 0.1
    helix_points.append(gmsh.model.occ.addPoint(x, y, z))

path = gmsh.model.occ.addSpline(helix_points)
path_wire = gmsh.model.occ.addWire([path])

# 创建截面（在路径起点）
section = gmsh.model.occ.addDisk(1, 0, 0, 0.1, 0.1)

# 沿路径扫掠
pipe = gmsh.model.occ.addPipe([(2, section)], path_wire)
```

### 不同截面形状

```python
# 方形截面
p1 = gmsh.model.occ.addPoint(0.9, -0.1, 0)
p2 = gmsh.model.occ.addPoint(1.1, -0.1, 0)
p3 = gmsh.model.occ.addPoint(1.1, 0.1, 0)
p4 = gmsh.model.occ.addPoint(0.9, 0.1, 0)
lines = [
    gmsh.model.occ.addLine(p1, p2),
    gmsh.model.occ.addLine(p2, p3),
    gmsh.model.occ.addLine(p3, p4),
    gmsh.model.occ.addLine(p4, p1),
]
loop = gmsh.model.occ.addCurveLoop(lines)
section = gmsh.model.occ.addPlaneSurface([loop])

pipe = gmsh.model.occ.addPipe([(2, section)], path_wire)
```

## 填充曲面 (Filling Surface)

### 边界填充

```python
# addSurfaceFilling(wireTag, pointTags=[], degree=3,
#                   numPointsOnCurves=15, numIter=2,
#                   anisotropic=False, tol2d=1e-8, tol3d=1e-4,
#                   tolAng=0.01, tolCurv=0.1, maxDeg=8, maxSegments=9)

# 创建边界曲线
curves = []
# 四条边界曲线（可以是任意曲线）
p1 = gmsh.model.occ.addPoint(0, 0, 0)
p2 = gmsh.model.occ.addPoint(1, 0, 0.2)
p3 = gmsh.model.occ.addPoint(1, 1, 0)
p4 = gmsh.model.occ.addPoint(0, 1, 0.3)

# 使用样条创建曲边
curves.append(gmsh.model.occ.addSpline([p1,
    gmsh.model.occ.addPoint(0.5, 0, 0.1), p2]))
curves.append(gmsh.model.occ.addLine(p2, p3))
curves.append(gmsh.model.occ.addSpline([p3,
    gmsh.model.occ.addPoint(0.5, 1, 0.15), p4]))
curves.append(gmsh.model.occ.addLine(p4, p1))

wire = gmsh.model.occ.addWire(curves)

# 创建填充曲面
filling = gmsh.model.occ.addSurfaceFilling(wire)
```

### 带内部点约束

```python
# 添加内部点约束
internal_points = [
    gmsh.model.occ.addPoint(0.5, 0.5, 0.25),
    gmsh.model.occ.addPoint(0.3, 0.7, 0.2),
]

filling = gmsh.model.occ.addSurfaceFilling(wire,
                                            pointTags=internal_points)
```

## B样条曲面 (BSpline Surface)

```python
# addBSplineSurface(pointTags, numPointsU, degreeU=3, degreeV=3,
#                   weights=[], knotsU=[], knotsV=[],
#                   multiplicitiesU=[], multiplicitiesV=[])

# 创建控制点网格 (4x4)
ctrl_points = []
for j in range(4):
    for i in range(4):
        z = 0.3 * math.sin(i * math.pi / 3) * math.sin(j * math.pi / 3)
        p = gmsh.model.occ.addPoint(i, j, z)
        ctrl_points.append(p)

# 创建B样条曲面
bspline_surf = gmsh.model.occ.addBSplineSurface(
    ctrl_points,
    numPointsU=4,
    degreeU=3,
    degreeV=3
)
```

## 贝塞尔曲面 (Bezier Surface)

```python
# addBezierSurface(pointTags, numPointsU)

# 创建控制点网格 (4x4)
ctrl_points = []
for j in range(4):
    for i in range(4):
        z = 0.5 if (i == 1 or i == 2) and (j == 1 or j == 2) else 0
        p = gmsh.model.occ.addPoint(i, j, z)
        ctrl_points.append(p)

bezier_surf = gmsh.model.occ.addBezierSurface(ctrl_points, numPointsU=4)
```

## 裁剪曲面 (Trimmed Surface)

```python
# addTrimmedSurface(surfaceTag, wireTag, wire3D=False)
# 用曲线环裁剪曲面

# 基础曲面
base = gmsh.model.occ.addPlaneSurface([
    gmsh.model.occ.addCurveLoop([
        gmsh.model.occ.addRectangle(0, 0, 0, 2, 2)
    ])
])

# 实际上，裁剪通常通过布尔运算实现
```

## 曲面操作

### 曲面缝合

```python
# 将多个曲面缝合成壳
# sewFaces(surfaceTags, tolerance=1e-7, makeSolid=False,
#          makeShell=False, removeDegeneratedFaces=True)

surfaces = [s1, s2, s3, s4, s5, s6]  # 立方体的六个面
result = gmsh.model.occ.sewFaces([(2, s) for s in surfaces],
                                  tolerance=1e-6,
                                  makeShell=True)
```

### 曲面信息

```python
# 获取曲面面积
area = gmsh.model.occ.getMass(2, surface_tag)

# 获取曲面质心
com = gmsh.model.occ.getCenterOfMass(2, surface_tag)

# 获取边界框
bbox = gmsh.model.occ.getBoundingBox(2, surface_tag)

# 获取曲面法向量（在指定参数点）
bounds = gmsh.model.getParametrizationBounds(2, surface_tag)
u = (bounds[0][0] + bounds[1][0]) / 2
v = (bounds[0][1] + bounds[1][1]) / 2
normal = gmsh.model.getNormal(surface_tag, [u, v])
```

## 完整示例：复杂曲面模型

```python
#!/usr/bin/env python3
"""
创建包含多种曲面类型的模型
"""
import gmsh
import math

gmsh.initialize()
gmsh.model.add("surface_types")

# 1. 基础平台（矩形）
base = gmsh.model.occ.addBox(0, 0, 0, 10, 10, 0.5)

# 2. 圆柱体（旋转曲面）
cylinder = gmsh.model.occ.addCylinder(2, 2, 0.5, 0, 0, 3, 0.5)

# 3. 圆锥体（旋转曲面）
cone = gmsh.model.occ.addCone(5, 5, 0.5, 0, 0, 2, 1, 0.2)

# 4. 球体
sphere = gmsh.model.occ.addSphere(8, 2, 1.5, 0.8)

# 5. 圆环体（旋转曲面）
torus = gmsh.model.occ.addTorus(8, 8, 1, 0.5, 0.2)

# 6. 放样曲面 - 创建花瓶
sections = []
heights = [0.5, 1.0, 1.5, 2.0, 2.5]
radii = [0.3, 0.5, 0.4, 0.6, 0.3]

for h, r in zip(heights, radii):
    circle = gmsh.model.occ.addCircle(2, 8, h, r)
    wire = gmsh.model.occ.addWire([circle])
    sections.append(wire)

vase = gmsh.model.occ.addThruSections(sections, makeSolid=True)

# 7. 管道 - 螺旋管
helix_pts = []
for i in range(40):
    t = i * 0.3
    x = 5 + 0.5 * math.cos(t)
    y = 8 + 0.5 * math.sin(t)
    z = 0.5 + t * 0.05
    helix_pts.append(gmsh.model.occ.addPoint(x, y, z))

helix_curve = gmsh.model.occ.addSpline(helix_pts)
helix_wire = gmsh.model.occ.addWire([helix_curve])

start_pt = helix_pts[0]
coords = gmsh.model.getValue(0, start_pt, [])
pipe_section = gmsh.model.occ.addDisk(coords[0], coords[1], coords[2],
                                       0.05, 0.05, nx=1, ny=0, nz=0)

pipe = gmsh.model.occ.addPipe([(2, pipe_section)], helix_wire)

gmsh.model.occ.synchronize()

# 网格设置
gmsh.option.setNumber("Mesh.MeshSizeMin", 0.1)
gmsh.option.setNumber("Mesh.MeshSizeMax", 0.5)
gmsh.option.setNumber("Mesh.MeshSizeFromCurvature", 20)

# 生成网格
gmsh.model.mesh.generate(3)

# 统计
entities = gmsh.model.getEntities(2)
print(f"曲面数量: {len(entities)}")

volumes = gmsh.model.getEntities(3)
print(f"体积数量: {len(volumes)}")

gmsh.write("surface_types.msh")
gmsh.finalize()
```

## 下一步

- [03-实体建模](./03-实体建模.md) - 学习3D实体的创建方法
