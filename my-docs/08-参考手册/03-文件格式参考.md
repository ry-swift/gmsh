# 文件格式参考

本节介绍Gmsh支持的各种文件格式，包括原生MSH格式、后处理POS格式，以及与其他软件的格式交换。

## MSH文件格式

### MSH 4.1格式（当前版本）

MSH 4.1是Gmsh的原生网格文件格式，采用ASCII或二进制编码。

#### 文件结构

```
$MeshFormat
version-number file-type data-size
$EndMeshFormat

$PhysicalNames (可选)
numPhysicalNames
dimension physicalTag "name"
...
$EndPhysicalNames

$Entities (可选)
numPoints numCurves numSurfaces numVolumes
pointTag X Y Z numPhysicalTags physicalTag ...
...
curveTag minX minY minZ maxX maxY maxZ numPhysicalTags physicalTag ... numBoundingPoints pointTag ...
...
surfaceTag minX minY minZ maxX maxY maxZ numPhysicalTags physicalTag ... numBoundingCurves curveTag ...
...
volumeTag minX minY minZ maxX maxY maxZ numPhysicalTags physicalTag ... numBoundingSurfaces surfaceTag ...
...
$EndEntities

$Nodes
numEntityBlocks numNodes minNodeTag maxNodeTag
entityDim entityTag parametric numNodesInBlock
nodeTag
...
x y z
...
...
$EndNodes

$Elements
numEntityBlocks numElements minElementTag maxElementTag
entityDim entityTag elementType numElementsInBlock
elementTag nodeTag ...
...
...
$EndElements
```

#### 示例文件

```
$MeshFormat
4.1 0 8
$EndMeshFormat
$PhysicalNames
2
2 1 "surface"
3 2 "volume"
$EndPhysicalNames
$Nodes
2 6 1 6
2 1 0 4
1
2
3
4
0 0 0
1 0 0
1 1 0
0 1 0
3 1 0 2
5
6
0.5 0.5 0
0.5 0.5 1
$EndNodes
$Elements
2 5 1 5
2 1 2 2
1 1 2 3
2 3 4 1
3 1 4 3
3 3 4 5 6
4 1 2 3 5
5 1 4 3 5
$EndElements
```

### MSH 2.2格式（旧版本）

MSH 2.2是早期版本的格式，仍被许多求解器支持。

```
$MeshFormat
2.2 file-type data-size
$EndMeshFormat

$Nodes
number-of-nodes
node-number x-coord y-coord z-coord
...
$EndNodes

$Elements
number-of-elements
elm-number elm-type number-of-tags < tag > ... node-number-list
...
$EndElements
```

### Python读写示例

```python
import gmsh
import numpy as np

# 写入MSH文件
gmsh.initialize()
gmsh.model.add("example")
gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1)
gmsh.model.occ.synchronize()
gmsh.model.mesh.generate(3)

# 写入MSH 4.1（默认）
gmsh.write("mesh_v41.msh")

# 写入MSH 2.2
gmsh.option.setNumber("Mesh.MshFileVersion", 2.2)
gmsh.write("mesh_v22.msh")

# 写入二进制格式
gmsh.option.setNumber("Mesh.Binary", 1)
gmsh.write("mesh_binary.msh")

gmsh.finalize()

# 读取MSH文件
gmsh.initialize()
gmsh.open("mesh_v41.msh")

# 获取节点
node_tags, node_coords, _ = gmsh.model.mesh.getNodes()
print(f"节点数: {len(node_tags)}")

# 获取元素
elem_types, elem_tags, elem_nodes = gmsh.model.mesh.getElements()
print(f"元素类型: {elem_types}")

gmsh.finalize()
```

## 后处理文件格式

### POS格式（列表式）

POS格式用于存储后处理数据，支持标量、向量、张量场。

#### 基本语法

```
View "视图名称" {
  数据类型(坐标列表){值列表};
  ...
};
```

#### 数据类型

| 类型 | 描述 | 坐标数 | 值数（每点） |
|------|------|--------|-------------|
| SP | 标量点 | 3 | 1 |
| VP | 向量点 | 3 | 3 |
| TP | 张量点 | 3 | 9 |
| SL | 标量线 | 6 | 2 |
| VL | 向量线 | 6 | 6 |
| TL | 张量线 | 6 | 18 |
| ST | 标量三角形 | 9 | 3 |
| VT | 向量三角形 | 9 | 9 |
| TT | 张量三角形 | 9 | 27 |
| SQ | 标量四边形 | 12 | 4 |
| VQ | 向量四边形 | 12 | 12 |
| TQ | 张量四边形 | 12 | 36 |
| SS | 标量四面体 | 12 | 4 |
| VS | 向量四面体 | 12 | 12 |
| TS | 张量四面体 | 12 | 36 |
| SH | 标量六面体 | 24 | 8 |
| VH | 向量六面体 | 24 | 24 |
| TH | 张量六面体 | 24 | 72 |

#### 示例：标量场

```
View "Temperature" {
  // 标量三角形: ST(x1,y1,z1, x2,y2,z2, x3,y3,z3){v1, v2, v3};
  ST(0,0,0, 1,0,0, 0.5,1,0){100, 200, 150};
  ST(1,0,0, 1,1,0, 0.5,1,0){200, 250, 150};
};
```

#### 示例：向量场

```
View "Velocity" {
  // 向量三角形: VT(坐标){vx1,vy1,vz1, vx2,vy2,vz2, vx3,vy3,vz3};
  VT(0,0,0, 1,0,0, 0.5,1,0){1,0,0, 0.5,0.5,0, 0,1,0};
};
```

#### 多时间步

```
View "Time-varying Temperature" {
  // 时间步0
  ST(0,0,0, 1,0,0, 0.5,1,0){100, 200, 150};
  // 时间步1
  ST(0,0,0, 1,0,0, 0.5,1,0){110, 210, 160};
  // 时间步2
  ST(0,0,0, 1,0,0, 0.5,1,0){120, 220, 170};
};
// 时间值在View选项中设置
```

### Python创建POS文件

```python
import gmsh
import numpy as np

gmsh.initialize()

# 创建视图
tag = gmsh.view.add("Temperature Field")

# 准备数据
# 三角形坐标和值
triangles = [
    # x1,y1,z1, x2,y2,z2, x3,y3,z3, v1,v2,v3
    [0,0,0, 1,0,0, 0.5,0.866,0, 100,200,150],
    [1,0,0, 1.5,0.866,0, 0.5,0.866,0, 200,250,150],
]

data = []
for tri in triangles:
    data.extend(tri)

# 添加列表数据
gmsh.view.addListData(tag, "ST", len(triangles), data)

# 保存为POS格式
gmsh.view.write(tag, "temperature.pos")

gmsh.finalize()
```

## VTK格式

### VTK Legacy格式

```
# vtk DataFile Version 3.0
Description
ASCII
DATASET UNSTRUCTURED_GRID
POINTS n_points float
x1 y1 z1
x2 y2 z2
...

CELLS n_cells n_values
n_pts pt1 pt2 pt3 ...
...

CELL_TYPES n_cells
type1
type2
...

POINT_DATA n_points
SCALARS name float 1
LOOKUP_TABLE default
v1
v2
...
```

### VTK单元类型

| VTK类型 | 代码 | 描述 |
|---------|------|------|
| VTK_VERTEX | 1 | 点 |
| VTK_LINE | 3 | 线段 |
| VTK_TRIANGLE | 5 | 三角形 |
| VTK_QUAD | 9 | 四边形 |
| VTK_TETRA | 10 | 四面体 |
| VTK_HEXAHEDRON | 12 | 六面体 |
| VTK_WEDGE | 13 | 棱柱 |
| VTK_PYRAMID | 14 | 金字塔 |

### Gmsh导出VTK

```python
import gmsh

gmsh.initialize()
gmsh.model.add("vtk_export")

# 创建网格
gmsh.model.occ.addSphere(0, 0, 0, 1)
gmsh.model.occ.synchronize()
gmsh.model.mesh.generate(3)

# 导出VTK
gmsh.write("mesh.vtk")

# 导出VTU（XML格式）
gmsh.write("mesh.vtu")

gmsh.finalize()
```

## CAD格式

### STEP格式

STEP (Standard for the Exchange of Product Data) 是ISO标准的CAD交换格式。

```python
import gmsh

gmsh.initialize()

# 导入STEP
gmsh.model.occ.importShapes("model.step")
gmsh.model.occ.synchronize()

# 导出STEP
gmsh.write("output.step")

gmsh.finalize()
```

### IGES格式

IGES (Initial Graphics Exchange Specification) 是较早的CAD交换格式。

```python
import gmsh

gmsh.initialize()

# 导入IGES
gmsh.model.occ.importShapes("model.igs")
gmsh.model.occ.synchronize()

# 导出IGES
gmsh.write("output.igs")

gmsh.finalize()
```

### BREP格式

BREP是OpenCASCADE的原生边界表示格式。

```python
import gmsh

gmsh.initialize()
gmsh.model.add("brep_example")

# 创建几何
gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1)
gmsh.model.occ.synchronize()

# 导出BREP
gmsh.write("model.brep")

# 导入BREP
gmsh.clear()
gmsh.model.occ.importShapes("model.brep")
gmsh.model.occ.synchronize()

gmsh.finalize()
```

## STL格式

STL格式用于三角化曲面的存储。

### ASCII STL

```
solid name
  facet normal ni nj nk
    outer loop
      vertex v1x v1y v1z
      vertex v2x v2y v2z
      vertex v3x v3y v3z
    endloop
  endfacet
  ...
endsolid name
```

### 二进制STL

```
80字节头部
4字节三角形数量
对于每个三角形:
  12字节法向量 (3个float)
  36字节顶点 (9个float)
  2字节属性
```

### Gmsh处理STL

```python
import gmsh

gmsh.initialize()

# 导入STL
gmsh.merge("model.stl")

# 分类曲面
gmsh.model.mesh.classifySurfaces(angle=40*3.14159/180,
                                  boundary=True,
                                  forReparametrization=True)

# 创建几何
gmsh.model.mesh.createGeometry()

# 重新网格化
gmsh.model.mesh.generate(2)

# 导出STL
gmsh.write("output.stl")

gmsh.finalize()
```

## 求解器格式

### CGNS格式

CGNS (CFD General Notation System) 是CFD标准格式。

```python
import gmsh

gmsh.initialize()
gmsh.model.add("cgns")

gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1)
gmsh.model.occ.synchronize()
gmsh.model.mesh.generate(3)

# 导出CGNS
gmsh.write("mesh.cgns")

gmsh.finalize()
```

### MED格式

MED格式由Code_Aster和Salome-Meca使用。

```python
import gmsh

gmsh.initialize()
gmsh.model.add("med")

gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1)
gmsh.model.occ.synchronize()
gmsh.model.mesh.generate(3)

# 导出MED
gmsh.write("mesh.med")

gmsh.finalize()
```

### UNV格式

UNV (Universal File Format) 由I-DEAS创建，被多种软件支持。

```python
import gmsh

gmsh.initialize()
gmsh.model.add("unv")

gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1)
gmsh.model.occ.synchronize()

# 添加物理组（UNV需要）
gmsh.model.addPhysicalGroup(3, [1], name="Volume")

gmsh.model.mesh.generate(3)

# 导出UNV
gmsh.write("mesh.unv")

gmsh.finalize()
```

### INP格式（Abaqus）

```python
import gmsh

gmsh.initialize()
gmsh.model.add("abaqus")

gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1)
gmsh.model.occ.synchronize()

# Abaqus需要物理组
surfaces = gmsh.model.getEntities(2)
for i, (dim, tag) in enumerate(surfaces):
    gmsh.model.addPhysicalGroup(2, [tag], name=f"Surface_{i+1}")

gmsh.model.addPhysicalGroup(3, [1], name="Volume")

gmsh.model.mesh.generate(3)

# 导出INP
gmsh.write("mesh.inp")

gmsh.finalize()
```

### BDF格式（Nastran）

```python
import gmsh

gmsh.initialize()
gmsh.model.add("nastran")

gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1)
gmsh.model.occ.synchronize()
gmsh.model.addPhysicalGroup(3, [1], name="SOLID")
gmsh.model.mesh.generate(3)

# 导出Nastran BDF
gmsh.write("mesh.bdf")

gmsh.finalize()
```

## 格式转换工具

### 批量格式转换

```python
"""
网格格式批量转换工具
"""
import gmsh
import os

def convert_mesh(input_file, output_file, options=None):
    """
    转换网格格式

    参数:
        input_file: 输入文件
        output_file: 输出文件
        options: 可选参数字典
    """
    gmsh.initialize()

    # 设置选项
    if options:
        for key, value in options.items():
            if isinstance(value, (int, float)):
                gmsh.option.setNumber(key, value)
            else:
                gmsh.option.setString(key, value)

    # 读取输入
    try:
        gmsh.open(input_file)
    except:
        gmsh.merge(input_file)

    # 写入输出
    gmsh.write(output_file)

    # 获取统计
    _, nodes, _ = gmsh.model.mesh.getNodes()
    elem_types, elem_tags, _ = gmsh.model.mesh.getElements()
    total_elements = sum(len(t) for t in elem_tags)

    print(f"转换完成: {input_file} -> {output_file}")
    print(f"  节点数: {len(nodes)}")
    print(f"  元素数: {total_elements}")

    gmsh.finalize()


def batch_convert(input_dir, output_dir, input_ext, output_ext, options=None):
    """
    批量转换目录中的所有文件
    """
    os.makedirs(output_dir, exist_ok=True)

    for filename in os.listdir(input_dir):
        if filename.endswith(input_ext):
            input_path = os.path.join(input_dir, filename)
            output_name = filename.replace(input_ext, output_ext)
            output_path = os.path.join(output_dir, output_name)

            convert_mesh(input_path, output_path, options)


# 使用示例
if __name__ == "__main__":
    # 单文件转换
    # convert_mesh("input.msh", "output.vtk")

    # MSH 4.1 转 MSH 2.2
    # convert_mesh("mesh_v41.msh", "mesh_v22.msh",
    #              {"Mesh.MshFileVersion": 2.2})

    # 批量转换
    # batch_convert("./meshes", "./vtk_output", ".msh", ".vtk")
    pass
```

## 文件格式对比

| 格式 | 优点 | 缺点 | 适用场景 |
|------|------|------|---------|
| MSH 4.1 | Gmsh原生，完整支持 | 非标准 | Gmsh内部使用 |
| MSH 2.2 | 广泛支持 | 功能受限 | 与老求解器兼容 |
| VTK | 可视化通用 | 不支持高阶 | ParaView后处理 |
| CGNS | CFD标准 | 复杂 | CFD求解器 |
| MED | 法国求解器 | 有限支持 | Code_Aster |
| UNV | 传统格式 | 过时 | 老求解器 |
| INP | Abaqus | 商业软件 | Abaqus |
| BDF | Nastran | 商业软件 | Nastran |
| STEP | CAD标准 | 只有几何 | CAD交换 |
| STL | 简单通用 | 只有面片 | 3D打印 |

## 小结

本节介绍了Gmsh支持的主要文件格式：

1. **MSH格式**：Gmsh原生格式，支持完整功能
2. **POS格式**：后处理数据的列表式存储
3. **VTK格式**：可视化交换格式
4. **CAD格式**：STEP、IGES、BREP几何交换
5. **STL格式**：三角化曲面
6. **求解器格式**：CGNS、MED、UNV、INP、BDF

选择格式时需考虑：
- 目标求解器的要求
- 是否需要高阶元素
- 物理组/边界条件的保留
- 文件大小和读写效率
