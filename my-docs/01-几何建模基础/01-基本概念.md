# 几何建模基本概念

本文档介绍Gmsh几何建模的核心概念，为后续学习打下基础。

## 实体维度层次

Gmsh采用边界表示法（B-Rep）构建几何模型，通过自底向上的方式定义几何实体：

```
┌─────────────────────────────────────────────────────────────────┐
│                        实体层次结构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│    ┌───────────┐                                                │
│    │  Volume   │  3D实体（体积）                                 │
│    │   dim=3   │  由Surface Loop定界                            │
│    └─────┬─────┘                                                │
│          │ 边界                                                  │
│    ┌─────▼─────┐                                                │
│    │  Surface  │  2D实体（曲面）                                 │
│    │   dim=2   │  由Curve Loop定界                              │
│    └─────┬─────┘                                                │
│          │ 边界                                                  │
│    ┌─────▼─────┐                                                │
│    │   Curve   │  1D实体（曲线）                                 │
│    │   dim=1   │  由Point定界                                   │
│    └─────┬─────┘                                                │
│          │ 端点                                                  │
│    ┌─────▼─────┐                                                │
│    │   Point   │  0D实体（点）                                   │
│    │   dim=0   │  基础构建块                                    │
│    └───────────┘                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 各维度实体说明

| 维度 | 名称 | 英文 | 描述 | 边界 |
|-----|------|------|------|------|
| 0 | 点 | Point | 空间中的位置 | 无 |
| 1 | 曲线 | Curve/Line | 连接两点的路径 | 两个端点 |
| 2 | 曲面 | Surface | 由曲线环围成的区域 | 曲线环 |
| 3 | 体积 | Volume | 由曲面环围成的空间 | 曲面环 |

## 标签系统 (Tag System)

### 什么是标签？

标签（Tag）是Gmsh中标识实体的唯一正整数。

```python
# 每个实体都有一个tag
point_tag = 1      # 点1
line_tag = 5       # 线5
surface_tag = 10   # 面10
volume_tag = 1     # 体1
```

### 标签规则

1. **同维度唯一**：同一维度的实体标签不能重复
   ```python
   # 正确
   gmsh.model.geo.addPoint(0, 0, 0, 0.1, 1)  # 点1
   gmsh.model.geo.addLine(1, 2, 1)           # 线1（与点1不冲突）

   # 错误
   gmsh.model.geo.addPoint(0, 0, 0, 0.1, 1)
   gmsh.model.geo.addPoint(1, 0, 0, 0.1, 1)  # 错误：点1已存在
   ```

2. **正整数**：标签必须是正整数（>0）

3. **自动分配**：使用 `-1` 让Gmsh自动分配标签
   ```python
   tag = gmsh.model.geo.addPoint(0, 0, 0, 0.1, -1)  # 自动分配
   print(f"分配的标签: {tag}")
   ```

4. **不连续允许**：标签不必连续
   ```python
   gmsh.model.geo.addPoint(0, 0, 0, 0.1, 1)
   gmsh.model.geo.addPoint(1, 0, 0, 0.1, 100)  # 跳过2-99
   ```

## dimTags 格式

### 定义

`dimTags` 是Gmsh API中表示实体集合的标准格式：

```python
dimTags = [(dim, tag), (dim, tag), ...]
```

- `dim`: 实体维度 (0, 1, 2, 或 3)
- `tag`: 实体标签

### 示例

```python
# 单个点
point = [(0, 1)]

# 多条曲线
curves = [(1, 1), (1, 2), (1, 3)]

# 混合维度（不常见）
mixed = [(2, 1), (3, 1)]  # 一个面和一个体

# 获取模型中的所有实体
all_entities = gmsh.model.getEntities()
# 返回: [(0, 1), (0, 2), (1, 1), (1, 2), (2, 1), ...]

# 获取特定维度的实体
surfaces = gmsh.model.getEntities(2)  # 只获取面
# 返回: [(2, 1), (2, 2), ...]
```

## 拓扑关系

### 边界关系

获取实体的边界（低一维度的实体）：

```python
# 获取曲面的边界（曲线）
boundary = gmsh.model.getBoundary([(2, 1)])
# 返回曲面1的边界曲线

# 递归获取边界（一直到点）
boundary_recursive = gmsh.model.getBoundary([(2, 1)], recursive=True)

# 获取组合边界（多个实体的外边界）
combined = gmsh.model.getBoundary([(2, 1), (2, 2)], combined=True)
```

### 邻接关系

获取与实体相邻的实体：

```python
# 获取邻接实体
upward, downward = gmsh.model.getAdjacencies(dim, tag)
# upward: 高维邻接实体的tags
# downward: 低维邻接实体的tags
```

## 曲线环 (Curve Loop)

### 定义

曲线环是由多条曲线首尾相连形成的闭合轮廓。

```
        l3
   p4 ◄───── p3
    │         ▲
 l4 │         │ l2
    ▼         │
   p1 ─────► p2
        l1
```

### 创建规则

1. **闭合性**：曲线必须首尾相连
2. **方向性**：正数表示正向，负数表示反向
3. **顺序性**：曲线按顺序排列

```python
# 正确：顺时针或逆时针连续
gmsh.model.geo.addCurveLoop([1, 2, 3, 4], 1)

# 使用负数表示反向
# 如果l2的方向是 p3→p2，需要反向使用
gmsh.model.geo.addCurveLoop([1, -2, 3, 4], 1)
```

### 自动创建曲线环

```python
# 让Gmsh自动确定方向
gmsh.model.geo.addCurveLoops([1, 2, 3, 4])  # 注意是复数形式
```

## 曲面环 (Surface Loop)

### 定义

曲面环是由多个曲面组成的封闭壳，用于定义体积的边界。

```python
# 六面体需要6个面围成
gmsh.model.geo.addSurfaceLoop([1, 2, 3, 4, 5, 6], 1)

# 创建体积
gmsh.model.geo.addVolume([1], 1)  # 使用曲面环1
```

### 注意事项

- 曲面必须构成封闭壳
- 法向量方向会自动处理
- 可以使用负数表示反向

## 实体操作示意图

### 创建2D几何

```python
# 点 → 线 → 曲线环 → 平面

# Step 1: 创建点
p1 = gmsh.model.geo.addPoint(0, 0, 0, 0.1)
p2 = gmsh.model.geo.addPoint(1, 0, 0, 0.1)
p3 = gmsh.model.geo.addPoint(1, 1, 0, 0.1)
p4 = gmsh.model.geo.addPoint(0, 1, 0, 0.1)

# Step 2: 创建线
l1 = gmsh.model.geo.addLine(p1, p2)
l2 = gmsh.model.geo.addLine(p2, p3)
l3 = gmsh.model.geo.addLine(p3, p4)
l4 = gmsh.model.geo.addLine(p4, p1)

# Step 3: 创建曲线环
cl = gmsh.model.geo.addCurveLoop([l1, l2, l3, l4])

# Step 4: 创建平面
s = gmsh.model.geo.addPlaneSurface([cl])
```

### 创建3D几何

```python
# 方法1：拉伸2D几何
# 创建底面后拉伸
gmsh.model.geo.extrude([(2, surface_tag)], 0, 0, height)

# 方法2：手动定义
# 点 → 线 → 曲线环 → 面 → 曲面环 → 体
```

## 坐标系统

Gmsh使用右手笛卡尔坐标系：

```
        Z
        │
        │
        │
        └───────── Y
       /
      /
     X
```

- X轴：向右
- Y轴：向内（屏幕里）
- Z轴：向上

## 单位

Gmsh本身不定义单位系统。坐标和尺寸的单位由用户自己定义和保持一致。

**最佳实践**：
- 保持所有输入数据使用相同单位
- 在脚本开头注明使用的单位
- 常用单位：米(m)、毫米(mm)、微米(μm)

```python
# 文档化单位（注释）
# 本模型使用毫米(mm)为单位

# 或使用变量
mm = 1e-3  # 如果想用米作为基础单位
length = 10 * mm
```

## 查询实体信息

```python
# 获取点坐标
x, y, z = gmsh.model.getValue(0, point_tag, [])

# 获取曲线上的点坐标（参数化）
# parametricCoord 范围 [0, 1]
coords = gmsh.model.getValue(1, curve_tag, [0.5])  # 曲线中点

# 获取实体的边界框
xmin, ymin, zmin, xmax, ymax, zmax = gmsh.model.getBoundingBox(dim, tag)

# 获取实体的质心（OCC）
x, y, z = gmsh.model.occ.getCenterOfMass(dim, tag)

# 获取实体的质量/长度/面积/体积（OCC）
mass = gmsh.model.occ.getMass(dim, tag)
```

## 完整示例

```python
#!/usr/bin/env python3
"""
几何基本概念演示
"""
import gmsh

gmsh.initialize()
gmsh.model.add("basic_concepts")

# 创建四边形
lc = 0.1
p1 = gmsh.model.geo.addPoint(0, 0, 0, lc, 1)
p2 = gmsh.model.geo.addPoint(1, 0, 0, lc, 2)
p3 = gmsh.model.geo.addPoint(1, 1, 0, lc, 3)
p4 = gmsh.model.geo.addPoint(0, 1, 0, lc, 4)

l1 = gmsh.model.geo.addLine(p1, p2, 1)
l2 = gmsh.model.geo.addLine(p2, p3, 2)
l3 = gmsh.model.geo.addLine(p3, p4, 3)
l4 = gmsh.model.geo.addLine(p4, p1, 4)

cl = gmsh.model.geo.addCurveLoop([l1, l2, l3, l4], 1)
s = gmsh.model.geo.addPlaneSurface([cl], 1)

gmsh.model.geo.synchronize()

# 查询信息
print("=== 实体列表 ===")
for dim in range(3):
    entities = gmsh.model.getEntities(dim)
    print(f"维度 {dim}: {entities}")

# 查询边界
print("\n=== 曲面1的边界 ===")
boundary = gmsh.model.getBoundary([(2, 1)])
print(f"边界曲线: {boundary}")

# 查询点坐标
print("\n=== 点坐标 ===")
for i in range(1, 5):
    coords = gmsh.model.getValue(0, i, [])
    print(f"点{i}: ({coords[0]:.2f}, {coords[1]:.2f}, {coords[2]:.2f})")

# 查询边界框
print("\n=== 曲面1的边界框 ===")
bbox = gmsh.model.getBoundingBox(2, 1)
print(f"X: [{bbox[0]:.2f}, {bbox[3]:.2f}]")
print(f"Y: [{bbox[1]:.2f}, {bbox[4]:.2f}]")
print(f"Z: [{bbox[2]:.2f}, {bbox[5]:.2f}]")

gmsh.finalize()
```

## 下一步

掌握基本概念后，请继续学习：
- [02-内置几何内核](./02-内置几何内核.md) - 学习geo内核的详细用法
