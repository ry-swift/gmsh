# 插件系统

Gmsh内置了丰富的插件，用于数据处理、后处理分析和可视化增强。

## 插件基础

### 使用插件

```python
import gmsh

gmsh.initialize()

# 设置插件参数
gmsh.plugin.setNumber("PluginName", "ParameterName", value)
gmsh.plugin.setString("PluginName", "ParameterName", "string_value")

# 运行插件
gmsh.plugin.run("PluginName")

gmsh.finalize()
```

### 获取插件信息

```python
# 获取可用插件列表（通过尝试运行）
# Gmsh API没有直接列出插件的方法
# 但可以查看文档或尝试常用插件
```

## 数据处理插件

### MathEval（数学运算）

对View数据进行数学运算。

```python
#!/usr/bin/env python3
"""
使用MathEval插件进行数学运算
"""
import gmsh
import numpy as np

gmsh.initialize()
gmsh.model.add("matheval")

# 创建网格和数据
rect = gmsh.model.occ.addRectangle(0, 0, 0, 1, 1)
gmsh.model.occ.synchronize()
gmsh.model.mesh.generate(2)

node_tags, node_coords, _ = gmsh.model.mesh.getNodes()
node_coords = np.array(node_coords).reshape(-1, 3)

# 创建View
view = gmsh.view.add("Original")
data = [[np.sin(np.pi*c[0])*np.sin(np.pi*c[1])] for c in node_coords]
gmsh.view.addModelData(view, 0, "", "NodeData", list(node_tags), data)

# 使用MathEval
# 可用变量：v0, v1, ... (View值), x, y, z (坐标)
gmsh.plugin.setNumber("MathEval", "View", 0)

# 表达式：v0的平方
gmsh.plugin.setString("MathEval", "Expression0", "v0*v0")

# 运行
gmsh.plugin.run("MathEval")

# 新View自动创建
print(f"View数量: {len(gmsh.view.getTags())}")

gmsh.write("matheval.msh")
gmsh.finalize()
```

### MathEval常用表达式

```python
# 加法
gmsh.plugin.setString("MathEval", "Expression0", "v0 + v1")

# 乘法
gmsh.plugin.setString("MathEval", "Expression0", "v0 * 2.0")

# 三角函数
gmsh.plugin.setString("MathEval", "Expression0", "sin(v0)")

# 条件
gmsh.plugin.setString("MathEval", "Expression0", "v0 > 0.5 ? 1 : 0")

# 组合
gmsh.plugin.setString("MathEval", "Expression0", "sqrt(v0*v0 + v1*v1)")

# 坐标相关
gmsh.plugin.setString("MathEval", "Expression0", "v0 * exp(-x*x-y*y)")
```

### Smooth（平滑）

对View数据进行平滑处理。

```python
# 设置View索引
gmsh.plugin.setNumber("Smooth", "View", 0)

# 迭代次数
gmsh.plugin.setNumber("Smooth", "NbIter", 5)

# 运行
gmsh.plugin.run("Smooth")
```

### Gradient（梯度）

计算标量场的梯度。

```python
gmsh.plugin.setNumber("Gradient", "View", 0)
gmsh.plugin.run("Gradient")

# 结果是一个向量场View
```

### Curl（旋度）

计算向量场的旋度。

```python
gmsh.plugin.setNumber("Curl", "View", 0)
gmsh.plugin.run("Curl")
```

### Divergence（散度）

计算向量场的散度。

```python
gmsh.plugin.setNumber("Divergence", "View", 0)
gmsh.plugin.run("Divergence")
```

## 几何处理插件

### CutPlane（切面）

创建平面切片。

```python
#!/usr/bin/env python3
"""
使用CutPlane创建切面
"""
import gmsh
import numpy as np

gmsh.initialize()
gmsh.model.add("cutplane")

# 创建3D数据
box = gmsh.model.occ.addBox(0, 0, 0, 1, 1, 1)
gmsh.model.occ.synchronize()
gmsh.model.mesh.generate(3)

node_tags, node_coords, _ = gmsh.model.mesh.getNodes()
node_coords = np.array(node_coords).reshape(-1, 3)

view = gmsh.view.add("3DField")
data = [[np.sqrt(c[0]**2+c[1]**2+c[2]**2)] for c in node_coords]
gmsh.view.addModelData(view, 0, "", "NodeData", list(node_tags), data)

# 切面：z = 0.5
# 平面方程：Ax + By + Cz + D = 0
gmsh.plugin.setNumber("CutPlane", "A", 0)
gmsh.plugin.setNumber("CutPlane", "B", 0)
gmsh.plugin.setNumber("CutPlane", "C", 1)
gmsh.plugin.setNumber("CutPlane", "D", -0.5)
gmsh.plugin.setNumber("CutPlane", "View", 0)
gmsh.plugin.setNumber("CutPlane", "ExtractVolume", 0)
gmsh.plugin.setNumber("CutPlane", "RecurLevel", 4)

gmsh.plugin.run("CutPlane")

gmsh.write("cutplane.msh")
gmsh.finalize()
```

### CutSphere（球面切片）

```python
# 球面切片
gmsh.plugin.setNumber("CutSphere", "Xc", 0.5)  # 球心x
gmsh.plugin.setNumber("CutSphere", "Yc", 0.5)  # 球心y
gmsh.plugin.setNumber("CutSphere", "Zc", 0.5)  # 球心z
gmsh.plugin.setNumber("CutSphere", "R", 0.3)   # 半径
gmsh.plugin.setNumber("CutSphere", "View", 0)
gmsh.plugin.run("CutSphere")
```

### CutBox（立方体切片）

```python
# 提取立方体区域
gmsh.plugin.setNumber("CutBox", "X0", 0.2)
gmsh.plugin.setNumber("CutBox", "Y0", 0.2)
gmsh.plugin.setNumber("CutBox", "Z0", 0.2)
gmsh.plugin.setNumber("CutBox", "X1", 0.8)
gmsh.plugin.setNumber("CutBox", "Y1", 0.8)
gmsh.plugin.setNumber("CutBox", "Z1", 0.8)
gmsh.plugin.setNumber("CutBox", "View", 0)
gmsh.plugin.run("CutBox")
```

### Isosurface（等值面）

提取等值面。

```python
#!/usr/bin/env python3
"""
提取等值面
"""
import gmsh
import numpy as np

gmsh.initialize()
gmsh.model.add("isosurface")

# 创建3D标量场
sphere = gmsh.model.occ.addSphere(0, 0, 0, 1)
gmsh.model.occ.synchronize()
gmsh.model.mesh.generate(3)

node_tags, node_coords, _ = gmsh.model.mesh.getNodes()
node_coords = np.array(node_coords).reshape(-1, 3)

view = gmsh.view.add("Density")
data = [[np.exp(-2*(c[0]**2+c[1]**2+c[2]**2))] for c in node_coords]
gmsh.view.addModelData(view, 0, "", "NodeData", list(node_tags), data)

# 提取等值面
gmsh.plugin.setNumber("Isosurface", "Value", 0.5)
gmsh.plugin.setNumber("Isosurface", "View", 0)
gmsh.plugin.run("Isosurface")

gmsh.write("isosurface.msh")
gmsh.finalize()
```

### StreamLines（流线）

生成流线。

```python
# 流线（针对向量场）
gmsh.plugin.setNumber("StreamLines", "View", 0)  # 向量场View
gmsh.plugin.setNumber("StreamLines", "X0", 0)    # 起点
gmsh.plugin.setNumber("StreamLines", "Y0", 0)
gmsh.plugin.setNumber("StreamLines", "Z0", 0)
gmsh.plugin.setNumber("StreamLines", "X1", 1)    # 终点
gmsh.plugin.setNumber("StreamLines", "Y1", 1)
gmsh.plugin.setNumber("StreamLines", "Z1", 0)
gmsh.plugin.setNumber("StreamLines", "NumPointsU", 10)
gmsh.plugin.setNumber("StreamLines", "MaxIter", 1000)
gmsh.plugin.setNumber("StreamLines", "DT", 0.01)
gmsh.plugin.run("StreamLines")
```

## 统计分析插件

### MinMax（最值）

```python
# 获取View的最小最大值
gmsh.plugin.setNumber("MinMax", "View", 0)
gmsh.plugin.run("MinMax")
# 结果通常在日志中显示
```

### Integrate（积分）

```python
# 对View进行积分
gmsh.plugin.setNumber("Integrate", "View", 0)
gmsh.plugin.setNumber("Integrate", "Dimension", -1)  # -1=自动
gmsh.plugin.run("Integrate")
```

### Probe（探针）

在指定点获取值。

```python
gmsh.plugin.setNumber("Probe", "X", 0.5)
gmsh.plugin.setNumber("Probe", "Y", 0.5)
gmsh.plugin.setNumber("Probe", "Z", 0)
gmsh.plugin.setNumber("Probe", "View", 0)
gmsh.plugin.run("Probe")
```

## 可视化增强插件

### Skin（表皮）

提取3D数据的表面。

```python
gmsh.plugin.setNumber("Skin", "View", 0)
gmsh.plugin.setNumber("Skin", "FromMesh", 0)
gmsh.plugin.run("Skin")
```

### Warp（变形）

根据向量场变形网格。

```python
# 使用位移场变形
gmsh.plugin.setNumber("Warp", "View", 0)
gmsh.plugin.setNumber("Warp", "Factor", 1.0)  # 变形因子
gmsh.plugin.run("Warp")
```

### Transform（变换）

对View数据进行几何变换。

```python
# 缩放
gmsh.plugin.setNumber("Transform", "A11", 2)  # X缩放
gmsh.plugin.setNumber("Transform", "A22", 2)  # Y缩放
gmsh.plugin.setNumber("Transform", "A33", 2)  # Z缩放
gmsh.plugin.setNumber("Transform", "View", 0)
gmsh.plugin.run("Transform")
```

### Annotate（标注）

添加文本标注。

```python
gmsh.plugin.setString("Annotate", "Text", "Maximum")
gmsh.plugin.setNumber("Annotate", "X", 0.5)
gmsh.plugin.setNumber("Annotate", "Y", 0.5)
gmsh.plugin.setNumber("Annotate", "Z", 0)
gmsh.plugin.setNumber("Annotate", "View", 0)
gmsh.plugin.run("Annotate")
```

## 完整示例：后处理流水线

```python
#!/usr/bin/env python3
"""
完整的后处理流水线示例
"""
import gmsh
import numpy as np

gmsh.initialize()
gmsh.model.add("processing_pipeline")

# 1. 创建3D网格和数据
box = gmsh.model.occ.addBox(0, 0, 0, 2, 2, 2)
gmsh.model.occ.synchronize()
gmsh.option.setNumber("Mesh.MeshSizeMax", 0.1)
gmsh.model.mesh.generate(3)

node_tags, node_coords, _ = gmsh.model.mesh.getNodes()
node_coords = np.array(node_coords).reshape(-1, 3)

# 2. 创建温度场View
view_temp = gmsh.view.add("Temperature")
temp_data = []
for c in node_coords:
    x, y, z = c
    # 高斯热源
    T = 100 * np.exp(-((x-1)**2 + (y-1)**2 + (z-1)**2) / 0.5)
    temp_data.append([T])

gmsh.view.addModelData(view_temp, 0, "", "NodeData",
                       list(node_tags), temp_data)

# 3. 计算温度梯度（热流方向）
gmsh.plugin.setNumber("Gradient", "View", 0)
gmsh.plugin.run("Gradient")
# 新建View[1]

# 4. 创建切面（z=1）
gmsh.plugin.setNumber("CutPlane", "A", 0)
gmsh.plugin.setNumber("CutPlane", "B", 0)
gmsh.plugin.setNumber("CutPlane", "C", 1)
gmsh.plugin.setNumber("CutPlane", "D", -1)
gmsh.plugin.setNumber("CutPlane", "View", 0)
gmsh.plugin.run("CutPlane")
# 新建View[2]

# 5. 提取等温面
gmsh.plugin.setNumber("Isosurface", "Value", 50)
gmsh.plugin.setNumber("Isosurface", "View", 0)
gmsh.plugin.run("Isosurface")
# 新建View[3]

# 6. 平滑处理
gmsh.plugin.setNumber("Smooth", "View", 2)  # 对切面View平滑
gmsh.plugin.setNumber("Smooth", "NbIter", 3)
gmsh.plugin.run("Smooth")

# 7. 计算派生量（平方）
gmsh.plugin.setNumber("MathEval", "View", 2)
gmsh.plugin.setString("MathEval", "Expression0", "v0*v0")
gmsh.plugin.run("MathEval")

# 8. 设置显示选项
# 原始温度场
gmsh.option.setNumber("View[0].Visible", 0)

# 梯度场（热流）
gmsh.option.setNumber("View[1].Visible", 0)
gmsh.option.setNumber("View[1].VectorType", 4)

# 切面
gmsh.option.setNumber("View[2].Visible", 1)
gmsh.option.setNumber("View[2].ColorTable", 3)  # Hot

# 等温面
gmsh.option.setNumber("View[3].Visible", 1)
gmsh.option.setNumber("View[3].ColorTable", 2)

# 9. 输出结果
views = gmsh.view.getTags()
print(f"生成的View数量: {len(views)}")

for i, tag in enumerate(views):
    print(f"View[{i}]: tag={tag}")

gmsh.write("processing_pipeline.msh")
gmsh.finalize()
```

## 常用插件汇总

| 类别 | 插件名 | 功能 |
|-----|--------|------|
| 数学 | MathEval | 数学运算 |
| 数学 | Smooth | 数据平滑 |
| 微分 | Gradient | 梯度计算 |
| 微分 | Curl | 旋度计算 |
| 微分 | Divergence | 散度计算 |
| 切片 | CutPlane | 平面切片 |
| 切片 | CutSphere | 球面切片 |
| 切片 | CutBox | 立方体切片 |
| 提取 | Isosurface | 等值面 |
| 提取 | StreamLines | 流线 |
| 提取 | Skin | 表面提取 |
| 变换 | Warp | 网格变形 |
| 变换 | Transform | 几何变换 |
| 统计 | MinMax | 最值 |
| 统计 | Integrate | 积分 |
| 统计 | Probe | 探针 |
| 标注 | Annotate | 文本标注 |

## 下一步

完成后处理与可视化学习后，请继续：
- [05-网格数据访问](../05-网格数据访问/01-节点与元素.md) - 学习网格数据的底层访问
